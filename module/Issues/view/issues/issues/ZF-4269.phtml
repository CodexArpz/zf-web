<h2>ZF-4269: Zend_Captcha_Image should check if a file with the unique name already exists</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Improvement</dd>

    <dt>Created:</dt>
    <dd>2008-09-12T05:50:01.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2009-06-17T14:32:52.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul>        <li>1.8.4 (23/Jun/09)</li>
    </ul></dd>

    <dt>Reporter:</dt>
    <dd>
        None
                    </dd>

    <dt>Assignee:</dt>
    <dd>
                Stanislav Malyshev (stas)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Captcha</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
        <li><a href="/issues/secure/attachment/11533/zend_captcha_image.patch">zend_captcha_image.patch</a></li>
        </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>Zend_Captcha_Image should check if a file with the generated unique name already exists.
On systems where there is a high load it could happen that a unique id gets generated twice. I know this is very unlikely but it could happen.</p>

<p>After generation of the id there should be an check if a file with that name already exists and if yes a new id should be generated.
I have created a fix that i will append to this issue. If the unique id generation fails three times an exception will be thrown.</p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Ota Mares (ota) on 2008-09-12T05:56:18.000+0000</p> 
        <div class="body">
            <p>Added logic to the generate method to check if a filename with the generated it exists, if yes a new id will be generated.
If the generation fails three times an exception will be thrown.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ota Mares (ota) on 2008-09-12T08:28:27.000+0000</p> 
        <div class="body">
            <p>Ugh, i just saw that there is a suffix property that should be used instead of hardcoding the suffix into the path like in my patch file.
Because there is no way to delete or reupload previously uploaded fixes i wont reprovide the changed verison to avoid confusion.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Stanislav Malyshev (stas) on 2008-10-23T12:30:19.000+0000</p> 
        <div class="body">
            <p>Did you actually see it happen? This requires that PHP random generator would give the same number in same microsecond for two processes. Is it a real problem?</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ota Mares (ota) on 2008-10-24T02:05:50.000+0000</p> 
        <div class="body">
            <p>I did not saw it happen but it <em>could</em> happen. And prevention is better then a late reaction.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Stanislav Malyshev (stas) on 2009-06-17T14:32:50.000+0000</p> 
        <div class="body">
            <p>fixed, thanks</p>

        </div>
    </div>
    </div>

