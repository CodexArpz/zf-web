<h2>ZF-12545: Database host not passed to adapter</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Bug</dd>

    <dt>Created:</dt>
    <dd>2013-03-19T22:52:13.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2013-03-21T17:12:52.000+0000</dd>

    <dt>Status:</dt>
    <dd>Closed</dd>

    <dt>Fix version(s):</dt>
    <dd><ul></ul></dd>

    <dt>Reporter:</dt>
    <dd>
                Anthor (anthor)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Frank Brückner (frosch)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Db</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
    </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>When trying to use an external host like this:</p>

<pre class="highlight"><code>
resources.db.adapter               = PDO_MYSQL
resourses.db.params.host           = "mysql51-48.pro"
resources.db.params.username       = "XXXXXX"
resources.db.params.password       = "XXXXXX"
resources.db.params.dbname         = "XXXXXX"
resources.db.isDefaultTableAdapter = true
resources.db.params.charset        = "utf8"
</code></pre>

<p>The resulting dsn generated by {{Zend_Db_Adapter_Pdo_Abstract::_dsn()}} does not contain the host value has it is not passed to it in the config object.
Thus it is not possible to connect to any database whose not localhost.</p>

<p>Adding manually the host in the function make the connection works has it should.</p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Frank Brückner (frosch) on 2013-03-20T07:43:42.000+0000</p> 
        <div class="body">
            <pre class="highlight"><code>
/**
 * @group ZF-12545
 */
public function testSetParamHost()
{
    $config = array(
        'bootstrap' =&gt; $this-&gt;bootstrap,
        'adapter'   =&gt; 'Pdo_Mysql',
        'params'    =&gt; array(
            'host'     =&gt; 'foo',
            'username' =&gt; 'bar',
            'password' =&gt; 'baz',
            'dbname'   =&gt; 'foobar',
        ),
    );

    $resource = new Zend_Application_Resource_Db($config);
    $db       = $resource-&gt;init();
    $actual   = $db-&gt;getConfig();
    $this-&gt;assertEquals($actual['host'], 'foo');
}
</code></pre>

<p><em>Test result: OK (11 tests, 13 assertions)</em></p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Anthor (anthor) on 2013-03-20T15:36:04.000+0000</p> 
        <div class="body">
            <p>Well I wonder where the host is going in a reel application as when I do some var_dump, 
especially in {{Zend_Db_Adapter_Pdo_Abstract::_dsn()}} and {{Zend_Db_Adapter_Abstract::__construct}}, 
none of the two get a host key.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Frank Brückner (frosch) on 2013-03-20T15:49:01.000+0000</p> 
        <div class="body">
            <p>Please add quotation marks for adapter entry:
```</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Anthor (anthor) on 2013-03-20T15:57:57.000+0000</p> 
        <div class="body">
            <p>I just try that and get the exact same error.
MySQL Error 2002, can't connect to localhost with socket.</p>

<p>{{var_dump}} on the dsn produced by {{Zend_Db_Adapter_Pdo_Abstract::dsn()}} shows that no host is passed to the adapter, thus it's trying to connect the application to localhost..</p>

<p>I'll try to reproduce it on a fresh application, but I can't see anything who would remove that config, as I can get it from my config object, and I'm not modifying the bootstrap DB.</p>

<p>Config was paste directly so I don't think my initialisation is wrong.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Frank Brückner (frosch) on 2013-03-20T16:09:54.000+0000</p> 
        <div class="body">
            <p>Please test in your bootstrap class:</p>

<pre class="highlight"><code>
protected function _initTest()
{
    $this-&gt;bootstrap('db');
    var_dump($this-&gt;getResource('db')-&gt;getConfig());
}
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Anthor (anthor) on 2013-03-20T16:16:50.000+0000</p> 
        <div class="body">
            <p>{</p>

<pre class="highlight"><code>
array(7) { 
    ["username"]=&gt; string(11) "XXXXXX" 
    ["password"]=&gt; string(10) "XXXXXX" 
    ["dbname"]=&gt; string(11) "XXXXXX" 
    ["charset"]=&gt; string(4) "utf8" 
    ["persistent"]=&gt; bool(false) 
    ["options"]=&gt; array(3) { 
        ["caseFolding"]=&gt; int(0) 
        ["autoQuoteIdentifiers"]=&gt; bool(true) 
        ["fetchMode"]=&gt; int(2)
    } 
    ["driver_options"]=&gt; array(0) { } 
} 
{</code></pre>

<p>}</p>

<p>Here is the return. Still no host, very strange behavior.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Frank Brückner (frosch) on 2013-03-20T16:24:10.000+0000</p> 
        <div class="body">
            <p>Okay, now we use only {{Zend_Config}}. Add to your bootstrap class:</p>

<pre class="highlight"><code>
protected function _initTest()
{
    $config = new Zend_Config_Ini(APPLICATION_PATH . '/configs/application.ini');
    var_dump($config-&gt;production-&gt;resources-&gt;db-&gt;toArray());
}
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Anthor (anthor) on 2013-03-20T16:34:57.000+0000</p> 
        <div class="body">
            <p>Same thing,
yesterday I add unix_socket as well just to try, and it does not appear</p>

<p>Here is the actual ini :
{</p>

<pre class="highlight"><code>
resources.db.adapter                                            = "pdo_mysql"
resourses.db.params.host                                        = "mysql51-48.pro"
resourses.db.params.unix_socket                                 = "/var/run/mysqld/mysqld.sock"
resources.db.params.username                                    = "chappeesite"
resources.db.params.password                                    = "XXXXXX"
resources.db.params.dbname                                      = "chappeesite"
resources.db.params.charset                                     = "utf8"
resources.db.isDefaultTableAdapter                              = true
resources.db.cache                                              = "database"
resources.db.defaultMetadataCache                               = "database"
{</code></pre>

<p>}</p>

<p>And here is the result :
{</p>

<pre class="highlight"><code>
array(5) { 
    ["adapter"]=&gt; string(9) "pdo_mysql" 
    ["params"]=&gt; array(4) { 
        ["username"]=&gt; string(11) "chappeesite" 
        ["password"]=&gt; string(10) "XXXXXX" 
        ["dbname"]=&gt; string(11) "chappeesite" 
        ["charset"]=&gt; string(4) "utf8" 
    } 
    ["isDefaultTableAdapter"]=&gt; string(1) "1" 
    ["cache"]=&gt; string(8) "database" 
    ["defaultMetadataCache"]=&gt; string(8) "database"
} 
{</code></pre>

<p>}</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Frank Brückner (frosch) on 2013-03-21T17:07:59.000+0000</p> 
        <div class="body">
            <p>Ahhh, here is the problem:</p>

<pre class="highlight"><code>resources.db.adapter = "pdo_mysql"
resourses.db.params.host = "mysql51-48.pro"</code></pre>

<p>Compare: <em>resources</em> vs. <em>resourses</em></p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Anthor (anthor) on 2013-03-21T17:12:52.000+0000</p> 
        <div class="body">
            <p>Woot, I'm really sorry ! Didn't see it coming !</p>

        </div>
    </div>
    </div>

