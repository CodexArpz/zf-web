<h2>ZF-1821: Zend_Auth_Adapter_DbTable SQL incompatible with MS SQL Server</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Bug</dd>

    <dt>Created:</dt>
    <dd>2007-08-07T07:21:19.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2009-12-30T13:50:50.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul></ul></dd>

    <dt>Reporter:</dt>
    <dd>
                Darby Felton (darby)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Ralph Schindler (ralph)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Auth</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
        <li><a href="/issues/secure/attachment/10670/DBTable-portable-sqll.diff">DBTable-portable-sqll.diff</a></li>
        </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>Original message from [~rob]:</p>

<p>{quote}
The SQL generated by Zend_Auth_Adapter_DbTable::authenticate() creates
the following SQL for MS SQL Server:</p>

<pre class="highlight"><code>
    SELECT
        "users".*,
        "password" = 'aa46347de7c4529eb7a1ce163daaa197fd1f1a62'
                        AS zend_auth_credential_match
        FROM "users"
        WHERE
            ("username" = 'rob')
</code></pre>

<p>This doesn't work and creates the following error:</p>

<p>SQLSTATE[HY000]: General error: 10007 Incorrect syntax near the keyword
'AS'. [10007] (severity 5) [(null)]</p>

<p>I've attached the patch I've used to get it working. It removes
functionality though as you can now no longer tell the difference
between the user not being in the database and the password being wrong.
Personally I don't need that, so I haven't fixed it as the only portable
way I can think of requires another database call.</p>

<p>I'll leave it to an SQL expert to come up with a better solution that
works across all supported databases.</p>

<p>Regards,</p>

<p>Rob...
{quote}</p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Rob Allen (rob) on 2007-08-07T07:48:58.000+0000</p> 
        <div class="body">
            <p>I've upped the priority as this is a show-stopper bug for Zend_Auth on MS SQL Server at least.</p>

<p>It doesn't help that the Exception message that is raised doesn't actually tell you what the problem is, so you assume that it's a problem with your code when it isn't!</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Marc Holzwarth (mholzwarth) on 2007-08-08T02:56:52.000+0000</p> 
        <div class="body">
            <p>Using CASE expression for password test may correct this problem.</p>

<p>AFAIK, most database implementations of CASE expression are ANSI SQL-92 compliant.</p>

<p>All sql queries below works on MSSQL :</p>

<pre class="highlight"><code>
zend_auth_credential_match = (CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END)
</code></pre>

<pre class="highlight"><code>
(CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END) AS zend_auth_credential_match
</code></pre>

<pre class="highlight"><code>
(CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END) zend_auth_credential_match
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2007-12-26T23:38:36.000+0000</p> 
        <div class="body">
            <p>Does anyone watching this issue have access to a MS-SQL server that they can test new adapters with?  I do not have direct access to one, but would like to find a workable solution to this within the next week.</p>

<p>-ralph</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2007-12-27T18:09:50.000+0000</p> 
        <div class="body">
            <p>I implemented</p>

<pre class="highlight"><code>
(CASE WHEN "password" = 'aa46347de7c452' THEN 1 ELSE 0 END) AS zend_auth_credential_match
</code></pre>

<p>in r7278</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2008-01-23T12:09:44.000+0000</p> 
        <div class="body">
            <p>Resolved in r7598</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Euller (eullerbd) on 2009-09-18T07:27:08.000+0000</p> 
        <div class="body">
            <p>This list states that the problem has been solved, but I continue having problems on accessing the database Sql Server using Zend_Auth. You have the implementation and Exception below.</p>

<p>I would like quoting that the fields on table are correct, I tested them using the database mysql.</p>

<p>Exception</p>

<p>The supplied parameters to Zend_Auth_Adapter_DbTable failed to produce a valid sql statement, please check table and column names for validity.</p>

<p>Implementation</p>

<pre class="highlight"><code>
public function login($login, $senha) {     
        $authAdapter = new Zend_Auth_Adapter_DbTable ( 
        Zend_Registry::get ( 'database' ), 'user', 'email', 'password', 'SHA1(?)' );
        $authAdapter-&gt;setIdentity ( '' . $login . '' )-&gt;setCredential ( '' . $senha . '' );
        $auth = self::getInstance ();
        $result = $auth-&gt;authenticate ( $authAdapter );
        if ($result-&gt;isValid ()) {
            $data = $authAdapter-&gt;getResultRowObject ( null, 'senha' );
            $auth-&gt;getStorage ()-&gt;write ( $data );
            $auth-&gt;getIdentity ();
            return true;
        } else {
            return false;
        }
    }
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2009-12-30T13:50:50.000+0000</p> 
        <div class="body">
            <p>Can you echo out the SQL statement that is being generated? You can do this by adding echo'ing the $dbSelect-&gt;__toString() from within the method Zend_Auth_Adapter_DbTable::_authenticateQuerySelect().</p>

<p>Additionally, attempt to var_dump the Exception $e.</p>

<p>-ralph</p>

        </div>
    </div>
    </div>

