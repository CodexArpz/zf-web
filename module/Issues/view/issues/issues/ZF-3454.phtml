<h2>ZF-3454: problem with zend_db_table_row save() when having multiple column primary key where one column gets populated by trigger</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Bug</dd>

    <dt>Created:</dt>
    <dd>2008-06-13T04:15:42.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2009-07-31T20:33:32.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul></ul></dd>

    <dt>Reporter:</dt>
    <dd>
        None
                    </dd>

    <dt>Assignee:</dt>
    <dd>
                Ralph Schindler (ralph)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Db_Table</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
    </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>I stumbled upon a strange problem today,</p>

<p>i was using zend_db_table_row object to insert new row to database, the problem is , that primary key for that table consists of 2 columns, and one of the columns is populated by a trigger so when i insert,  protected function _doInsert() in the end runs _refresh();</p>

<p>The problem is refresh is using a "where" clause builder function that expects me to pass all the fields that create primary key,  since one of those fields was populated by trigger  i end up with something like that launched against DB:</p>

<p>SELECT "document_pages".* FROM "document_pages" WHERE ("object" = 71) AND ("sort" = '') LIMIT 1</p>

<p>since, sort was populated with trigger , i cant supply it to the save(), and we end up with that little monster talking to postgres, and an exception thrown in result.</p>

<p>We should not assume that user will supply everything  to the save().</p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Marcin Lulek (ergo14) on 2008-06-13T04:28:34.000+0000</p> 
        <div class="body">
            <p>i should also note that i fixed my problem by using plain ol insert() method from zend_db_table to solve my problem, but i dont really see why i could not be able to use zend_db_table_row object to insert my data into db, as as we have the code now - it prevents me from it.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2009-05-21T07:25:18.000+0000</p> 
        <div class="body">
            <p>Its seems to me that this is not a bug per-se with the Row Gateway object.  The row gateway object makes the assumption that the primary keys of an object are either part of a sequence or provided.  This means that any case where the primary key would be generated by the database unbeknown to the row object (trigger for example), that specific business logic needs to be handled by the user.</p>

<p>I am not sure what you are proposing ultimately as the row object simply cannot know that the developer has offloaded business logic into the database.  Since it can never create a row that is fully connected to the database <em>by design</em>, you should probably avoid using the Row Gateway to create rows.</p>

<p>Alternatively, if you can find a way to be able to determine the value of your last tirggered insert, you should prob. move that logic into the _refresh() method that you might overwrite in your extending row class objects.</p>

<p>I am inclined to mark as not an issue, unless you can provide a suggestion that might describe a generic way of handling this type of issue.</p>

<p>Thanks,
Ralph</p>

        </div>
    </div>
    </div>

