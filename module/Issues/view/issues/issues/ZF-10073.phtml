<h2>ZF-10073: Invalid iTunes categories with Zend_Feed</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Bug</dd>

    <dt>Created:</dt>
    <dd>2010-06-29T06:58:07.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2011-05-13T20:29:44.000+0000</dd>

    <dt>Status:</dt>
    <dd>Closed</dd>

    <dt>Fix version(s):</dt>
    <dd><ul></ul></dd>

    <dt>Reporter:</dt>
    <dd>
                Fabio Bacigalupo. (openhaus)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Pádraic Brady (padraic)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Feed</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
    </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>RSS feeds generated with Zend_Feed::importBuilder(new Zend_Feed_Builder(...), 'rss')-&gt;saveXML() do not validate if one of the iTunes categories consists of a main and a sub element. The tag for the main element is closed before the sub element is enclosed as shown below.</p>

<p>Result as generated by Zend_Feed:</p>

<pre><code>&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd&lt;/a&gt;" text="Arts"/&gt;
&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd&lt;/a&gt;" text="Arts"/&gt;
&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd&lt;/a&gt;" text="Performing Arts"/&gt;
&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"/"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd"/&lt;/a&gt;&gt;
</code></pre>

<p>Expected:</p>

<pre><code>&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd&lt;/a&gt;" text="Arts"/&gt; &lt;!-- Only main category is ok --&gt;
&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd&lt;/a&gt;" text="Arts"&gt;
   &lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd&lt;/a&gt;" text="Performing Arts"/&gt;
&lt;itunes:category xmlns:itunes="http://&lt;a rel="nofollow" href="www.itunes.com/DTDs/Podcast-1.0.dtd"/"&gt;www.itunes.com/DTDs/Podcast-1.0.dtd"/&lt;/a&gt;&gt;
</code></pre>

<p>or from <a href="http://www.apple.com/itunes/podcasts/specs.html">http://www.apple.com/itunes/podcasts/specs.html</a>:</p>

<p></p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Henrik Nicolaisen (hmn) on 2010-08-26T15:16:09.000+0000</p> 
        <div class="body">
            <p>Hvis should fix the problem</p>

<h1>Index: library/Zend/Feed/Rss.php</h1>

<p>--- library/Zend/Feed/Rss.php   (revision 22908)
+++ library/Zend/Feed/Rss.php   (working copy)
@@ -359,17 +359,11 @@
                 $node = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
                 $node-&gt;setAttribute('text', $category['main']);
                 $root-&gt;appendChild($node);
-                $add_end_category = false;
                 if (!empty($category['sub'])) {
-                    $add_end_category = true;
-                    $node = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
-                    $node-&gt;setAttribute('text', $category['sub']);
-                    $root-&gt;appendChild($node);
+                    $nodeSub = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
+                    $nodeSub-&gt;setAttribute('text', $category['sub']);
+                    $node-&gt;appendChild($nodeSub);
                 }
-                if ($i &gt; 0 || $add_end_category) {
-                    $node = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
-                    $root-&gt;appendChild($node);
-                }
             }
         }
     }</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Henrik Nicolaisen (hmn) on 2010-08-26T15:20:38.000+0000</p> 
        <div class="body">
            <p>sorry forgot wiki tags</p>

<pre class="highlight"><code>
Index: library/Zend/Feed/Rss.php
===================================================================
--- library/Zend/Feed/Rss.php   (revision 22908)
+++ library/Zend/Feed/Rss.php   (working copy)
@@ -359,17 +359,11 @@
                 $node = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
                 $node-&gt;setAttribute('text', $category['main']);
                 $root-&gt;appendChild($node);
-                $add_end_category = false;
                 if (!empty($category['sub'])) {
-                    $add_end_category = true;
-                    $node = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
-                    $node-&gt;setAttribute('text', $category['sub']);
-                    $root-&gt;appendChild($node);
+                    $nodeSub = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
+                    $nodeSub-&gt;setAttribute('text', $category['sub']);
+                    $node-&gt;appendChild($nodeSub);
                 }
-                if ($i &gt; 0 || $add_end_category) {
-                    $node = $this-&gt;_element-&gt;createElementNS('<a href="http://www.itunes.com/DTDs/Podcast-1.0.dtd">http://www.itunes.com/DTDs/Podcast-1.0.dtd</a>', 'itunes:category');
-                    $root-&gt;appendChild($node);
-                }
             }
         }
     }
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Fabio Bacigalupo. (openhaus) on 2010-08-30T07:09:17.000+0000</p> 
        <div class="body">
            <p>Works very well for me!</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Pádraic Brady (padraic) on 2011-05-13T20:29:44.000+0000</p> 
        <div class="body">
            <p>Please note that any missing or non-standard behaviour will not be fixed. Users are advised that Zend_Feed is basically deprecated (not in ZF2) and they should use/migrate to Zend_Feed_Reader/Zend_Feed_Writer which are far more comprehensive, adherent to all standards, easier to use, simple to extend for RSS/Atom extensions and which have somewhere in excess of 1000 unit tests to back those statements up (or was it almost 1500?). Anyway - I almost broke my fingers in testing ;). Using the newer components will also make transitioning new functionality to ZF2 that much easier.</p>

        </div>
    </div>
    </div>

