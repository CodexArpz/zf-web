<h2>ZF-2633: testToFloatSetlocale(Zend_Locale_FormatTest): &quot;Zend_Locale_Math_Exception: subtraction overflow: 1234.5 - 1234 != 0,5&quot;</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Unit Tests: Problem</dd>

    <dt>Created:</dt>
    <dd>2008-02-12T18:44:15.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2008-03-21T16:25:47.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul>        <li>1.5.0 (17/Mar/08)</li>
    </ul></dd>

    <dt>Reporter:</dt>
    <dd>
                Alexander Veremyev (alexander)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Thomas Weidner (thomas)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Locale</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
        <li><a href="/issues/browse/ZF-2368">ZF-2368</a></li>
            <li><a href="/issues/browse/ZF-2672">ZF-2672</a></li>
            <li><a href="/issues/browse/ZF-2368">ZF-2368</a></li>
            <li><a href="/issues/browse/ZF-2631">ZF-2631</a></li>
        </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
        <li><a href="/issues/secure/attachment/11152/out.txt">out.txt</a></li>
            <li><a href="/issues/secure/attachment/11156/out1.txt">out1.txt</a></li>
            <li><a href="/issues/secure/attachment/11153/PhpMath.php">PhpMath.php</a></li>
            <li><a href="/issues/secure/attachment/11150/PhpMath.php">PhpMath.php</a></li>
            <li><a href="/issues/secure/attachment/11158/UnitTestsOutput.txt">UnitTestsOutput.txt</a></li>
        </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>Error occurs while unit tests passing with the following diagnostic:</p>

<pre class="highlight"><code> 
2) testToFloatSetlocale(Zend_Locale_FormatTest)
Zend_Locale_Math_Exception: subtraction overflow: 1234.5 - 1234 != 0,5
/home/cawa/ZendFramework/release-1.0/library/Zend/Locale/Format.php:399
/home/cawa/ZendFramework/release-1.0/library/Zend/Locale/Format.php:526
/home/cawa/ZendFramework/release-1.0/tests/Zend/Locale/FormatTest.php:913
/home/cawa/ZendFramework/release-1.0/tests/AllTests.php:51
/home/cawa/ZendFramework/release-1.0/tests/AllTests.php:65
</code></pre>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-13T01:47:11.000+0000</p> 
        <div class="body">
            <p>Have you tested with the branch or just with the release ???
This is part of another issue and has already been fixed in te past with the help of Darby and Sebastian.</p>

<p>It would be interesting if the same problem occurs within trunk or not.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-13T01:49:45.000+0000</p> 
        <div class="body">
            <p>I need details...
PHP Version, OS, BCMath activated, Used Locale, ZF Revision</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-13T03:05:07.000+0000</p> 
        <div class="body">
            <p>It's current SVN version of release maintenance branch</p>

<p>I tested it using two different Linux machines.</p>

<h2>PHP versions:</h2>

<p>PHP 5.2.5 (cli) (built: Feb 12 2008 11:37:43)
Copyright (c) 1997-2007 The PHP Group
Zend Engine v2.2.0, Copyright (c) 1998-2007 Zend Technologies</p>

<p>PHP 5.2.4 (cli) (built: Oct 16 2007 17:32:16)
Copyright (c) 1997-2007 The PHP Group
Zend Engine v2.2.0, Copyright (c) 1998-2007 Zend Technologies
    with Xdebug v2.0.2, Copyright (c) 2002-2007, by Derick Rethans</p>

<p>PHP 5.2.2RC2-dev (cli) (built: Feb  1 2008 01:09:49)
Copyright (c) 1997-2007 The PHP Group</p>

<h2>Zend Engine v2.2.0, Copyright (c) 1998-2007 Zend Technologies</h2>

<p>BCMath extension  is disabled (enabling bcmath extension doesn't help)</p>

<p>TESTS_ZEND_LOCALE_BCMATH_ENABLED tests configuration variable is set to true.</p>

<p>ZF revision 7971</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-15T02:11:33.000+0000</p> 
        <div class="body">
            <p>Can you please test with the latest release and give me response ?</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-15T15:01:25.000+0000</p> 
        <div class="body">
            <p>Still fails:</p>

<pre class="highlight"><code>
1) testToFloatSetlocale(Zend_Locale_FormatTest)
Zend_Locale_Math_Exception: subtraction overflow: 1234.5 - 1234 != 0,5
/home/cawa/ZendFramework/release-1.0/library/Zend/Locale/Format.php:409
/home/cawa/ZendFramework/release-1.0/library/Zend/Locale/Format.php:532
/home/cawa/ZendFramework/release-1.0/tests/Zend/Locale/FormatTest.php:913
/home/cawa/ZendFramework/release-1.0/tests/Zend/Locale/AllTests.php:63
/home/cawa/ZendFramework/release-1.0/tests/Zend/Locale/AllTests.php:79
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-16T12:47:13.000+0000</p> 
        <div class="body">
            <p>I attached a debug version for Zend/Locale/Math/PhpMath.php</p>

<p>Please change yours with the debug file and return me the debug output for detail analysis.
Thank you</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-18T18:28:00.000+0000</p> 
        <div class="body">
            <p>Here is an output of the test code you provided (see the attachment).</p>

<p>Output is generated by passing Zend_Locale tests set (tests/Zend/Locale/AllTests.php).</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-19T14:02:48.000+0000</p> 
        <div class="body">
            <p>Unsure if it will make until 1.0.4... therefor downgrading to critical</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-19T15:31:19.000+0000</p> 
        <div class="body">
            <p>I attached a reworked PhpMath file.
The problem is related to a autoconversion which is done even after casting to a specific type.</p>

<p>Please test the new version and give me feedback if it now works or if I have to find another way.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-19T16:57:09.000+0000</p> 
        <div class="body">
            <p>Aha. OK!</p>

<p>Here is next output (out1.txt)</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-21T19:23:15.000+0000</p> 
        <div class="body">
            <p>Changeset <a href="http://framework.zend.com/fisheye/changelog/Zend_Framework?cs=8266">8266</a> is related to this issue (wrong issue number in the comment)</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-21T19:25:55.000+0000</p> 
        <div class="body">
            <p>Fixed for trunk and release maintenance branch.</p>

<p>Thomas, please review the changes</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-02-22T02:26:13.000+0000</p> 
        <div class="body">
            <p>I reviewed them and found other problems related to this.
I rewrote the class, now it should work in all different environments.</p>

<p>I have no problems in my 3 environments... can you verify that for your's ?</p>

<p>PS: I made the changes only to trunk ! If it works for you you can make the change also to branch (ask darby related to release date)</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-22T10:21:12.000+0000</p> 
        <div class="body">
            <p>I've tested it and got a set of errors (see the attached file). I have fix for them and I'm going to commit it. Please review update.</p>

<p>PS Could you mention JIRA issue number within commit comments (like [ZF-xxxx])? JIRA automatically lists such commits within 'FishEye' tab for the specified issue and it's very helpful for linking changesets with issues and merging changes to branches.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-22T11:03:04.000+0000</p> 
        <div class="body">
            <p>Still have problems...</p>

<pre class="highlight"><code>
PHPUnit 3.2.12 by Sebastian Bergmann.

............................................................ 60 / 87
...............E...........

Time: 14 seconds

There was 1 error:

1) testToFloatSetlocale(Zend_Locale_FormatTest)
Zend_Locale_Math_Exception: subtraction overflow: 1234,5 - 1234 != 0
/home/cawa/ZendFramework/trunk/library/Zend/Locale/Format.php:414
/home/cawa/ZendFramework/trunk/library/Zend/Locale/Format.php:537
/home/cawa/ZendFramework/trunk/tests/Zend/Locale/FormatTest.php:913
/home/cawa/ZendFramework/trunk/tests/Zend/Locale/AllTests.php:63
/home/cawa/ZendFramework/trunk/tests/Zend/Locale/AllTests.php:79

FAILURES!
Tests: 87, Errors: 1.
</code></pre>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-22T11:46:50.000+0000</p> 
        <div class="body">
            <p>Some problems still exist. Needs more complex solution.</p>

<p>Test is marked as skipped.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Alexander Veremyev (alexander) on 2008-02-22T11:47:56.000+0000</p> 
        <div class="body">
            <p>Priority is downgraded to postpone issue.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-03-04T14:02:52.000+0000</p> 
        <div class="body">
            <p>Should be fixed with SVN-8532... please verify this and give me feedback... Thank you</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-03-05T10:51:52.000+0000</p> 
        <div class="body">
            <p>Fixed</p>

        </div>
    </div>
    </div>

