<h2>ZF-5823: Non-optimized SQL generated for LIMIT clause in MSSQL adapter</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Improvement</dd>

    <dt>Created:</dt>
    <dd>2009-02-18T00:12:07.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2009-08-24T10:50:48.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul>        <li>1.9.2 (25/Aug/09)</li>
    </ul></dd>

    <dt>Reporter:</dt>
    <dd>
                TNF ICT Dept (tnfict)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Ralph Schindler (ralph)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Db</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
    </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>When no offset is given in a Zend_Db_Select object, the SQL generated by Zend_Db_Adapter_Pdo_Mssql gives non-optimal results. It looks like 'SELECT * FROM(SELECT TOP n * FROM(SELECT TOP m * FROM... ORDER BY fld DESC) ORDER BY fld ASC as inner_tbl) ORDER BY fld DESC as outer_tbl.</p>

<p>This convoluted query is only needed if an offset if given. If only a limit is given, a much simpler and lighter query can be used: SELECT TOP n * FROM...</p>

<p>I propose the following diff:</p>

<pre class="highlight"><code>
===================================================================
--- library-1.6.2/Zend/Db/Adapter/Pdo/Mssql.php 2009-02-18 07:41:49 UTC (rev 6802)
+++ library-1.6.2/Zend/Db/Adapter/Pdo/Mssql.php 2009-02-18 08:01:42 UTC (rev 6803)
@@ -321,17 +321,21 @@
             $order = trim(preg_replace('/\bASC\b|\bDESC\b/i', '', $order));
         }

-        $sql = preg_replace('/^SELECT\s/i', 'SELECT TOP ' . ($count+$offset) . ' ', $sql);
+        if ($offset &gt; 0) {
+            $sql = preg_replace('/^SELECT\s/i', 'SELECT TOP ' . 
+ ($count+$offset) . ' ', $sql);

-        $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';
-        if ($orderby !== false) {
-            $sql .= ' ORDER BY ' . $order . ' ';
-            $sql .= (stripos($sort, 'asc') !== false) ? 'DESC' : 'ASC';
+            $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';
+            if ($orderby !== false) {
+                $sql .= ' ORDER BY ' . $order . ' ';
+                $sql .= (stripos($sort, 'asc') !== false) ? 'DESC' : 'ASC';
+            }
+            $sql .= ') AS outer_tbl';
+            if ($orderby !== false) {
+                $sql .= ' ORDER BY ' . $order . ' ' . $sort;
+            }
+        } else {
+            $sql = preg_replace('/^SELECT\s/i', 'SELECT TOP ' . 
+ ($count) . ' ', $sql);
         }
-        $sql .= ') AS outer_tbl';
-        if ($orderby !== false) {
-            $sql .= ' ORDER BY ' . $order . ' ' . $sort;
-        }

         return $sql;
     }

</code></pre>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2009-08-21T07:20:29.000+0000</p> 
        <div class="body">
            <p>Improvement in r17714, please test.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Ralph Schindler (ralph) on 2009-08-24T10:50:48.000+0000</p> 
        <div class="body">
            <p>Fixed in release branch 1.9</p>

        </div>
    </div>
    </div>

