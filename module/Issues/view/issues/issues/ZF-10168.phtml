<h2>ZF-10168: Zend_Mime_Decode is not able to split a mime message when end boundary is missing.</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Improvement</dd>

    <dt>Created:</dt>
    <dd>2010-07-16T04:57:44.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2011-11-01T17:49:07.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul></ul></dd>

    <dt>Reporter:</dt>
    <dd>
                Jochem Blok (jochemblok)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Marc Hodgins (mjh_ca)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Mime</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
    </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>Method splitMime throws an exception (throw new Zend_Exception('Not a valid Mime Message: End Missing')) when no end boundary is found. This causes a problem for me. I received an e-mail where the end boundary is missing, and get the exception mentioned above. I was able to continue parsing the email by replacing the exception line with:</p>

<p>$p = strlen($boundary);</p>

<p>All the remaining data is handled as the last part.</p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by user77 (zend77user) on 2010-11-09T10:32:28.000+0000</p> 
        <div class="body">
            <p>i did fix it with</p>

<p>// no more parts, find end boundary
$p = strpos($body, '--' . $boundary . '--', $start);
/* fixed */ if ($p===false) $p = strlen($boundary);
if ($p===false) {
 throw new Zend_Exception('Not a valid Mime Message: End Missing');
}</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Marc Hodgins (mjh_ca) on 2010-11-09T13:59:06.000+0000</p> 
        <div class="body">
            <p>Isn't an end boundary required by the MIME spec?  I don't think Zend_Mime_Decode should be working around others' broken implementations</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Jochem Blok (jochemblok) on 2010-11-10T03:33:59.000+0000</p> 
        <div class="body">
            <p>The problem is that the MIME is retrieved 1on1 from a POP3 server. So I have to deal with it as it is delivered. So the fix is very needed.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Marc Hodgins (mjh_ca) on 2010-11-10T10:29:46.000+0000</p> 
        <div class="body">
            <p>It is a slippery slope when you start working around bugs in third party applications - better to suggest a fix at the source.  What application generated the malformed message?  It is likely listed in the headers.</p>

<p>AFAIK, POP3 shouldn't have anything to do with the MIME content. That content is generated by the original creator of the message so it would be a bug in whatever application is generating the malformed message.</p>

<p>A Try/Catch block to allow you to gracefully recover from malformed messages would probably be more appropriate (outside of this component).</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Marc Hodgins (mjh_ca) on 2010-11-13T15:16:13.000+0000</p> 
        <div class="body">
            <p>Closing as not an issue.  As mentioned, suggest you work around this with Try/Catch block or similar.  It is expected behavior to throw an exception on a malformed message.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Douglas Reith (redthor) on 2011-05-09T23:42:20.000+0000</p> 
        <div class="body">
            <p>If anyone gets this error and is pulling emails from Google IMAP you might be interested in:
<a href="http://www.google.com/support/forum/p/gmail/thread?tid=33ae5a9e490f33e6&amp;hl=en">http://google.com/support/forum/…</a></p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Oleg (grifon) on 2011-07-12T14:23:45.000+0000</p> 
        <div class="body">
            <p>Not all messages ending by '--' . $boundary . '--'
To fix this bug we shold write code like this:</p>

<pre><code>    // no more parts, find end boundary
    $p = strpos($body, '--' . $boundary . '--', $start);
    /* fixed */ if ($p===false) $p = strlen($body);
    if ($p===false) {
        throw new Zend_Exception('Not a valid Mime Message: End Missing');
    }
</code></pre>

<p>Zend Framework Developers please fix this bug, do not forget it in the next release!
Yours sincerely :)</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Matt Lavinder (mlavinder) on 2011-11-01T17:26:56.000+0000</p> 
        <div class="body">
            <p>I think the fact that this has been closed as "Not an Issue" is unacceptable.  These messages load fine in Thunderbird, Gmail, and other clients and blow up in Zend Framework.</p>

<p>How can I get involved so I can have this issue assigned to me and correct it?  Would rather not have to manually apply a patch every time I download Zend Framework.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Adam Lundrigan (adamlundrigan) on 2011-11-01T17:49:07.000+0000</p> 
        <div class="body">
            <p>You will need to sign a CLA (See here: <a href="http://framework.zend.com/wiki/display/ZFPROP/Contributor+License+Agreement">http://framework.zend.com/wiki/display/…</a>).  Once it's processed and you have been added to the {{zf-framework-dev}} group you will be able to attach patches to issues here in JIRA.</p>

<p>This is what I do:  attach your patch, then email the component maintainer and/or the dev mailing list asking to have it reviewed.  Keep doing that every couple of weeks until someone from Zend or the CR team takes the time to review your patch.  I haven't seen it written officially, but my feeling is that Zend Framework 1.x is more or less frozen...Zend staff and most core contributors are focused on building v2.0, so there hasn't been much activity around v1.x as of late.</p>

        </div>
    </div>
    </div>

