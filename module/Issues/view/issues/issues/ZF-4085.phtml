<h2>ZF-4085: wrong xml encoding detection mechanism in Zend_Translate_Adapter_Xliff throwing Zend_Translate_Exception: XML error: No error at line 0</h2>

<dl class="metadata">
    <dt>Issue Type:</dt>
    <dd>Bug</dd>

    <dt>Created:</dt>
    <dd>2008-08-27T02:56:00.000+0000</dd>

    <dt>Last Updated:</dt>
    <dd>2008-09-02T10:38:53.000+0000</dd>

    <dt>Status:</dt>
    <dd>Resolved</dd>

    <dt>Fix version(s):</dt>
    <dd><ul>        <li>1.6.0 (02/Sep/08)</li>
    </ul></dd>

    <dt>Reporter:</dt>
    <dd>
                Remy Damour (remy215)
            </dd>

    <dt>Assignee:</dt>
    <dd>
                Thomas Weidner (thomas)
            </dd>

    <dt>Tags:</dt>
    <dd><ul>        <li>Zend_Translate</li>
        </ul></dd>

    <dt>Related issues:</dt>
    <dd><ul>
    </ul></dd>

    <dt>Attachments:</dt>
    <dd><ul>
    </ul></dd>
</dl>

<div class="description">
    <h3>Description</h3>

    <div class="body">
        <p>If you use the following header for xliff files:
&lt;?xml version='1.0' encoding='utf-8'?&gt;
instead of 
&lt;?xml version="1.0" encoding="utf-8"?&gt;
(i.e. single quotes instead of double quotes for "enconding" attribute value)
you end up with the following exception:
<b>Fatal error</b>:  Uncaught exception 'Zend_Translate_Exception' with message 'XML error: No error at line 0' in /home/remy/my_php/ZendFramework-1.5.3/library/Zend/Translate/Adapter/Xliff.php:97
Stack trace:</p>

<h1>0 ZendFramework-1.5.3/library/Zend/Translate/Adapter.php(406): Zend_Translate_Adapter_Xliff-&gt;_loadTranslationData('../application/...', 'en', Array)</h1>

<p>My xliff file has been generated by translate-toolkit (part of pootle project), using po2xliff python script. At first I thought that all attribute values had to be wrapped into double quotes (cf. <a href="http://bugs.locamotion.org/show_bug.cgi?id=492">http://bugs.locamotion.org/show_bug.cgi?id=492</a>) but single quotes appear to be legal too (cf. <a href="http://www.w3.org/TR/REC-xml/#NT-EncodingDecl">http://www.w3.org/TR/REC-xml/#NT-EncodingDecl</a>).</p>

<p>Error comes from Zend_Translate_Adapter_Xliff-&gt;_findEncoding() method which tries to extract xml encoding from xliff file, but expect encoding value to be wrapped using double-quotes:
line 195: $encoding = substr($encoding, 0, strpos($encoding, '"'));</p>

<p>One solution could be "$encoding = substr($encoding, 0, min(strpos($encoding, '"'), strpos($encoding, "'")));" since no single quote is to be found in any valid encoding value.</p>

<p>Regards,
Remy</p>

    </div>
</div>

<div class="comments">
    <h3>Comments</h3>

    <div class="comment">
        <p class="metadata">Posted by Remy Damour (remy215) on 2008-08-27T03:05:19.000+0000</p> 
        <div class="body">
            <p>Oups! my suggested solution does not work. (one of the two min() arguments may be false and then return 0).
The following one works (it detects opening char (" or ') and look for corresponding closing one):
[old]
            $encoding = substr($file, strpos($file, "encoding") + 10);
            $encoding = substr($encoding, 0, strpos($encoding, '"'));
[new]
            $encoding = substr($file, strpos($file, "encoding") + 9);
            $encoding = substr($encoding, 1, strpos($encoding, $encoding[0]));</p>

<p>Regards,
Remy</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-08-27T11:32:48.000+0000</p> 
        <div class="body">
            <p>Fixed with r11088.</p>

<p>PS: Given solution code does not work.</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Remy Damour (remy215) on 2008-08-27T11:35:54.000+0000</p> 
        <div class="body">
            <p>thx. I saw it too, I attached a working solution as comment #1
Cheers</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Thomas Weidner (thomas) on 2008-08-27T11:58:05.000+0000</p> 
        <div class="body">
            <p>Both of your solutions do not work :-)
Look at trunk.. your encoding is ALWAYS empty as you must add an offset of 1 to the strpos in the second line.
Otherwise it will be substr() from 1 to 0 which is empty :-)</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Remy Damour (remy215) on 2008-08-27T12:31:08.000+0000</p> 
        <div class="body">
            <p>You're 100% right, shame on me :P</p>

<p>I forgot to add "1" as offset on my second strpos.</p>

<p>$encoding = substr($file, strpos($file, "encoding") + 9);
$encoding = substr($encoding, 1, strpos($encoding, $encoding[0], 1));</p>

<p>Thanks for your vigileance :)
Remy</p>

        </div>
    </div>
        <div class="comment">
        <p class="metadata">Posted by Wil Sinclair (wil) on 2008-09-02T10:38:53.000+0000</p> 
        <div class="body">
            <p>Updating for the 1.6.0 release.</p>

        </div>
    </div>
    </div>

