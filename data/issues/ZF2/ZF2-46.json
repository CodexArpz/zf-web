{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF2-46",
    "key": "ZF2-46",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Definition\/Compiler marks all setter-injection method arguments as optional"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF2-46\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2011-10-11T00:04:49.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                "name": "adamlundrigan",
                "displayName": "Adam Lundrigan",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-08-05T13:34:11.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-10-11T00:04:49.000+0000"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Reproducing code (from http:\/\/pastie.org\/2325111)\r\n\r\nTarget of setter injection:\r\n{code}\r\n<?php\r\nnamespace DiTest;\r\n\r\nclass ObjectOne\r\n{\r\n    protected $_objTwo = null;\r\n    \r\n    \/**\r\n     * Set Dependency\r\n     * @param ObjectTwo $o\r\n     * @return ObjectOne \r\n     *\/\r\n    public function setTwo(ObjectTwo $o)\r\n    {\r\n        $this->_objTwo = $o;\r\n        return $this;\r\n    }\r\n}\r\n{code}\r\n\r\nDefinition Compiler:\r\n{code}\r\n<?php\r\n\/\/ Compile DI definitions\r\n$compiler = new Zend\\Di\\Definition\\Compiler();\r\n$compiler->addCodeScannerDirectory(\r\n    new Zend\\Code\\Scanner\\DirectoryScanner(\r\n        APPLICATION_PATH . \"\/..\/library\/DiTest\"\r\n    )\r\n);\r\n$definitions = $compiler->compile();\r\n{code}\r\n\r\nDiTest\\ObjectTwo is an empty class.\r\n\r\nResulting Definition for DiTest\\ObjectOne (print_r):\r\n{code}\r\n[DiTest\\ObjectOne] => Array\r\n    (\r\n        [superTypes] => Array\r\n            (\r\n            )\r\n\r\n        [instantiator] => __construct\r\n        [injectionMethods] => Array\r\n            (\r\n                [setTwo] => Array\r\n                    (\r\n                        [o] => Array\r\n                            (\r\n                                [0] => DiTest\\ObjectTwo\r\n                                [1] => 1                 \/\/<-- Paramter $o marked as optional, which it isn't\r\n                                [2] => 1\r\n                            )\r\n\r\n                    )\r\n\r\n            )\r\n\r\n    )\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF2-46\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [
                "Zend\\Di\\Definition\\Compiler"
            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF2",
                "key": "ZF2",
                "name": "Zend Framework 2.0",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10620",
                    "id": 10620,
                    "name": "Zend\\Di",
                    "description": "Dependency Injection Component",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47868",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "Possible fix:\r\n{code}\r\ndiff --git a\/library\/Zend\/Di\/Definition\/Compiler.php b\/library\/Zend\/Di\/Definition\/Compiler.php\r\nindex 5cdb446..d1523ad 100644\r\n--- a\/library\/Zend\/Di\/Definition\/Compiler.php\r\n+++ b\/library\/Zend\/Di\/Definition\/Compiler.php\r\n@@ -257,8 +257,8 @@ class Compiler\r\n                 $params[$paramName][] = null;\r\n             }\r\n\r\n-            if ($introspectionType == IntrospectionRuleset::TYPE_SETTER && $rules['paramCanBeOptional']) {\r\n-                $params[$paramName][] = true;\r\n+            if ($introspectionType == IntrospectionRuleset::TYPE_SETTER && !$rules['paramCanBeOptional']) {\r\n+                $params[$paramName][] = false;\r\n             } else {\r\n                 $params[$paramName][] = $p->isOptional();\r\n             }\r\n{code}\r\n\r\nThe first part of the existing logic says that \"If method is setter and parameter can be optional, then it is optional\", whereas it should be more along the lines of: \"If method is setter and parameter cannot be optional, then it is not optional\"\r\n\r\nI've placed this fix in my ZF2 fork:  https:\/\/github.com\/adamlundrigan\/zf2\/tree\/hotfix\/ZF2-46\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-08-05T13:47:29.000+0000",
                    "updated": "2011-08-05T13:47:29.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47883",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=evan.pro",
                        "name": "evan.pro",
                        "displayName": "Evan Coury",
                        "active": true
                    },
                    "body": "Confirmed. I went ahead and adjusted the unit tests in my fork to check for this, and with Adam's fix, the tests pass.\r\n\r\nhttps:\/\/github.com\/EvanDotPro\/zf2\/tree\/hotfix\/ZF2-46",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=evan.pro",
                        "name": "evan.pro",
                        "displayName": "Evan Coury",
                        "active": true
                    },
                    "created": "2011-08-06T16:38:00.000+0000",
                    "updated": "2011-08-06T16:38:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47884",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "I've opened pull request [#321|https:\/\/github.com\/zendframework\/zf2\/pull\/321] to have this fix + contributed tests merged into zendframework\/zf2:master",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-08-06T16:47:37.000+0000",
                    "updated": "2011-08-06T16:47:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47885",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=evan.pro",
                        "name": "evan.pro",
                        "displayName": "Evan Coury",
                        "active": true
                    },
                    "body": "Looking at this a bit deeper, it seems that \"optional\" in terms of Zend\\Di is not strictly based off whether the parameter is literally optional with a default value in the setter (the parameter in a setter is generally always going to be required, otherwise you would not be calling the setter). For that reason, this fix is probably not exactly correct.\r\n\r\nWhat \"optional\" seems to mean here, is that the DI container should not allow an instance of a class without some property being defined in the DI definition \/ configuration.\r\n\r\nInterestingly, reversing the logic as Adam has in his patch in Zend\\Di\\Definition\\RuntimeDefinition does actually fix the failing assertion in the Zend\\Di\\DependencyInjector test. This could be to another developer making the same assumption in this bug report, and coding some part of Zend\\Di based on that assumption. I'll keep digging.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=evan.pro",
                        "name": "evan.pro",
                        "displayName": "Evan Coury",
                        "active": true
                    },
                    "created": "2011-08-06T18:26:04.000+0000",
                    "updated": "2011-08-06T18:26:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48062",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "So, at the time of the writing of Zend\\Di, there was plenty of code out there, including code matthew was writing for the example ZF2 quickstart that had setters that accepted type-hinted objects that were also not null.  They match the setter pattern: set[A-Z]\\w(), but the author would not necessarily consider the presence of this method to mean there is a hard dependency from the class its in on the class in the typehint.\r\n\r\nThe unit test currently failing is similar to the code below.  Also in the code below, you'll see the modification to the IntrosepctionRuleset that would make it behavior like you are expecting:\r\n\r\n{code}\r\n\r\n<?php\r\nclass X\r\n{\r\n    public $one = null;\r\n    public $two = null;\r\n    public function setOne($one)\r\n    {\r\n        $this->one = $one;\r\n    }\r\n    public function setTwo($two)\r\n    {\r\n        $this->two = $two;\r\n    }\r\n}\r\n\r\nclass Y\r\n{\r\n    public $x = null;\r\n    public function setX(X $x)\r\n    {\r\n        $this->x = $x;\r\n    }\r\n}\r\n\r\n\r\n$di = new Zend\\Di\\DependencyInjector;\r\n$im = $di->getInstanceManager();\r\n\r\n\/\/ START change of the introspection rules\r\n$ir = $di->getDefinition()->getIntrospectionRuleset();\r\n$ir->addSetterRule('paramCanBeOptional', false);\r\n\/\/ END change of the introspection rules\r\n\r\n$im->setParameters('X', array('one' => 1, 'two' => 2));\r\n$y = $di->newInstance('Y');\r\nvar_dump($y);\r\n{code}\r\n\r\nThe question is, is this the correct default value for the introspection ruleset? Do we go stricter or less strict out of the box?  Basically, how do we handle situations like this?\r\n\r\n-ralph\r\n\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2011-08-25T17:28:59.000+0000",
                    "updated": "2011-08-25T17:30:35.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48665",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "After further work with Zend\\Di, and discussions with Evan on this issue, i've determined the issue isn't with Zend\\Di but with the way I was using it. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-10-11T00:04:49.000+0000",
                    "updated": "2011-10-11T00:04:49.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF2-46\/transitions"
}