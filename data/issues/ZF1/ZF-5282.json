{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5282",
    "key": "ZF-5282",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Calling _forward() from init() make the dispatcher dispatch the wrong controller"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/9",
                "name": "Docs:  Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5282\/votes",
                "votes": 5,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10380",
                    "id": 10380,
                    "description": "Mini Release",
                    "name": "1.9.5",
                    "userReleaseDate": "27\/Oct\/09",
                    "archived": false,
                    "releaseDate": "2009-10-27",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-10-15T13:33:59.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=doctorrock83",
                "name": "doctorrock83",
                "displayName": "julien PAULI",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-12-16T09:19:43.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-10-15T13:33:59.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When calling _forward(), the method just injects the arguments into the request, aka module, controller, action, and set the dispatch token to false.\r\n\r\nThe problem is when we call _forward() from an init() method of an action controller.\r\nIn that case, the dispatcher tries to load the action, but keeps the actual controller as to be dispatched instead of taking the one which could have been specified in _forward().\r\n\r\nThat special use case should be patched in the dispatch() method of the ZC_Action class.\r\n\r\n{code}\r\n\r\nclass MyController extends Zend_Controller_Action\r\n{\r\n    public function init()\r\n    {\r\n        $this->_forward('someaction', 'somecontroller');\r\n    }\r\n    \/\/ ...\r\n}\r\n{code}\r\n\r\nThat code will ask for the dispatching of MyController \/ someaction ; instead of someController \/ someaction"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5282\/watchers",
                "isWatching": false,
                "watchCount": 5
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "customfield_10000": {
            "name": "Language",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10011",
                    "id": 10011,
                    "name": "Zend_Controller",
                    "description": "front controller, including router and dispatcher",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29279",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=parsifal",
                        "name": "parsifal",
                        "displayName": "Sean",
                        "active": true
                    },
                    "body": "This *needs* to be addressed. We just ran into it and spent a lot of time trying to figure out why our _forward() wasn't being respected correctly.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=parsifal",
                        "name": "parsifal",
                        "displayName": "Sean",
                        "active": true
                    },
                    "created": "2009-03-04T14:32:43.000+0000",
                    "updated": "2009-03-04T14:32:43.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30168",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=phagger",
                        "name": "phagger",
                        "displayName": "Phillip Hagger",
                        "active": true
                    },
                    "body": "I have come across this same issue and believe I have found the problem.\n\nCalling _forward() sets the dispatched flag on the request to false. This is done at the time of controller instantiation in the dispatch method of he dispatcher. But before after that and before the controller action is dispatched the dispatcher sets the dispatched flag back to true. This is why foward works in init() in the same controller but not across controllers or modules. Here is the offending section of Zend\/Controller\/Dispatcher\/Standard.php with my comments added.\n\n{code}\n    \/\/controller instantiated here..._forward() will be called in init now.\n    $controller = new $className($request, $this->getResponse(), $this->getParams());\n\n        if (!$controller instanceof Zend_Controller_Action) {\n            require_once 'Zend\/Controller\/Dispatcher\/Exception.php';\n            throw new Zend_Controller_Dispatcher_Exception(\"Controller '$className' is not an instance of Zend_Controller_Action\");\n        }\n\n        \/**\n         * Retrieve the action name\n         *\/\n        $action = $this->getActionMethod($request);\n\n        \/**\n         * Dispatch the method call\n         *\/\n        \/\/dispatch flag reset to true here after having been set to false by _forward() call\n        $request->setDispatched(true);\n\n        \/\/ by default, buffer output\n        $disableOb = $this->getParam('disableOutputBuffering');\n        $obLevel   = ob_get_level();\n        if (empty($disableOb)) {\n            ob_start();\n        }\n\n        try {\n            $controller->dispatch($action);\n        } catch (Exception $e) { ...\n{code}\n\nI commented out the setDispatched() call for a quick trial and it solved the problem but of course this is not the solution. Could the call to setDispatched() be moved so that it happens before controller instantiation? I don't see any problems that it could cause but I'm not expert on the dispatch loop. I'm going to move it for the time being in my projects and report back if anything fails. \n\nIn addition it seems to me that a call to _forward in init() should stop the processing of the current action and move to the new action. Again this works in the same controller because the action is determined after the request has been modified by _forward(). But a forward to a different controller fails because we are already in the controller called in the original request. The rest of the current dispatcher dispatch() call should be ignored so that the front controller dispatch loop can run again and pick up the new controller and module. Were forwards not meant to happen from init()?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=phagger",
                        "name": "phagger",
                        "displayName": "Phillip Hagger",
                        "active": true
                    },
                    "created": "2009-04-15T19:11:33.000+0000",
                    "updated": "2009-04-15T19:11:33.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35243",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "init() was originally intended for extending the constructor, since the constructor has a verbose signature. This would include instantiating appropriate models, setting object state from front controller\/bootstrap parameters and\/or a registry, etc. The idea is that you would initialize resources that the controller would consume here -- but not do any actual decisioning or application logic.\r\n\r\npreDispatch() and postDispatch() are to be used for altering or enhancing behavior of the dispatched action. The idea was that if you determined the action could not be executed in preDispatch(), then you could _forward() to another action.\r\n\r\nI see no real benefit to adding a dispatched check between init() and preDispatch() as this basically duplicates logic, and violates the original intentions of the two methods.\r\n\r\nI think this is primarily an educational issue, and I'll add a note to the manual detailing correct usage of _forward() in these circumstances.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-10-15T13:19:29.000+0000",
                    "updated": "2009-10-15T13:19:29.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35245",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Changed issue type to \"docs improvement\"",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-10-15T13:33:15.000+0000",
                    "updated": "2009-10-15T13:33:15.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35246",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Section added to action controller chapter of manual detailing usage of init() vs. preDispatch(), specifically mentioning difference in how _forward() will act.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-10-15T13:33:59.000+0000",
                    "updated": "2009-10-15T13:33:59.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5282\/transitions"
}