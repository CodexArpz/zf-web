{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5524",
    "key": "ZF-5524",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Http_Client_Adapter_Proxy doesn't support SSL Client Certificate"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5524\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10412",
                    "id": 10412,
                    "description": "Mini Release",
                    "name": "1.10.1",
                    "userReleaseDate": "10\/Feb\/10",
                    "archived": false,
                    "releaseDate": "2010-02-10",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-06-19T13:20:48.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=crapougnax",
                "name": "crapougnax",
                "displayName": "Olivier L\u00e9pine",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-01-12T01:32:56.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-06-19T13:20:48.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "certificate",
                "client",
                "http",
                "proxy",
                "ssl"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Although Zend_Http_Client_Adapter_Socket fully support SSL Client certificate authentication, Zend_Http_Client_Adapter_Proxy doesn't.\n\nin the write() method of Zend_Http_Client_Adapter_Proxy, there is a call to method connectHandshake() if protocol is HTTPS. \n\nThis method tries to send a CONNECT query to the proxy server and then, if ok, switch to crypto with PHP function stream_socket_enable_crypto(). \n\nThis fails if the remote server requires a SSL client certificate to be presented. \n\nThe  stream_socket_enable_crypto() function is not well documented but it seems that an additional parameter allows to pass the context of another socket (including a local cert) to the function.\n\nIn the connecHandshake() method, I changed the code here:\n\n        $success = false; \n        foreach($modes as $mode) {\n            $success = stream_socket_enable_crypto($this->socket, true, $mode);\n        \tif ($success) break;\n        }\n\nto:\n\n        $context = stream_context_create();\n        if (! stream_context_set_option($context, 'ssl', 'local_cert', 'path\/to\/my\/local_cert')) {\n        \tdie ('unable to set SSL cert');\n        }\n            \n        $socket = stream_socket_client($host . ':' . $port, $errno,$errstr, (int) $this->config['timeout'], STREAM_CLIENT_CONNECT, $context);\n                                                  \n        if ($socket === false) {\n        \tdie('Unable to set socket');\n        }\n        \n        $success = false; \n        foreach($modes as $mode) {\n            $success = stream_socket_enable_crypto($this->socket, true, $mode, $socket);\n        \tif ($success) break;\n        }\n\nCurrently, the apache child dies when processing this patched adapter (Apache 2.2.8 + PHP 5.2.8 on Ubuntu 8.04)\n\nIs it a valid method to achieve what I aim to? If positive, what is going wrong?\n\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5524\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                "name": "padraic",
                "displayName": "P\u00e1draic Brady",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-2946",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2946",
                    "type": {
                        "name": "Dependency",
                        "direction": "OUTBOUND",
                        "description": "depends on"
                    }
                },
                {
                    "issueKey": "ZF-9143",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9143",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10015",
                    "id": 10015,
                    "name": "Zend_Http_Client",
                    "description": "performs HTTP requests",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32881",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "body": "Sorry for taking so long with this :)\n\nRecent improvements to HTTP client allowed me to implement this by reducing most of the code in the connect() method, and simply relying on preset stream context for this task. \n\nThis should now not be any different than using the Socket adapter with an SSL certificate - you can also look at the setStreamContext and getStreamContext methods for this, if you need \"advanced\" stuff like peer certificate validation forcing.\n\nFixed in CS-17013",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "created": "2009-07-23T15:44:01.000+0000",
                    "updated": "2009-07-23T15:46:46.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33940",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "body": "This change breaks backwards compatibility. \n\nhttp:\/\/framework.zend.com\/code\/browse\/Zend_Framework\/standard\/trunk\/library\/Zend\/Http\/Client\/Adapter\/Proxy.php?r1=17010&r2=17013\n\n>\t146\t \t-\t        if ($this->connected_to[0] != $host || $this->connected_to[1] != $port) {\n \t \t126\t+\t        if ($this->connected_to[0] != \"tcp:\/\/$host\" || $this->connected_to[1] != $port) {\n\nAt least in our environment there is no tcp:\/\/ prefix there as it is not required as far as I understand. \n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "created": "2009-08-26T04:48:33.000+0000",
                    "updated": "2009-08-26T04:48:33.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33941",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "body": "Changing the line to:\n\nif (($this->connected_to[0] != \"tcp:\/\/$host\" && $this->connected_to[0] != $host) || $this->connected_to[1] != $port) {\n\nSeems to fix this in our environment.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "created": "2009-08-26T04:56:34.000+0000",
                    "updated": "2009-08-26T04:56:34.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33942",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "body": "Reopening following previous comment",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "created": "2009-08-26T05:37:34.000+0000",
                    "updated": "2009-08-26T05:37:34.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33944",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "body": "To actually fix the functionality:\n\nhttp:\/\/pastebin.com\/m604f9746",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "created": "2009-08-26T06:15:15.000+0000",
                    "updated": "2009-08-26T06:15:15.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36136",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "body": "I commented that this bug breaks backwards compatibility and it's still present in 1.9.5",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "created": "2009-11-19T02:05:12.000+0000",
                    "updated": "2009-11-19T02:05:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36202",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "body": "Mikko,\r\n\r\nCan you repost the fix you added on pastebin? The paste ID is no longer valid. I'll commit tomorrow once I have a fix I can run tests against.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "created": "2009-11-19T12:37:00.000+0000",
                    "updated": "2009-11-19T12:37:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36208",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "body": "The following code can be used to test the issue:\r\n\r\n{code}\r\n$client = new Zend_Http_Client('https:\/\/test.example.com', array('sslcert' => '\/etc\/pki\/test.pem',\r\n                                                                 'proxy_host' => '127.0.0.1',\r\n\t\t\t\t\t\t                 'proxy_port' => '8888',\r\n\t\t\t\t\t\t\t         'adapter' => 'Zend_Http_Client_Adapter_Proxy'));\r\n\r\nvar_dump($client->request());\r\n{code}\r\n\r\nThe whole issue explained briefly:\r\n\r\nZend_Http_Client_Adapter_Proxy calls the parent::connect method setting $secure = false. This means that ssl context is not created for the connection. This is problematic in a scenario where the connection to proxy is over plain but SSL stream using client certs is negotiated inside that connection.\r\n\r\nThe proposed fix:\r\n\r\n{code}\r\n### Eclipse Workspace Patch 1.0\r\n#P zf-trunk\r\nIndex: src\/Zend\/Http\/Client\/Adapter\/Socket.php\r\n===================================================================\r\n--- src\/Zend\/Http\/Client\/Adapter\/Socket.php\t(revision 18996)\r\n+++ src\/Zend\/Http\/Client\/Adapter\/Socket.php\t(working copy)\r\n@@ -62,10 +62,11 @@\r\n      * @var array\r\n      *\/\r\n     protected $config = array(\r\n-        'persistent'    => false,\r\n-        'ssltransport'  => 'ssl',\r\n-        'sslcert'       => null,\r\n-        'sslpassphrase' => null\r\n+        'persistent'      => false,\r\n+        'ssltransport'    => 'ssl',\r\n+        'sslcert'         => null,\r\n+        'sslpassphrase'   => null,\r\n+        'sslusecontext' => false\r\n     );\r\n \r\n     \/**\r\n@@ -176,11 +177,11 @@\r\n         if (($this->connected_to[0] != $host || $this->connected_to[1] != $port)) {\r\n             if (is_resource($this->socket)) $this->close();\r\n         }\r\n-\r\n+ \r\n         \/\/ Now, if we are not connected, connect\r\n         if (! is_resource($this->socket) || ! $this->config['keepalive']) {\r\n             $context = $this->getStreamContext();\r\n-            if ($secure) {\r\n+            if ($secure || $this->config['sslusecontext']) {\r\n                 if ($this->config['sslcert'] !== null) {\r\n                     if (! stream_context_set_option($context, 'ssl', 'local_cert',\r\n                                                     $this->config['sslcert'])) {\r\nIndex: src\/Zend\/Http\/Client\/Adapter\/Proxy.php\r\n===================================================================\r\n--- src\/Zend\/Http\/Client\/Adapter\/Proxy.php\t(revision 18996)\r\n+++ src\/Zend\/Http\/Client\/Adapter\/Proxy.php\t(working copy)\r\n@@ -91,6 +91,11 @@\r\n         if (! $this->config['proxy_host']) {\r\n             return parent::connect($host, $port, $secure);\r\n         }\r\n+        \r\n+        \/* Url might require stream context even if proxy connection doesn't *\/\r\n+        if ($secure) {\r\n+        \t$this->config['sslusecontext'] = true;\r\n+        }\r\n \r\n         \/\/ Connect (a non-secure connection) to the proxy server\r\n         return parent::connect(\r\n{code}\r\n\r\nThe issue can be tested using CA setup mentioned here (http:\/\/sial.org\/howto\/openssl\/ca\/) and setting up for example apache to require the client certificate to be present. Note that this seems to only affect proxy adapter.\r\n\r\n\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mkoppanen",
                        "name": "mkoppanen",
                        "displayName": "Mikko Koppanen",
                        "active": true
                    },
                    "created": "2009-11-19T13:09:59.000+0000",
                    "updated": "2009-11-19T13:09:59.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/38302",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "body": "Fixed in r20946",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "created": "2010-02-06T09:06:58.000+0000",
                    "updated": "2010-02-06T09:06:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40991",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quipo",
                        "name": "quipo",
                        "displayName": "Lorenzo Alberton",
                        "active": true
                    },
                    "body": "This issue is not completely fixed in 1.10.5: the\r\n\r\n'sslusecontext' => false\r\n\r\nentry is missing from the\r\n\r\nprotected $config = array()\r\n\r\ncausing a NOTICE (Undefined index sslusecontext) on line 92:\r\n\r\nif ($secure || $this->config['sslusecontext']) { ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quipo",
                        "name": "quipo",
                        "displayName": "Lorenzo Alberton",
                        "active": true
                    },
                    "created": "2010-06-14T08:33:00.000+0000",
                    "updated": "2010-06-14T08:33:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41006",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bate",
                        "name": "bate",
                        "displayName": "Marco Kaiser",
                        "active": true
                    },
                    "body": "next release should address this issue. There was one line missing in the merge",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bate",
                        "name": "bate",
                        "displayName": "Marco Kaiser",
                        "active": true
                    },
                    "created": "2010-06-16T02:06:14.000+0000",
                    "updated": "2010-06-16T02:06:14.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41111",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "body": "Reopen due to misapplied patch",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "created": "2010-06-19T13:12:42.000+0000",
                    "updated": "2010-06-19T13:12:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41112",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "body": "Missing lines previously committed to release branch by bate.\r\n\r\nNote: If an issue is technically not fixed, it is fine to reopen it until properly resolved. Thanks for reporting the missing line!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=padraic",
                        "name": "padraic",
                        "displayName": "P\u00e1draic Brady",
                        "active": true
                    },
                    "created": "2010-06-19T13:20:48.000+0000",
                    "updated": "2010-06-19T13:20:48.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5524\/transitions"
}