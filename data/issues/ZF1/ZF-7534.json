{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7534",
    "key": "ZF-7534",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "The Reveive method on Zend_Queue Adapters creates multiple consumers when running in a polling mode "
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7534\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/3",
                "name": "Duplicate"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10520",
                    "id": 10520,
                    "description": "Mini Release",
                    "name": "1.11.2",
                    "userReleaseDate": "30\/Dec\/10",
                    "archived": false,
                    "releaseDate": "2010-12-30",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-12-18T00:28:13.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                "name": "kkarank",
                "displayName": "Dheeraj Saxena",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-08-07T21:34:04.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-12-18T00:28:18.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Client",
                "Framework",
                "Stomp",
                "Zend",
                "Zend_Queue"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I am trying to setup a listener for messages send to an ActiveMq Broker from Zend_Queue. My client code in the listener class looks like this\n\n{code}\nwhile (1)\n      {\n                          \n                  if ($messages=$this->queue->receive(1))\n                  {\n                        foreach ($messages as $message)\n                        {\n                              if (($msg=$message->body) != null)\n                              {\n                                    \/\/do my processing and then delete the message from queue\n                                    $this->queue->deleteMessage($message);\n                              }\n                        }\n                  }\n                        \n      }\n{code}\n\nThe problem is with the following code in the ZF Supplied ActiveMQ Adapter (happens around lines 208)\n\n{code}\n   \/\/ signal that we are reading\n        if ($this->isConnected == 0)\n        {\n        $frame = $this->_client->createFrame();\n        $frame->setCommand('SUBSCRIBE');\n        $frame->setHeader('destination', $queue->getName());\n        $frame->setHeader('ack','client');\n        $this->_client->send($frame);\n        $this->isConnected = 1;\n        }\n{code}\n\nWhen running in a listening mode , this code creates multiple consumers for every call to receive even though there are no messages on the queue. A better way would have been to strip this code from receive into a seperate method (something like checkmessage or getMessageCount..) and call that before calling receive? Also, it would be nice to have a generic listener in the framework itself that just needs the name of a queue\/topic and possibly a polling interval and which can invoke predefined code when it receives a message. Thats how most adapters in EAI systems work.\n\nAgain, for now I have written my own adapter that works around this. The documentation on this functionality is sparse so raising an Issue just in case I might have missed something."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7534\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=necrogami",
                "name": "necrogami",
                "displayName": "Anton C. Swartz IV",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12134",
                    "filename": "Activemq-ZF7534.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "created": "2009-08-08T20:03:36.000+0000",
                    "size": 1202,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12134\/Activemq-ZF7534.php"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10320",
                    "id": 10320,
                    "description": "Minor Release",
                    "name": "1.9.0",
                    "userReleaseDate": "31\/Jul\/09",
                    "archived": false,
                    "releaseDate": "2009-07-31",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10421",
                    "id": 10421,
                    "name": "Zend_Queue",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33324",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "If you have already solved this issue, please submit a patch :)\n\nI will check into this.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T12:55:46.000+0000",
                    "updated": "2009-08-08T12:55:46.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33325",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "I checked around, but there is no method to obtain the number of messages in the queue.  If you know of such a method for ActiveMQ please let me know.\n\nSources:\n\n* http:\/\/stomp.codehaus.org\/Protocol\n* http:\/\/activemq.apache.org\/stomp.html\n\nContinuing to look into this...",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T13:07:02.000+0000",
                    "updated": "2009-08-08T13:07:02.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33329",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "body": "The proposed fix will stop the adapter from creating multiple consumers. Instead of hardcoding the value of isConnected, keeping it configurable will give a user the option to have a set number of consumers depending upon expected load and application specificity.\n\n\/Dheeraj",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "created": "2009-08-08T20:03:37.000+0000",
                    "updated": "2009-08-08T20:03:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33330",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "body": "Daniel,\n\n\nA simple way would be to check that there is a valid MESSAGE frame on a target queue before receive (in its current incarnation) is called. I believe this can be easily done in the _canRead() method?( i may be wrong but the brief look I had at its code seemed to suggest that as the ideal place for such logic)\n\nUsing this and my proposed fix would  a) make the adapter create a subscriber on demand  and b) let the user control the number of  required consumers based on his application needs (my current application suffices 1 consumer as i use the queue to process sparse email sending for comments placed on my message board. In another application though I have over 100 messages per sec flowing into the broker so I would like to have more consumers)\n\nThis would be a great load balancing act .\n\nDheeraj",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "created": "2009-08-08T20:13:48.000+0000",
                    "updated": "2009-08-08T20:13:48.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33489",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "We are currently waiting for Matthew O'Phinney to get back from vacation to comment on this issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-16T09:10:17.000+0000",
                    "updated": "2009-08-16T09:10:17.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34062",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ndrtek_rob",
                        "name": "ndrtek_rob",
                        "displayName": "Rob Olmos",
                        "active": true
                    },
                    "body": "The only method I have found to get the number of pending messages (along with other items) is:\n\n#Activate the ActiveMQ.Agent topic (and JMX)\n#Send a \"query -QQueue=<queue name>\" message\n##*Required*: Set a reply-to header with a queue or topic\n#Parse the number from the response\n\nYou might be able to return only the line or number of messages with more options to the command but I haven't tried.\n\nhttp:\/\/activemq.apache.org\/activemq-command-line-tools-reference.html\nhttp:\/\/activemq.apache.org\/command-agent.html",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ndrtek_rob",
                        "name": "ndrtek_rob",
                        "displayName": "Rob Olmos",
                        "active": true
                    },
                    "created": "2009-08-28T23:32:05.000+0000",
                    "updated": "2009-08-28T23:32:05.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43690",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=necrogami",
                        "name": "necrogami",
                        "displayName": "Anton C. Swartz IV",
                        "active": true
                    },
                    "body": "I fixed this issue in ZF-7948",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=necrogami",
                        "name": "necrogami",
                        "displayName": "Anton C. Swartz IV",
                        "active": true
                    },
                    "created": "2010-12-18T00:28:14.000+0000",
                    "updated": "2010-12-18T00:28:14.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7534\/transitions"
}