{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10879",
    "key": "ZF-10879",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Acl stoped working in 1.11.1"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10879\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2011-06-14T01:22:44.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vincentbluff",
                "name": "vincentbluff",
                "displayName": "Shaun Freeman",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-12-28T17:38:46.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-06-14T01:22:44.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "After upgrading from 1.11.0 to 1.11.1 Acl just does not work anymore in my code.\r\nI use a model based Acl system.\r\nIf I use the Acl.php file from 1.11.0 in zf 1.11.1 then it works. I can't see what's wrong looking at the difference bewteen the two files. But what ever was changed in zf 1.11.1 Acl.php broke my code.\r\n\r\nThis is a critical element for me. If you need examples of my code it can be seen here:\r\nhttp:\/\/bazaar.launchpad.net\/~shaun-shaunfreeman\/uthando-cms\/trunk\/files"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10879\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                "name": "adamlundrigan",
                "displayName": "Adam Lundrigan",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-9643",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9643",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-10649",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10649",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/13930",
                    "filename": "ZF-10879_reproduce.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-04-29T14:06:40.000+0000",
                    "size": 1874,
                    "mimeType": "text\/x-patch",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/13930\/ZF-10879_reproduce.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10501",
                    "id": 10501,
                    "description": "Mini Release",
                    "name": "1.11.1",
                    "userReleaseDate": "30\/Nov\/10",
                    "archived": false,
                    "releaseDate": "2010-11-30",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10070",
                    "id": 10070,
                    "name": "Zend_Acl",
                    "description": "Access control list authorization component",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43836",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "body": "Saying \"it just does not work anymore\" is not helpful.  We cannot review your entire codebase to review how you are using the Acl component.\r\n\r\nPlease provide, at minimum, exactly what error message or unexpected behavior you are experiencing as well as a simple code sample (think: a dozen or two lines of code at most) to reproduce the problem.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "created": "2010-12-29T00:21:28.000+0000",
                    "updated": "2010-12-29T00:21:28.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43847",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vincentbluff",
                        "name": "vincentbluff",
                        "displayName": "Shaun Freeman",
                        "active": true
                    },
                    "body": "There are no error messages. The expected behaviour is that Acl should only allow users with the right roles to access their allow areas.\r\n\r\nA Guest can access the login and register actions but not admin and logout.\r\n\r\nAlso the menu should show links according to access rights.\r\n\r\nNow when a guest views the site he can see all menu links and access the admin area. When trying to view the login area nothing appears when before he could see the login form. It seems all access is denied and\/or not implemented.\r\n\r\nWhen I set it so anyone can view login and tying loging in then the session is cleared when Zend_Auth should be set in it.\r\n\r\nIf I now use the Acl.php from zf 1.11.0 in zf 1.11.1 then everything works as it should.\r\n\r\nThe problem seems that Acl doesn't get set any more in the setRule method of Acl.php but I don't know why.\r\n\r\nI am using a database to store the roles of the user which is queried when logging in and the the respective role is set.\r\n\r\nI am still leaning this framework so I will try to reproduce the error in a dozen or two lines.\r\n\r\nBut as my code is in two or three classes I am finding it difficult to condense for the error to occur.\r\n\r\nAcl is new to me and I am finding it difficult to understand so please be patience with me. All I now at the moment is it was working in zf 1.11.0 and now it is not in zf 1.11.1 and the problem lies somewhere in Acl.php or the changes that where made means I have to reimplement Acl differently.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vincentbluff",
                        "name": "vincentbluff",
                        "displayName": "Shaun Freeman",
                        "active": true
                    },
                    "created": "2010-12-29T15:47:19.000+0000",
                    "updated": "2010-12-29T15:47:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43850",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vincentbluff",
                        "name": "vincentbluff",
                        "displayName": "Shaun Freeman",
                        "active": true
                    },
                    "body": "I have worked out why it's not working.\r\n\r\nIn the zf 1.11.1 Acl.php in the setRule method all my resources get set into the $allResources array, but nothing is done with it! So all my resources do not get any any rules set to them.\r\n\r\nThis update has changed the way Acl works and breaks backward compatibility with zf 1.11.0, which in my opion shouldn't happen on a bug fix release.\r\n\r\nNow there is a comment on line 652 which says\r\n{quote}\r\n$allResources = array(); \/\/ this might be used later if resource iteration is required\r\n{quote}\r\n\r\nnow if I add this code at line 656:\r\n{code}\r\n$resources = (count($allResources) > 0) ? $allResources : null;\r\n{code}\r\nit works again!\r\n\r\nmy acl model looks like this:\r\n{code}\r\nclass Uthando_Model_Acl_Uthando extends Zend_Acl\r\n{\r\n    public function __construct()\r\n    {\r\n        $this->addRole(new Uthando_Model_Acl_Role_Guest)\r\n             ->addRole(new Uthando_Model_Acl_Role_Registered)\r\n             ->addRole(new Uthando_Model_Acl_Role_Manager, 'Registered')\r\n             ->addRole(new Uthando_Model_Acl_Role_Administrator, 'Manager')\r\n             ->addRole(new Uthando_Model_Acl_Role_SuperAdministrator, 'Administrator');\r\n\r\n        $this->deny();\r\n\r\n        $this->add(new Uthando_Model_Acl_Resource_Guest)\r\n             ->allow('Guest')\r\n             ->deny(array(\r\n                 'Registered',\r\n                 'Manager',\r\n                 'Administrator',\r\n                 'SuperAdministrator'\r\n                 ));\r\n        $this->add(new Uthando_Model_Acl_Resource_User)->allow('Registered');\r\n        $this->add(new Uthando_Model_Acl_Resource_Admin)->allow('Manager');\r\n    }\r\n}\r\n{code}\r\n\r\nI hope this is helpful\r\nIf you need more please let me know.\r\n\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vincentbluff",
                        "name": "vincentbluff",
                        "displayName": "Shaun Freeman",
                        "active": true
                    },
                    "created": "2010-12-30T03:20:38.000+0000",
                    "updated": "2010-12-30T03:20:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46202",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "Shaun, \r\n\r\nCould you take a look at the attached patch for Zend_Acl_AclTest and let me know if i've accurately reproduced the ACL usage you outlined in your last post? \r\n\r\nI added your suggested modification to Zend_Acl:\r\n{code}\r\nIndex: library\/Zend\/Acl.php\r\n===================================================================\r\n--- library\/Zend\/Acl.php (revision 23890)\r\n+++ library\/Zend\/Acl.php (working copy)\r\n@@ -654,6 +654,7 @@\r\n                 $allResources[] = $rTarget['instance'];\r\n             }\r\n             unset($rTarget);\r\n+            $resources = (count($allResources) > 0) ? $allResources : null;\r\n         }\r\n\r\n         \/\/ normalize privileges to array\r\n{code}\r\nand ran the test suite again with the attached test added, and the test still failed.\r\n\r\nI think I may have spotted the problem....let me know if i'm on the right track here:  When you run this code:\r\n{code}\r\n$this->add(new Uthando_Model_Acl_Resource_Guest)\r\n     ->allow('Guest')\r\n     ->deny(array(\r\n         'Registered',\r\n         'Manager',\r\n         'Administrator',\r\n         'SuperAdministrator'\r\n     ));\r\n{code}\r\nIt creates the resource Guest and, because add() returns an instance of Zend_Acl and you don't specify a resource on the chained allow() and deny() call, it globally allows Guest and denies everyone else. As Guest is the only resource available, that's fine.  However, the next line:\r\n{code}\r\n$this->add(new Uthando_Model_Acl_Resource_User)->allow('Registered');\r\n{code}\r\nCreates a new resource User and allows Registered access, which applies to both User and Guest resources because add() returns Zend_Acl and your chained allow() call doesn't specify a resource.  So, the allow('Registered') call affects both resources.  \r\n\r\nDoes that seem like an accurate synopsis of what's happening?\r\n\r\nIf it does, you can fix it by adding the resource name each allow()\/deny() call should apply to as the second argument to the allow()\/deny() call",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-04-29T14:06:40.000+0000",
                    "updated": "2011-04-29T14:08:21.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10879\/transitions"
}