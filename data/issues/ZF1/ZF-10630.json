{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10630",
    "key": "ZF-10630",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Queue::send() fails when using Zend_Queue_Db_Adapter with SQL Server"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10630\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nathanpbell",
                "name": "nathanpbell",
                "displayName": "Nathan Bell",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-11-02T19:57:24.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-11-08T12:13:16.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Zend_Queue_Adapter_Db relies on the database enforcing a unique restraint on the 'handle' column of the 'message' table.  In MySQL and some other RDBMS, a UNIQUE constraint is not enforced if the value is 'null' for that column and Zend_Queue_Adapter_Db relies on this behavior.\r\n\r\nHowever, other RDBMS (namely SQL Server) enforce uniqueness even if the value for that column is 'null' (i.e. you can only have one row who's value in a UNIQUE column is null).  This breaks the Zend_Queue functionality when using Zend_Db_Adapter_Sqlsrv.\r\n\r\nSpecifically all inserts (all calls to Zend_Queue->send()) fail on a UNIQUE key constraint once the queue has two or more records because the column \"handle\" is inserted with value 'null'.\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10630\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/10000",
                "name": "Postponed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10490",
                    "id": 10490,
                    "description": "Mini Release",
                    "name": "1.10.8",
                    "userReleaseDate": "25\/Aug\/10",
                    "archived": false,
                    "releaseDate": "2010-08-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10421",
                    "id": 10421,
                    "name": "Zend_Queue",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42849",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nathanpbell",
                        "name": "nathanpbell",
                        "displayName": "Nathan Bell",
                        "active": true
                    },
                    "body": "One possible fix is to remove the UNIQUE constraint on the 'handle' column of the 'message' table in all provided .sql definition files, and then change the deleteMessage() method in Zend_Queue_Adapter_Db:\r\n\r\npublic function deleteMessage(Zend_Queue_Message $message) {\r\n     $db = $this->_messageTable->getAdapter();\r\n\r\n-     $where = $db->quoteInto('handle=?', $message->handle);\r\n+     $where = array();\r\n+     $where[] = $db->quoteInto('message_id=?', $message->message_id);\r\n+     $where[] = $db->quoteInto('handle=?', $message->handle);\r\n\r\n      if ($this->_messageTable->delete($where)) { return true; }\r\n\r\n      return false;\r\n}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nathanpbell",
                        "name": "nathanpbell",
                        "displayName": "Nathan Bell",
                        "active": true
                    },
                    "created": "2010-11-05T16:35:35.000+0000",
                    "updated": "2010-11-05T16:35:35.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42896",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Doing this, however, breaks BC for those who have already deployed, as it would require altering the DB schema.\r\n\r\nPostponing to 2.0.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2010-11-08T12:02:06.000+0000",
                    "updated": "2010-11-08T12:02:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42898",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nathanpbell",
                        "name": "nathanpbell",
                        "displayName": "Nathan Bell",
                        "active": true
                    },
                    "body": "Actually the old schemas work as well.  I don't perceive any break to BC.  \r\n\r\nThe only conceptual difference between the provided SQL Server schema and the others is the UNIQUE constraint on 'handle'.  The constraint is present in all DB schemas except for SQL Servers.  But that constraint is redundant if you delete on 'message_id' and 'handle', which is what the suggested code change does.  Already deployed instances are unaffected and BC is preserved.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nathanpbell",
                        "name": "nathanpbell",
                        "displayName": "Nathan Bell",
                        "active": true
                    },
                    "created": "2010-11-08T12:12:10.000+0000",
                    "updated": "2010-11-08T12:13:16.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10630\/transitions"
}