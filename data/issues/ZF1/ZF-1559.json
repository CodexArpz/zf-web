{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1559",
    "key": "ZF-1559",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Pdf leaks memory"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1559\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10100",
                    "id": 10100,
                    "description": "Release Candidate 3",
                    "name": "1.0.0 RC3",
                    "userReleaseDate": "23\/Jun\/07",
                    "archived": true,
                    "releaseDate": "2007-06-23",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2007-06-22T10:25:20.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=antych",
                "name": "antych",
                "displayName": "Karol Grecki",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-06-13T11:20:05.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2007-07-05T14:44:19.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I've created fairly extensive reporting system based on Zend_Pdf. It generates reports in a loop.\nEach report has around 20 pages containing text, images and tables. \nThe problem is that I'm loosing about 1.5MB of memory on each iteration.\nLooks like a major memory leak to me.\n\nIt seams that even simple instantiation of Zend_Pdf or Zend_Pdf_Page looses memory.\nThe script below demonstrates this. Objects are not assigned to anything and shouldn't eat memory like that.\nFor comparison Zend_Pdf_Style shows proper behavior.\n\n{code}\nstart:4,076,700\nnew Zend_Pdf()\n4,087,384\n4,093,488\n4,099,544\n4,105,560\n4,111,596\nnew Zend_Pdf_Page()\n4,115,544\n4,121,936\n4,128,504\n4,135,072\n4,141,640\nnew Zend_Pdf_Style()\n4,141,872\n4,141,872\n4,141,872\n4,141,872\n4,141,872\n{code}\n\n\n{code}\nrequire_once 'Zend\/Pdf.php';\nrequire_once 'Zend\/Pdf\/Page.php';\nrequire_once 'Zend\/Pdf\/Style.php';\n\necho number_format(memory_get_usage()),PHP_EOL;\necho 'new Zend_Pdf()',PHP_EOL;\nforeach(range(1,5) as $i) {\n\tnew Zend_Pdf();\n\techo number_format(memory_get_usage()),PHP_EOL;\n}\necho 'new Zend_Pdf_Page()',PHP_EOL;\nforeach(range(1,5) as $i) {\n\tnew Zend_Pdf_Page('a4');\n\techo number_format(memory_get_usage()),PHP_EOL;\n}\necho 'new Zend_Pdf_Style()',PHP_EOL;\nforeach(range(1,5) as $i) {\n\tnew Zend_Pdf_Style('a4');\n\techo number_format(memory_get_usage()),PHP_EOL;\n}\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1559\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10090",
                    "id": 10090,
                    "description": "Release Candidate 2",
                    "name": "1.0.0 RC2",
                    "userReleaseDate": "08\/Jun\/07",
                    "archived": true,
                    "releaseDate": "2007-06-08",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10020",
                    "id": 10020,
                    "name": "Zend_Pdf",
                    "description": "pure PHP manipulation engine for composing PDFs",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15173",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "Assigning to Alexander.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-06-13T12:41:22.000+0000",
                    "updated": "2007-06-13T12:41:22.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15370",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "Fixed.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-06-21T09:26:24.000+0000",
                    "updated": "2007-06-21T09:26:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15372",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=antych",
                        "name": "antych",
                        "displayName": "Karol Grecki",
                        "active": true
                    },
                    "body": "Thanks Alexander for working on it.\nUnfortunately  I checked out code from trunk and I get lots of warnings, an error opening a pdf file and missing images.\n\nHere are the warnings:\nWarning: Invalid argument supplied for foreach() in \/home\/kgrecki\/Zend\/Pdf\/ElementFactory.php on line 274\nWarning: Invalid argument supplied for foreach() in \/home\/kgrecki\/Zend\/Pdf\/ElementFactory.php on line 226\nWarning: ksort() expects parameter 1 to be array, null given in \/home\/kgrecki\/Zend\/Pdf\/ElementFactory.php on line 386\nWarning: Invalid argument supplied for foreach() in \/home\/kgrecki\/Zend\/Pdf\/ElementFactory.php on line 389\nWarning: Invalid argument supplied for foreach() in \/home\/kgrecki\/Zend\/Pdf\/ElementFactory.php on line 402\n\nAcrobat complains: Could not find the XObject named 'X1'\n\nCheers",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=antych",
                        "name": "antych",
                        "displayName": "Karol Grecki",
                        "active": true
                    },
                    "created": "2007-06-21T10:15:58.000+0000",
                    "updated": "2007-06-21T10:15:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15373",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "one moment... I'll check it right now",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-06-21T10:44:01.000+0000",
                    "updated": "2007-06-21T10:44:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15374",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "I think the problem is concerned with sharing image object between documents or something like this.  Nevertheless such sharing should work correct.\n\nI can't reproduce problem right now. Could you give an example of your script and, if possible, your data? If yes, please send it to me (alexander.v@zend.com) or put somewhere for downloading or attach to the issue.\n ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-06-21T11:15:27.000+0000",
                    "updated": "2007-06-21T11:15:27.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15375",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=antych",
                        "name": "antych",
                        "displayName": "Karol Grecki",
                        "active": true
                    },
                    "body": "I managed to replicate it with this code.\nI have a decorator class, where I'm passing $pdf object and draw logo on every page.\nThis seams to be a problem, when I render it inside a function it works, but if I return it and call render() it gives warnings.\n\nHopes that help\n\n{code}\n$pdf = new Zend_Pdf();\n$pdf->pages[] = new Zend_Pdf_Page('a4');\n\n$pdf = decorate($pdf);\n$pdf->render();\n\nfunction decorate(Zend_Pdf $pdf) {\n\t$logo = new Zend_Pdf_Resource_Image_Png('..\/assets\/logo.png');\n\tforeach ($pdf->pages as $page) {\n\t\t$page->drawImage($logo, 30, 530, 30 + $logo->getPixelWidth()\/4.2, 530 + $logo->getPixelHeight()\/4.2);\t\n\t}\n\treturn $pdf;\n}\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=antych",
                        "name": "antych",
                        "displayName": "Karol Grecki",
                        "active": true
                    },
                    "created": "2007-06-21T11:33:44.000+0000",
                    "updated": "2007-06-21T11:33:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15376",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "Yes. That's clear, what is this. \n\n$logo variable goes out of scope and it destroys image data.\n\nYou can describe $logo as static as temporary solution:\n{code}\nfunction decorate(Zend_Pdf $pdf) {\n    $dirName = '\/home\/cawa\/ZendFramework\/laboratory\/Pdf';\n\n    static $logo;\n    if (!$logo instanceof Zend_Pdf_Resource_Image) {\n        $logo = Zend_Pdf_Image::imageWithPath($dirName . '\/stamp.png');\n    }\n\n\tforeach ($pdf->pages as $page) {\n\t\t$page->drawImage($logo, 30, 530, 30 + $logo->getPixelWidth()\/4.2, 530 + $logo->getPixelHeight()\/4.2);\n\t}\n\treturn $pdf;\n}\n{code}\n\nSo I am reopening issue while this problem is not fixed.\n\n\nPS New syntax Zend_Pdf_Image::imageWithPath(...) is preferable.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-06-21T12:06:12.000+0000",
                    "updated": "2007-06-21T12:06:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15400",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "Fixed.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-06-22T10:25:20.000+0000",
                    "updated": "2007-06-22T10:25:20.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1559\/transitions"
}