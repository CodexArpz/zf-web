{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11341",
    "key": "ZF-11341",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Form_Decorator_PrepareElements does not \"prepare\" subforms"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11341\/votes",
                "votes": 3,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                "name": "toxygene",
                "displayName": "Justin Hendrickson",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-05-03T22:49:45.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-07-05T11:56:07.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The conditional for handling subforms in Zend_Form_Decorator_PrepareElements currently requires the parent form to have an element belongs to value or it will not recurssively prepare the subform (and any subforms it may have). The typical use case for Zend_Form doesn't include setting an elements belongs to value, but without it subforms will not be prepared.\r\n\r\nThe problem is with this section of code:\r\n\r\n{code}\r\n} elseif (!empty($belongsTo) && ($item instanceof Zend_Form)) {\r\n    if ($item->isArray()) {\r\n        $name = $this->mergeBelongsTo($belongsTo, $item->getElementsBelongTo());\r\n        $item->setElementsBelongTo($name, true);\r\n    } else {\r\n        $item->setElementsBelongTo($belongsTo, true);\r\n    }\r\n    $this->_recursivelyPrepareForm($item);\r\n} elseif (!empty($belongsTo) && ($item instanceof Zend_Form_DisplayGroup)) {\r\n{code}\r\n\r\nThe !empty($belongsTo) conditional should only apply to setting the elements belong to value and not the recursivelyPrepareForm call.\r\n\r\nThe following fixes the issue:\r\n\r\n{code}\r\n} elseif ($item instanceof Zend_Form) {\r\n    if (!empty($belongsTo)) {\r\n        if ($item->isArray()) {\r\n            $name = $this->mergeBelongsTo($belongsTo, $item->getElementsBelongTo());\r\n            $item->setElementsBelongTo($name, true);\r\n        } else {\r\n            $item->setElementsBelongTo($belongsTo, true);\r\n        }\r\n    }\r\n    $this->_recursivelyPrepareForm($item);\r\n} elseif (!empty($belongsTo) && ($item instanceof Zend_Form_DisplayGroup)) {\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11341\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                "name": "alab",
                "displayName": "Christian Albrecht",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/13941",
                    "filename": "prepare-elements-test.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                        "name": "toxygene",
                        "displayName": "Justin Hendrickson",
                        "active": true
                    },
                    "created": "2011-05-04T00:54:57.000+0000",
                    "size": 798,
                    "mimeType": "text\/x-patch",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/13941\/prepare-elements-test.patch"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/13940",
                    "filename": "prepare-elements.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                        "name": "toxygene",
                        "displayName": "Justin Hendrickson",
                        "active": true
                    },
                    "created": "2011-05-04T00:21:00.000+0000",
                    "size": 1309,
                    "mimeType": "text\/x-patch",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/13940\/prepare-elements.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10550",
                    "id": 10550,
                    "description": "Mini Release",
                    "name": "1.11.5",
                    "userReleaseDate": "07\/Apr\/11",
                    "archived": false,
                    "releaseDate": "2011-04-07",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10029",
                    "id": 10029,
                    "name": "Zend_Form",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46371",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                        "name": "toxygene",
                        "displayName": "Justin Hendrickson",
                        "active": true
                    },
                    "body": "Patch for PrepareElements decorator.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                        "name": "toxygene",
                        "displayName": "Justin Hendrickson",
                        "active": true
                    },
                    "created": "2011-05-04T00:21:00.000+0000",
                    "updated": "2011-05-04T00:21:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46372",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                        "name": "toxygene",
                        "displayName": "Justin Hendrickson",
                        "active": true
                    },
                    "body": "Patch for the PrepareElements unit test to expose the bug and show the prepare-elements.patch fixes the bug.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=toxygene",
                        "name": "toxygene",
                        "displayName": "Justin Hendrickson",
                        "active": true
                    },
                    "created": "2011-05-04T00:54:57.000+0000",
                    "updated": "2011-05-04T00:54:57.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51263",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=tridem",
                        "name": "tridem",
                        "displayName": "Webdevilopers",
                        "active": true
                    },
                    "body": "Actually the prepareElements decorator can cause different issues depending on the way elements are used inside the viewScript.\r\nHere is a summary:\r\n\r\n{code}\r\n<?php\r\nclass Default_Form extends Zend_Form\r\n{\r\n    public function init()\r\n    {\r\n        $this->setDecorators(array(\r\n\t\t'PrepareElements',\r\n\t\tarray('ViewScript', array(\r\n            \t'viewScript' => 'form\/_form.phtml'\r\n\t\t\t)),\r\n        \t'Form'\r\n\t\t));\r\n\r\n        $this->addElement(\r\n\t\t\t'text',\r\n        \t'name',\r\n        \tarray()\r\n        );\r\n\r\n        $barForm = new Zend_Form(); \/\/ Extended in ZendX_JQuery_Form\r\n        #$barForm = new Zend_Form_SubForm();\r\n        $barForm\r\n        \t->setIsArray(true)\r\n    \t\t->setDecorators(array('FormElements'));\r\n    \t$barForm->addElement(\r\n\t\t\t'text',\r\n    \t\t'name',\r\n    \t\tarray()\r\n    \t);\r\n    \t$this->addSubForm($barForm, 'bar');\r\n\r\n    \t$fooForm = new Zend_Form_SubForm();\r\n    \t$fooForm\r\n    \t\t->setIsArray(true)\r\n    \t\t->setDecorators(array('FormElements'));\r\n    \t$fooForm->addElement(\r\n    \t\t'text',\r\n    \t\t'name',\r\n    \t\tarray()\r\n    \t);\r\n    \t$barForm->addSubForm($fooForm, 'foo');\r\n    }\r\n}\r\n{code}\r\n\r\nThe following viewScript returns the desired result:\r\n{code}\r\n<?=$this->element->name?>\r\n<?=$this->element->bar?>\r\n{code}\r\n\r\nCorrect markup:\r\n{code}\r\n<form enctype=\"application\/x-www-form-urlencoded\" action=\"\" method=\"post\">\r\n<dt id=\"name-label\">&#160;<\/dt>\r\n<dd id=\"name-element\">\r\n<input type=\"text\" name=\"name\" id=\"name\" value=\"\" \/><\/dd>\r\n<dt id=\"bar-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-name-element\">\r\n<input type=\"text\" name=\"bar[name]\" id=\"bar-name\" value=\"\" \/><\/dd>\r\n\r\n<dt id=\"bar-foo-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-foo-name-element\">\r\n<input type=\"text\" name=\"bar[foo][name]\" id=\"bar-foo-name\" value=\"\" \/><\/dd><\/form>\r\n\r\nThis viewScript is missing the array notation for the 'bar' subForm:\r\n<?=$this->element->name?>\r\n<?=$this->element->bar->name?>\r\n<?=$this->element->bar->foo?>\r\n{code}\r\n\r\nWrong markup:\r\n{code}\r\n<form enctype=\"application\/x-www-form-urlencoded\" action=\"\" method=\"post\">\r\n<dt id=\"name-label\">&#160;<\/dt>\r\n<dd id=\"name-element\">\r\n<input type=\"text\" name=\"name\" id=\"name\" value=\"\" \/><\/dd><dt id=\"name-label\">&#160;<\/dt>\r\n<dd id=\"name-element\">\r\n<input type=\"text\" name=\"name\" id=\"name\" value=\"\" \/><\/dd>\r\n<dt id=\"foo-name-label\">&#160;<\/dt>\r\n<dd id=\"foo-name-element\">\r\n<input type=\"text\" name=\"foo[name]\" id=\"foo-name\" value=\"\" \/><\/dd><\/form>\r\n{code}\r\n\r\nApplying the patch we get the correct array notation for the 'bar' subForm:\r\n{code}\r\n<form enctype=\"application\/x-www-form-urlencoded\" action=\"\" method=\"post\">\r\n<dt id=\"name-label\">&#160;<\/dt>\r\n<dd id=\"name-element\">\r\n<input type=\"text\" name=\"name\" id=\"name\" value=\"\" \/><\/dd><dt id=\"bar-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-name-element\">\r\n<input type=\"text\" name=\"bar[name]\" id=\"bar-name\" value=\"\" \/><\/dd>\r\n<dt id=\"bar-foo-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-foo-name-element\">\r\n<input type=\"text\" name=\"bar[foo][name]\" id=\"bar-foo-name\" value=\"\" \/><\/dd><\/form>\r\n{code}\r\n\r\nReturning to our first viewScript we get a wrong array notation for the 'foo' subForm (subForm of 'bar' subForm):\r\n{code}\r\n<form enctype=\"application\/x-www-form-urlencoded\" action=\"\" method=\"post\">\r\n<dt id=\"name-label\">&#160;<\/dt>\r\n<dd id=\"name-element\">\r\n<input type=\"text\" name=\"name\" id=\"name\" value=\"\" \/><\/dd>\r\n<dt id=\"bar-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-name-element\">\r\n<input type=\"text\" name=\"bar[name]\" id=\"bar-name\" value=\"\" \/><\/dd>\r\n\r\n<dt id=\"bar-bar-foo-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-bar-foo-name-element\">\r\n<input type=\"text\" name=\"bar[bar][foo][name]\" id=\"bar-bar-foo-name\" value=\"\" \/><\/dd><\/form>\r\n{code}\r\n\r\n\"Fortunately\" this issue is already known and there is a patch that can be found here:\r\nhttp:\/\/www.zfforums.com\/zend-framework-components-13\/model-view-controller-mvc-21\/nested-subforms-viewscript-decorators-6208.html#post19159\r\n\r\nComment out l.82: $this->_recursivelyPrepareForm($item);\r\n\r\nCombined with the original patch it created the correct markup:\r\n{code}\r\n<form enctype=\"application\/x-www-form-urlencoded\" action=\"\" method=\"post\">\r\n<dt id=\"name-label\">&#160;<\/dt>\r\n<dd id=\"name-element\">\r\n<input type=\"text\" name=\"name\" id=\"name\" value=\"\" \/><\/dd>\r\n<dt id=\"bar-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-name-element\">\r\n<input type=\"text\" name=\"bar[name]\" id=\"bar-name\" value=\"\" \/><\/dd>\r\n\r\n<dt id=\"bar-foo-name-label\">&#160;<\/dt>\r\n<dd id=\"bar-foo-name-element\">\r\n<input type=\"text\" name=\"bar[foo][name]\" id=\"bar-foo-name\" value=\"\" \/><\/dd><\/form>\r\n{code}\r\n\r\nThe complete method:\r\n{code}\r\n    protected function _recursivelyPrepareForm(Zend_Form $form)\r\n    {\r\n        $belongsTo      = ($form instanceof Zend_Form) ? $form->getElementsBelongTo() : null;\r\n        $elementContent = '';\r\n        $separator      = $this->getSeparator();\r\n        $translator     = $form->getTranslator();\r\n        $view           = $form->getView();\r\n\r\n        foreach ($form as $item) {\r\n            $item->setView($view)\r\n                 ->setTranslator($translator);\r\n            if ($item instanceof Zend_Form_Element) {\r\n                $item->setBelongsTo($belongsTo);\r\n\t\t\t} elseif ($item instanceof Zend_Form) {\r\n\t\t\t    if (!empty($belongsTo)) {\r\n\t\t\t        if ($item->isArray()) {\r\n\t\t\t            $name = $this->mergeBelongsTo($belongsTo, $item->getElementsBelongTo());\r\n\t\t\t            $item->setElementsBelongTo($name, true);\r\n\t\t\t        } else {\r\n\t\t\t            $item->setElementsBelongTo($belongsTo, true);\r\n\t\t\t        }\r\n\t\t\t    }\r\n\t\t\t    #$this->_recursivelyPrepareForm($item);\r\n\t\t\t} elseif (!empty($belongsTo) && ($item instanceof Zend_Form_DisplayGroup)) {\r\n\t\t\t\tforeach ($item as $element) {\r\n                    $element->setBelongsTo($belongsTo);\r\n                }\r\n            }\r\n        }\r\n    }\r\n{code}\r\n\r\nRelated issue:\r\nhttp:\/\/framework.zend.com\/issues\/browse\/ZF-4812",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=tridem",
                        "name": "tridem",
                        "displayName": "Webdevilopers",
                        "active": true
                    },
                    "created": "2012-07-05T11:56:07.000+0000",
                    "updated": "2012-07-05T11:56:07.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11341\/transitions"
}