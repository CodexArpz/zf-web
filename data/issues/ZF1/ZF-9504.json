{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9504",
    "key": "ZF-9504",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_XmlRpc_Generator: memory leak"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9504\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10451",
                    "id": 10451,
                    "description": "Mini Release",
                    "name": "1.10.4",
                    "userReleaseDate": "28\/Apr\/10",
                    "archived": false,
                    "releaseDate": "2010-04-28",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-04-27T11:13:48.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wojewsky",
                "name": "wojewsky",
                "displayName": "Sascha Wojewsky",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-03-22T04:06:47.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-04-27T11:13:50.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "With Zend Framework 1.9.5 we've any problems with our xmlrpc-server.\r\nNow (with 1.10.2) we've got this error:\r\nPHP Fatal error:  Allowed memory size of 134217728 bytes exhausted (tried to allocate 220715 bytes) in \/usr\/local\/zend\/share\/ZendFramework\/library\/Zend\/XmlRpc\/Generator\/GeneratorAbstract.php on line 127\r\n\r\nI've tried both:\r\n- Zend_XmlRpc_Value::setGenerator(new Zend_XmlRpc_Generator_XmlWriter());\r\n- Zend_XmlRpc_Value::setGenerator(new Zend_XmlRpc_Generator_DomDocument());\r\n\r\nBest Regards\r\nSascha Wojewsky"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9504\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-8457",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8457",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/13036",
                    "filename": "trace.xt.bz2",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hobodave",
                        "name": "hobodave",
                        "displayName": "David Abdemoulaie",
                        "active": true
                    },
                    "created": "2010-04-26T18:48:31.000+0000",
                    "size": 1246976,
                    "mimeType": "application\/x-bzip2",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/13036\/trace.xt.bz2"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10360",
                    "id": 10360,
                    "description": "Minor Release",
                    "name": "1.10.0",
                    "userReleaseDate": "27\/Jan\/10",
                    "archived": false,
                    "releaseDate": "2010-01-27",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10412",
                    "id": 10412,
                    "description": "Mini Release",
                    "name": "1.10.1",
                    "userReleaseDate": "10\/Feb\/10",
                    "archived": false,
                    "releaseDate": "2010-02-10",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10430",
                    "id": 10430,
                    "description": "Mini Release",
                    "name": "1.10.2",
                    "userReleaseDate": "24\/Feb\/10",
                    "archived": false,
                    "releaseDate": "2010-02-24",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10440",
                    "id": 10440,
                    "description": "Mini Release",
                    "name": "1.10.3",
                    "userReleaseDate": "01\/Apr\/10",
                    "archived": false,
                    "releaseDate": "2010-04-01",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10082",
                    "id": 10082,
                    "name": "Zend_XmlRpc_Server",
                    "description": "XMLRpc Server",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40239",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hobodave",
                        "name": "hobodave",
                        "displayName": "David Abdemoulaie",
                        "active": true
                    },
                    "body": "I have been able to duplicate this memory leak as well, please view the attached xdebug trace. (45M, 1.2M compressed).\r\n\r\nThings to note:\r\n\r\nThe return value from this xmlrpc call is an array in the following format:\r\n\r\n{noformat}\r\narray(\r\n    'values' => array(\r\n        0 => array(\r\n            'id' => 1,\r\n            'name' => 'Foobar',\r\n            'group_id' => 7,\r\n            'priority' => 0,\r\n        ),\r\n       \/\/ ...\r\n       740 => array(\/* ... *\/),\r\n    ),\r\n    'last_modified' => '2010-01-01 00:00:00',\r\n)\r\n{noformat}\r\n\r\nThe entire resultset is loaded into the PHP array format between lines 5577348 and 6837560. This increases script memory usage by 1.2M for a total of 6.6M.\r\n\r\nLine 63810 Zend_XmlRpc_Response->__toString(), invoked marking beginning of copying the PHP array into the corresponding Zend_XmlRpc_Value object graph - current usage 6.5M\r\n\r\nLine 86148 - Zend_XmlRpc_Value object graph construction completes - current usage 8.7M\r\n\r\nLine 86245 - Zend_XmlRpc_Generator_GeneratorAbstract->__toString() invoked, leak begins - current usage 9072432 bytes\r\n\r\nNow continue searching the document for invocations of Zend_XmlRpc_Generator_GeneratorAbstract->__toString():\r\n\r\nLine 86283 - Usage: 9072744 (312 byte increase)\r\nLine 86321 - Usage: 9073144 (400 byte increase)\r\nLine 86349 - Usage: 9073612 (468 byte increase)\r\n...\r\nLine 247124  - Usage: 726055636 \r\nLine 247162 - Usage: 726371428 (315792 byte increase)\r\nLine 247200 - Usage: 726687288 (315860 byte increase)\r\n\r\nThe memory usage continues to increase exponentially. You can view this easily by simply grepping for Zend_XmlRpc_Generator_GeneratorAbstract->stripDeclaration() and noting the increasing deltas in column 3. By the time the script crashes, each call to saveXml() is increasing the memory usage by over 300KB.\r\n\r\nThere is clearly something wrong here, though I haven't yet figured out yet.\r\n\r\nThe memory usage is increasing exponentially, but the rate of increase is linear. This leads me to believe it's a problem similar to:\r\n\r\n{noformat}\r\n<?php\r\n\r\n$o = new stdClass();\r\n$o->str = 'abc';\r\n\r\n$arr = array($o);\r\nfor ($i = 0; $i < 100; $i++) {\r\n    $o = clone $o; \r\n    $o->str .= 'abc';\r\n    $arr[] = $o; \r\n}\r\n{noformat}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hobodave",
                        "name": "hobodave",
                        "displayName": "David Abdemoulaie",
                        "active": true
                    },
                    "created": "2010-04-26T18:47:54.000+0000",
                    "updated": "2010-04-26T18:47:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40251",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hobodave",
                        "name": "hobodave",
                        "displayName": "David Abdemoulaie",
                        "active": true
                    },
                    "body": "I have confirmed my suspicions from the example above. Each Zend_XmlRpc_Value node has an $_xml property. During the _generateXml() methods the Generator is reused, thus a full copy of the DOM as xml is saved at each node. \r\n\r\ne.g.\r\n\r\nFirst Node\r\n{code:xml}\r\n<?xml version=\"1.0\"?>\r\n<methodResponse>\r\n  <params>\r\n    <param>\r\n      <value>\r\n        <struct>\r\n          <member>\r\n            <name>updates<\/name>\r\n            <value>\r\n              <array>\r\n                <data>\r\n                  <value>\r\n                    <struct>\r\n                      <member>\r\n                        <name>id<\/name>\r\n                        <value>\r\n                          <string>1<\/string>\r\n                        <\/value>\r\n                      <\/member>\r\n                    <\/struct>\r\n                  <\/value>\r\n                <\/data>\r\n              <\/array>\r\n            <\/value>\r\n          <\/member>\r\n        <\/struct>\r\n      <\/value>\r\n    <\/param>\r\n  <\/params>\r\n<\/methodResponse>\r\n{code}\r\n\r\nSecond Node\r\n{code:xml}\r\n<?xml version=\"1.0\"?>\r\n<methodResponse>\r\n  <params>\r\n    <param>\r\n      <value>\r\n        <struct>\r\n          <member>\r\n            <name>updates<\/name>\r\n            <value>\r\n              <array>\r\n                <data>\r\n                  <value>\r\n                    <struct>\r\n                      <member>\r\n                        <name>id<\/name>\r\n                        <value>\r\n                          <string>1<\/string>\r\n                        <\/value>\r\n                      <\/member>\r\n                      <member>\r\n                        <name>name<\/name>\r\n                        <value>\r\n                          <string>Relocate \/ Remove<\/string>\r\n                        <\/value>\r\n                      <\/member>\r\n                    <\/struct>\r\n                  <\/value>\r\n                <\/data>\r\n              <\/array>\r\n            <\/value>\r\n          <\/member>\r\n        <\/struct>\r\n      <\/value>\r\n    <\/param>\r\n  <\/params>\r\n<\/methodResponse>\r\n{code}\r\n\r\nThird Node\r\n{code:xml}\r\n<?xml version=\"1.0\"?>\r\n<methodResponse>\r\n  <params>\r\n    <param>\r\n      <value>\r\n        <struct>\r\n          <member>\r\n            <name>updates<\/name>\r\n            <value>\r\n              <array>\r\n                <data>\r\n                  <value>\r\n                    <struct>\r\n                      <member>\r\n                        <name>id<\/name>\r\n                        <value>\r\n                          <string>1<\/string>\r\n                        <\/value>\r\n                      <\/member>\r\n                      <member>\r\n                        <name>name<\/name>\r\n                        <value>\r\n                          <string>Relocate \/ Remove<\/string>\r\n                        <\/value>\r\n                      <\/member>\r\n                      <member>\r\n                        <name>description<\/name>\r\n                        <value>\r\n                          <string\/>\r\n                        <\/value>\r\n                      <\/member>\r\n                    <\/struct>\r\n                  <\/value>\r\n                <\/data>\r\n              <\/array>\r\n            <\/value>\r\n          <\/member>\r\n        <\/struct>\r\n      <\/value>\r\n    <\/param>\r\n  <\/params>\r\n<\/methodResponse>\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hobodave",
                        "name": "hobodave",
                        "displayName": "David Abdemoulaie",
                        "active": true
                    },
                    "created": "2010-04-27T10:09:20.000+0000",
                    "updated": "2010-04-27T10:09:20.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40252",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Patch created by hobodave, and applied by matthew in trunk and 1.10 release branch; saw improvements of 1GB memory usage -> 8.8MB after patch, and > 300% decrease in time needed to execute.\r\n\r\nWill release with 1.10.4.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2010-04-27T11:13:48.000+0000",
                    "updated": "2010-04-27T11:13:48.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9504\/transitions"
}