{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6047",
    "key": "ZF-6047",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "'Unable to create SHM segments for process communications' in long running script"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6047\/votes",
                "votes": 3,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-11-20T20:53:20.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                "name": "adamcharnock",
                "displayName": "Adam Charnock",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-03-17T04:47:23.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T20:53:20.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "*Background:*\nZendX_Console_Process_Unix is being used to dispatch tasks from within a long running parent script. The parent script dispatches tasks based on new records in a database.\n\n*Problem:*\nThe this bug seems to happen when either:\n\n1) The script has been running for a while (30mins to a few hours)\n2) The script has been stopped and started a few times (as well as having been run for a while)\n\nOnce the problem occurs, it will keep occurring until the server is restarted.\n\nThe output is as follows:\n\n{noformat} \nPHP Warning:  shmop_open(): unable to attach or create shared memory segment in \/www\/libs\/ZendFramework-1.7.6\/extras\/library\/ZendX\/Console\/Process\/Unix.php on line 501\n\nWarning: shmop_open(): unable to attach or create shared memory segment in \/www\/libs\/ZendFramework-1.7.6\/extras\/library\/ZendX\/Console\/Process\/Unix.php on line 501\nPHP Fatal error:  Uncaught exception 'ZendX_Console_Process_Exception' with message 'Unable to create SHM segments for process communications' in \/www\/libs\/ZendFramework-1.7.6\/extras\/library\/ZendX\/Console\/Process\/Unix.php:191\nStack trace:\n#0 \/www\/omniwiki\/sitesmoke\/library\/Ss\/Dispatcher.php(83): ZendX_Console_Process_Unix->start()\n#1 \/www\/omniwiki\/sitesmoke\/library\/Ss\/Dispatcher.php(58): Ss_Dispatcher->dispatchSiteMonitor(Array)\n#2 \/www\/omniwiki\/sitesmoke\/application\/monitor\/scripts\/run.php(35): Ss_Dispatcher->dispatch()\n#3 {main}\n  thrown in \/www\/libs\/ZendFramework-1.7.6\/extras\/library\/ZendX\/Console\/Process\/Unix.php on line 191\n{noformat}\n\n*Workaround:*\nI don't have a real work around for this apart from:\n\n1) Restart the server\n2) Use exec() (or similar) rather than ZendX_Console_Process_Unix\n\n*Other notes:*\n\nI am not sure, but this bug sounds like it may relate to bug ZF-5575\n\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6047\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-5575",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5575",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-7775",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7775",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11810",
                    "filename": "test.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2009-03-18T12:57:38.000+0000",
                    "size": 695,
                    "mimeType": "application\/x-httpd-php",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11810\/test.php"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10290",
                    "id": 10290,
                    "description": "Mini Release",
                    "name": "1.7.6",
                    "userReleaseDate": "02\/Mar\/09",
                    "archived": false,
                    "releaseDate": "2009-03-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10374",
                    "id": 10374,
                    "name": "ZendX_Console_Process_Unix",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29520",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "body": "That bug somewhat sounds to me like that comment on the php.net manual:\nhttp:\/\/de2.php.net\/manual\/en\/function.shmop-open.php#35361\n\nBut ftok should never return zero, and failures (-1) is always checked. Do you have any other information about that problem?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "created": "2009-03-17T06:28:28.000+0000",
                    "updated": "2009-03-17T06:28:28.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29533",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "I think a code-block that can reproduce this error would be really helpful. \nI have created a long running script in the past which did not use shared memory at all, yet required a restart of the machine to free memory purely because I had not unset vars as it went along.\nSo it is quite possible that there could be other factors involved in this.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2009-03-18T02:25:54.000+0000",
                    "updated": "2009-03-18T02:25:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29542",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                        "name": "adamcharnock",
                        "displayName": "Adam Charnock",
                        "active": true
                    },
                    "body": "Ok, I am going to set the script running on an EC2 instance and just leave it there until it (potentially) dies.\n\nHowever, I have put in place a change that I suspect\/hope will address this...\n\nIn some cases an exception could be thrown within the _run() method. These exceptions were not being caught, so I chance the _run() method to be as follows:\n\n{noformat}\nprotected function _run() {\n\t\ttry {\n\t\t\t$responses = $this->runMonitor(); \/\/it is runMonitor() that may throw exceptions\n\t\t} catch(Exception $e) {\n\t\t\t$this->stop(); \/\/force memory to be cleaned up\n\t\t\tthrow $e;\n\t\t}\n\t\t$this->save($responses);\n\t}\n{noformat}\n\nIf an exception is thrown I call stop(). This in turn calls _cleanProcessContext(), which cleans up the various memory segments (so we don't end up collecting unused shared memory, ultimately causing the errors seen in the initial bug report).\n\nIf this does end up helping, a solution could be for ZendX_Console_Process_Unix to wrap the call to _run() in a try\/catch blog as shown above.\n\nI'll let you know how it gets on.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                        "name": "adamcharnock",
                        "displayName": "Adam Charnock",
                        "active": true
                    },
                    "created": "2009-03-18T07:14:08.000+0000",
                    "updated": "2009-03-18T07:14:08.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29550",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "I have attached a test which should reproduce this behaviour.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2009-03-18T12:57:44.000+0000",
                    "updated": "2009-03-18T12:57:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29555",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=letssurf",
                        "name": "letssurf",
                        "displayName": "James Dempster",
                        "active": true
                    },
                    "body": "The problem is caused because the shared memory segments are never deleted. They end up filling the servers memory up. Which you see solved by restarting the server.\n\nTo see the shared memory blocks run.\nuser@server:~$ ipcs -m\n\nYou can remove the old memory segments by doing run this, replacing owner with the owner of the shared memory block.\nuser@server:~$ ipcs -m | awk '$3 == \"<owner>\" {print $2}' | while read i; do ipcrm -m $i; done\n\nTo fix the problem it's possible to to use shmop_delete after both processes have successfully connected to the shared memory segment. The shared memory stays active until both processes disconnect, then the memory segment is deleted.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=letssurf",
                        "name": "letssurf",
                        "displayName": "James Dempster",
                        "active": true
                    },
                    "created": "2009-03-18T14:26:05.000+0000",
                    "updated": "2009-03-18T14:26:05.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29556",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=letssurf",
                        "name": "letssurf",
                        "displayName": "James Dempster",
                        "active": true
                    },
                    "body": "P.S\n\nI have a heavily modified version of this class which solves the memory problems plus some others regarding child processes that fail (e.g atm if a child process was to fatal you never know about it due to problems with the way it does it's signal handling)\n\nThere where also some other issues I found.\n\nI can post more info here regarding these problems. I couldn't find the component when I found the problems, I don't think it had been released then.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=letssurf",
                        "name": "letssurf",
                        "displayName": "James Dempster",
                        "active": true
                    },
                    "created": "2009-03-18T14:32:37.000+0000",
                    "updated": "2009-03-18T14:32:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29559",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "body": "James, I have comitted the latest version to the extras trunk. It is actually released yet, just pretty well hidden by Zend ;). You can find it there:\nhttp:\/\/framework.zend.com\/svn\/framework\/extras\/trunk\/library\/ZendX\/Console\/Process\/Unix.php\n\nWhen you have any solutions, It would be kind of you to attach a patch or if possible directly commit to the trunk.\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "created": "2009-03-18T14:42:26.000+0000",
                    "updated": "2009-03-18T14:42:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29562",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                        "name": "adamcharnock",
                        "displayName": "Adam Charnock",
                        "active": true
                    },
                    "body": "Ryan\/James\/Ben, thank you for the very fast response - it is much appreciated!\n\nMay it be worth mentioning this in the docs as exceptions thrown in the process will now vanish (whereas before they could be seen on the console).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                        "name": "adamcharnock",
                        "displayName": "Adam Charnock",
                        "active": true
                    },
                    "created": "2009-03-18T15:03:41.000+0000",
                    "updated": "2009-03-18T15:03:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29676",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                        "name": "adamcharnock",
                        "displayName": "Adam Charnock",
                        "active": true
                    },
                    "body": "I just thought I would update this issue to say that catching exceptions does indeed solve this issue for me.\n\nHowever, I am still a little concerned that this solution causes uncaught exceptions to be ignored. Would it be better (or even possible?) to do the cleanup in a __destruct() method instead? Or is the view that developers should be catching their exceptions anyway?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamcharnock",
                        "name": "adamcharnock",
                        "displayName": "Adam Charnock",
                        "active": true
                    },
                    "created": "2009-03-22T17:38:42.000+0000",
                    "updated": "2009-03-22T17:38:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29678",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "body": "Well it only solves it half the way. When you see the testcase, you will notice that the bug still appears after creating about 700 processes (because they are not cleaned up at the end). I yet have the cleanup in the destructor, but i is pretty certain that the instance stays alive for a very long time.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "created": "2009-03-22T18:34:21.000+0000",
                    "updated": "2009-03-22T18:34:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30473",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=polothy",
                        "name": "polothy",
                        "displayName": "Mark Nielsen",
                        "active": true
                    },
                    "body": "I'm running into this same problem but under different conditions:\n* First time was when I called setVariable() before the process had been started.  Not sure how else to set variables to a child process before starting it.\n* Second time was my script caused a fetal error while a process was still being executed.\n\nFor both scenarios, I had to restart my computer before I could get the code to start working again.  Without restarting my computer I get the following error:\n\n{noformat}\nWarning: shmop_open(): unable to attach or create shared memory segment in \/path\/to\/ZendX\/Console\/Process\/Unix.php on line 501\n\nFatal error: Uncaught exception 'ZendX_Console_Process_Exception' with message 'Unable to create SHM segments for process communications' in\/path\/to\/ZendX\/Console\/Process\/Unix.php:191\nStack trace:\n#0 \/path\/to\/a\/file.php(15): ZendX_Console_Process_Unix->start()\n#1 {main}\n  thrown in \/path\/to\/ZendX\/Console\/Process\/Unix.php on line 191\n{noformat}\n\nFurther, the system directory is being loaded full of .sem and .shm files.  Seems like the class is missing a cleanup routine to make sure everything shuts down OK.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=polothy",
                        "name": "polothy",
                        "displayName": "Mark Nielsen",
                        "active": true
                    },
                    "created": "2009-04-27T16:32:40.000+0000",
                    "updated": "2009-04-27T16:32:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30474",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "body": "As already mentioned, Process_Unix has currently major flaws, which require some internal refactoring. Will going to fix them between 1.8 and 1.9.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dasprid",
                        "name": "dasprid",
                        "displayName": "Ben Scholzen",
                        "active": true
                    },
                    "created": "2009-04-27T16:40:08.000+0000",
                    "updated": "2009-04-27T16:40:08.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/52721",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Bulk change of all issues last updated before 1st January 2010 as \"Won't Fix\".\r\n\r\nFeel free to re-open and provide a patch if you want to fix this issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-11-20T20:53:20.000+0000",
                    "updated": "2012-11-20T20:53:20.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6047\/transitions"
}