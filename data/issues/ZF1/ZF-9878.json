{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9878",
    "key": "ZF-9878",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "quoteInto handles multiple inputs incorrectly"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/11",
                "name": "Patch",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9878\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2011-05-27T21:13:58.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bugslayer",
                "name": "bugslayer",
                "displayName": "John Crenshaw",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-05-22T18:23:10.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-05-27T21:24:34.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I've provided a full explanation of why this is needed after the patch. The patch is just a minor rewrite of Zend_Db_Adapter_Abstract::quoteInto():\r\n\r\n{code}\r\n    public function quoteInto($text, $value, $type = null, $count = null)\r\n    {\r\n        if ($count === null && !is_array($value)) { \/\/ continue to support old (but undocumented and abnormal) method of passing a single value to multiple binding points \r\n            return str_replace('?', $this->quote($value, $type), $text);\r\n        }\r\n        if (!is_array($value)) { \/\/ if the input wasn't an array, make it so\r\n            $value = array($value);\r\n        }\r\n        if ($count === null) { \/\/ if we don't have a count, figure it out from the size of the input array\r\n            $count = count($value);\r\n        }\r\n        while ($count > 0) {\r\n            \/\/ get the type and value to use for the next binding point\r\n            $thisvalue = array_shift($value);\r\n            if (is_array($type)) {\r\n                $thistype = array_shift($type);\r\n            } else {\r\n                $thistype = $type;\r\n            }\r\n            \r\n            \/\/ bind one more\r\n            if (strpos($text, '?') !== false) {\r\n                $text = substr_replace($text, $this->quote($thisvalue, $thistype), strpos($text, '?'), 1);\r\n            }\r\n            else\r\n            {\r\n                require_once 'Zend\/Db\/Adapter\/Exception.php';\r\n                throw new Zend_Db_Adapter_Exception(\"Mismatch: Input text contained fewer '?' characters than number of available values\");\r\n            }\r\n            --$count;\r\n        }\r\n\r\n        \/\/ see if we had anything left over\r\n        if (strpos($text, '?') !== false) {\r\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\r\n            throw new Zend_Db_Adapter_Exception(\"Mismatch: Input text contained more '?' characters than number of available values\");\r\n        }\r\n\r\n        return $text;\r\n    }\r\n{code}\r\n\r\n********************************************************\r\nWhy this change is important and what it does:\r\n********************************************************\r\n\r\nHere is the use case for normal parameter binding in other database layers and\/or adapters:\r\n1. Function signature is query(string $sql, array $values)\r\n2. $sql contains 0 or more '?' characters\r\n3. Array contains exactly as many values as there are '?' characters in $sql.\r\n   3b. If the count doesn't match, and exception is thrown.\r\n4. Each nth '?' is replaced by the nth entry in the input array.\r\n\r\nThe current quoteInto() function violates 3 and 4 above. As a result, the quoteInto() function behaves completely differently than similar features in other systems, and every place that uses quoteInto() gives unexpected results. One such place is the \"where\" feature, which cannot bind multiple parameters. I believe this issue is known, because someone deliberately avoided it when writing the documentation. See the following sample query (which contains UNSANITIZED INPUTS directly in the string) taken directly from the documentation:\r\n\r\n{code}\r\n$select = $db->select()\r\n             ->from('products',\r\n                    array('product_id', 'product_name', 'price'))\r\n             ->where(\"price < $minimumPrice OR price > $maximumPrice\")\r\n             ->where('product_name = ?', $prod);\r\n\r\nThe above should have been able to be written like this (which is safer, and better style):\r\n$select = $db->select()\r\n             ->from('products',\r\n                    array('product_id', 'product_name', 'price'))\r\n             ->where(\"price < ? OR price > ?\", array($minimumPrice, $maximumPrice))\r\n             ->where('product_name = ?', $prod);\r\n{code}\r\n\r\nSince the system is currently in wide use, backwards compatibility is important to retain while fixing the problem. The behavior of quoteInto is completely undocumented beyond the case of a single input, so that does give some flexibility, however, the code was obviously intended to permit the following addition use case, which may be used in the wild:\r\n5. $values may be a single non-array value, while $sql contains multiple '?'. In this case, the value is bound to all '?' locations.\r\n\r\nI've written the patch so that it will honor this use case as well, even though it is undocumented and not like other systems.\r\n\r\nThere is one undocumented behavior of the old method that is NOT retained, because it conflicts with the desired behavior, and doesn't seem to be intended:\r\n- With the old code, if $values was an array, the values would be escaped, and it would be comma separated. If the text contained \"some_field IN (?)\" (notice the () around '?') this could be used to bind an array.\r\n\r\nThis last behavior is not directly supported by the new code. Users that rely on this undocumented behavior can continue to do so by using array(array($v1, $v2, $v3)).\r\n\r\nThe fix should promote better code (by encouraging binding in complex queries, rather than placing parameters directly in the string) and make the system behave as expected by new users migrating to the Zend platform.\r\n\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9878\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                "name": "kblomqvist",
                "displayName": "Kim Blomqvist",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10412",
                    "id": 10412,
                    "description": "Mini Release",
                    "name": "1.10.1",
                    "userReleaseDate": "10\/Feb\/10",
                    "archived": false,
                    "releaseDate": "2010-02-10",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10190",
                    "id": 10190,
                    "name": "Zend_Db_Adapter_Db2",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10131",
                    "id": 10131,
                    "name": "Zend_Db_Adapter_Mysqli",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10135",
                    "id": 10135,
                    "name": "Zend_Db_Adapter_Oracle",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10130",
                    "id": 10130,
                    "name": "Zend_Db_Adapter_Xml",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10132",
                    "id": 10132,
                    "name": "Zend_Db_Select",
                    "description": "OO interface to building a SELECT SQL query.",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10133",
                    "id": 10133,
                    "name": "Zend_Db_Table",
                    "description": "Lightweight OO interface to database tables and rowsets.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46847",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "body": "Adding code tags",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "created": "2011-05-27T20:11:17.000+0000",
                    "updated": "2011-05-27T20:11:17.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46849",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "body": "I strongly agree with the use case as I have tried that many times before just to realise it's not working that way.\r\n\r\nThis is the way I do it atm.\r\n{code}\r\n$select = $db->select()\r\n             ->from('products',\r\n                    array('product_id', 'product_name', 'price'))\r\n             ->where('price < :min OR price > :max'))\r\n             ->bind(array(\r\n                 ':min' => $minimumPrice,\r\n                 ':max' => $maximumPrice\r\n             ));\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "created": "2011-05-27T20:33:53.000+0000",
                    "updated": "2011-05-27T20:33:53.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46851",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "body": "Discussed with Ralph about the issue and we decided to resolve this as won't fix. The problem with this in zf1 is that quoteInto method is intended to quote a single value not multiple. In addition, we saw that it is not worth of hacking on this while zf2 is coming with different solutions.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "created": "2011-05-27T21:12:24.000+0000",
                    "updated": "2011-05-27T21:12:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46852",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bugslayer",
                        "name": "bugslayer",
                        "displayName": "John Crenshaw",
                        "active": true
                    },
                    "body": "Can you please at least make sure that multiple quoting is supported by whatever solution you use in zf2? This is a really big deal, especially when migrating legacy code.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bugslayer",
                        "name": "bugslayer",
                        "displayName": "John Crenshaw",
                        "active": true
                    },
                    "created": "2011-05-27T21:24:34.000+0000",
                    "updated": "2011-05-27T21:24:34.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9878\/transitions"
}