{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7366",
    "key": "ZF-7366",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Paginator does not use cached Zend_Db_Select correctly"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7366\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/3",
                "name": "Duplicate"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-07-23T07:57:22.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mmoussa",
                "name": "mmoussa",
                "displayName": "Michael Moussa",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-07-23T07:51:16.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-07-23T07:59:44.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "zend_cache",
                "zend_db_select",
                "zend_paginator"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Caching is not working correctly when using Zend_Paginator to paginate Zend_Db_Select results.  The values are being cached (I can see the files in my cache location), but they are not being used.\n\nThe problem is that the cache IDs are being generated incorrectly.\n\n{code:title=Feed.php}\nclass Dashboard_Feed extends Zend_Db_Table_Abstract\n{\n    protected $_name = 'FEED';\n    protected $_primary = 'FEED_ID';\n}\n{code}\n\n{code:title=FeedController.php}\n$feed = new Dashboard_Feed( Zend_Registry::get('db') );\n$select = $feed->select()->order('FEED_TITLE' );\n\n$paginator = Zend_Paginator::factory( $select );\n$paginator->setCache( Zend_Registry::get('cache') );\n$paginator->setCurrentPageNumber( $this->_getParam('page', 1) );\n$paginator->setItemCountPerPage(10);\n{code} \n\n{code:title=cache settings}\ncache.frontend.type = \"Core\"\ncache.frontend.options.automatic_serialization = true\ncache.frontend.options.cache_id_prefix = \"dashboard_\"\n\ncache.backend.type = \"File\"\ncache.backend.options.cache_dir = APPLICATION_PATH \"\/..\/data\/cache\/\"\n{code}\n\nDb adapter is Oracle\n\nUpon first execution, *zend_cache---dashboard_Zend_Paginator_1_81a9b1f25e24763494338baa43444b99* is creating in my cache directory - so far so good.\n\nI make a change to one of the items in the DB and refresh.  I should *not* see the change since the results are cached; however, I do see it.  Zend_Paginator went back to the database to get the info.\n\nI looked into the Zend_Paginator.php to attempt to get to the bottom of the issue.  The problem can be observed in *getItemsByPage(...)*.  See the comments I inserted.\n\n{code:title=Paginator.php}\npublic function getItemsByPage($pageNumber)\n{\n    $pageNumber = $this->normalizePageNumber($pageNumber);\n\n    if ($this->_cacheEnabled()) {\n        \/\/ here, _getCacheId(...)  returns \"Zend_Paginator_1_a479583744ccc3a9c4d653c390e7ff7f\"\n        $data = self::$_cache->load($this->_getCacheId($pageNumber));\n        if ($data !== false) {\n            return $data;\n        }\n    }\n\n    $offset = ($pageNumber - 1) * $this->_itemCountPerPage;\n\n    $items = $this->_adapter->getItems($offset, $this->_itemCountPerPage);\n\n    $filter = $this->getFilter();\n\n    if ($filter !== null) {\n        $items = $filter->filter($items);\n    }\n\n    if (!$items instanceof Traversable) {\n        $items = new ArrayIterator($items);\n    }\n\n    if ($this->_cacheEnabled()) {\n        \/\/ here, _getCacheId(...)  returns \"Zend_Paginator_1_81a9b1f25e24763494338baa43444b99\"\n        self::$_cache->save($items, $this->_getCacheId($pageNumber), array($this->_getCacheInternalId()));\n    }\n\n    return $items;\n}\n{code}\n\nAs you can see, when the items are cached, the cache ID corresponds to what was created in my cache directory (obviously), but when Paginator tries to *read* the cache, it's looking for the wrong ID!\n\nThe source of the problem is that *_getCacheInternalId()* serializes the adapter to identify the cache entry.\n\n{code:title=Paginator.php}\nprotected function _getCacheInternalId()\n{\n    return md5(serialize($this->_adapter).$this->_itemCountPerPage);\n}\n{code}\n\nOf course, the adapter's state is going to be different after results are retrieved vs before they are retrieved, so this mechanism cannot work.  I saved the serialized value of the adapter from the first and second calls to _getInternalCacheId() to a file and did a diff... there are several differences.\n\nThe problem is *greatly* exacerbated if one is using Zend_Db_Profiler.  I was using the profiler to determine if the cache was working correctly.  Instead, Zend_Paginator was creating a brand new cache entry *with a different ID each time* every time I reloaded the page.  Why?  Well, the profiler contains performance information on the queries that have been run thus far.  This information will be different from request to request 99.99% of the time.  Different content = different serialization = different cacheId.\n\nI would appreciate it if anybody can comment on this bug and perhaps queue up a resolution for the next ZF patch\/release.\n\nI am devising a workaround to use in my project and will post it here for the benefit of others who have encountered this problem."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7366\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=norm2782",
                "name": "norm2782",
                "displayName": "Jurrien Stutterheim",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-6989",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6989",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10340",
                    "id": 10340,
                    "description": "Mini Release",
                    "name": "1.8.4",
                    "userReleaseDate": "23\/Jun\/09",
                    "archived": false,
                    "releaseDate": "2009-06-23",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10315",
                    "id": 10315,
                    "name": "Zend_Paginator",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32864",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=doctorrock83",
                        "name": "doctorrock83",
                        "displayName": "julien PAULI",
                        "active": true
                    },
                    "body": "Duplicates #ZF-6989 , even if it gives more informations (will be linked into #ZF-6989)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=doctorrock83",
                        "name": "doctorrock83",
                        "displayName": "julien PAULI",
                        "active": true
                    },
                    "created": "2009-07-23T07:57:12.000+0000",
                    "updated": "2009-07-23T07:57:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32865",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=doctorrock83",
                        "name": "doctorrock83",
                        "displayName": "julien PAULI",
                        "active": true
                    },
                    "body": "Please, get the patch attached to ZF-6989 and make a use case.\nWe are actually looking for help to test that in order to provide a patch the better it could be.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=doctorrock83",
                        "name": "doctorrock83",
                        "displayName": "julien PAULI",
                        "active": true
                    },
                    "created": "2009-07-23T07:59:44.000+0000",
                    "updated": "2009-07-23T07:59:44.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7366\/transitions"
}