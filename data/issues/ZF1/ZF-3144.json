{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3144",
    "key": "ZF-3144",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Cascading db operations do not work when 'refColumns' is not explicity set inside $_referenceMap."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField",
            "value": {
                "timeoriginalestimate": 0,
                "timeestimate": 0
            }
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3144\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10510",
                    "id": 10510,
                    "description": "Minor Release",
                    "name": "1.12.0",
                    "userReleaseDate": "27\/Aug\/12",
                    "archived": false,
                    "releaseDate": "2012-08-27",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-05-28T19:36:30.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                "name": "zimnyx",
                "displayName": "Piotr Czachur",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-04-18T04:28:40.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-05-28T21:13:10.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "{code}\r\n<?php\r\nclass Files extends Zend_Db_Table\r\n{\r\n    protected $_name = 'files';\r\n    protected $_rowClass = 'File';\r\n    protected $_referenceMap = array(\r\n        'Email' => array(\r\n            'columns'           => 'emailId',\r\n            'refTableClass'     => 'Emails',\r\n            \/\/ Without next row CASCADE doesn't work despite id is PK, and should be retrieved automaticaly\r\n            \/\/ Manual says that if refColumns is not set it will be be discovered from table schema as PK\r\n            'refColumns'        => 'id',\r\n            'onDelete'          => self::CASCADE,\r\n        ),\r\n}\r\n{code}\r\n\r\nBtw I noticed, that without  'refColumns'  set to 'id' CASCADE query looks like \"DELETE FROM files WHERE phoneId = 0\" - this is just wrong."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/6",
                "name": "N\/A"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3144\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [
                "FixForZF1.12",
                "state:patch-ready-for-review",
                "zf-caretaker-adamlundrigan",
                "zf-crteam-review"
            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                "name": "adamlundrigan",
                "displayName": "Adam Lundrigan",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/14666",
                    "filename": "ZF-3144_fix.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-09-26T19:39:51.000+0000",
                    "size": 8061,
                    "mimeType": "text\/x-patch",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/14666\/ZF-3144_fix.patch"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/14661",
                    "filename": "ZF-3144_reproduce.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-09-23T14:50:36.000+0000",
                    "size": 5695,
                    "mimeType": "text\/x-patch",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/14661\/ZF-3144_reproduce.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10174",
                    "id": 10174,
                    "description": "Mini Release",
                    "name": "1.5.1",
                    "userReleaseDate": "25\/Mar\/08",
                    "archived": true,
                    "releaseDate": "2008-03-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10133",
                    "id": 10133,
                    "name": "Zend_Db_Table",
                    "description": "Lightweight OO interface to database tables and rowsets.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21091",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Please evaluate and categorize as necessary.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-04-18T13:20:28.000+0000",
                    "updated": "2008-04-18T13:20:28.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26982",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Reassigning to Ralph since he's the new maintainer of Zend_Db",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-12-04T13:17:29.000+0000",
                    "updated": "2008-12-04T13:17:29.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28016",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "Will evaluate within 2 weeks",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-01-10T11:58:12.000+0000",
                    "updated": "2009-01-10T11:58:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30065",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                        "name": "zimnyx",
                        "displayName": "Piotr Czachur",
                        "active": true
                    },
                    "body": "Is this forgotten issue?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                        "name": "zimnyx",
                        "displayName": "Piotr Czachur",
                        "active": true
                    },
                    "created": "2009-04-10T03:48:01.000+0000",
                    "updated": "2009-04-10T03:48:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31149",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "can you describe the 2 tables and\/or produce a small script (you can use sqlite ::memory:: to accomplish this) that will demonstrate the problem?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-05-19T12:29:47.000+0000",
                    "updated": "2009-05-19T12:29:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31206",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                        "name": "zimnyx",
                        "displayName": "Piotr Czachur",
                        "active": true
                    },
                    "body": "\nRalph, here you go:\n\n\n{code:title=SQL}\nCREATE TABLE `products` (\n  `id` tinyint(4) NOT NULL auto_increment,\n  PRIMARY KEY  (`id`)\n);\n\nCREATE TABLE `files` (\n  `id` tinyint(4) NOT NULL auto_increment,\n  `productId` tinyint(4) NOT NULL,\n  PRIMARY KEY  (`id`)\n);\n\nINSERT INTO products values (1),(2);\nINSERT INTO files values (7,2),(8,2);\n{code}\n\n\n\n{code:title=PHP}\nclass Default_Model_DbTable_Files extends Zend_Db_Table\n{\n    protected $_name = 'files';\n    protected $_referenceMap = array(\n        'Product' => array(\n            'columns'           => 'productId',\n            'refTableClass'     => 'Default_Model_DbTable_Products',\n           \/\/ 'refColumns'        => 'id',    \n            'onDelete'          => self::CASCADE,\n        ),\n    );\n} \n\nclass Default_Model_DbTable_Products extends Zend_Db_Table\n{ \n    protected $_name = 'products';  \n    protected $_dependentTables = array('Default_Model_DbTable_Files');\n\n} \n\n$productsTable = new Default_Model_DbTable_Products;\n$productsTable->find(2)->current()->delete();\n{code}\n\n{code:title=Logs}\n\/trunk\/lib\/Zend\/Db\/Table\/Abstract.php:1085 'Undefined index:  refColumns'\nDELETE FROM `files` WHERE (`productId` = 0)\nDELETE FROM `products` WHERE (`products`.`id` = 2)\n{code}\n\nUncommenting  \/\/ 'refColumns'        => 'id',  fixes problem.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                        "name": "zimnyx",
                        "displayName": "Piotr Czachur",
                        "active": true
                    },
                    "created": "2009-05-21T00:59:24.000+0000",
                    "updated": "2009-05-21T00:59:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44434",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "Is the suggestion here to throw an exception when refColumns is not present? Seems that should be the behavior because if you don't explicitly say what the reference column is, Zend_Db_Table shouldn't make an assumption about what it's related to (it could technically be another column, not the PK).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2011-02-17T15:03:19.000+0000",
                    "updated": "2011-02-17T15:03:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/45510",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                        "name": "zimnyx",
                        "displayName": "Piotr Czachur",
                        "active": true
                    },
                    "body": "Ralph,\r\n\r\nI quit using ZF almost 2 years ago. Please decide on your own.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zimnyx",
                        "name": "zimnyx",
                        "displayName": "Piotr Czachur",
                        "active": true
                    },
                    "created": "2011-03-15T04:18:55.000+0000",
                    "updated": "2011-03-15T04:18:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47685",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bento.vilas.boas",
                        "name": "bento.vilas.boas",
                        "displayName": "Bento Vilas Boas",
                        "active": true
                    },
                    "body": "Ralph,\r\n\r\nAccording to official documentation, if refColumns is not present, pk will be used. http:\/\/framework.zend.com\/manual\/en\/zend.db.table.relationships.html\r\n\r\nThis issue was fixed somewhere along the way.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bento.vilas.boas",
                        "name": "bento.vilas.boas",
                        "displayName": "Bento Vilas Boas",
                        "active": true
                    },
                    "created": "2011-07-27T04:12:23.000+0000",
                    "updated": "2011-07-27T04:12:23.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48506",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "Implemented Piotr's reproduction code as a unit test (patch attached).  The result is still the same as he found:\r\n{code}\r\n2) Zend_Db_Table_Pdo_SqliteTest::testCascadingOperationReferenceColumnFallsBackToPrimaryKeyWhenNotSpecified\r\nUndefined index: refColumns\r\n\r\n\/usr\/local\/apache2\/htdocs\/lib\/zfdev\/trunk\/library\/Zend\/Db\/Table\/Abstract.php:1205\r\n\/usr\/local\/apache2\/htdocs\/lib\/zfdev\/trunk\/library\/Zend\/Db\/Table\/Row\/Abstract.php:620\r\n\/usr\/local\/apache2\/htdocs\/lib\/zfdev\/trunk\/tests\/Zend\/Db\/Table\/TestCommon.php:1683\r\n{code}\r\n\r\nRalph has said that refColumns should be explicitly specified, and the current implementation doesn't try to \"autodiscover\" the reference columns.  However, the ZF manual says the opposite.  Should we change the implementation or the manual?  \r\n\r\nAs this issue has been around since at least 1.5.1, anyone using cascading operations would already have specified their reference columns, so I would vote for updating the manual page to note that specifying 'refColumns' is required for cascade operations to work.  I would also change the implementation to throw an exception if 'refColumns' is not specified. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-09-23T14:50:36.000+0000",
                    "updated": "2011-09-23T14:52:32.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48537",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "After discussion with [~ralph] on IRC, it was decided that the manual should be updated to display a note saying that as of 1.11.11 the refColumns key is required, and an exception should be thrown if it is not present.  Attached is a patch implementing these changes.\n\nComments?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-09-26T19:39:51.000+0000",
                    "updated": "2011-09-26T19:39:51.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50590",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "Reflecting on this, is throwing an exception the best course of action?  With pre-1.12, any applications that use referenceMap without refColumns emit a notice and the cascade fails ([see here above|http:\/\/framework.zend.com\/issues\/browse\/ZF-3144?focusedCommentId=31206&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-31206]), but after this patch is applied it will throw an exception that will halt the entire application unless it's caught  Would it be better to silently ignore the referenceMap entry if it doesn't have a refColumns key?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2012-05-11T01:09:01.000+0000",
                    "updated": "2012-05-11T01:09:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50785",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Updated manual to better reflect reality in svn r24820.\r\nDo not through an exception as this will cause a B\/C break for no real benefit at this stage in ZF1's lifecycle.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-05-28T19:36:30.000+0000",
                    "updated": "2012-05-28T19:36:30.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3144\/transitions"
}