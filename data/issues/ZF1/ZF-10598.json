{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10598",
    "key": "ZF-10598",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend Select odd behavior"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10598\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/3",
                "name": "Duplicate"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2011-04-23T07:46:42.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                "name": "loconut",
                "displayName": "The Lone Coder",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-10-25T16:13:30.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-04-23T07:46:42.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Here is some code that was designed to randomly choose a row from the databse. I discovered that doing $select->__toString() would always show the correct SQL and when put in MySQL directly would work, but when used with fetchRow($select) the end result seemed to ignore the limit clause. If I switched to fetchAll($select) it worked.\r\n\r\n{code}\r\n    public static function ChooseRandomPoolFile()\r\n    {\r\n        $retval = false;\r\n\r\n        $tbl = new TableAdapters_PoolFiles();\r\n        $db = $tbl->getAdapter();\r\n        $select = $db->select()\r\n            ->from('PoolFiles', array('Sum' => new Zend_Db_Expr('COUNT(*)')))\r\n            ->where('FileSize > 0')\r\n            ->order(array('DateAdded ASC', 'BlockID ASC'));\r\n        $count = $db->fetchOne($select);\r\n        unset($select);\r\n\r\n        if (is_numeric($count) && ($count > 0)) {\r\n            $offset = mt_rand(0, ($count - 1));\r\n            $select = $tbl->select()\r\n                ->where('FileSize > 0')\r\n                ->order(array('DateAdded ASC', 'BlockID ASC'))\r\n                ->limit(1, $offset);\r\n            $result = $tbl->fetchRow($select);\r\n            if ($result instanceof Zend_Db_Table_Row) {\r\n                $retval = new self($result, false);\r\n            }\r\n        }\r\n\r\n        return $retval;\r\n    }\r\n{code}\r\n\r\nthe above would always return the same row despite getting a varying \/ valid offset. Changing the above to:\r\n\r\n{code}\r\n    public static function ChooseRandomPoolFile()\r\n    {\r\n        $retval = false;\r\n\r\n        $tbl = new TableAdapters_PoolFiles();\r\n        $db = $tbl->getAdapter();\r\n        $select = $db->select()\r\n            ->from('PoolFiles', array('Sum' => new Zend_Db_Expr('COUNT(*)')))\r\n            ->where('FileSize > 0')\r\n            ->order(array('DateAdded ASC', 'BlockID ASC'));\r\n        $count = $db->fetchOne($select);\r\n        unset($select);\r\n\r\n        if (is_numeric($count) && ($count > 0)) {\r\n            $offset = mt_rand(0, ($count - 1));\r\n            $select = $tbl->select()\r\n                ->where('FileSize > 0')\r\n                ->order(array('DateAdded ASC', 'BlockID ASC'))\r\n                ->limit(1, $offset);\r\n            $result = $tbl->fetchAll($select);\r\n            if (($result instanceof Zend_Db_Table_Rowset) && ($result->count() == 1)) {\r\n                $retval = new self($result->current(), false);\r\n            }\r\n        }\r\n\r\n        return $retval;\r\n    }\r\n{code}\r\n \r\nwould work fine.\r\n\r\nLong story short it appears fetchRow ignores the limit clause assuming it can, but forgetting users may want to select 1 but after some offset?"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10598\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ramon",
                "name": "ramon",
                "displayName": "Ramon Henrique Ornelas",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-8944",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8944",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10490",
                    "id": 10490,
                    "description": "Mini Release",
                    "name": "1.10.8",
                    "userReleaseDate": "25\/Aug\/10",
                    "archived": false,
                    "releaseDate": "2010-08-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10132",
                    "id": 10132,
                    "name": "Zend_Db_Select",
                    "description": "OO interface to building a SELECT SQL query.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42697",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "Sorry on the above I made a typo- I took my final version and re-edited it while I was typing my post to make my original, and typed fetchOne instead of fetchRow. The one that doesn't work should be:\r\n\r\npublic static function ChooseRandomPoolFile()\r\n{\r\n$retval = false;\r\n\r\n$tbl = new TableAdapters_PoolFiles();\r\n$db = $tbl->getAdapter();\r\n$select = $db->select()\r\n->from('PoolFiles', array('Sum' => new Zend_Db_Expr('COUNT')))\r\n->where('FileSize > 0')\r\n->order(array('DateAdded ASC', 'BlockID ASC'));\r\n$count = $db->fetchOne($select);\r\nunset($select);\r\n\r\nif (is_numeric($count) && ($count > 0)) {\r\n$offset = mt_rand(0, ($count - 1));\r\n$select = $tbl->select()\r\n->where('FileSize > 0')\r\n->order(array('DateAdded ASC', 'BlockID ASC'))\r\n->limit(1, $offset);\r\n$result = $tbl->fetchRow($select);\r\nif ($result instanceof Zend_Db_Table_Row) { $retval = new self($result, false); }\r\n}\r\n\r\nreturn $retval;\r\n}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-10-25T17:04:26.000+0000",
                    "updated": "2010-10-25T17:04:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42698",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "Upon inspection of Zend\/Db\/Table\/Abstract.php around line 1361 it appears that the limit is overridden.\r\n\r\nIdeally it should preserve any limit offset that was passed in.\r\n\r\nchange the limits to something like\r\n\r\n$this->limit(1, $select->getPart('limitoffset'));\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-10-25T17:11:06.000+0000",
                    "updated": "2010-10-25T17:11:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42700",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "proposed patch?\r\n\r\nIndex: Zend\/Db\/Table\/Abstract.php\r\n===================================================================\r\n--- Zend\/Db\/Table\/Abstract.php\t(revision 1791)\r\n+++ Zend\/Db\/Table\/Abstract.php\t(working copy)\r\n@@ -1358,10 +1358,10 @@\r\n                 $this->_order($select, $order);\r\n             }\r\n \r\n-            $select->limit(1);\r\n+            $select->limit(1, $select->getPart(Zend_Db_Select::LIMIT_OFFSET));\r\n \r\n         } else {\r\n-            $select = $where->limit(1);\r\n+            $select = $where->limit(1, $select->getPart(Zend_Db_Select::LIMIT_OFFSET));\r\n         }\r\n \r\n         $rows = $this->_fetch($select);\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-10-25T17:27:29.000+0000",
                    "updated": "2010-10-25T17:27:29.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42701",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "JIRA stinks for posting code... yeesh.\r\n\r\npatch placed at:\r\nhttp:\/\/webtrotter.com\/zf1.10.8.patch\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-10-25T17:31:23.000+0000",
                    "updated": "2010-10-25T17:31:23.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42702",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "I believe my patch to Zend_Db_Table_Abstract is a better solution though.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-10-25T17:33:46.000+0000",
                    "updated": "2010-10-25T17:33:46.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43142",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "All you need to do is put the  \\{code\\} tag around your code. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2010-11-19T07:31:37.000+0000",
                    "updated": "2010-11-19T07:31:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43143",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "If you are using MySQL, why not instead do something like this: $select->order(new Zend_Db_Expr('RAND()')); as opposed to finding the count and crafting your own random algorithm?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2010-11-19T07:36:12.000+0000",
                    "updated": "2010-11-19T07:36:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43144",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "Well, regardless of a better implementation of the above code, the bug is real. Fact is, if you give a limit with a specific row offset and fetchOne, it obliterates the offset. Simply passing in the offset as in my patch lets one specify an arbitrary offset and still be able to fetchOne.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-11-19T08:47:06.000+0000",
                    "updated": "2010-11-19T08:47:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43145",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "Have a look at the lines referenced in the patch.\r\n\r\nIn Zend\/Db\/Table\/Abstract.php:\r\n\r\nThere are two instances where it has $select->limit(1) instead of\r\n$select->limit(1, $select->getPart(Zend_Db_Select::LIMIT_OFFSET))\r\n\r\nWhich would fix the problem. It seems pretty obvious looking at the source what the problem is and the solution is only a half step away.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2010-11-19T08:50:24.000+0000",
                    "updated": "2010-11-19T08:50:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44290",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "body": "I've updated the parent task as this is still not resolved. I'm commenting here to reawaken anyone watching.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=loconut",
                        "name": "loconut",
                        "displayName": "The Lone Coder",
                        "active": true
                    },
                    "created": "2011-02-06T12:16:20.000+0000",
                    "updated": "2011-02-06T12:16:20.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/45983",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "body": "Patch provided in ZF-11253.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "created": "2011-04-23T07:46:42.000+0000",
                    "updated": "2011-04-23T07:46:42.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10598\/transitions"
}