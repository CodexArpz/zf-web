{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12266",
    "key": "ZF-12266",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Improving Zend_Db_Table_Abstract::getReference()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12266\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frmarq",
                "name": "frmarq",
                "displayName": "Marc Barilley",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2012-05-30T12:53:46.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-05-30T12:53:46.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The problem arises when extending classes that manage the same objects. The extension is due to the fact that the classes are run in different contexts and, therefore, their actual functionnalities may change.\r\n\r\nWhen loading the referenced objects of one table off the database, the call to Zend_Db_Table_Abstract::getReference() fails due to a class checking that is - in my opinion - too strong .\r\n\r\nHere are the sources I use (maybe the example is simpler but this is what I have) :\r\n\r\nThese are the base classes. They manage accounts (dbtable account) that may use resources (dbtable resource) through access definitions (dbtable access). The tables are really simple and can be guessed by reading this code (I can provide a schema if necessary).\r\n{code:title=application\/models\/DbTable\/Access.php|borderStyle=solid}\r\nclass Application_Model_DbTable_Access extends Zend_Db_Table_Abstract\r\n{\r\n    protected $_name = 'access';\r\n    \/**\r\n     * Links to other tables.\r\n     * @var array\r\n     *\/\r\n    protected $_referenceMap = array(\r\n        'Account' => array (\r\n            'columns'       => array('account_id'),\r\n            'refTableClass' => 'Application_Model_DbTable_Account',\r\n            'refColumns'    => array('account_id'),\r\n        ),\r\n        'Resource' => array(\r\n            'columns'       => array('resource_id'),\r\n            'refTableClass' => 'Application_Model_DbTable_Resource',\r\n            'refColumns'    => array('resource_id'),\r\n        ),\r\n    );\r\n}\r\n{code}\r\n\r\n{code:title=application\/models\/DbTable\/Account.php|borderStyle=solid}\r\nclass Application_Model_DbTable_Account extends Zend_Db_Table_Abstract\r\n{\r\n    protected $_name = 'account';\r\n}\r\n{code}\r\n\r\n{code:title=application\/models\/DbTable\/Resource.php|borderStyle=solid}\r\nclass Application_Model_DbTable_Resource extends Zend_Db_Table_Abstract\r\n{\r\n    protected $_name = 'resource';\r\n}\r\n{code}\r\n\r\n\r\n{code:title=application\/models\/Account.php|borderStyle=solid}\r\nclass Application_Model_Account\r\n{\r\n    \/**\r\n     * The account id.\r\n     * @var integer\r\n     *\/\r\n    protected $_accountId;\r\n    \/**\r\n     * The resources that the account may access.\r\n     * @var array\r\n     *\/\r\n    protected $_authorizedResources;\r\n\r\n    \/**\r\n     * Set Id\r\n     * @param integer _accountId Id\r\n     * @return Application_Model_Account\r\n     *\/\r\n    public function setAccountId($_accountId)\r\n    {\r\n        $this->_accountId = $_accountId;\r\n        return $this;\r\n    }\r\n\r\n    \/**\r\n     * Set the authorized resources for this account\r\n     * @param array _authorizedResources the authorized resources for this account\r\n     * @return Application_Model_Account\r\n     *\/\r\n    public function setAuthorizedResources($_authorizedResources)\r\n    {\r\n        $this->_authorizedResources = $_authorizedResources;\r\n        return $this;\r\n    }\r\n}\r\n{code}\r\n\r\n{code:title=application\/models\/AccountMapper.php|borderStyle=solid}\r\nclass Application_Model_AccountMapper extends Application_Model_DefaultMapper\r\n{\r\n    \/**\r\n     * The table class name associated to the mapper.\r\n     * @var string\r\n     *\/\r\n    protected $_dbTableClass = 'Application_Model_DbTable_Account';\r\n\r\n    \/**\r\n     * Build an object from one database row.\r\n     * @param Zend_Db_Table_Row_Abstract $row\r\n     * @return Application_Model_Account\r\n     *\/\r\n    public function buildFromRow(Zend_Db_Table_Row_Abstract $row)\r\n    {\r\n        $resourceRows = $row->findManyToManyRowset(\r\n            'Application_Model_DbTable_Resource',\r\n            'Application_Model_DbTable_Access',\r\n            'Account',\r\n            'Resource'\r\n        );\r\n        $resourceMapper = new Application_Model_ResourceMapper();\r\n        $resources = $resourceMapper->buildFromRowset($resourceRows);\r\n        $account = new Application_Model_Account();\r\n        $account->setAccountId($row->account_id)\r\n            ->setAuthorizedResources($resources)\r\n        ;\r\n        return $account;\r\n    }\r\n}\r\n{code}\r\n\r\n{code:title=application\/models\/DefaultMapper.php|borderStyle=solid}\r\nclass Application_Model_DefaultMapper\r\n{\r\n    \/**\r\n     * The table class name associated to the mapper.\r\n     * @var string\r\n     *\/\r\n    protected $_dbTableClass = '';\r\n    \/**\r\n     * The table object associated to the mapper.\r\n     * @var Zend_Db_Table_Abstract\r\n     *\/\r\n    protected $_dbTable;\r\n\r\n    \/**\r\n     * Get the associated table of the object.\r\n     * @return Zend_Db_Table_Abstract\r\n     *\/\r\n    public function getDbTable()\r\n    {\r\n        if (null === $this->_dbTable) {\r\n            $this->setDbTable($this->_dbTableClass);\r\n        }\r\n        return $this->_dbTable;\r\n    }\r\n\r\n    \/**\r\n     * Set the object's table\r\n     * @param string|Zend_Db_Table_Abstract $dbTable a class name or a Zend_Db_Table_Abstract object\r\n     * @return Application_Model_Default\r\n     * @throws Exception\r\n     *\/\r\n    public function setDbTable($dbTable)\r\n    {\r\n        if (is_string($dbTable)) {\r\n            $dbTable = new $dbTable();\r\n        }\r\n        if (!$dbTable instanceof Zend_Db_Table_Abstract) {\r\n            throw new Exception('Invalid table data gateway provided');\r\n        }\r\n        $this->_dbTable = $dbTable;\r\n        return $this;\r\n    }\r\n\r\n    \/**\r\n     * Build an object from one database row.\r\n     * @param Zend_Db_Table_Row_Abstract $row\r\n     * @return Application_Model_Default\r\n     *\/\r\n    abstract public function buildFromRow(Zend_Db_Table_Row_Abstract $row);\r\n\r\n    \/**\r\n     * Load all the objects.\r\n     * @return array<Application_Model_Default>\r\n     *\/\r\n    public function fetchAll($where=null, $order=null, $count=null, $offset=null)\r\n    {\r\n        return $this->buildFromRowset($this->getDbTable()->fetchAll($where, $order, $count, $offset));\r\n    }\r\n\r\n    \/**\r\n     * Build an objects array from a rowset.\r\n     * @return array<Application_Model_Default>\r\n     *\/\r\n    public function buildFromRowset(Zend_Db_Table_Rowset_Abstract $rows)\r\n    {\r\n        $objects = array();\r\n        foreach ($rows as $row) {\r\n            $objects[] = $this->buildFromRow($row);\r\n        }\r\n        return $objects;\r\n    }\r\n}\r\n{code}\r\n\r\n{code:title=application\/models\/Resource.php|borderStyle=solid}\r\nclass Application_Model_Resource\r\n{\r\n    \/**\r\n     * The identifying number.\r\n     * @var integer\r\n     *\/\r\n    protected $_resourceId;\r\n\r\n    \/**\r\n     * Set Id\r\n     * @param integer _resourceId Id\r\n     * @return Application_Model_Resource\r\n     *\/\r\n    public function setResourceId($_resourceId)\r\n    {\r\n        $this->_resourceId = $_resourceId;\r\n        return $this;\r\n    }\r\n}\r\n{code}\r\n\r\n{code:title=application\/models\/ResourceMapper.php|borderStyle=solid}\r\nclass Application_Model_ResourceMapper extends Application_Model_DefaultMapper\r\n{\r\n    \/**\r\n     * The table class name associated to the mapper.\r\n     * @var string\r\n     *\/\r\n    protected $_dbTableClass = 'Application_Model_DbTable_Resource';\r\n\r\n    \/**\r\n     * Build a resource from one database row.\r\n     * @param Zend_Db_Table_Row_Abstract $row\r\n     * @return Application_Model_Resource\r\n     *\/\r\n    public function buildFromRow(Zend_Db_Table_Row_Abstract $row)\r\n    {\r\n        $resource = new Application_Model_Resource();\r\n        $resource->setResourceId($row->resource_id);\r\n        return $resource;\r\n    }\r\n}\r\n{code}\r\n\r\nThe child classes follow. For this example, they don't extend the base-classes functionnalities.\r\n\r\n{code:title=application\/modules\/admin\/models\/DbTable\/Access.php|borderStyle=solid}\r\nclass Admin_Model_DbTable_Access extends Application_Model_DbTable_Access\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/DbTable\/Account.php|borderStyle=solid}\r\nclass Admin_Model_DbTable_Account extends Application_Model_DbTable_Account\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/DbTable\/Resource.php|borderStyle=solid}\r\nclass Admin_Model_DbTable_Resource extends Application_Model_DbTable_Resource\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/Access.php|borderStyle=solid}\r\nclass Admin_Model_Access extends Application_Model_Access\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/AccessMapper.php|borderStyle=solid}\r\nclass Admin_Model_AccessMapper extends Application_Model_AccessMapper\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/Account.php|borderStyle=solid}\r\nclass Admin_Model_Account extends Application_Model_Account\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/AccountMapper.php|borderStyle=solid}\r\nclass Admin_Model_AccountMapper extends Application_Model_AccountMapper\r\n{\r\n    \/**\r\n     * The table class name associated to the mapper.\r\n     * @var string\r\n     *\/\r\n    protected $_dbTableClass = 'Admin_Model_DbTable_Account';\r\n\r\n    \/**\r\n     * Build an object from one database row.\r\n     * @param Zend_Db_Table_Row_Abstract $row\r\n     * @return Admin_Model_Account\r\n     * @see Application_Model_AccountMapper::buildFromRow()\r\n     *\/\r\n    public function buildFromRow(Zend_Db_Table_Row_Abstract $row)\r\n    {\r\n        $account = parent::buildFromRow($row); \/\/ This call fails!!!\r\n        return $account;\r\n    }\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/Resource.php|borderStyle=solid}\r\nclass Admin_Model_Resource extends Application_Model_Resource\r\n{\r\n}\r\n{code}\r\n\r\n{code:title=application\/modules\/admin\/models\/ResourceMapper.php|borderStyle=solid}\r\nclass Admin_Model_ResourceMapper extends Application_Model_ResourceMapper\r\n{\r\n}\r\n{code}\r\n\r\nWhen calling the index action of this controller, there is an error in fetchAll(), because it comes from a Admin_Model_AccountMapper but actually executes the parent's method:\r\n\r\n{code:title=application\/modules\/admin\/controllers\/AccountController.php|borderStyle=solid}\r\nclass Admin_AccountController extends Zend_Controller_Action\r\n{\r\n    public function indexAction()\r\n    {\r\n        \/\/ action body\r\n        $accountMapper = new Admin_Model_AccountMapper();\r\n        $this->view->entries = $accountMapper->fetchAll();\r\n    }\r\n}\r\n{code}\r\n{noformat} \r\nApplication error\r\nException information:\r\n\r\nMessage: Reference rule \"Account\" does not reference table Admin_Model_DbTable_Account \r\n\r\nStack trace:\r\n\r\n#0 \/usr\/share\/php\/Zend\/Db\/Table\/Row\/Abstract.php(845): Zend_Db_Table_Abstract->getReference('Admin_Model_DbT...', 'Account')\r\n#1 \/usr\/share\/php\/Zend\/Db\/Table\/Row\/Abstract.php(1063): Zend_Db_Table_Row_Abstract->_prepareReference(Object(Application_Model_DbTable_Access), Object(Admin_Model_DbTable_Account), 'Account')\r\n...\r\n{noformat} \r\n\r\nThe rule \"Account\" that is used here actually references a table of type Application_Model_DbTable_Account, not Admin_Model_DbTable_Account but Admin_Model_AccountMapper want to work with a Admin_Model_DbTable_Account. But because Admin_Model_DbTable_Account is extending Application_Model_DbTable_Account, this call should work, not fail.\r\n(Am I clearly explaining that? Huh....)\r\n\r\nI suggest that the code of Zend_Db_Table_Abstract->getReference() at line 472 may be changed from:\r\n{code:title=Zend\/Db\/Table\/Abstract.php|borderStyle=solid}\r\nif ($refMap[$ruleKey][self::REF_TABLE_CLASS] != $tableClassname) {\r\n{code}\r\nto:\r\n{code:title=Zend\/Db\/Table\/Abstract.php|borderStyle=solid}\r\nif (is_a($tableClassname, $refMap[$ruleKey][self::REF_TABLE_CLASS])) {\r\n{code}\r\nThis would allow derived classes to work."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/5",
                "name": "Trivial"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12266\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10981",
                    "id": 10981,
                    "description": "Mini Release",
                    "name": "1.11.11",
                    "userReleaseDate": "29\/Sep\/11",
                    "archived": false,
                    "releaseDate": "2011-09-29",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10133",
                    "id": 10133,
                    "name": "Zend_Db_Table",
                    "description": "Lightweight OO interface to database tables and rowsets.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [

            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12266\/transitions"
}