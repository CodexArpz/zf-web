{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11537",
    "key": "ZF-11537",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "MSSQL PDO: Schema name is optional but primary key detection fails quietly on non-dbo tables using sp_pkeys"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11537\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matt_1",
                "name": "matt_1",
                "displayName": "Matt Carter",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-07-07T13:45:58.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-07-13T08:49:42.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "mssql",
                "primary_key"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Environment: Zend_Db_Adapter_Pdo_Mssql connecting to Microsoft SQL Server 2008\r\n\r\nTo reproduce:\r\n\r\nCreate a table in a schema other than dbo, e.g. a schema called \"audit\", table called e.g. \"EventHistory\".\r\nInvoke Zend_Db_Adapter_Pdo_Mssql::describeTable('EventHistory', null);\r\n\r\nLook at the PRIMARY field of the primary key column, which will be false. This is because sp_pkeys with a null argument for @table_owner (schema name) works for tables in the 'dbo' schema, but returns 0 primary keys for tables in non-dbo schemas.\r\n\r\nUse case:\r\n\r\nMy application uses $db->listTables() to get a list of all tables, then uses Zend_Db_Table instances created from this list to operate on each table. A few tables in my database are in schemas other than 'dbo', e.g. schemas 'audit' and 'cache'.\r\n\r\nlistTables() lists these tables, but as it doesn't include the schema name I cannot pass this to the Zend_Db_Table constructor. (Schema name is marked optional everywhere including on describeTable() so there should be no problem - unless the same table name appears twice.)\r\n\r\nFunctions acting on tables not in the dbo schema that rely on the primary key, will fail with the message \"A table must have a primary key, but none was found.\"\r\n\r\nAs a workaround I am extending listTables() to qualify tables in non-dbo schemas with the schema name as follows:\r\n\r\n    \/**\r\n     * Returns a list of the tables in the database.\r\n     * Overrides the Zend implementation to add schema prefix for tables not in the dbo schema.\r\n     * @return array\r\n     *\/\r\n    public function listTables()\r\n    {\r\n        \/\/ Shipped impl: $sql = \"SELECT name FROM sysobjects WHERE type = 'U' ORDER BY name\";\r\n        \/\/ New impl:\r\n        $sql = \"SELECT case when s.name is null or s.name = 'dbo' then o.name else s.name+'.'+o.name end as name\"\r\n        .\" from sysobjects o left join sys.schemas s on o.[uid] = s.[schema_id]\"\r\n        .\" where o.type = 'U' order by name\";\r\n        return $this->fetchCol($sql);\r\n    }\r\n\r\nI can then pass the schema name if present on to Zend_Db_Table, avoiding this issue.\r\n\r\nI could also hack Zend_Db_Adapter_Pdo_Mssql to query for the schema name if schema name is null before calling sp_pkeys so that the sp_pkeys call returns correct results. That is probably a better solution (one that doesn't change the contract of listTables()). I don't want to change Zend classes so I am reporting this bug and using the former workaround for now."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11537\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10550",
                    "id": 10550,
                    "description": "Mini Release",
                    "name": "1.11.5",
                    "userReleaseDate": "07\/Apr\/11",
                    "archived": false,
                    "releaseDate": "2011-04-07",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47477",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "I would recommend using the sqlsrv adapter instead of pdo_mssql; the latter is very much out-dated at this time.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2011-07-12T19:13:27.000+0000",
                    "updated": "2011-07-12T19:13:27.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47490",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matt_1",
                        "name": "matt_1",
                        "displayName": "Matt Carter",
                        "active": true
                    },
                    "body": "sqlsrv doesn't support connecting to SQL Server from Linux, it is only an option for those running PHP on Windows.\r\n\r\nMy ZF-based software system runs on Linux and it connects to heterogenous databases within the organisation (PostgreSQL, MSSQL, MySQL and Sybase).\r\n\r\nIf I provide a patch or snippet will that help?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matt_1",
                        "name": "matt_1",
                        "displayName": "Matt Carter",
                        "active": true
                    },
                    "created": "2011-07-13T08:49:42.000+0000",
                    "updated": "2011-07-13T08:49:42.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11537\/transitions"
}