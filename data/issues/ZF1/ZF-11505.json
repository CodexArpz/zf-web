{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11505",
    "key": "ZF-11505",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Queue and idle connections"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11505\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=caphrim007",
                "name": "caphrim007",
                "displayName": "Tim Rupp",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-06-23T18:46:37.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-09-01T05:49:19.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I have the following in a delete method for an application I have\r\n\r\n{code}\r\n  $queue = $config->queue->get('rebuildProxyDb');\r\n  $queue = new Zend_Queue('Db', $queue->toArray());\r\n  $message = array(\r\n    'status' => true\r\n  );\r\n  $message = json_encode($message);\r\n  $queue->send($message);\r\n{code}\r\n\r\nAnd I find that if I run the above in a loop, the idle connections to my database rise and rise until ultimately it starts rejecting connections due to too many being open\r\n\r\n{code}\r\npostgres=# SELECT count(*) as cnt, usename, current_query FROM\r\npg_stat_activity GROUP BY usename,current_query ORDER BY cnt DESC;\r\n cnt | usename  |current_query\r\n-----+----------+--------------\r\n  50 | myuser   | <IDLE>\r\n{code}\r\n\r\nIf I remove the queue code, the idle connection problem goes away.\r\n\r\nCan anyone provide any insight into what would be causing this? When the method returns, I would have thought the queue variable would be cleaned up and the database connections would be all closed.\r\n\r\nunset'ing the $queue variable does not help the problem, and I do not see a way to get the database adapter back from the queue to call a closeConnection() on it."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11505\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jplock",
                "name": "jplock",
                "displayName": "Justin Plock",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10680",
                    "id": 10680,
                    "description": "Mini Release",
                    "name": "1.11.7",
                    "userReleaseDate": "02\/Jun\/11",
                    "archived": false,
                    "releaseDate": "2011-06-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10421",
                    "id": 10421,
                    "name": "Zend_Queue",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47644",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=warmans",
                        "name": "warmans",
                        "displayName": "Stefan Warman",
                        "active": true
                    },
                    "body": "I'm not sure if this is really a bug - it's possibly a feature. Zend_Queue (possibly the database adapter rather than Zend_Queue itself) seems to try and keep connections open to reuse them later thus reducing the overall number of connections but if you put the instantiation of a new Zend_Queue object into a loop it generates a new connection every time and doesn't close it if the Zend_Queue object is destroyed. Arguably it shouldn't do this  - it should realise it's already got a connection and use that but if you simply move the object creation out of the loop it will probably solve your issues (I had the same issue and I solved it this way).\r\n\r\nI had the following code in my application which would max-out my ~150 available connections in about 5 seconds if used in a loop:\r\n\r\n    protected function _getApplicationQueue($appName){\r\n        return new Zend_Queue('Db', $this->_getQueueConfig($appName));\r\n    }\r\n\r\nI replaced it with this:\r\n\r\n    protected function _getApplicationQueue($appName){\r\n        if(!isset(self::$queue[$appName]) || !self::$queue[$appName]){\r\n            self::$queue[$appName] = new Zend_Queue('Db', $this->_getQueueConfig($appName));\r\n        }\r\n        return self::$queue[$appName];\r\n    }\r\n\r\nand now only get as many connections as I have unique queues (7 in my case) regardless of the number of iterations the loop runs.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=warmans",
                        "name": "warmans",
                        "displayName": "Stefan Warman",
                        "active": true
                    },
                    "created": "2011-07-25T19:41:17.000+0000",
                    "updated": "2011-07-25T19:41:17.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47647",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=caphrim007",
                        "name": "caphrim007",
                        "displayName": "Tim Rupp",
                        "active": true
                    },
                    "body": "I'll give that a try, although I thought I found myself experiencing the same results.\r\n\r\nIn any event, I would expect a call to \"new Zend_Queue\" to literally give me a new Zend_Queue object and not carry anything over. If I were using a particular design pattern that carried stuff over, well then ok. But assignment, to me, means \"step on the old and give me the new\" and it doesn't appear to be working like that.\r\n\r\nMaybe this is expected behavior though. I would not know.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=caphrim007",
                        "name": "caphrim007",
                        "displayName": "Tim Rupp",
                        "active": true
                    },
                    "created": "2011-07-25T20:12:06.000+0000",
                    "updated": "2011-07-25T20:12:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48303",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=foodiebytes",
                        "name": "foodiebytes",
                        "displayName": "FoodieBytes",
                        "active": true
                    },
                    "body": "\r\nI ran into similar issues where sending a message in a loop was getting into a \"too many open connections\" error on MySQL. Suggestion to get the queue outside the loop is a valid one but required too much refactoring at my end, so I went in a different direction - supply the static default DB adapter or the adapter you are currently using. This will force Zend_Queue to use the existing connection.\r\n\r\n$db = new \\Zend_Queue_Adapter_Db(array('dbAdapter'=>\\Zend_Db_Table::getDefaultAdapter()));\r\n        $queue = new \\Zend_Queue($db, $options);\r\n        $queue->createQueue($queueName);\r\n        return $queue;\r\n\r\nSeems to work fine so far. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=foodiebytes",
                        "name": "foodiebytes",
                        "displayName": "FoodieBytes",
                        "active": true
                    },
                    "created": "2011-09-01T05:49:19.000+0000",
                    "updated": "2011-09-01T05:49:19.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11505\/transitions"
}