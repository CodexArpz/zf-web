{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6283",
    "key": "ZF-6283",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Search_Lucene indexing memory usage improvement."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/21",
                "name": "Performance Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6283\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-04-13T06:56:11.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-08-31T08:39:37.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The issue was originaly reported by Jurri\u00ebn Stutterheim:\r\n----------------------------------------------------------\r\nZend_Search_Lucene memory leak?\r\n\r\nI ran into a problem indexing a relatively small amount of records\r\n(+\/- 50k). Memory usage slowly rises from roughly 45MB to the memory limit of 128M (using the default merge factor of 10). When the indexing process hits the limit, I've only indexed roughly 15k documents. When using a merge factor of 5 I manage to squeeze in a few thousand extra records before running out of memory again. Executing the same code, but uncommenting the $index->addDocument() call, I happily iterate over the 50k records, using only 47MB of memory.\r\n\r\nStrangely enough I've never experienced this in a previous application, where I'd index 150k records (roughly the same size as the current ones) without a problem. Could there be a memory leak of some sorts? Or is this expected?\r\nI'm using Zend Server 4.0.1 on Mac OS X 10.5.6 with mbstring enabled\r\n(non-overloading) and set to UTF-8. I'm running the Zend_Search_Lucene from the trunk. Of course I could increase the memory limit to 256M or 512M, but that's not ideal.\r\n------------------------------------\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/customFieldOption\/10040",
                "value": " Nice to Have"
            }
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6283\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/3",
                "name": "In Progress"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30101",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "That's possible to get such behavior in some cases:\n1. PHP doesn't detect cyclic object references and doesn't destroy object structures with cyclic references. It only checks if object is not referred (using references counter) and destroys object if number of references is 0.\nZend_Search_Lucene shouldn't create such structures, but... it's better to check it again.\n\n2. Some strings operations (like .= operator) produces high level of free memory fragmentation. It increases overall memory usage. So it also should be checked.\n\n3. Index growing also increases memory usage.\n\n\nCould you perform the following experiments?\n\n1. Check amount of memory used by loaded index.\na) Create new index and add as much documents as it's possible (2-5 documents before reaching memory usage limit). Check memory usage at the end of script:\n{code}\n...\n\nvar_dump(memory_get_usage());\nvar_dump(memory_get_usage(true));\n{code}\n\nb) Open index using separate script and check memory usage:\n{code}\n$index = Zend_Search_Lucene::open($indexPath);\n\/\/ Load dictionary index structures\n$index->hasTerm(new Zend_Search_Lucene_Index_Term('dummy_data', 'dummy_fieldname'));\n\nvar_dump(memory_get_usage());\nvar_dump(memory_get_usage(true));\n{code}\n\n\n2. Check, if increasing memory usage is not caused by missing destroy operation for document objects. Use _the_same_ document object for each addDocument() operation and check memory usage during indexing (in compare to the current memory utilization).\n\n\n3. If above experiments don't give enough information, try to track document objects creation\/destroy operations (add destructor to the document object and make debug output for document creation\/destroy operations).\n\n\nPS Which Analyzer do you use for indexing? If it's UTF-8 analyzer, then it may be [ZF-4997] related problem.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2009-04-13T07:31:16.000+0000",
                    "updated": "2009-04-13T07:31:16.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30163",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=norm2782",
                        "name": "norm2782",
                        "displayName": "Jurrien Stutterheim",
                        "active": true
                    },
                    "body": "I will try and get you the result of 1.a. later today. In the mean time...\n\n1.b:\nint(1693916)\nint(2097152)\n\n2. Adding the same document to the index - using a merge factor of 10 - roughly 50k times keeps memory usage to an acceptable level. At 25k documents, the PHP process only consumes 56MB. Below is the original index method, where I manually unset the search document:\n\n{code}\npublic function addPublication(Pub_Publication $publication)\n{\n    $document = new Zend_Search_Lucene_Document();\n\n    $this->_mapper->pubToSearchDocument($publication, $document); \/\/ Only strings, booleans, and integers get added here\n\n    $this->_index->addDocument($document); \/\/ Commenting this out keeps memory consumption to 47MB\n\n    unset($document);\n}\n{code}\nIs the document retained in the index somehow?\n\nIndex setup:\n{code}\nZend_Search_Lucene_Search_QueryParser::setDefaultEncoding('utf-8');\nZend_Search_Lucene_Analysis_Analyzer::setDefault(\n    new Zend_Search_Lucene_Analysis_Analyzer_Common_Utf8Num_CaseInsensitive()\n);\n{code}\nThe problem also occurred without the UTF-8 analyzer though : )",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=norm2782",
                        "name": "norm2782",
                        "displayName": "Jurrien Stutterheim",
                        "active": true
                    },
                    "created": "2009-04-15T15:24:31.000+0000",
                    "updated": "2009-04-15T15:24:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30167",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=norm2782",
                        "name": "norm2782",
                        "displayName": "Jurrien Stutterheim",
                        "active": true
                    },
                    "body": "The indexing performed better than before this run... I managed to squeeze in roughly 45500 records before hitting the memory limit of 128MB. Not sure why it performed better this time around though...\n\nMemory usage:\n\nint(133245448)\nint(134217728)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=norm2782",
                        "name": "norm2782",
                        "displayName": "Jurrien Stutterheim",
                        "active": true
                    },
                    "created": "2009-04-15T18:43:27.000+0000",
                    "updated": "2009-04-15T18:43:27.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6283\/transitions"
}