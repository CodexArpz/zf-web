{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3994",
    "key": "ZF-3994",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Lucene optimize() consumes 64M (or more) when optimizing indices created with stock settings in ZF 1.6.0 RC2"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3994\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=brenden",
                "name": "brenden",
                "displayName": "Michael Brenden",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-08-19T02:49:46.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-04-30T01:37:12.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Lucene optimize() consumes 64M (or more) when optimizing indices created with stock settings in ZF 1.6.0 RC2.\r\n\r\nData was originally total 71,000 items, around 36MB total size after indexing with stock Lucene settings.  After setting memory_limit = 128M in \/etc\/php.ini and then re-running ZSL->optimize(), the resulting single index file (\"_2eaw.cfs\") is 31,798,340 bytes.  If memory_limit = 64M in php.ini, then ZSL->optimize() bombs.  Following two messages appeared:\r\n\r\nThis first message appeared when memory_limit = 64M and before it was increased to 128M allowing optimization to succeed:\r\n\r\n{quote}\r\nFatal error: Allowed memory size of 67108864 bytes exhausted (tried to allocate 1024 bytes) in \/var\/www\/SHARED\/ZEND_FRAMEWORK\/ZendFramework-1.6.0RC2\/library\/Zend\/Search\/Lucene\/Index\/SegmentInfo.php on line 1591\r\n{quote}\r\n\r\nThis second message appeared after optimize() succeeded (when memory_limit = 128M) and another item was added to index and memory_limit was reset to 64M in php.ini, followed by attempt to optimize() again:\r\n\r\n{quote}\r\nFatal error: Allowed memory size of 67108864 bytes exhausted (tried to allocate 71 bytes) in \/var\/www\/SHARED\/ZEND_FRAMEWORK\/ZendFramework-1.6.0RC2\/library\/Zend\/Search\/Lucene\/Index\/SegmentWriter.php on line 453\r\n{quote}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3994\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10050",
                    "id": 10050,
                    "description": "Minor Release Candidate",
                    "name": "1.6.0RC2",
                    "userReleaseDate": "11\/Aug\/08",
                    "archived": true,
                    "releaseDate": "2008-08-11",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46222",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=djteej",
                        "name": "djteej",
                        "displayName": "Trevor Smith",
                        "active": true
                    },
                    "body": "This is actually a serious issue and affects all versions of ZF that include Lucene.\r\n\r\nWhen building large indexes, and then running the optimize() method, PHP will throw a \"Allowed memory size of ... bytes exhausted\".  Since the PHP process has a set memory limit, and your index file needs to be loaded into memory for Zend Search Lucene to handle it, the ratio seems to be about 2:1 memory_limit value to index size, in order to prevent memory exhaustion.\r\n\r\nThere's probably a better way to construct the optimize() method to handle optimizing the index files, however I do not have time atm to fix this for the community.\r\n\r\nI'm not sure if anyone has found a work around for the problem, but if you are working with a very large index, say 500MB+, I have found the easiest solution is to setup a separate web service running Apache Solr and using the dataimport handler to build\/maintain the indexes.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=djteej",
                        "name": "djteej",
                        "displayName": "Trevor Smith",
                        "active": true
                    },
                    "created": "2011-04-29T19:33:34.000+0000",
                    "updated": "2011-04-29T19:33:34.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3994\/transitions"
}