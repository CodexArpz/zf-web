{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5758",
    "key": "ZF-5758",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Oracle error : '1000 ORA-01000: maximum open cursors exceeded *SELECT S_CTO_PAC.NEXTVAL FROM dual'"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5758\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=w_loche",
                "name": "w_loche",
                "displayName": "Wilfried Loche",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-02-12T05:53:05.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-01-25T11:03:24.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "11g",
                "DRCP",
                "ORA-01000",
                "Oracle",
                "cursors",
                "exceeded",
                "maximum",
                "open"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hi,\n\nI use thz ZF for a couple og years now but only for some packages. I want to use it dephly (and MVC + Zend_Db).\n\nI got an issue with the Zend_Db_Table as soon as I want to execute more SQL than I\/the DBA have\/has authorized cursors... even if they should be closed by the ZF...\n\nHere is my example:\n\n{code:title=TABLE T_CTO_PAC2|borderStyle=solid}\nCREATE TABLE \"T_CTO_PAC2\" \n(\n    \"ID_PAC\" NUMBER(38,0), \n    \"PAC\" CHAR(6 BYTE), \n    \"CID\" VARCHAR2(64 BYTE), \n    \"LABEL\" VARCHAR2(128 BYTE), \n    \"CREATED_ON\" DATE DEFAULT sysdate, \n    \"UPDATED_ON\" DATE, \n    CONSTRAINT \"CK_CTO_PAC2_CID\" CHECK (CID is not null) ENABLE, \n    CONSTRAINT \"CK_CTO_PAC2_LABEL\" CHECK (LABEL is not null) ENABLE, \n    CONSTRAINT \"PK_CTO_PAC2\" PRIMARY KEY (\"ID_PAC\") USING INDEX TABLESPACE \"CTO_INDEX\"  ENABLE, \n    CONSTRAINT \"U_CTO_PAC_PAC2\" UNIQUE (\"PAC\")  USING INDEX TABLESPACE \"CTO_INDEX\"  ENABLE\n) TABLESPACE \"CTO_DATA\";\n{code}\n\n{code:title=TPac|borderStyle=solid}\nclass TPac extends Cto_Core_Db_Table_Abstract {\n\n    \/** @var string Table name *\/\n    protected $_name = 'T_CTO_PAC2';\n    \/** @var string PK *\/\n    protected $_primary = 'ID_PAC';\n    \/** @var string Sequence name *\/\n    protected $_sequence = 'S_CTO_PAC';\n\n}\n{code}\n\n\n{code:title=sw in the indexAction()... oups!|borderStyle=solid}\n$pac = new TPac();\n\/\/$pac->getAdapter()->beginTransaction();\nfor ($i = 100; $i < 1901; ++$i) {\n    $p = str_pad($i, 6, '0', STR_PAD_LEFT);\n    \n\/\/--- This hard coded SQL string works....\n\/\/            $sql = \"insert into T_CTO_PAC2\n\/\/                    cols (ID_PAC, PAC, LABEL, CID)\n\/\/                    values (S_CTO_PAC.nextval, '$p', 'label $i', 'TEST WILL')\";\n\/\/\n\/\/            $pac->getAdapter()->query($sql);\n    \n    \/\/--- This insert through the Adapter DOESN'T work\n    $pac->getAdapter()->insert('T_CTO_PAC2',\n                               array(\n                                   'ID_PAC' => new Zend_Db_Expr('S_CTO_PAC.nextval'),\n                                   'PAC' => str_pad($i, 6, '0', STR_PAD_LEFT),\n                                   'LABEL' => \"label $i\",\n                                   'CID' => 'TEST WILL'\n                               )\n                              );\n                              \n\/\/--- This insert through the Adapter DOESN'T work either\n\/\/            $pac->insert(array('PAC' => str_pad($i, 6, '0', STR_PAD_LEFT),\n\/\/                               'LABEL' => \"label $i\",\n\/\/                               'CID' => 'TEST WILL'));\n}\n\n\/\/$pac->getAdapter()->commit();\nreturn;\n{code}\n\nThat works for $i < 200, but with $i < 1901, it breaks: \n\n{noformat}\nFatal error: Uncaught exception 'Zend_Db_Statement_Oracle_Exception' with message '1000 ORA-01000: maximum open cursors exceeded\n    *INSERT INTO T_CTO_PAC2 (ID_PAC, PAC, LABEL, CID) VALUES (S_CTO_PAC.nextval, :PAC1, :LABEL2, :CID3)'\n    in \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.7.4\/library\/Zend\/Db\/Statement\/Oracle.php:274 Stack trace: \n#0 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.7.4\/library\/Zend\/Db\/Statement.php(303): Zend_Db_Statement_Oracle->_execute(Array) \n#1 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.7.4\/library\/Zend\/Db\/Adapter\/Abstract.php(433): Zend_Db_Statement->execute(Array) \n#2 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.7.4\/library\/Zend\/Db\/Adapter\/Oracle.php(641): Zend_Db_Adapter_Abstract->query('INSERT INTO T_C...', Array) \n#3 \/ehc\/fs1\/adp\/spms\/web-app\/spms.wloche\/application\/default\/controllers\/IndexController.php(57): Zend_Db_Adapter_Oracle->insert('T_CTO_PAC2', Array) \n#4 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.7.4\/library\/Zend\/Controller\/Action.php(503): IndexController->indexAction()\n#5 \/ehc\/fs1\/softs\/s in \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.7.4\/library\/Zend\/Db\/Statement\/Oracle.php on line 274\n{noformat}\n\nDoes anybody already got this issue?\nWe got some workarroud and optimization we will propose in a next post.\n\nThx,\nWilfried Loche\n\nPS. Env :\n- PHP 5.2.8,\n- Oracle Database 11g Enterprise Edition Release 11.1.0.6.0 - 64bit Production With the Partitioning, OLAP, Data Mining and Real Application Testing options\n- tnsname.ora: SPMS11=(DESCRIPTION=(SOURCE_ROUTE=OFF)(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=xx.xx.xx.xx)(PORT=11020)))(CONNECT_DATA=(SID=SPMS11)(SERVER=)))\n- using DRCP\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/6",
                "name": "N\/A"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5758\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                "name": "mikaelkael",
                "displayName": "Mickael Perraud",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-5759",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5759",
                    "type": {
                        "name": "Dependency",
                        "direction": "INBOUND",
                        "description": "is dependecy of"
                    }
                },
                {
                    "issueKey": "ZF-5761",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5761",
                    "type": {
                        "name": "Dependency",
                        "direction": "INBOUND",
                        "description": "is dependecy of"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10280",
                    "id": 10280,
                    "description": "Mini Release",
                    "name": "1.7.4",
                    "userReleaseDate": "02\/Feb\/09",
                    "archived": false,
                    "releaseDate": "2009-02-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10133",
                    "id": 10133,
                    "name": "Zend_Db_Table",
                    "description": "Lightweight OO interface to database tables and rowsets.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30464",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=w_loche",
                        "name": "w_loche",
                        "displayName": "Wilfried Loche",
                        "active": true
                    },
                    "body": "Am I the only one who use Oracle? :D",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=w_loche",
                        "name": "w_loche",
                        "displayName": "Wilfried Loche",
                        "active": true
                    },
                    "created": "2009-04-27T06:14:00.000+0000",
                    "updated": "2009-04-27T06:14:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32324",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "body": "No, we use Oracle extensively, we just haven't had this issue.\n\nHave you tried:\n\n{code}\n$pacModel = new TPac();\n\nfor ($i = 100; $i < 1901; ++$i) {\n    $pac = $pacModel->createRow();\n    $pac->PAC = str_pad($i, 6, '0', STR_PAD_LEFT);\n    $pac->LABEL = \"label $i\";\n    $pac->CID = 'TEST WILL';\n    $pac->save();\n}\n\nreturn;\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "created": "2009-07-01T11:13:03.000+0000",
                    "updated": "2009-07-01T11:13:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33896",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=w_loche",
                        "name": "w_loche",
                        "displayName": "Wilfried Loche",
                        "active": true
                    },
                    "body": "Hi Roger,\n\nHappy to have some good news (I didn't see you answer :().\nI'm afraid I have exactly the same issue...\n\n{noformat}Fatal error<\/b>:  Uncaught exception 'Zend_Db_Statement_Oracle_Exception' with message '604 ORA-00604: error occurred at recursive SQL level 1\nORA-01000: maximum open cursors exceeded SELECT z2.*\n            FROM (\n                SELECT z1.*, ROWNUM AS &quot;zend_db_rownum&quot;\n                FROM (\n                    SELECT T_CTO_PAC2.* FROM *T_CTO_PAC2 WHERE (T_CTO_PAC2.ID_PAC = 7037.000000)\n                ) z1\n            ) z2\n            WHERE z2.&quot;zend_db_rownum&quot; BETWEEN 1 AND 1' in \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.9.1\/library\/Zend\/Db\/Statement\/Oracle.php:275\nStack trace:\n#0 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.9.1\/library\/Zend\/Db\/Statement.php(304): Zend_Db_Statement_Oracle-&gt;_execute(Array)\n#1 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.9.1\/library\/Zend\/Db\/Adapter\/Abstract.php(468): Zend_Db_Statement-&gt;execute(Array)\n#2 \/ehc\/fs1\/adp\/spms\/web-app\/spms.wloche\/library\/Cto\/Core\/Db\/Adapter\/Oracle.php(120): Zend_Db_Adapter_Abstract-&gt;query('SELECT z2.*?   ...', Array)\n#3 \/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.9. in <b>\/ehc\/fs1\/softs\/spms\/php_lib\/ZendFramework-1.9.1\/library\/Zend\/Db\/Statement\/Oracle.php<\/b> on line 275{noformat} \n\nWell... this is not he same ORA error. Seems there is a clue there:\n[http:\/\/www.dba-oracle.com\/sf_ora_00604_error_occurred_and_recursive_sql_level_string.htm]\n\nOur dba will look at it.\n\nThx,\nWilfried",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=w_loche",
                        "name": "w_loche",
                        "displayName": "Wilfried Loche",
                        "active": true
                    },
                    "created": "2009-08-25T07:39:04.000+0000",
                    "updated": "2009-08-25T07:39:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49568",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fxmauricard",
                        "name": "fxmauricard",
                        "displayName": "Fran\u00e7ois-Xavier MAURICARD",
                        "active": true
                    },
                    "body": "Oh man, you should use you DBMS the rights way :\r\n\r\n{code}\r\n$sqlQuery = 'insert into T1 (C1, C2, C3) values (:c1, :c2, :c3)';\r\n$statement = new Zend_Db_Statement_Oracle($dbAdapter, $sqlQuery);\r\nfor ($i = 100; $i < 1901; ++$i) {\r\n    $statement->execute(array(\r\n        ':c1' => 'Test C1',\r\n        ':c2' => 'Test C2',\r\n        ':c3' => 'Test C3',\r\n    ));\r\n}\r\n{code}\r\n\r\nIt's the only way to Oracle doing noparse for the query and to have the best speed. (or you could have done it with a PL\/SQL stored procedures + a VARRAY as parameter).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fxmauricard",
                        "name": "fxmauricard",
                        "displayName": "Fran\u00e7ois-Xavier MAURICARD",
                        "active": true
                    },
                    "created": "2012-01-25T11:03:24.000+0000",
                    "updated": "2012-01-25T11:03:24.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5758\/transitions"
}