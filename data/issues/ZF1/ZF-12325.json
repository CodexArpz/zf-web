{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12325",
    "key": "ZF-12325",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Mail : sending a message with setBodyText and createAttachment cause gmail to receave a blank email with a \"noname\" attachment"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12325\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=etremblay",
                "name": "etremblay",
                "displayName": "Eric Durand-Tremblay",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2012-07-06T20:26:48.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-07-06T20:26:48.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "This is caused by Zend_Mail_Transport_Abstract::_buildBody() appending the text part \"Content-Disposition\" headers to the message top headers.\r\n\r\nI think there is a conflict between the \"Content-Disposition: inline\" header and the \"Content-Type: multipart\/mixed;\"\r\n\r\nHere is a snipplet of code to reproduce\r\n\r\n{code}\r\n$transport = new \\Zend_Mail_Transport_Smtp($smtpHost);\r\n\\Zend_Mail::setDefaultTransport($transport);\r\n\r\n$mail = new \\Zend_Mail('UTF-8');\r\n$mail->setFrom('asdf@asdf.com', 'ASDF')\r\n     ->setSubject('Subject')\r\n     ->setBodyText('Body')\r\n     ->addTo('asdf2@asdf.com', 'ASDF2');\r\n\t\t\t\t\t\t\t\r\n$attachment = $mail->createAttachment(file_get_contents($path));\r\n$attachment->type = 'application\/pdf';\r\n$attachment->disposition = \\Zend_Mime::DISPOSITION_ATTACHMENT;\r\n$attachment->filename = 'Test.pdf';\t\t\t\r\n$mail->send();\r\n{code}\r\n\r\n\r\nThe resulting header look like this :\r\n\r\n{code}\r\nFrom: asdf@asdf.com\r\nSubject: ASDF\r\nTo: asdf2@asdf.com\r\nDate: Fri, 06 Jul 2012 11:31:23 -0400\r\nContent-Type: multipart\/mixed;\r\n boundary=\"=_07cc44413e2aa6b79877aba401f7f090\"\r\nContent-Transfer-Encoding: quoted-printable\r\nContent-Disposition: inline\r\nMIME-Version: 1.0\r\n{code}\r\n\r\nAs I understand it, the body part headers are copied to the message header for the case when the whole message is plain text without attachment.  For both case to work, we have to check if there is only one part in the message.\r\n\r\nHere is my patch\r\n\r\n{code}\r\ndiff --git a\/lib\/Zend\/Mail\/Transport\/Abstract.php b\/lib\/Zend\/Mail\/Transport\/Abstract.php\r\nindex 1d225a3..14d74cb 100644\r\n--- a\/lib\/Zend\/Mail\/Transport\/Abstract.php\r\n+++ b\/lib\/Zend\/Mail\/Transport\/Abstract.php\r\n@@ -284,14 +284,18 @@ abstract class Zend_Mail_Transport_Abstract\r\n             throw new Zend_Mail_Transport_Exception('No body specified');\r\n         }\r\n \r\n-        \/\/ Get headers\r\n-        $this->_headers = $this->_mail->getHeaders();\r\n-        $headers = $body->getHeadersArray($this->EOL);\r\n-        foreach ($headers as $header) {\r\n-            \/\/ Headers in Zend_Mime_Part are kept as arrays with two elements, a\r\n-            \/\/ key and a value\r\n-            $this->_headers[$header[0]] = array($header[1]);\r\n-        }\r\n+               \/\/ Get headers\r\n+               $this->_headers = $this->_mail->getHeaders();\r\n+\r\n+               if(count($this->_parts) == 1 ){\r\n+                       \/\/ Copy the body headers into the message header        \r\n+                       $headers = $body->getHeadersArray($this->EOL);\r\n+                       foreach ($headers as $header) {\r\n+                               \/\/ Headers in Zend_Mime_Part are kept as arrays with two elements, a\r\n+                               \/\/ key and a value\r\n+                               $this->_headers[$header[0]] = array($header[1]);\r\n+                       }\r\n+               }\r\n     }\r\n \r\n     \/**\r\n{code}\r\n\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12325\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                "name": "freak",
                "displayName": "Dolf Schimmel (Freeaqingme)",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/11080",
                    "id": 11080,
                    "description": "Mini Release",
                    "name": "1.11.12",
                    "userReleaseDate": "22\/Jun\/12",
                    "archived": false,
                    "releaseDate": "2012-06-22",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10018",
                    "id": 10018,
                    "name": "Zend_Mail",
                    "description": "high-level utility to build MIME-compliant messages and send using a mail transport adapter",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [

            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12325\/transitions"
}