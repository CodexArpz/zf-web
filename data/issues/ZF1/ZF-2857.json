{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2857",
    "key": "ZF-2857",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Search_Lucene_Query::highlightMatches doesn't take the Analyzers encoding into account"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2857\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=dlx",
                "name": "dlx",
                "displayName": "Stefan Oestreicher",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-03-11T04:57:01.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-08-31T09:13:44.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Zend_Search_Lucene_Query::highlightMatches doesn't ensure that the highlighted text has the same encoding as the the analyzer uses to extract the tokens. This results in wrong token offsets and ultimately breaks the highlighting.\r\n\r\nTo reproduce just pass a multibyte string to the method while using the default analyzer. One can easily work around this issue by converting the text manually to ASCII\/\/TRANSLIT before invoking highlightMatches.\r\n\r\nCurrently the code in Zend_Search_Lucene_Document_Html::_highlightTextNode looks like this:\r\n\r\n{code}\r\n$analyzer = Zend_Search_Lucene_Analysis_Analyzer::getDefault();\r\n$analyzer->setInput($node->nodeValue, $this->_doc->encoding); \/\/converts from _doc->encoding to ASCII\/\/TRANSLIT\r\nforeach ($matchedTokens as $token) {\r\n    \/\/ Cut text after matched token\r\n    $node->splitText($token->getEndOffset()); \/\/uses wrong character offset\r\n    \/\/ ...\r\n}\r\n{code}\r\n\r\nI suggest to provide a method in the analyzer to convert any text to its internal encoding and invoke this function before creating the Zend_Search_Lucene_Document_Html instance like this (in Zend_Search_Lucene_Search_Query::highlightMatches):\r\n{code}\r\n$input = Zend_Search_Lucene_Analysis_Analyzer::getDefault()->encode($inputHTML);\r\n$doc = Zend_Search_Lucene_Document_Html::loadHTML($input);\r\n{code}\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/5",
                "name": "Trivial"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/customFieldOption\/10039",
                "value": "  Should Have"
            }
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2857\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-3626",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3626",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                },
                {
                    "issueKey": "ZF-11292",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11292",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10031",
                    "id": 10031,
                    "description": "Major Release",
                    "name": "1.0.0",
                    "userReleaseDate": "30\/Jun\/07",
                    "archived": true,
                    "releaseDate": "2007-06-30",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10110",
                    "id": 10110,
                    "description": "Mini Release",
                    "name": "1.0.1",
                    "userReleaseDate": "30\/Jul\/07",
                    "archived": true,
                    "releaseDate": "2007-07-30",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10130",
                    "id": 10130,
                    "description": "Mini Release",
                    "name": "1.0.2",
                    "userReleaseDate": "25\/Sep\/07",
                    "archived": true,
                    "releaseDate": "2007-09-25",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10140",
                    "id": 10140,
                    "description": "Mini Release",
                    "name": "1.0.3",
                    "userReleaseDate": "30\/Nov\/07",
                    "archived": true,
                    "releaseDate": "2007-11-30",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10170",
                    "id": 10170,
                    "description": "Mini Release",
                    "name": "1.0.4",
                    "userReleaseDate": "26\/Feb\/08",
                    "archived": true,
                    "releaseDate": "2008-02-26",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10171",
                    "id": 10171,
                    "description": "Minor Release Candidate",
                    "name": "1.5.0RC1",
                    "userReleaseDate": "26\/Feb\/08",
                    "archived": true,
                    "releaseDate": "2008-02-26",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/20249",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Please categorize\/fix as needed.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-03-25T20:31:42.000+0000",
                    "updated": "2008-03-25T20:31:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21722",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wb-hornbill",
                        "name": "wb-hornbill",
                        "displayName": "WIlliam Bailey",
                        "active": true
                    },
                    "body": "{code:title=Unit Test|borderStyle=solid}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wb-hornbill",
                        "name": "wb-hornbill",
                        "displayName": "WIlliam Bailey",
                        "active": true
                    },
                    "created": "2008-05-13T00:51:30.000+0000",
                    "updated": "2008-05-13T00:51:30.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21723",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wb-hornbill",
                        "name": "wb-hornbill",
                        "displayName": "WIlliam Bailey",
                        "active": true
                    },
                    "body": "If it helps here is an example unit test that highlights this issue.\n\n\n{code:title=Example Unit Test|borderStyle=solid}\n    public function testHighlightMatches()\n    {\n        Zend_Search_Lucene_Analysis_Analyzer::setDefault(new Zend_Search_Lucene_Analysis_Analyzer_Common_Utf8_CaseInsensitive());\n        Zend_Search_Lucene_Search_QueryParser::setDefaultEncoding('utf-8');\n        \n        $query = Zend_Search_Lucene_Search_QueryParser::parse('email');\n        \/\/ - == \\u2013 or &#8211;\n        $html  = trim('\n<!DOCTYPE html PUBLIC \"-\/\/W3C\/\/DTD XHTML 1.0 Transitional\/\/EN\" \"http:\/\/www.w3.org\/TR\/xhtml1\/DTD\/xhtml1-transitional.dtd\">\n<html>\n<head><meta http-equiv=\"Content-Type\" content=\"text\/html; charset=UTF-8\"><\/head>\n<body>\n<p>For example - POP3 - will get email via telnet. With Exchange and Lotus Notes we use client software to connect\/retrieve email.<\/p>\n<\/body>\n<\/html>\n');\n        $expectedHighlight = trim('For example - POP3 - will get <b style=\"color:black;background-color:#66ffff;\">email<\/b> via telnet. With Exchange and Lotus Notes we use client software to connect\/retrieve <b style=\"color:black;background-color:#66ffff;\">email<\/b>.');\n        $highlight = trim(preg_replace('~^.*<p>(:?.*)<\/p>.*$~iUs', '\\1', $query->highlightMatches($html)));\n        $this->assertEquals($expectedHighlight, $highlight);\n    }\n\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wb-hornbill",
                        "name": "wb-hornbill",
                        "displayName": "WIlliam Bailey",
                        "active": true
                    },
                    "created": "2008-05-13T00:59:50.000+0000",
                    "updated": "2008-05-13T00:59:50.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2857\/transitions"
}