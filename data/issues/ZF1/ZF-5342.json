{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5342",
    "key": "ZF-5342",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Mysqli::__connect() forget to reset internal mysqli _connection object when connection failed"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5342\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10330",
                    "id": 10330,
                    "description": "Mini Release",
                    "name": "1.8.2",
                    "userReleaseDate": "27\/May\/09",
                    "archived": false,
                    "releaseDate": "2009-05-27",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-05-15T18:32:48.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=belgattitude",
                "name": "belgattitude",
                "displayName": "S\u00e9bastien Vanvelthem",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-12-23T06:36:25.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-08-03T15:33:11.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Just found a minor issue with MySQLi::connect(). \r\n\r\nThe test made to see if the mysqli connection succeed is based on 2 conditions : $this->_connection and mysqli_connect_errno(). In case of failure with mysql_connect_errno(), we need to clear\/unset the value of $this->_connection (which is a \"false\" mysqli object = an empty mysqli object with no real link to the database - sorry for approximative english :). \r\n\r\nThe problem is that the entire class relies on existence of $this->_connection to see if the connection is active. In some circumstances, (i.e. ZF-3984) the connection exception can be catched by a calling class and ignored, all subsequent calls will think that the connection is effective (because Mysqli::_connection is an object) and write warnings which are undesirable and hard to debug. \r\n\r\nI think fixing the bug is just one line... read the proposed solution below and hope that it will work \r\n\r\nThanks to Zend guys, it's an amazing job you do...\r\n\r\nSeb\r\n\r\n\r\nSolution attempt :\r\n\r\n[original]\r\n{code}\r\nif ($this->_connection === false || mysqli_connect_errno()) {\r\n         require_once 'Zend\/Db\/Adapter\/Mysqli\/Exception.php';\r\n         throw new Zend_Db_Adapter_Mysqli_Exception(mysqli_connect_error());\r\n}\r\n{code}\r\n\r\n[patched]\r\n{code}\r\nif ($this->_connection === false || mysqli_connect_errno()) {\r\n       \/\/ THE connection error was given with mysqli_connect_errno, the value of $this->_connection is a \"invalid\" mysqli object. So I reset it\r\n        $this->_connection = false; \r\n        require_once 'Zend\/Db\/Adapter\/Mysqli\/Exception.php';\r\n        throw new Zend_Db_Adapter_Mysqli_Exception(mysqli_connect_error());\r\n}\r\n{code}\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5342\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                "name": "satoruyoshida",
                "displayName": "Satoru Yoshida",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-3984",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3984",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10270",
                    "id": 10270,
                    "description": "Mini Release",
                    "name": "1.7.1",
                    "userReleaseDate": "01\/Dec\/08",
                    "archived": false,
                    "releaseDate": "2008-12-01",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10131",
                    "id": 10131,
                    "name": "Zend_Db_Adapter_Mysqli",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/27620",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=belgattitude",
                        "name": "belgattitude",
                        "displayName": "S\u00e9bastien Vanvelthem",
                        "active": true
                    },
                    "body": "An example of the same issue when database connection fails because of \"Too many open links\". ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=belgattitude",
                        "name": "belgattitude",
                        "displayName": "S\u00e9bastien Vanvelthem",
                        "active": true
                    },
                    "created": "2008-12-23T06:38:31.000+0000",
                    "updated": "2008-12-23T06:38:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/27621",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=belgattitude",
                        "name": "belgattitude",
                        "displayName": "S\u00e9bastien Vanvelthem",
                        "active": true
                    },
                    "body": "Solution with formatted code, for ZF 1.7.1 Zend_Db_Adapter_Mysqli::_connect() method\n\n{code}\n\n        if ($this->_connection === false || mysqli_connect_errno()) {\n            \/**\n             * @see Zend_Db_Adapter_Mysqli_Exception\n             *\/\n            {color:red}\n           \/\/ unsetting invalid mysql object\n            $this->_connection = false;;\n           {color}\n            require_once 'Zend\/Db\/Adapter\/Mysqli\/Exception.php';\n            throw new Zend_Db_Adapter_Mysqli_Exception(mysqli_connect_error());\n        }\n\n{code} \n\nPS: take a look at ZF-3984, this attempt brings a solution for that (mysqli_real_escape wont't be called, the exception will be thrown as expected), but there's maybe some reasons to look deeper, to see why the quote method was called even if the connection failed (lazy connect mode ?).\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=belgattitude",
                        "name": "belgattitude",
                        "displayName": "S\u00e9bastien Vanvelthem",
                        "active": true
                    },
                    "created": "2008-12-23T06:53:59.000+0000",
                    "updated": "2008-12-23T06:53:59.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30883",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yoshida@zend.co.jp",
                        "name": "yoshida@zend.co.jp",
                        "displayName": "old of Satoru Yoshida",
                        "active": true
                    },
                    "body": "Is this still active?\nThe description seems to be outdated.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yoshida@zend.co.jp",
                        "name": "yoshida@zend.co.jp",
                        "displayName": "old of Satoru Yoshida",
                        "active": true
                    },
                    "created": "2009-05-11T23:07:31.000+0000",
                    "updated": "2009-05-11T23:07:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31052",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yoshida@zend.co.jp",
                        "name": "yoshida@zend.co.jp",
                        "displayName": "old of Satoru Yoshida",
                        "active": true
                    },
                    "body": "Solved by ZF-3984",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yoshida@zend.co.jp",
                        "name": "yoshida@zend.co.jp",
                        "displayName": "old of Satoru Yoshida",
                        "active": true
                    },
                    "created": "2009-05-15T18:32:46.000+0000",
                    "updated": "2009-05-15T18:32:46.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5342\/transitions"
}