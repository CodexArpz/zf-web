{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5670",
    "key": "ZF-5670",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Fix to Front Controller and ErrorHandler helper to work when throwing an exception in the router"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/11",
                "name": "Patch",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5670\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=sc0ttdav3y",
                "name": "sc0ttdav3y",
                "displayName": "Scott Davey",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-02-01T20:17:06.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-05-28T13:15:28.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "controller",
                "exception",
                "front",
                "router"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The design of Zend_Controller_Front::dispatch() has two levels of try\/catch and handles exceptions thrown in routing separately from exceptions thrown during dispatch.  This means that exceptions thrown in the router will not be picked up by Zend_Controller_Plugin_ErrorHandler because the entire dispach loop never runs.\n\nIt seems valid to be able to throw exceptions during routing; in fact, the API recommends throwing a Zend_Controller_Router_Exception.  But currently this prevents ErrorHandler from being able to reroute to the ErrorController.\n\nI have a working patch that corrects this behaviour (tested against ZF 1.7.3).  \n\nIt essentially wraps another try\/catch around the routing functions, and alters ErrorHandler to check for exceptions in both preDispatch() and postDispatch().  preDispatch is needed to switch to the ErrorHandler before dispatching if an exception occurred during routing.\n\nSorry this is not in a patch format, but it is easy to apply.  When I get some more time on this I'll create and upload a diff file, but in the meantime the code changes are reproduced below.\n\n1.   Replace lines 893 - 916 in Zend_Controller_Front with the following:\n\n{code:title=Zend_Controller_Front |borderStyle=solid}\n            try {\n\t            \/**\n\t            * Notify plugins of router startup\n\t            *\/\n\t            $this->_plugins->routeStartup($this->_request);\n\n\t            $router->route($this->_request);\n\n\t            \/**\n\t            * Notify plugins of router completion\n\t            *\/\n\t            $this->_plugins->routeShutdown($this->_request);\n\n\t            \/**\n\t             * Notify plugins of dispatch loop startup\n\t             *\/\n\t            $this->_plugins->dispatchLoopStartup($this->_request);\n\n        \t} catch (Exception $e) {\n        \t    if ($this->throwExceptions()) {\n        \t        throw $e;\n        \t        }\n        \t    $this->_response->setException($e);\n        \t}\n{code}\n\n2.   And add the following into Zend_Controller_Plugin_ErrorHandler (begins line 189)\n\n{code:title=Zend_Controller_Plugin_ErrorHandler |borderStyle=solid}\n    \/**\n     * preDispatch() plugin hook -- check for exceptions during routing and\n     * dispatches the error handler if necessary\n     *\n     * @see {@link Zend_Controller_Plugin_ErrorHandler::_handleException}\n     * @param  Zend_Controller_Request_Abstract $request\n     * @return void\n     *\/\n    public function preDispatch(Zend_Controller_Request_Abstract $request)\n    {\n    \t$this->_handleException($request);\n    }\n\n\n    \/**\n     * postDispatch() plugin hook -- check for exceptions during the dispatch\n     * loop and dispatches the error handler if necessary\n     *\n     * @see {@link Zend_Controller_Plugin_ErrorHandler::_handleException}\n     * @param  Zend_Controller_Request_Abstract $request\n     * @return void\n     *\/\n    public function postDispatch(Zend_Controller_Request_Abstract $request)\n    {\n    \t$this->_handleException($request);\n    }\n\n    \/**\n     * Check for exceptions and dispatch error handler if necessary\n     *\n     * If the 'noErrorHandler' front controller flag has been set,\n     * returns early.\n     *\n     * @param  Zend_Controller_Request_Abstract $request\n     * @return void\n     *\/\n    private function _handleException(Zend_Controller_Request_Abstract $request)\n    {\n    \t\/\/ ... code that used to be in postDispatch() goes in here verbatim\n    }\n\n{code}\n\nNote that the current code inside postDispatch() now does into the private _handleException()\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5670\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10250",
                    "id": 10250,
                    "description": "Mini Release",
                    "name": "1.7.3",
                    "userReleaseDate": "19\/Jan\/09",
                    "archived": false,
                    "releaseDate": "2009-01-19",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10011",
                    "id": 10011,
                    "name": "Zend_Controller",
                    "description": "front controller, including router and dispatcher",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46867",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "body": "Is this still valid?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kblomqvist",
                        "name": "kblomqvist",
                        "displayName": "Kim Blomqvist",
                        "active": true
                    },
                    "created": "2011-05-28T13:15:28.000+0000",
                    "updated": "2011-05-28T13:15:28.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5670\/transitions"
}