{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2739",
    "key": "ZF-2739",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Select and Oracle with clause limit()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2739\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2008-03-17T19:23:21.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                "name": "mikaelkael",
                "displayName": "Mickael Perraud",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-02-27T12:57:18.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2008-05-28T11:02:06.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Until rev.7576, the implementation of the clause limit() functioned in Oracle.\nThe new operation of __toString() broke the functionality.\n\nFor information: Oracle has no clause limit(), we must simulate it with subqueries and ROWNUM.\nSo we obtain a string like this: \"SUBQUERY . SQL . SUBQUERY\".\n\nThe new __toString() implode the differents elements.\n\nInstead of:\n{code}\nSELECT z2.* FROM\n  ( SELECT ROWNUM AS zend_db_rownum, z1.* FROM ( \n       SELECT tab_charge.num_charge\n       FROM tab_charge\n       ORDER BY date_charge DESC ) z1\n ) z2\nWHERE z2.zend_db_rownum BETWEEN 1 AND 15\n{code}\n\nI have:\n{code}\nSELECT tab_charge.num_charge\nFROM tab_charge\nORDER BY date_charge DESC\nSELECT z2.* FROM\n  ( SELECT ROWNUM AS zend_db_rownum, z1.* FROM (  ) z1\n ) z2\nWHERE z2.zend_db_rownum BETWEEN 1 AND 15\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/6",
                "name": "N\/A"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2739\/watchers",
                "isWatching": false,
                "watchCount": 5
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=peptolab",
                "name": "peptolab",
                "displayName": "Simon Mundy",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10132",
                    "id": 10132,
                    "name": "Zend_Db_Select",
                    "description": "OO interface to building a SELECT SQL query.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/19445",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=darby",
                        "name": "darby",
                        "displayName": "Darby Felton",
                        "active": true
                    },
                    "body": "Assigning to [~peptolab] for initial review.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=darby",
                        "name": "darby",
                        "displayName": "Darby Felton",
                        "active": true
                    },
                    "created": "2008-02-27T13:11:47.000+0000",
                    "updated": "2008-02-27T13:11:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/19862",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                        "name": "mikaelkael",
                        "displayName": "Mickael Perraud",
                        "active": true
                    },
                    "body": "Andre Vignaud in [this message|http:\/\/www.nabble.com\/Why-does-this-snippet-%28using-Oracle-adapter%29-produce-broken-SQL--td15997769s16154.html] propose modifications in Zend_Db_Select:\n\n{code}\n-   protected function _renderLimitoffset()\n+   protected function _renderLimitoffset($sql)\n    {\n        $count = 0;\n        $offset = 0;\n\n        if (!empty($this->_parts[self::LIMIT_OFFSET])) {\n            $offset = (int) $this->_parts[self::LIMIT_OFFSET];\n            \/\/ This should reduce to the max integer PHP can support\n            $count = intval(9223372036854775807);\n        }\n\n        if (!empty($this->_parts[self::LIMIT_COUNT])) {\n            $count = (int) $this->_parts[self::LIMIT_COUNT];\n        }\n\n        \/*\n         * Add limits clause\n         *\/\n        if ($count > 0) {\n-           return trim($this->_adapter->limit('', $count, $offset));\n+           return trim($this->_adapter->limit($sql, $count, $offset));\n        }\n\n-        return null;\n+        return $sql;\n    }\n{code}\n\nand\n\n{code}\n    public function __toString()\n    {\n        $sql = array(self::SQL_SELECT);\n        foreach (array_keys(self::$_partsInit) as $part) {\n            $method = '_render' . ucfirst($part);\n            if (method_exists($this, $method)) {\n-               $sql[] = $this->$method();\n+               if ( $part == self::LIMIT_OFFSET ) { \n+                   $sql = array($this->_renderLimitoffset(implode(' ', array_filter($sql)))); \n+               } else { \n+                   $sql[] = $this->$method(); \n+               }\n            }\n        }\n        return implode(' ', array_filter($sql));\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                        "name": "mikaelkael",
                        "displayName": "Mickael Perraud",
                        "active": true
                    },
                    "created": "2008-03-12T05:54:42.000+0000",
                    "updated": "2008-03-12T05:54:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/19870",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=peptolab",
                        "name": "peptolab",
                        "displayName": "Simon Mundy",
                        "active": true
                    },
                    "body": "I've refactored Zend_Db_Select to more gracefully handle the various transformations to the query. Can you please verify the limit() method is now behaving itself?\n\nFixed in trunk r8784",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=peptolab",
                        "name": "peptolab",
                        "displayName": "Simon Mundy",
                        "active": true
                    },
                    "created": "2008-03-12T09:05:10.000+0000",
                    "updated": "2008-03-12T09:05:10.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21249",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Was this fixed in 1.5.1? If not, could you get it verified, merge back to 1.5 branch, and mark it fixed for 1.5? If so, could you mark it fixed for 1.5.1?\n\nThanks.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-04-21T15:03:16.000+0000",
                    "updated": "2008-04-21T15:03:16.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21253",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                        "name": "mikaelkael",
                        "displayName": "Mickael Perraud",
                        "active": true
                    },
                    "body": "This was fixed effectively for me in r\u00e9v. 8784 (for 1.5.1) but not merge back to 1.5.0.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                        "name": "mikaelkael",
                        "displayName": "Mickael Perraud",
                        "active": true
                    },
                    "created": "2008-04-21T15:41:54.000+0000",
                    "updated": "2008-04-21T15:41:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21982",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gabriel",
                        "name": "gabriel",
                        "displayName": "Gabriel Baez",
                        "active": true
                    },
                    "body": "I'm using    Zend Framework 1.5.2  and this function is not working for me,    I get the following error:\n\nSQLSTATE[HY000]: General error: 918 OCIStmtExecute: ORA-00918: column ambiguously defined\n\n (ext\\pdo_oci\\oci_statement.c:146)\n\n\nPHO Code:\n\n$select = $this->db->select()\n\t\t\t                                     ->from(array('p' => 'HARDWARE_JOBS_VW'),\n\t\t\t\t\t\t\t\t                        array('HARDWARE_ID','NAME','ACCOUNT','PASSWORD','TYPE_NAME','GROUP_ID','PLATFORM_NAME'))\t\t\t\t\t\t\t\t                \n\t\t\t\t\t\t\t\t                 ->join(array('pf' =>'USERS_IN_GROUPS'),\n\t\t\t\t\t\t\t\t                              'p.GROUP_ID=pf.GROUP_ID')\t\t\t\t\t\t\t\t                 \t\t\t\t\t          \n\t\t\t\t\t\t\t\t                 ->where('pf.USER_ID= ?', $id)\t\t\t\t\t\t\t\t                 \n\t\t\t\t\t\t\t\t                 ->where('p.GROUP_ID= ?',$groupid)\n\t\t\t\t\t\t\t\t                 ->limit($page,$limit);\n\n\t\t\t\t  $stm = $this->db->query($select); ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gabriel",
                        "name": "gabriel",
                        "displayName": "Gabriel Baez",
                        "active": true
                    },
                    "created": "2008-05-28T06:25:56.000+0000",
                    "updated": "2008-05-28T06:25:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21983",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gabriel",
                        "name": "gabriel",
                        "displayName": "Gabriel Baez",
                        "active": true
                    },
                    "body": "This is the output from __toString();\n               \n{quote}\nSELECT z2.*\n\n            FROM (\n\n                SELECT ROWNUM AS zend_db_rownum, z1.*\n\n                FROM (\n\n                    SELECT p.HARDWARE_ID, p.NAME, p.ACCOUNT, p.PASSWORD, p.TYPE_NAME, p.GROUP_ID, p.PLATFORM_NAME\n\n, pf.* FROM HARDWARE_JOBS_VW p\n\n INNER JOIN USERS_IN_GROUPS pf ON p.GROUP_ID=pf.GROUP_ID WHERE (pf.USER_ID= '8') AND (p.GROUP_ID= '21'\n\n)\n\n                ) z1\n\n            ) z2\n\n            WHERE z2.zend_db_rownum BETWEEN 11 AND 11\n{\/quote}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gabriel",
                        "name": "gabriel",
                        "displayName": "Gabriel Baez",
                        "active": true
                    },
                    "created": "2008-05-28T06:30:56.000+0000",
                    "updated": "2008-05-28T06:30:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21985",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                        "name": "mikaelkael",
                        "displayName": "Mickael Perraud",
                        "active": true
                    },
                    "body": "Hi,\n\nIt is not due to the limit() part but this is due to \"join(array('pf' =>'USERS_IN_GROUPS')\".\nIn this you select also pf.GROUP_ID so in Z1, you have p.GROUP_ID and pf.GROUP_ID.\nTo resolve this you can add an alias to the first table like this:\n{code:sql}\n$select = $this->db->select()\n->from(array('p' => 'HARDWARE_JOBS_VW'),\narray('HARDWARE_ID','NAME','ACCOUNT','PASSWORD','TYPE_NAME','gid'=>'GROUP_ID','PLATFORM_NAME'))\n->join(array('pf' =>'USERS_IN_GROUPS'),\n'p.GROUP_ID=pf.GROUP_ID')\n->where('pf.USER_ID= ?', $id)\n->where('p.GROUP_ID= ?',$groupid)\n->limit($page,$limit);\n\n$stm = $this->db->query($select); \n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                        "name": "mikaelkael",
                        "displayName": "Mickael Perraud",
                        "active": true
                    },
                    "created": "2008-05-28T09:11:54.000+0000",
                    "updated": "2008-05-28T09:11:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21991",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gabriel",
                        "name": "gabriel",
                        "displayName": "Gabriel Baez",
                        "active": true
                    },
                    "body": "Thanks that fixed it.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gabriel",
                        "name": "gabriel",
                        "displayName": "Gabriel Baez",
                        "active": true
                    },
                    "created": "2008-05-28T11:02:06.000+0000",
                    "updated": "2008-05-28T11:02:06.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2739\/transitions"
}