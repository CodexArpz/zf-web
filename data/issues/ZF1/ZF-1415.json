{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1415",
    "key": "ZF-1415",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Module route always prepends 'default' in assemble() method"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1415\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10023",
                    "id": 10023,
                    "description": "Release Candidate 1",
                    "name": "1.0.0 RC1",
                    "userReleaseDate": "28\/May\/07",
                    "archived": true,
                    "releaseDate": "2007-05-28",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2007-05-27T10:03:44.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=peptolab",
                "name": "peptolab",
                "displayName": "Simon Mundy",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-05-22T02:23:36.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2007-07-05T14:44:11.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I've got my front controller set up with a reasonably standard bootstrap:-\n{code}\n\/\/ Get front controller\n$front = Zend_Controller_Front::getInstance();\n\n\/\/ Set up router\n$router = $front->getRouter();\n$router->addRoute('business', new Zend_Controller_Router_Route(...etc...));\n\n\/\/ Create front controller, configure and dispatch\n$front->setParam('config', $config)\n      ->setParam('useGlobalDefault', true)\n      ->setRouter($router)\n      ->setControllerDirectory(array('default' => realpath('..\/application\/default\/controllers'),\n                                     'business' => realpath('..\/application\/business\/controllers')))\n      ->dispatch();\n{code}\n\nIf I use the default View helper url() to output a 'default' route like so within my view templartes:-\n{code}\n<?php echo $this->url(array('controller' => 'foo', 'action' => bar), 'default', true) ?>\n\nor \n\n<?php echo $this->url(array('controller' => 'foo', 'action' => bar), null, true) ?>\n\nyields:-\n\n\/default\/foo\/bar\/\n{code}\n\nIt appears that the code within Zend_Controller_Router_Route_Module attempts to suppress the module segment from a path if it matches the default module, however the logic in this case will always mean that default is still prepended:-\n{code}\n        if (isset($module) && (!empty($url) || $module !== $this->_defaults[$this->_moduleKey])) {\n            $url = '\/' . $module . $url;\n        }\n{code}\nBecause $module is already set and in the above use case the $url is not empty, it automatically executes the conditional.\n\nThe solution would be to switch the order to the following, so that it first tests that the module is not the default and also checks that the URL is non-empty.\n{code}\n        if (isset($module) && ($module !== $this->_defaults[$this->_moduleKey] || !empty($url))) {\n            $url = '\/' . $module . $url;\n        }\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1415\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=martel",
                "name": "martel",
                "displayName": "Michal Minicki",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10080",
                    "id": 10080,
                    "description": "Beta Release; bug fixes",
                    "name": "0.9.3",
                    "userReleaseDate": "05\/May\/07",
                    "archived": true,
                    "releaseDate": "2007-05-05",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10011",
                    "id": 10011,
                    "name": "Zend_Controller",
                    "description": "front controller, including router and dispatcher",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14797",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=martel",
                        "name": "martel",
                        "displayName": "Michal Minicki",
                        "active": true
                    },
                    "body": "Simon, look at it more closely - you have just reversed (bool1 || bool2) into (bool2 || bool1). It changes nothing, actually.\n\nI see your point though and tried to fix t so the following test passes:\n\n{code}\n        $values = $this->route->match('mod\/con\/act\/sort\/name');\n\n        $url = $this->route->assemble(array('action' => 'new'), true);\n\n        $this->assertSame('defctrl\/new', $url);\n{code}\n\nPreviously it matched:\n\n{code}\n        $this->assertSame('default\/defctrl\/new', $url);\n{code}\n\nHope it's what you wished to accomplish. If not, please reopen and give some more code to reproduce. Yours passes - see tests testAssembleDefaultModuleResetZF1415 and testAssembleDefaultModuleZF1415.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=martel",
                        "name": "martel",
                        "displayName": "Michal Minicki",
                        "active": true
                    },
                    "created": "2007-05-25T12:14:03.000+0000",
                    "updated": "2007-05-25T12:14:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14816",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=peptolab",
                        "name": "peptolab",
                        "displayName": "Simon Mundy",
                        "active": true
                    },
                    "body": "Hi Martel\n\nThis fix has created another issue with 'defaults' - consider the following two modules routes:-\n\ndefault\/index\/index\nmymodule\/index\/index\n\nIf my current module is 'default' and I call (from a Zend_View) $this->url(array('module' => 'mymodule', 'controller' => 'index', 'action' => 'index')) the following happens:-\n\n* The $action variable is not added to $url because it matches the default ( = index). $url is empty.\n* The $controller variable is not added to $url because it too matches the default ( = index)\n* Because $url is empty, the check for $module is skipped because of the && clause. So my $url stays empty.\n\nSo both of the above assembled routes still give me '\/' as a URL :(\n\nSince you've improved the check for the $module variable, simply changing the code from (isset($module) && empty($url)) could be shortened to (isset($module)).\n\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=peptolab",
                        "name": "peptolab",
                        "displayName": "Simon Mundy",
                        "active": true
                    },
                    "created": "2007-05-27T08:56:47.000+0000",
                    "updated": "2007-05-27T08:56:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14817",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=martel",
                        "name": "martel",
                        "displayName": "Michal Minicki",
                        "active": true
                    },
                    "body": "My bad (I forgot to change && to ||). But it seems module check is in fact sufficient. Thanks for the catch, Simon.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=martel",
                        "name": "martel",
                        "displayName": "Michal Minicki",
                        "active": true
                    },
                    "created": "2007-05-27T10:03:44.000+0000",
                    "updated": "2007-05-27T10:03:44.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1415\/transitions"
}