{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7427",
    "key": "ZF-7427",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Adapter_Oracle->describeTable() does not perform acceptably on large databases"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/21",
                "name": "Performance Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7427\/votes",
                "votes": 3,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=asgeo1",
                "name": "asgeo1",
                "displayName": "Adam George",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-07-30T20:35:55.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-06-21T20:39:50.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The Zend_Db_Adapter_Oracle->describeTable() function will not perform on large databases.\n\nThe reason is that this function queries some large, key tables such as ALL_TAB_COLUMNS, ALL_CONSTRAINTS, but the joins\/filters are written in a way which they will tablescan the database rather than use any indexes efficiently.\n\nOn smaller databases this would not even be noticeable. But we have large oracle databases at work, with many objects in them, and so these queries are table-scanning and will not finish executing for us.\n\nWith some simple changes I was able to fix these performance issues. This is my re-written function:\n\n{code:javascript}\n    public function describeTable($tableName, $schemaName = null)\n    {\n        $version = $this->getServerVersion();\n        if (($version === null) || version_compare($version, '9.0.0', '>=')) {\n\t\t\t$sql = \"\tSELECT\tTC.TABLE_NAME,\n\t\t\t\t\t\t\t\tTC.OWNER,\n\t\t\t\t\t\t\t\tTC.COLUMN_NAME,\n\t\t\t\t\t\t\t\tTC.DATA_TYPE,\n\t\t\t\t\t\t\t\tTC.DATA_DEFAULT,\n\t\t\t\t\t\t\t\tTC.NULLABLE,\n\t\t\t\t\t\t\t\tTC.COLUMN_ID,\n\t\t\t\t\t\t\t\tTC.DATA_LENGTH,\n\t\t\t\t\t\t\t\tTC.DATA_SCALE,\n\t\t\t\t\t\t\t\tTC.DATA_PRECISION,\n\t\t\t\t\t\t\t\tC.CONSTRAINT_TYPE,\n\t\t\t\t\t\t\t\tCC.POSITION\n\t\t\t\t\t\tFROM\tALL_TAB_COLUMNS TC\n\t\t\t\t\t\tLEFT\tJOIN (\n\t\t\t\t\t\t\t\t\tALL_CONS_COLUMNS CC\n\t\t\t\t\t\t\tJOIN\tALL_CONSTRAINTS C ON (CC.CONSTRAINT_NAME = C.CONSTRAINT_NAME AND CC.TABLE_NAME = C.TABLE_NAME AND C.CONSTRAINT_TYPE = 'P'\" . ($schemaName ? ' AND C.OWNER = UPPER(:SCNAME)' : '') . \")\n\t\t\t\t\t\t) ON TC.TABLE_NAME\t\t\t\t\t= CC.TABLE_NAME\n\t\t\t\t\t\tAND\t\tTC.COLUMN_NAME\t\t\t\t= CC.COLUMN_NAME\n\t\t\t\t\t\t\" . ($schemaName ? ' AND CC.OWNER\t= UPPER(:SCNAME)' : '') . \"\n\t\t\t\t\t\tWHERE\tTC.TABLE_NAME\t\t\t\t= UPPER(:TBNAME)\";\n\n            $bind[':TBNAME'] = $tableName;\n\n            if($schemaName) {\n                $sql .= ' AND TC.OWNER = UPPER(:SCNAME)';\n                $bind[':SCNAME'] = $schemaName;\n            }\n\n            $sql .= ' ORDER BY TC.COLUMN_ID';\n        } else {\n            $subSql=\"SELECT AC.OWNER, AC.TABLE_NAME, ACC.COLUMN_NAME, AC.CONSTRAINT_TYPE, ACC.POSITION\n                from ALL_CONSTRAINTS AC, ALL_CONS_COLUMNS ACC\n                  WHERE ACC.CONSTRAINT_NAME = AC.CONSTRAINT_NAME\n                    AND ACC.TABLE_NAME = AC.TABLE_NAME\n                    AND ACC.OWNER = AC.OWNER\n                    AND AC.CONSTRAINT_TYPE = 'P'\n                    AND UPPER(AC.TABLE_NAME) = UPPER(:TBNAME)\";\n            $bind[':TBNAME'] = $tableName;\n            if ($schemaName) {\n                $subSql .= ' AND UPPER(ACC.OWNER) = UPPER(:SCNAME)';\n                $bind[':SCNAME'] = $schemaName;\n            }\n            $sql=\"SELECT TC.TABLE_NAME, TC.OWNER, TC.COLUMN_NAME, TC.DATA_TYPE,\n                    TC.DATA_DEFAULT, TC.NULLABLE, TC.COLUMN_ID, TC.DATA_LENGTH,\n                    TC.DATA_SCALE, TC.DATA_PRECISION, CC.CONSTRAINT_TYPE, CC.POSITION\n                FROM ALL_TAB_COLUMNS TC, ($subSql) CC\n                WHERE UPPER(TC.TABLE_NAME) = UPPER(:TBNAME)\n                  AND TC.OWNER = CC.OWNER(+) AND TC.TABLE_NAME = CC.TABLE_NAME(+) AND TC.COLUMN_NAME = CC.COLUMN_NAME(+)\";\n            if ($schemaName) {\n                $sql .= ' AND UPPER(TC.OWNER) = UPPER(:SCNAME)';\n            }\n            $sql .= ' ORDER BY TC.COLUMN_ID';\n        }\n\n        $stmt = $this->query($sql, $bind);\n\n        \/**\n         * Use FETCH_NUM so we are not dependent on the CASE attribute of the PDO connection\n         *\/\n        $result = $stmt->fetchAll(Zend_Db::FETCH_NUM);\n\n        $table_name      = 0;\n        $owner           = 1;\n        $column_name     = 2;\n        $data_type       = 3;\n        $data_default    = 4;\n        $nullable        = 5;\n        $column_id       = 6;\n        $data_length     = 7;\n        $data_scale      = 8;\n        $data_precision  = 9;\n        $constraint_type = 10;\n        $position        = 11;\n\n        $desc = array();\n        foreach ($result as $key => $row) {\n            list ($primary, $primaryPosition, $identity) = array(false, null, false);\n            if ($row[$constraint_type] == 'P') {\n                $primary = true;\n                $primaryPosition = $row[$position];\n                \/**\n                 * Oracle does not support auto-increment keys.\n                 *\/\n                $identity = false;\n            }\n            $desc[$this->foldCase($row[$column_name])] = array(\n                'SCHEMA_NAME'      => $this->foldCase($row[$owner]),\n                'TABLE_NAME'       => $this->foldCase($row[$table_name]),\n                'COLUMN_NAME'      => $this->foldCase($row[$column_name]),\n                'COLUMN_POSITION'  => $row[$column_id],\n                'DATA_TYPE'        => $row[$data_type],\n                'DEFAULT'          => $row[$data_default],\n                'NULLABLE'         => (bool) ($row[$nullable] == 'Y'),\n                'LENGTH'           => $row[$data_length],\n                'SCALE'            => $row[$data_scale],\n                'PRECISION'        => $row[$data_precision],\n                'UNSIGNED'         => null, \/\/ @todo\n                'PRIMARY'          => $primary,\n                'PRIMARY_POSITION' => $primaryPosition,\n                'IDENTITY'         => $identity\n            );\n        }\n        return $desc;\n    }\n{code}\n\n\nBasically the key is to use the OWNER column in the joins. Without this, there are way too many rows to scan through for the database. The original code was attempting to do this, but in a way that was still causing table-scans to occur.\n\nFor instance, the original code had this in the where clause:\n\n{code:javascript}\nif ($schemaName) { \n    $sql .= ' AND UPPER(TC.OWNER) = UPPER(:SCNAME)';\n{code}\n\nYou can't put UPPER() around TC.OWNER, because as soon as you do that, Oracle will not use any indexes that are attached to that column. (unless there was a function based index there, but there isn't).   It happens to be unnecessary to use UPPER() anyway, since the column is in uppercase anyhow.\n\n\nCheers,\n-adam\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/6",
                "name": "N\/A"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7427\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mikaelkael",
                "name": "mikaelkael",
                "displayName": "Mickael Perraud",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-10415",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10415",
                    "type": {
                        "name": "Duplicate",
                        "direction": "INBOUND",
                        "description": "is duplicated by"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10340",
                    "id": 10340,
                    "description": "Mini Release",
                    "name": "1.8.4",
                    "userReleaseDate": "23\/Jun\/09",
                    "archived": false,
                    "releaseDate": "2009-06-23",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10135",
                    "id": 10135,
                    "name": "Zend_Db_Adapter_Oracle",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/45966",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                        "name": "satoruyoshida",
                        "displayName": "Satoru Yoshida",
                        "active": true
                    },
                    "body": "It seems to be duplicated by ZF-10415.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                        "name": "satoruyoshida",
                        "displayName": "Satoru Yoshida",
                        "active": true
                    },
                    "created": "2011-04-22T14:28:31.000+0000",
                    "updated": "2011-04-22T14:28:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51181",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=molecularbear",
                        "name": "molecularbear",
                        "displayName": "Ross Davis",
                        "active": true
                    },
                    "body": "Thank you, Adam! My describeTable() performance went from 0.3s\/query to 0.1s\/query with this optimization.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=molecularbear",
                        "name": "molecularbear",
                        "displayName": "Ross Davis",
                        "active": true
                    },
                    "created": "2012-06-21T20:39:50.000+0000",
                    "updated": "2012-06-21T20:39:50.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7427\/transitions"
}