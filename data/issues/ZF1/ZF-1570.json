{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1570",
    "key": "ZF-1570",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Db2: lastInsertId() should fall back to IDENTITY_VAL_LOCAL()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/11",
                "name": "Patch",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1570\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10100",
                    "id": 10100,
                    "description": "Release Candidate 3",
                    "name": "1.0.0 RC3",
                    "userReleaseDate": "23\/Jun\/07",
                    "archived": true,
                    "releaseDate": "2007-06-23",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2007-06-14T19:42:16.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                "name": "ledezma",
                "displayName": "Salvador Ledezma",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-06-14T16:18:40.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2007-07-05T14:44:20.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "If a table name is passed into lastInsertId(), it assumes a sequence is used as a primary key though it can be an identity\n\nlastInsertId() returns the latest identity value unless a parameter(s) is(are) passed in.  When there is a parameter passed in, the existence of a sequence object is assumed.\n\nIn the case where a parameter is passed in but no sequence object exists, the method should be given one last chance to check for the identity value.  The patch catches the exception and if the error message is \"object not found\" it tries the identity:\n\n{code}\n   public function lastInsertId($tableName = null, $primaryKey = null)\n    {\n        $this->_connect();\n\n        if ($tableName !== null) {\n            $sequenceName = $tableName;\n            if ($primaryKey) {\n                $sequenceName .= \"_$primaryKey\";\n            }\n            $sequenceName .= '_seq';\n            try {\n                return $this->lastSequenceId($sequenceName);    \n            } catch (Zend_Db_Exception $e) {\n                $found = stristr($e->getMessage(), \"SQL0204N\");\n                if (!$found){\n                    \/**\n                    * @see Zend_Db_Adapter_Db2_Exception\n                    *\/\n                    require_once 'Zend\/Db\/Adapter\/Db2\/Exception.php';\n                    throw new Zend_Db_Adapter_Db2_Exception($e);\n                }\n            }\n        }\n\n        $sql = 'SELECT IDENTITY_VAL_LOCAL() AS VAL FROM SYSIBM.SYSDUMMY1';\n        $value = $this->fetchOne($sql);\n        return $value;\n    }\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1570\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                "name": "bkarwin",
                "displayName": "Bill Karwin",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/10572",
                    "filename": "Db2.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "created": "2007-06-14T16:20:17.000+0000",
                    "size": 20819,
                    "mimeType": "application\/php",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/10572\/Db2.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/10573",
                    "filename": "TestCommon.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "created": "2007-06-14T16:22:59.000+0000",
                    "size": 43272,
                    "mimeType": "application\/php",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/10573\/TestCommon.php"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10090",
                    "id": 10090,
                    "description": "Release Candidate 2",
                    "name": "1.0.0 RC2",
                    "userReleaseDate": "08\/Jun\/07",
                    "archived": true,
                    "releaseDate": "2007-06-08",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10190",
                    "id": 10190,
                    "name": "Zend_Db_Adapter_Db2",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15230",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "body": "This file contains the change to lastInsertId()",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "created": "2007-06-14T16:20:17.000+0000",
                    "updated": "2007-06-14T16:20:17.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15231",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "body": "The unit test for testAdapterInsert() has an additional call to lastInsertId() to ensure that passing in the table name still returns the last inserted id.\n\nIf this does not work for other adapters, then we can move this extra check into Db2Test.php:\n\n{code}\n $bugs = $this->_db->quoteIdentifier('zfbugs');   \n $lastInsertId = $this->_db->lastInsertId($bugs);\n  $this->assertEquals('5', (string) $lastInsertId,\n            'Expected new id to be 5');\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "created": "2007-06-14T16:22:59.000+0000",
                    "updated": "2007-06-14T16:22:59.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15232",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "Reword summary.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-06-14T17:50:22.000+0000",
                    "updated": "2007-06-14T17:50:22.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15233",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "I have strong objections to this patch.\n\nBy allowing someone to pass a table name to {{lastInsertId()}}, but then subsequently returning the result from {{IDENTITY_VAL_LOCAL()}}, the interface would give a false impression that the value returned was the last identity value inserts to the specified table.  But it's not -- it's the last value inserted to _any_ table in the scope of the current database connection.\n\n{code}\n$db->insert('zfbugs', $bugData);\n$db->insert('zfproducts', $productData);\n$bugId = $db->lastInsertId('zfbugs');  \/\/ returns the product_id, not the bug_id\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-06-14T18:17:54.000+0000",
                    "updated": "2007-06-14T18:17:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15236",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "body": "I understand your concerns.\n\nThis becomes an issue of correct usage because there is also the case when a sequence is used to populate a row, but lastInsertId() is called without a table name:\n\n{code}\n$data = array(\n  'id'    => $db->nextSequenceId(\"mytable_id_seq\"),\n  'stuff' => 'sequences, yeah!'\n);\n$db->insert('zfbugs', $data);\n$bugId = $db->lastInsertId();  \/\/ this unexpectedly returns IDENTITY_VAL_LOCAL()\n{code}\n\nAfter taking a look at the documentation (http:\/\/framework.zend.com\/manual\/en\/zend.db.html#zend.db.adapter.write), it is very explicit as to when parameters should or should not be used in lastInsertId().\n\nI am comfortable if this patch is rejected.\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ledezma",
                        "name": "ledezma",
                        "displayName": "Salvador Ledezma",
                        "active": true
                    },
                    "created": "2007-06-14T18:52:48.000+0000",
                    "updated": "2007-06-14T18:52:48.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15237",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "We agree that the interface for {{lastInsertId()}} is already defined to return {{IDENTITY_VAL_LOCAL()}} only in the case that no table name is specified in the argument.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-06-14T19:42:16.000+0000",
                    "updated": "2007-06-14T19:42:16.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1570\/transitions"
}