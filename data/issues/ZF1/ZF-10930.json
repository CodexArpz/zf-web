{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10930",
    "key": "ZF-10930",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Adapter_Abstract->query doesn't cache the prepared statement for a given SQL query"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/21",
                "name": "Performance Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10930\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2011-01-10T00:21:56.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthieu",
                "name": "matthieu",
                "displayName": "matthieu",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-01-09T18:16:28.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-01-10T00:23:05.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "* Problem\r\n\r\nCalling Zend_Db_Adapter_Abstract->query() many times (ie. thousands) with the same SQL query string (using bind parameters) results in much wasted time performing instanciation of the same Zend_Db_Statement object. See screenshot 1 from xhprof.\r\n\r\nIn particular, Zend_Db_Statement::_parseParameters is using preg_split and _stripQuoted which are very costly in time and memory.\r\n\r\n* Proposed solution\r\n\r\nI have a proposed patch which statically caches the prepared statement for the given SQL string statement:\r\n\r\n{noformat}\r\nIndex: libs\/Zend\/Db\/Adapter\/Abstract.php\r\n===================================================================\r\n--- libs\/Zend\/Db\/Adapter\/Abstract.php\t(revision 3647)\r\n+++ libs\/Zend\/Db\/Adapter\/Abstract.php\t(working copy)\r\n@@ -444,6 +444,9 @@\r\n      *\/\r\n     public function query($sql, $bind = array())\r\n     {\r\n+    \t\/\/ Let's cache prepared statements to avoid preparing the same query more than once\r\n+    \tstatic $cachePreparedStatement = array();\r\n+    \t\r\n         \/\/ connect to the database if needed\r\n         $this->_connect();\r\n \r\n@@ -464,7 +467,11 @@\r\n         }\r\n \r\n         \/\/ prepare and execute the statement with profiling\r\n-        $stmt = $this->prepare($sql);\r\n+        if(empty($cachePreparedStatement[$sql])) {\r\n+        \t$cachePreparedStatement[$sql] = $this->prepare($sql);\r\n+        } \r\n+        $stmt = $cachePreparedStatement[$sql];\r\n+        \r\n         $stmt->execute($bind);\r\n \r\n         \/\/ return the results embedded in the prepared statement object\r\n@@ -472,6 +479,7 @@\r\n         return $stmt;\r\n     }\r\n{noformat}\r\n\r\n* Conclusion\r\n\r\nProbably we are using zend_db in a very special use case, but this patch saves 10% of execution time of a very large batch script, and avoids allocating a total of 400Mb of memory over the run of our script. Please confirm if it will be included in Zend or I'll have to add the code in our parent classes. "
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10930\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                "name": "bittarman",
                "displayName": "Ryan Mauger",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10480",
                    "id": 10480,
                    "description": "Mini Release",
                    "name": "1.10.7",
                    "userReleaseDate": "28\/Jul\/10",
                    "archived": false,
                    "releaseDate": "2010-07-28",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43986",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthieu",
                        "name": "matthieu",
                        "displayName": "matthieu",
                        "active": true
                    },
                    "body": "I wanted to post xhprof screenshots but cant find the feature to upload images on here.\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthieu",
                        "name": "matthieu",
                        "displayName": "matthieu",
                        "active": true
                    },
                    "created": "2011-01-09T18:18:48.000+0000",
                    "updated": "2011-01-09T18:18:48.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43988",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "Im closing this as not an issue.\r\n\r\nThe query method returns an instance of the statement class, which would be your 'cached' query, if you wish to re-use it, then you should re-use the statement returned, rather than forcing this into the adapter.\r\n\r\nThis behaviour is very similar to the manner in which PDO creates its prepared statements, and so would be expected by the majority of users.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2011-01-10T00:21:56.000+0000",
                    "updated": "2011-01-10T00:21:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43989",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "Additionally, in order to upload attachments to issues, or supply patches, you need to sign the CLA\r\n\r\nYou can find the CLA here: http:\/\/framework.zend.com\/wiki\/display\/ZFPROP\/Contributor+License+Agreement",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2011-01-10T00:23:05.000+0000",
                    "updated": "2011-01-10T00:23:05.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10930\/transitions"
}