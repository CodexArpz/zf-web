{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10715",
    "key": "ZF-10715",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Json_Server does not handle invalid JSON requests properly"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10715\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jsjohns2",
                "name": "jsjohns2",
                "displayName": "Joshua Johnson",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-11-19T11:51:19.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-06-28T15:31:20.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "According to the JSON-RPC 2.0 spec: \"When a remote procedure call fails, the Procedure Return object MUST contain the error member...\". Additionally, the spec lists -32700 as the code for JSON parsing errors.\r\n\r\n\r\nZend_Json_Server does not conform to this part of the spec...if invalid JSON is sent to the server, a PHP error is returned rather than a proper JSON error message. This is what you get:\r\nFatal error: Uncaught exception 'Zend_Json_Exception' with message 'Decoding failed: Syntax error' in \/usr\/share\/pear\/Zend\/Json.php:93\r\nStack trace:\r\n#0 \/usr\/share\/pear\/Zend\/Json\/Server\/Request.php(251): Zend_Json::decode('this is invalid JSON')\r\n#1 \/usr\/share\/pear\/Zend\/Json\/Server\/Request\/Http.php(53): Zend_Json_Server_Request->loadJson('this is invalid JSON')\r\n#2 \/usr\/share\/pear\/Zend\/Json\/Server.php(250): Zend_Json_Server_Request_Http->__construct()\r\n#3 \/usr\/share\/pear\/Zend\/Json\/Server.php(505): Zend_Json_Server->getRequest()\r\n#4 \/usr\/share\/pear\/Zend\/Json\/Server.php(191): Zend_Json_Server->_handle()\r\n#5 \/root\/dvat\/public\/rpc\/test.php(22): Zend_Json_Server->handle()\r\n#6 {main}\r\n  thrown in \/usr\/share\/pear\/Zend\/Json.php on line 93\r\n\r\nBut what you should get is:\r\n{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32700, \"message\": \"Parse error.\"}, \"id\": 123}\r\n\r\nOn line 251 of Json\/Server\/Request.php, a call to Zend_Json::decode() is made on the received data. If decode() throws an exception, it is not caught by any of the consuming code. Zend_Json_Server needs to catch the exception, and call $this->fault('Parse Error', -32700)."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10715\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/14425",
                    "filename": "ZF-10715.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-06-28T15:29:33.000+0000",
                    "size": 3893,
                    "mimeType": "text\/x-patch",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/14425\/ZF-10715.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10420",
                    "id": 10420,
                    "description": "Minor Release",
                    "name": "1.11.0",
                    "userReleaseDate": "02\/Nov\/10",
                    "archived": false,
                    "releaseDate": "2010-11-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10121",
                    "id": 10121,
                    "name": "Zend_Json_Server",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43644",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bladeofsteel",
                        "name": "bladeofsteel",
                        "displayName": "Oleg Lobach",
                        "active": true
                    },
                    "body": "I broken my mind when try to write test for this bug.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bladeofsteel",
                        "name": "bladeofsteel",
                        "displayName": "Oleg Lobach",
                        "active": true
                    },
                    "created": "2010-12-17T04:09:56.000+0000",
                    "updated": "2010-12-17T04:09:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47289",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "@Oleg: Me too.  Use of {{Zend_Json_Server_Request_Http}} is hard-coded into {{Zend_Json_Server::getRequest}}, and that class reads from STDIN in it's constructor, so it's extremely difficult to capture the issue's behavior in a unit test without modifying the SUT.  So that's what i've done:\r\n{code}\r\nIndex: tests\/Zend\/Json\/ServerTest.php\r\n===================================================================\r\n--- tests\/Zend\/Json\/ServerTest.php      (revision 24159)\r\n+++ tests\/Zend\/Json\/ServerTest.php      (working copy)\r\n@@ -440,6 +440,18 @@\r\n         $server->loadFunctions($functions);\r\n         $this->assertEquals($functions->toArray(), $server->getFunctions()->toArray());\r\n     }\r\n+\r\n+    \/**\r\n+     * @group ZF-10715\r\n+     *\/\r\n+    public function testServerHandlesInvalidJsonResponseProperly()\r\n+    {\r\n+        $server = new Zend_Json_ServerTest_Server();\r\n+        $server->setClass('Zend_Json_ServerTest_Foo')\r\n+               ->setAutoEmitResponse( false );\r\n+\r\n+        $response = $server->handle();\r\n+    }\r\n }\r\n\r\n \/**\r\n@@ -481,6 +493,53 @@\r\n     return true;\r\n }\r\n\r\n+\/**\r\n+ * Invalid Request implementation\r\n+ * @see ZF-10715\r\n+ *\/\r\n+class Zend_Json_ServerTest_Request_Invalid extends Zend_Json_Server_Request\r\n+{\r\n+    protected $_rawJson = null;\r\n+\r\n+    \/**\r\n+     * Constructor\r\n+     *\/\r\n+    public function __construct()\r\n+    {\r\n+        $this->_rawJson = 'This is invalid JSON';\r\n+        $this->loadJson($this->_rawJson);\r\n+    }\r\n+\r\n+    \/**\r\n+     * Retrieve raw JSON string\r\n+     * @return string\r\n+     *\/\r\n+    public function getRawJson()\r\n+    {\r\n+        return $this->_rawJson;\r\n+    }\r\n+}\r\n+\r\n+\/**\r\n+ * Zend_Json_Server w\/ getRequest() which injects test request object\r\n+ * @see ZF-10715\r\n+ *\/\r\n+class Zend_Json_ServerTest_Server extends Zend_Json_Server\r\n+{\r\n+    \/**\r\n+     * Get JSON-RPC request object\r\n+     *\r\n+     * @return Zend_Json_Server_Request\r\n+     *\/\r\n+    public function getRequest()\r\n+    {\r\n+        if (null === ($request = $this->_request)) {\r\n+            $this->setRequest(new Zend_Json_ServerTest_Request_Invalid());\r\n+        }\r\n+        return $this->_request;\r\n+    }\r\n+}\r\n+\r\n \/\/ Call Zend_Json_ServerTest::main() if this source file is executed directly.\r\n if (PHPUnit_MAIN_METHOD == \"Zend_Json_ServerTest::main\") {\r\n     Zend_Json_ServerTest::main();\r\n{code}\r\nThe gist is I override {{Zend_Json_Server}} and redefine {{getRequest}} to create a new instance of {{Zend_Json_ServerTest_Request_Invalid}} instead of {{Zend_Json_Server_Request_Http}}, and this new Request class triggers the proper error in a reproducible way.  When I run the test suite I now get:\r\n\r\n{code}\r\n1) Zend_Json_ServerTest::testServerHandlesInvalidJsonResponseProperly\r\nZend_Json_Exception: Decoding failed: Syntax error\r\n\r\n\/tmp\/zf\/trunk\/library\/Zend\/Json.php:93\r\n\/tmp\/zf\/trunk\/library\/Zend\/Json\/Server\/Request.php:251\r\n\/tmp\/zf\/trunk\/tests\/Zend\/Json\/ServerTest.php:510\r\n\/tmp\/zf\/trunk\/tests\/Zend\/Json\/ServerTest.php:537\r\n\/tmp\/zf\/trunk\/library\/Zend\/Json\/Server.php:504\r\n\/tmp\/zf\/trunk\/library\/Zend\/Json\/Server.php:191\r\n\/tmp\/zf\/trunk\/tests\/Zend\/Json\/ServerTest.php:453\r\n{code}\r\n\r\nWhich equates to an exception thrown from the same location as the OP experienced. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-06-28T15:25:25.000+0000",
                    "updated": "2011-06-28T15:25:25.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47290",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "My suggested fix:\r\n{code}\r\nIndex: library\/Zend\/Json\/Server.php\r\n===================================================================\r\n--- library\/Zend\/Json\/Server.php        (revision 24159)\r\n+++ library\/Zend\/Json\/Server.php        (working copy)\r\n@@ -188,10 +188,14 @@\r\n         }\r\n\r\n         \/\/ Handle request\r\n-        $this->_handle();\r\n+        $handleResponse = $this->_handle();\r\n\r\n         \/\/ Get response\r\n-        $response = $this->_getReadyResponse();\r\n+        if ($handleResponse instanceof Zend_Json_Server_Error) {\r\n+            $response = $this->getResponse()->setError($handleResponse);\r\n+        } else {\r\n+            $response = $this->_getReadyResponse();\r\n+        }\r\n\r\n         \/\/ Emit response?\r\n         if ($this->autoEmitResponse()) {\r\n@@ -501,7 +505,11 @@\r\n      *\/\r\n     protected function _handle()\r\n     {\r\n-        $request = $this->getRequest();\r\n+        try {\r\n+            $request = $this->getRequest();\r\n+        } catch (Zend_Json_Exception $ex) {\r\n+            return $this->fault('Parse Error', -32768);\r\n+        }\r\n\r\n         if (!$request->isMethodError() && (null === $request->getMethod())) {\r\n             return $this->fault('Invalid Request', -32600);\r\n{code}\r\nI've attached the entire patch, including unit tests, to this issue as well.\r\n\r\nThoughts?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-06-28T15:27:10.000+0000",
                    "updated": "2011-06-28T15:27:10.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47291",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "One thing to note:  I don't have much experience with Zend_Json_Server, but it appears that it doesn't implement JSON-RPC 2.0.  {{Zend_Json_Server_Error}} defines the error code for a parse error as -32768, so my patch abides by that value. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-06-28T15:31:20.000+0000",
                    "updated": "2011-06-28T15:31:20.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10715\/transitions"
}