{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5771",
    "key": "ZF-5771",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Wrong pointer position after unsetting data."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5771\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10241",
                    "id": 10241,
                    "description": "Minor Release",
                    "name": "1.8.0",
                    "userReleaseDate": "30\/Apr\/09",
                    "archived": false,
                    "releaseDate": "2009-04-30",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-03-14T14:39:28.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jpieper",
                "name": "jpieper",
                "displayName": "Jan Pieper",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-02-13T02:59:39.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-03-14T14:39:27.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "{code}require_once 'Zend\/Config.php';\n$config = new Zend_Config(array(\n    'first'  => array(1),\n    'second' => array(2),\n    'third'  => array(3)\n), true);\n\nforeach ($config as $key => $value)\n{\n    echo $key . PHP_EOL;\n    if ($key == 'first') {\n        unset($config->$key); \/\/ uses magic Zend_Config::__unset() method\n    }\n}{code}\n\n{code:title=expected result}first\nsecond\nthird{code}\n\n{code:title=actual result}first\nthird{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5771\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                "name": "rob",
                "displayName": "Rob Allen",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11749",
                    "filename": "reduced_testcase.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T06:39:48.000+0000",
                    "size": 1725,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11749\/reduced_testcase.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11753",
                    "filename": "reduced_testcase2.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T14:54:19.000+0000",
                    "size": 2617,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11753\/reduced_testcase2.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11754",
                    "filename": "robinsk_testcase_and_patch.tar.gz",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=robinsk",
                        "name": "robinsk",
                        "displayName": "Robin Skoglund",
                        "active": true
                    },
                    "created": "2009-02-14T15:55:02.000+0000",
                    "size": 3838,
                    "mimeType": "application\/x-gzip",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11754\/robinsk_testcase_and_patch.tar.gz"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11750",
                    "filename": "unset_during_iteration_solution_1.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T06:45:03.000+0000",
                    "size": 3224,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11750\/unset_during_iteration_solution_1.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11752",
                    "filename": "unset_during_iteration_solution_2.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T14:47:04.000+0000",
                    "size": 3551,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11752\/unset_during_iteration_solution_2.php"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10280",
                    "id": 10280,
                    "description": "Mini Release",
                    "name": "1.7.4",
                    "userReleaseDate": "02\/Feb\/09",
                    "archived": false,
                    "releaseDate": "2009-02-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10010",
                    "id": 10010,
                    "name": "Zend_Config",
                    "description": "property based interface to an array",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28824",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "This is the most simple test code I could come up with to show the problem.\n\nI have no idea how to fix it!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T05:16:41.000+0000",
                    "updated": "2009-02-14T05:16:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28825",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Corrected file that shows reduced use-case ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T06:39:48.000+0000",
                    "updated": "2009-02-14T06:39:48.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28826",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Solution to the reduced test case - no optimisation. Created with help from Freeaqingme and Jon Whitcraft on #zftalk.dev.\n\nObvious optimisation is to store the deleted keys in and _deleted array to save iterating over _data.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T06:45:03.000+0000",
                    "updated": "2009-02-14T06:45:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28827",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=robinsk",
                        "name": "robinsk",
                        "displayName": "Robin Skoglund",
                        "active": true
                    },
                    "body": "This patch solves the problem as currently described in the issue, and all Zend\/Config* unit tests run fine with this patch.\n\nHowever, I still think the patch needs more testing before applying it to the trunk.\n\n{code}\n--- library\/Zend\/Config.php\t(revision 14089)\n+++ library\/Zend\/Config.php\t(working copy)\n@@ -56,6 +56,13 @@\n      *\/\n     protected $_data;\n \n+    \/**\n+     * Flag to use when unsetting during config iteration\n+     *\n+     * @link http:\/\/framework.zend.com\/issues\/browse\/ZF-5771\n+     * @var boolean\n+     *\/\n+    protected $_iterationUnsetFlag;\n \n     \/**\n      * Contains which config file sections were loaded. This is null\n@@ -223,6 +230,7 @@\n         if ($this->_allowModifications) {\n             unset($this->_data[$name]);\n             $this->_count = count($this->_data);\n+            $this->_iterationUnsetFlag = true;\n         } else {\n             \/** @see Zend_Config_Exception *\/\n             require_once 'Zend\/Config\/Exception.php';\n@@ -267,6 +275,10 @@\n      *\/\n     public function next()\n     {\n+        if ($this->_iterationUnsetFlag) {\n+            $this->_iterationUnsetFlag = false;\n+            return;\n+        }\n         next($this->_data);\n         $this->_index++;\n     }\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=robinsk",
                        "name": "robinsk",
                        "displayName": "Robin Skoglund",
                        "active": true
                    },
                    "created": "2009-02-14T09:07:02.000+0000",
                    "updated": "2009-02-14T09:09:22.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28829",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Robin,\n\nYour patch fixes the described problem but introduces another one:\n\n{code}\nunset($config->first);\nforeach($config as $key=>$item) {\n    echo $key . PHP_EOL;\n}\n{code}\n\nThe first next() doesn't get called, so the output becomes:\nsecond\nsecond\nthird\n\nrather than the expected\nsecond\nthird\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T11:12:58.000+0000",
                    "updated": "2009-02-14T11:12:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28831",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jpieper",
                        "name": "jpieper",
                        "displayName": "Jan Pieper",
                        "active": true
                    },
                    "body": "I think I\u00b4ve found a solution.\n\n{code:title=Diff}Index: Config.php\n===================================================================\n--- Config.php\t(revision 14089)\n+++ Config.php\t(working copy)\n@@ -84,6 +84,13 @@\n     protected $_loadFileErrorStr = null;\n\n     \/**\n+     * Contains the index keys of the configuration data array.\n+     *\n+     * @var array\n+     *\/\n+    protected $_indexes = array();\n+\n+    \/**\n      * Zend_Config provides a property based interface to\n      * an array. The data are read-only unless $allowModifications\n      * is set to true on construction.\n@@ -100,6 +107,7 @@\n         $this->_allowModifications = (boolean) $allowModifications;\n         $this->_loadedSection = null;\n         $this->_index = 0;\n+        $this->_indexes = array_keys($array);\n         $this->_data = array();\n         foreach ($array as $key => $value) {\n             if (is_array($value)) {\n@@ -155,6 +163,9 @@\n             } else {\n                 $this->_data[$name] = $value;\n             }\n+            if (!in_array($name, $this->_indexes)) {\n+                $this->_indexes[] = $name;\n+            }\n             $this->_count = count($this->_data);\n         } else {\n             \/** @see Zend_Config_Exception *\/\n@@ -222,7 +233,10 @@\n     {\n         if ($this->_allowModifications) {\n             unset($this->_data[$name]);\n+            unset($this->_indexes[array_search($name, $this->_indexes)]);\n+            $this->_indexes = array_values($this->_indexes);\n             $this->_count = count($this->_data);\n+            --$this->_index;\n         } else {\n             \/** @see Zend_Config_Exception *\/\n             require_once 'Zend\/Config\/Exception.php';\n@@ -248,7 +262,10 @@\n      *\/\n     public function current()\n     {\n-        return current($this->_data);\n+        if (!array_key_exists($key = $this->key(), $this->_data)) {\n+            return false;\n+        }\n+        return $this->_data[$key];\n     }\n\n     \/**\n@@ -258,7 +275,7 @@\n      *\/\n     public function key()\n     {\n-        return key($this->_data);\n+        return $this->_indexes[$this->_index];\n     }\n\n     \/**\n@@ -267,8 +284,7 @@\n      *\/\n     public function next()\n     {\n-        next($this->_data);\n-        $this->_index++;\n+        ++$this->_index;\n     }\n\n     \/**\n@@ -277,7 +293,6 @@\n      *\/\n     public function rewind()\n     {\n-        reset($this->_data);\n         $this->_index = 0;\n     }\n{code}\n\n{code:title=My example}foreach ($config as $key => $value)\n{\n    echo $key . PHP_EOL;\n    if ($key == 'first') {\n        unset($config->$key);\n    }\n}\n\nfirst\nsecond\nthird{code}\n\n{code:title=Robs example}unset($config->first);\nforeach($config as $key=>$item) {\n    echo $key . PHP_EOL;\n}\n\nsecond\nthird{code}\n\n{code:title=Test Zend_Config}[jan@jason Zend]# phpunit ConfigTest.php\nPHPUnit 3.3.13 by Sebastian Bergmann.\n\n.......................\n\nTime: 0 seconds\n\nOK (23 tests, 58 assertions){code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jpieper",
                        "name": "jpieper",
                        "displayName": "Jan Pieper",
                        "active": true
                    },
                    "created": "2009-02-14T14:17:37.000+0000",
                    "updated": "2009-02-14T14:17:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28832",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Same basic solution, but more comprehensive exercising of the code. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T14:47:06.000+0000",
                    "updated": "2009-02-14T14:47:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28833",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Updated the reduced testcase file to include the more robust set of exercises. File is reduced_testcase2.php.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-02-14T14:54:20.000+0000",
                    "updated": "2009-02-14T14:54:20.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28834",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=robinsk",
                        "name": "robinsk",
                        "displayName": "Robin Skoglund",
                        "active": true
                    },
                    "body": "I attached a file 'robinsk_testcase_and_patch.tar.gz', which includes a modified version of Zend_Config with 6 runnable tests (not unit tests). The patch is also in the archive.\n\nSummary of patch:\nSet $this->_iterationUnsetFlag = true in the __unset() method. If the flag is true, next() will not advance the internal pointer, but just flip the flag to false. Other iterator methods will also set the flag to false, so the internal state of the pointer\/flag is not corrupted. This is way more efficient than maintaining deleted keys or using string operations.\n\nTo run tests:\n* Download robinsk_testcase_and_patch.tar.gz\n* $ tar -zxvf robinsk_testcase_and_patch.tar.gz\n* $ php test1.php\n* $ php test2.php\n* ...\n* $ php test6.php\n\nEach test outputs what it tests, and what the expected and actual results are.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=robinsk",
                        "name": "robinsk",
                        "displayName": "Robin Skoglund",
                        "active": true
                    },
                    "created": "2009-02-14T15:55:03.000+0000",
                    "updated": "2009-02-14T15:55:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29482",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Fixed on trunk - r14321.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2009-03-14T14:39:21.000+0000",
                    "updated": "2009-03-14T14:39:21.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5771\/transitions"
}