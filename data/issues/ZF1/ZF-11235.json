{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11235",
    "key": "ZF-11235",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Test_PHPUnit_Db_Operation_Truncate fails in Mysql 5.5 on InnoDB tables with foreign keys"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11235\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ert256",
                "name": "ert256",
                "displayName": "Rafa? Tr\u00f3jniak",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-03-28T11:17:28.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-03-28T15:24:05.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When trying to set db ready to test, i got this exception\r\n{quote}\r\nPHPUnit_Extensions_Database_Operation_Exception: COMPOSITE[TRUNCATE] operation failed on query: TRUNCATE User using args: Array\r\n(\r\n)\r\n [SQLSTATE[42000]: Syntax error or access violation: 1701 Cannot truncate a table referenced in a foreign key constraint (`database`.`tableA`, CONSTRAINT `keyname` FOREIGN KEY (`field`) REFERENCES `czytnikrss`.`tableB` (`idTableB`))]\r\n{quote}\r\n\r\nThere is constrain between table A and B. Schemas :\r\n{quote}\r\nCREATE  TABLE IF NOT EXISTS `tableB` (\r\n  `idTableB` INT NOT NULL AUTO_INCREMENT ,\r\n  PRIMARY KEY (`idTableB`) )\r\nENGINE = InnoDB;\r\n\r\nCREATE  TABLE IF NOT EXISTS `tableA` (\r\n  `field` INT NOT NULL ,\r\n  CONSTRAINT `keyname`\r\n    FOREIGN KEY (`field` )\r\n    REFERENCES `tableB` (`idTableB` )\r\n    ON DELETE CASCADE ON UPDATE CASCADE)\r\nENGINE = InnoDB;\r\n{quote}\r\n\r\nAlso, in Mysql 5.5 reference manual I've found \r\n{quote}\r\nTRUNCATE TABLE fails for an InnoDB table if there are any FOREIGN KEY constraints from other tables that reference the table. Foreign key constraints between columns of the same table are allowed.\r\n{quote}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11235\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10540",
                    "id": 10540,
                    "description": "Mini Release",
                    "name": "1.11.4",
                    "userReleaseDate": "03\/Mar\/11",
                    "archived": false,
                    "releaseDate": "2011-03-03",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10312",
                    "id": 10312,
                    "name": "Zend_Test_PHPUnit",
                    "description": "PHPUnit test scaffolding for ZF MVC applications",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/45639",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ert256",
                        "name": "ert256",
                        "displayName": "Rafa? Tr\u00f3jniak",
                        "active": true
                    },
                    "body": "more specific name of issue",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ert256",
                        "name": "ert256",
                        "displayName": "Rafa? Tr\u00f3jniak",
                        "active": true
                    },
                    "created": "2011-03-28T11:19:38.000+0000",
                    "updated": "2011-03-28T11:19:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/45644",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ert256",
                        "name": "ert256",
                        "displayName": "Rafa? Tr\u00f3jniak",
                        "active": true
                    },
                    "body": "I've found quick, and a bit tricki fix to that problem.\r\nAfter reading bug on Mysql http:\/\/bugs.mysql.com\/bug.php?id=56785 i found, about foreign_key_checks flag in mysql.\r\n\r\nSo, I've created action for setting that flag :\r\n{code}\r\nclass DB_Ooperation_setEnv \r\n\timplements PHPUnit_Extensions_Database_Operation_IDatabaseOperation\r\n{\r\n\tprivate $env;\r\n\tprivate $val;\r\n\r\n\tpublic function __construct($env,$val)\r\n\t{\r\n\t\t$this->env=$env;\r\n\t\t$this->val=$val;\r\n\t}\r\n\r\n\tpublic function execute(PHPUnit_Extensions_Database_DB_IDatabaseConnection $connection,\r\n\t\tPHPUnit_Extensions_Database_DataSet_IDataSet $dataSet)\r\n\t{\r\n\t\t$connection->getConnection()->query('SET '.$this->env.'='.$this->val);\r\n\t}\r\n}\r\n{code}\r\n\r\nThan, I've overloaded getSetUpOperation in class Zend_Test_PHPUnit_DatabaseTestCase that uses database\r\n{code}\r\nprotected function getSetUpOperation()\r\n{\r\n\treturn new PHPUnit_Extensions_Database_Operation_Composite(array(\r\n\t\tnew DB_Ooperation_setEnv ('foreign_key_checks',0),\r\n\t\tnew Zend_Test_PHPUnit_Db_Operation_Truncate(),\r\n\t\tnew DB_Ooperation_setEnv ('foreign_key_checks',1),\r\n\t\tnew Zend_Test_PHPUnit_Db_Operation_Insert(),\r\n\t));\r\n    }\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ert256",
                        "name": "ert256",
                        "displayName": "Rafa? Tr\u00f3jniak",
                        "active": true
                    },
                    "created": "2011-03-28T15:24:05.000+0000",
                    "updated": "2011-03-28T15:24:05.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11235\/transitions"
}