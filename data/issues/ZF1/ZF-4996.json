{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4996",
    "key": "ZF-4996",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Adapter_Pdo_Mssql->limit() Does Not Account For Multiple ORDER BY Columns"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4996\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/3",
                "name": "Duplicate"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-05-14T05:16:20.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                "name": "nix0n",
                "displayName": "Adam VanBerlo",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-11-19T10:36:38.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-08-20T14:40:11.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "mssql"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Zend_Db_Adapter_Pdo_Mssql->limit() does not account for multiple *ORDER BY* columns.  \r\n\r\nThe way the adapter reverses the sub-select to get the limit, by reversing the sort order, it reverses only the last column in the *ORDER BY* list.  It should be reversing all the columns.  By \"reverse\" I mean, *ASC* becomes *DESC*, and *DESC* becomes *ASC*.\r\n\r\nThen, in the outermost *SELECT*, it does not revert back to the original *ORDER BY* list.  Again, only the last column in the list is reverted.\r\n\r\nBelow is an example (formatted for better reading):\r\n{code:sql|title=Expected SQL}\r\nSELECT * \r\nFROM\r\n(\r\n\tSELECT TOP 10 * \r\n\tFROM \r\n\t(\r\n\t\tSELECT TOP 30 * \r\n\t\tFROM \"people\"\r\n\t\tORDER BY \"lname\" ASC, \"fname\" ASC\r\n\t)\r\n\tORDER BY \"lname\" DESC, \"fname\" DESC\r\n)\r\nORDER BY \"lname\" ASC, \"fname\" ASC\r\n{code} \r\n\r\n{code:sql|title=Actual SQL}\r\nSELECT * \r\nFROM\r\n(\r\n\tSELECT TOP 10 * \r\n\tFROM \r\n\t(\r\n\t\tSELECT TOP 30 * \r\n\t\tFROM \"people\"\r\n\t\tORDER BY \"lname\" ASC, \"fname\" ASC\r\n\t)\r\n\tORDER BY \"lname\" , \"fname\" DESC\r\n)\r\nORDER BY \"lname\" , \"fname\" asc\r\n{code} "
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4996\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                "name": "satoruyoshida",
                "displayName": "Satoru Yoshida",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-4099",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4099",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10251",
                    "id": 10251,
                    "description": "Mini Release",
                    "name": "1.6.2",
                    "userReleaseDate": "13\/Oct\/08",
                    "archived": false,
                    "releaseDate": "2008-10-13",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29875",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "body": "The method limit() has not changed (functionally) since at least 1.0.0.  While this bug doesn't affect common direct usage.  In my scenario, this renders the desperately needed Zend_Paginator component effectively useless in my application.\n\nLet's take for example a common application, an \"eCommerce\" site.  This site would show various items \"for sale\" and limit the amount of items shown on a single page.  Well, let's say we want to re-sort those items in a different order; let's say price.  Price is definitely not a unique key, and duplicate values are certain to come up.  This is where the second \"ORDER BY\" is important.  It ensures that regardless of how many duplicate primary ordered columns, there is a secondary order enforcing boundaries in limits.  When this secondary order isn't enforced, it allows records to be returned in duplicate at various offsets.\n\nThis bug not only doesn't support multiple ORDER BY columns, but renders them completely backwards by flipping <strong>only<\/strong> the least significant column (the last one).\n\nI could come up with all sorts of other scenarios where multiple ORDER BY columns, in league with limit() functionality, would be a <u>paramount<\/u> requirement for operation.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "created": "2009-04-01T12:48:54.000+0000",
                    "updated": "2009-04-01T12:48:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29892",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "body": "Ok, I have a fix, but it comes with a catch.  This code will generate the expected SQL above, but it does not support omitted ASC\/DESC.  It must be defined otherwise it is ignored.\n\nThere might be a better \"placeholder\" instead of zASC or zDESC, but it works regardless.  It reverses both ORDER BY columns; not just the least significant one.  I'm sure with a bit more crafty regex, omitted ASC\/DESC can be supported.  However, internally, the framework tends to explicitly provide it regardless.  So it works well for my application.\n\n{code:java|title=Sample Fix}\n    \/**\n     * Adds an adapter-specific LIMIT clause to the SELECT statement.\n     *\n     * @link http:\/\/lists.bestpractical.com\/pipermail\/rt-devel\/2005-June\/007339.html\n     *\n     * @param string $sql\n     * @param integer $count\n     * @param integer $offset OPTIONAL\n     * @throws Zend_Db_Adapter_Exception\n     * @return string\n     *\/\n     public function limit($sql, $count, $offset = 0)\n     {\n        $count = intval($count);\n        if ($count <= 0) {\n            \/** @see Zend_Db_Adapter_Exception *\/\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument count=$count is not valid\");\n        }\n\n        $offset = intval($offset);\n        if ($offset < 0) {\n            \/** @see Zend_Db_Adapter_Exception *\/\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument offset=$offset is not valid\");\n        }\n\n        $orderby = stristr($sql, 'ORDER BY');\n        if ($orderby !== false) {\n            $order = str_ireplace('ORDER BY', '', $orderby);\n            \/\/ A single pass will negate itself, so placeholders must be put in first\n            $orderFlipped = preg_replace(array(\"\/\\bASC\\b\/i\", \"\/\\bDESC\\b\/i\"), array('zDESC', 'zASC'), $order);\n            $orderFlipped = preg_replace(array(\"\/\\bzASC\\b\/\", \"\/\\bzDESC\\b\/\"), array('ASC', 'DESC'), $orderFlipped);\n        }\n\n        $sql = preg_replace('\/^SELECT\\s\/i', 'SELECT TOP ' . ($count+$offset) . ' ', $sql);\n\n        $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';\n        if ($orderby !== false) {\n            $sql .= ' ORDER BY ' . $orderFlipped;\n        }\n        $sql .= ') AS outer_tbl';\n        if ($orderby !== false) {\n            $sql .= ' ORDER BY ' . $order;\n        }\n\n        return $sql;\n    }\n{code} \n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "created": "2009-04-02T16:09:42.000+0000",
                    "updated": "2009-04-02T16:09:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30963",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yoshida@zend.co.jp",
                        "name": "yoshida@zend.co.jp",
                        "displayName": "old of Satoru Yoshida",
                        "active": true
                    },
                    "body": "It duplicates ZF-4099 .  ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yoshida@zend.co.jp",
                        "name": "yoshida@zend.co.jp",
                        "displayName": "old of Satoru Yoshida",
                        "active": true
                    },
                    "created": "2009-05-14T05:16:11.000+0000",
                    "updated": "2009-05-14T05:16:11.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33726",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "A fix has been provided in r17706, please test. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-08-21T07:21:07.000+0000",
                    "updated": "2009-08-21T07:21:07.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33728",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "body": "I'm noticing just a $ in the matching regex on lines 331 and 336.  We should allow for some whitespace to the right of the order direction since that is legal SQL.  It is acceptable to leave the whitespace out in the replacement though.\n\nSuggested for line 331:\n$inv = preg_replace('\/\\s+desc\\s*$\/i', ' ASC', $orderPart, 1, $pregReplaceCount);",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "created": "2009-08-21T08:41:21.000+0000",
                    "updated": "2009-08-21T08:41:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33745",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "You are right, but since it is the replacement, i think removing whitespace is the better thing to do.\n\nFixed in r17728",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-08-21T12:37:35.000+0000",
                    "updated": "2009-08-21T12:37:35.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4996\/transitions"
}