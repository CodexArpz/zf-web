{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10194",
    "key": "ZF-10194",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Can't delete an entry from Google services using Gdata->delete method - client headers not taken into account ?"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10194\/votes",
                "votes": 4,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                "name": "yannick",
                "displayName": "Yannick BIET",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-07-21T03:29:12.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-12-22T22:16:35.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Trying to create\/update\/delete contacts from Google contacts.\r\nKnow there's no classes as they already exist for others services, but i am using gdata Zend_Gdata_Query class to directly retrieve contacts, gdata->updateEntry() to update a contact\r\n\r\nLast action is how to delete a contact.\r\n\r\nLooked the documentation (http:\/\/files.zend.com\/help\/Zend-Framework\/zend.gdata.html#zend.gdata.introduction.delete)\r\nBut it didn't work : Got a 403 error with error message \"If-Match or If-None-Match header or entry etag attribute required\"\r\n\r\n------------------\r\n\r\nSteps to reproduce issue:\r\n\r\nTry to delete contact with this php code :\r\n$client = Zend_Gdata_ClientLogin::getHttpClient($login,$pass,'cp');\r\n$client->setHeaders(\"If-Match: *\");\r\n$gdata = new Zend_Gdata($client);\r\n$gdata->setMajorProtocolVersion(3);\r\n$gdata->setMinorProtocolVersion(null);\r\n                            \r\n$gdata->delete('http:\/\/www.google.com\/m8\/feeds\/contacts\/'.str_replace('@', '%40', $user->google_email).'\/full\/'.$synchContacts->idgoogle);\r\n\r\nI also tried to retrieve the entry and delete it directly - same result !\r\n$query = new Zend_Gdata_Query('http:\/\/www.google.com\/m8\/feeds\/contacts\/'.str_replace('@', '%40', $user->google_email).'\/full\/'.$synchContacts->idgoogle);\r\n$entry = $gdata->getEntry($query);\r\n$entry->delete();\r\n\r\n\r\nI tried on zend framework 10.2 and 10.5 same behavior\r\n\r\nI tried to downgrade to protocol version 1, it was working last month but now it isn't anymore. How can we check with Zend or Google if there's some changes in the apis ?\r\n\r\n\r\nI tried downgrading to protocol V1 but it didn't work as well.\r\nWhy the setHeaders instruction is not correctly take into account by Google servers ?\r\n\r\nI captured the network traffic and don't see the header If-Match I wrote in the code. Is it taken into account ?\r\n\r\n\r\n\r\nExpected output:\r\n\r\nContact deleted, with answer 200 from Google\r\n\r\nActual results:\r\n\r\n403\r\n\r\nHere is the network traffic recorded between my app and google servers :\r\n\r\nMy App packet :\r\n---------------------\r\nDELETE \/m8\/feeds\/contacts\/demococea%40captivea.fr\/full\/308d6f698f2e8298 HTTP\/1.1\r\nHost: www.google.com\r\nConnection: close\r\nUser-Agent: MyCompany-MyApp-1.0 Zend_Framework_Gdata\/1.10.2\r\nauthorization: GoogleLogin auth=DQAAAJ8AAABGra3kyGKzGO_Gpy8ULHhnr3irCWGXcIMsNFL0s5qCoS4ss3O2EHQ8oH5uVvdXI4HX6s9lNfdymnZwrmjCgtPX6KD1YAGtz2AL3cKHWYYGQjLr9xJWoy1Bg_w3x-AzJ21jDeDVltN6Im8gtZDfo0dGx5AGQ9IicTlNiqUvc_17nNOPDSTMQXpDXVoZxqX7OcK_dUJSXoUwPPVcGRlykz9H\r\nGData-Version: 3\r\nAccept-encoding: identity\r\nContent-Type: application\/atom+xml\r\nContent-Length: 0\r\n\r\nAnswer from Google :\r\n--------------------------\r\nHTTP\/1.1 403 Forbidden\r\nContent-Type: text\/html; charset=UTF-8\r\nDate: Wed, 21 Jul 2010 09:56:32 GMT\r\nExpires: Wed, 21 Jul 2010 09:56:32 GMT\r\nCache-Control: private, max-age=0\r\nX-Content-Type-Options: nosniff\r\nX-Frame-Options: SAMEORIGIN\r\nX-XSS-Protection: 1; mode=block\r\nServer: GSE\r\nConnection: close\r\nIf-Match or If-None-Match header or entry etag attribute required"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/1",
                "name": "Blocker"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10194\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                "name": "rob",
                "displayName": "Rob Allen",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/15222",
                    "filename": "zf-10194.diff",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-12-22T22:16:35.000+0000",
                    "size": 1148,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/15222\/zf-10194.diff"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10430",
                    "id": 10430,
                    "description": "Mini Release",
                    "name": "1.10.2",
                    "userReleaseDate": "24\/Feb\/10",
                    "archived": false,
                    "releaseDate": "2010-02-24",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10440",
                    "id": 10440,
                    "description": "Mini Release",
                    "name": "1.10.3",
                    "userReleaseDate": "01\/Apr\/10",
                    "archived": false,
                    "releaseDate": "2010-04-01",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10451",
                    "id": 10451,
                    "description": "Mini Release",
                    "name": "1.10.4",
                    "userReleaseDate": "28\/Apr\/10",
                    "archived": false,
                    "releaseDate": "2010-04-28",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10460",
                    "id": 10460,
                    "description": "Mini Release",
                    "name": "1.10.5",
                    "userReleaseDate": "26\/May\/10",
                    "archived": false,
                    "releaseDate": "2010-05-26",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10470",
                    "id": 10470,
                    "description": "Mini Release",
                    "name": "1.10.6",
                    "userReleaseDate": "22\/Jun\/10",
                    "archived": false,
                    "releaseDate": "2010-06-22",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10088",
                    "id": 10088,
                    "name": "Zend_Gdata",
                    "description": "Class interface to Google Data API's.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41650",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                        "name": "yannick",
                        "displayName": "Yannick BIET",
                        "active": true
                    },
                    "body": "Problem is located in Zend_Gdata_App::performHttpRequest (app.php line 639)\r\n\r\n\/\/ Make sure the HTTP client object is 'clean' before making a request\r\n\/\/ In addition to standard headers to reset via resetParameters(),\r\n\/\/ also reset the Slug and If-Match headers\r\n$this->_httpClient->resetParameters();\r\n$this->_httpClient->setHeaders(array('Slug', 'If-Match'));\r\n\r\nAs the If-Match parameters is reseted during the $gData->delete($entry) call, there's no way for the developper to set up the If-Match header required by Google API.\r\n\r\n\r\n\r\nDefault behavior should be the following :\r\nCase A\r\n\r\nif delete call has been made using edit URL parameter (string), then in case of a delete operation we should add a header \"if-Match: *\" as we can't know the etag attribute\r\n\r\n\r\nCase B\r\nIn case we call the delete method with the entry element (from the feed retrieved) then in case of a delete operation we should add a header \"If-Match: <etag value>\"\r\n\r\n\r\n\r\nThe modification should be in prepareRequest method \r\n\r\nLine 500 (Case A)\r\nif ($data == null && $method == 'DELETE')\r\n{\r\n        \t$headers['If-Match'] = '*';\r\n}\r\n\r\n-----------------\r\n\r\nLine 531 (Case B)\r\nif ($method == 'DELETE')\r\n{\r\n   if ($rawData != null && isset($rawData->etag) && $rawData->etag != '') {\r\n      $headers['If-Match'] = $rawData->etag;\r\n   }else{\r\n      $headers['If-Match'] = '*';\r\n   }\r\n}\r\n\r\nThus the delete calls are now working !\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                        "name": "yannick",
                        "displayName": "Yannick BIET",
                        "active": true
                    },
                    "created": "2010-07-21T06:24:42.000+0000",
                    "updated": "2010-07-21T06:24:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49084",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=themming",
                        "name": "themming",
                        "displayName": "Tim Hemming",
                        "active": true
                    },
                    "body": "Our company are also experiencing this bug with DELETE actions. Framework version 1.11.11.\r\n\r\nI can confirm that the approach @Yannick mentions does work. However I have implemented it by extending Zend_Gdata_Calendar into my own class and overriding prepareRequest as follows:\r\n\r\n{code:title=ZendGdataCalendar.php}\r\nclass ZendGdataCalendar extends \\Zend_Gdata_Calendar {\r\n    \/**\r\n     * Overridden to fix an issue with the HTTP request\/response for deleting.\r\n     * @link http:\/\/zendframework.com\/issues\/browse\/ZF-10194\r\n     *\r\n     * @param       $method\r\n     * @param null  $url\r\n     * @param array $headers\r\n     * @param null  $data\r\n     * @param null  $contentTypeOverride\r\n     *\r\n     * @return array\r\n     *\/\r\n    public function prepareRequest($method,\r\n                                   $url = null,\r\n                                   $headers = array(),\r\n                                   $data = null,\r\n                                   $contentTypeOverride = null) {\r\n        $request = parent::prepareRequest($method, $url, $headers, $data, $contentTypeOverride);\r\n\r\n        if($request['method'] == 'DELETE') {\r\n            \/\/ Default to any\r\n            $request['headers']['If-Match'] = '*';\r\n\r\n            if($data instanceof Zend_Gdata_App_MediaSource) {\r\n                $rawData = $data->encode();\r\n                if(isset($rawData->etag) && $rawData->etag != '') {\r\n                    \/\/ Set specific match\r\n                    $request['headers']['If-Match'] = $rawData->etag;\r\n                }\r\n            }\r\n        }\r\n\r\n        return $request;\r\n    }\r\n}\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=themming",
                        "name": "themming",
                        "displayName": "Tim Hemming",
                        "active": true
                    },
                    "created": "2011-11-14T12:49:09.000+0000",
                    "updated": "2011-11-14T12:49:09.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49085",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                        "name": "yannick",
                        "displayName": "Yannick BIET",
                        "active": true
                    },
                    "body": "Hi Tim,\r\n\r\nGlad to see that my 1year old work helped you fix this damned issue !\r\nI didn't catch how you implemented it and it may interest me as now I am blocked to 1.10.6 as I didn't had any time upgrading and reporting the fix.\r\n\r\nDoes it change anything to the php code needed to use the service ?\r\nIn deed I don't know how the lines :\r\n\r\n$entry = $gdata->getEntry($query);\r\n$entry->delete();\r\n\r\nwill return instance of your code instead of default Zend_Gdata_Calendar (ok I'm in a rush right now so I don't have time to think about it but I would be interested to have a solution to upgrade to latest Zend framework !)\r\n\r\nHave a nice day.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                        "name": "yannick",
                        "displayName": "Yannick BIET",
                        "active": true
                    },
                    "created": "2011-11-14T13:07:22.000+0000",
                    "updated": "2011-11-14T13:07:22.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49089",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=themming",
                        "name": "themming",
                        "displayName": "Tim Hemming",
                        "active": true
                    },
                    "body": "I'm using my overridden Zend_Gdata_Calendar class with a Symfony 2 project so it's difficult to explain the usage of it without mentioning the Symfony2 service container and that sort of thing.\r\n\r\nHowever, it seems from your code snippet that you are creating an instance of Zend_Gdata_Calendar and assigning it to $gdata. So in that situation you would instantiate the child class instead:\r\n\r\n\/\/ Create your $httpClient first as that is used for the transport layer\r\n$gdata = new ZendGdataCalendar($httpClient);\r\n\r\nAlso I am using PHP 5.3 namespaces so my class is called ZendGdataCalendar within its own namespace. If you're not using namespacing I'd call the class something different, like: ZendGdataCalendarFixed.\r\n\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=themming",
                        "name": "themming",
                        "displayName": "Tim Hemming",
                        "active": true
                    },
                    "created": "2011-11-14T17:59:03.000+0000",
                    "updated": "2011-11-14T17:59:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51544",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=renatochea",
                        "name": "renatochea",
                        "displayName": "RChea",
                        "active": true
                    },
                    "body": "You are the man!!! The case B solved my problem :D, thank you for sharing!!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=renatochea",
                        "name": "renatochea",
                        "displayName": "RChea",
                        "active": true
                    },
                    "created": "2012-08-07T18:13:05.000+0000",
                    "updated": "2012-08-07T18:13:05.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51553",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                        "name": "yannick",
                        "displayName": "Yannick BIET",
                        "active": true
                    },
                    "body": "Hi RChea, glad to see the 2 years old bug report still helps few developpers !\r\nWill this be fixed one day into Zend framework ?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=yannick",
                        "name": "yannick",
                        "displayName": "Yannick BIET",
                        "active": true
                    },
                    "created": "2012-08-08T07:54:38.000+0000",
                    "updated": "2012-08-08T07:54:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/52975",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "I believe that this patch solves cases A and B as referenced by Yannick.\r\n\r\nI would appreciate it if someone could test this patch before I commit it.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-12-22T22:16:35.000+0000",
                    "updated": "2012-12-22T22:16:35.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10194\/transitions"
}