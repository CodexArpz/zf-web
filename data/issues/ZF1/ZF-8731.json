{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8731",
    "key": "ZF-8731",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Paginator bug with caching"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8731\/votes",
                "votes": 3,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10460",
                    "id": 10460,
                    "description": "Mini Release",
                    "name": "1.10.5",
                    "userReleaseDate": "26\/May\/10",
                    "archived": false,
                    "releaseDate": "2010-05-26",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-05-26T04:19:08.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=deallas",
                "name": "deallas",
                "displayName": "Michal Korus",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-01-06T17:15:07.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-05-26T04:19:08.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hello,\r\n\r\nI found a bug in Zend_Paginator. If we enable caching of queries to the database through Zend_Paginator:\r\n{code}\r\n$cache = Zend_Cache::factory('Core', 'File', $frontendOptions, $backendOptions);\r\nZend_Paginator::setCache($cache);\r\n{code}\r\n....and then run the page with the following code:\r\n{code}\r\n$news = new Default_Model_DbTable_News();\r\n$select = $news->select();\r\n$paginator = Zend_Paginator::factory($select);\r\n\r\n$page = (int)$this->_getParam('page', 1);\r\n$paginator->setItemCountPerPage(1);\r\n$paginator->setCurrentPageNumber($page);\r\n$this->view->result = $paginator;\r\n{code}\r\n...it will execute 4 queries:\r\n\r\n0.00359    connect      NULL\r\n0.00019    SELECT COUNT(1) AS `zend_paginator_row_count` FROM `news`    NULL\r\n0.00067    connect    NULL\r\n0.0003     SELECT `news`.* FROM `news` LIMIT 1    NULL\r\n\r\nAlso, it always creates a new cache with different name even though it performed the same query. I found function in code, which is responsible for generating name of cache\r\n\r\nreturn md5(serialize($this->getAdapter()) . $this->getItemCountPerPage());\r\n\r\nThe problem is that the serialized object (Zend_Paginator_Adapter_DbSelect) when Zend_Db_Profiler is enable, has also included a unique time measurement queries. So we can be 100% sure that the result of function md5() will be different every time. Also, when we execute the function serialize() of adapter, Zend_Db disconnect from the database.\r\n\r\nI prepared an initial fix, which solves the problem with the cache and re-connecting to the database. Zend_Paginator_Adapter_DbSelect class should implement Serializable interface (although I think it should all implement adapters, not only DbSelect):\r\n{code}\r\nclass Zend_Paginator_Adapter_DbSelect implements Zend_Paginator_Adapter_Interface, Serializable\r\n{\r\n...\r\n    public function serialize()\r\n    {\r\n    \treturn serialize($this->_select->__toString());\r\n    }\r\n    public function unserialize($data) {}\r\n...\r\n}{code}\r\n\r\nI hope that this bug will be fixed soon.\r\n\r\nRegards\r\ndeallas"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8731\/watchers",
                "isWatching": false,
                "watchCount": 5
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bate",
                "name": "bate",
                "displayName": "Marco Kaiser",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-6989",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6989",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10240",
                    "id": 10240,
                    "description": "Minor Release",
                    "name": "1.6.0",
                    "userReleaseDate": "02\/Sep\/08",
                    "archived": false,
                    "releaseDate": "2008-09-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10315",
                    "id": 10315,
                    "name": "Zend_Paginator",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37459",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "body": "Added formatting",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "created": "2010-01-06T17:19:40.000+0000",
                    "updated": "2010-01-06T17:19:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/38250",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=creeves1982",
                        "name": "creeves1982",
                        "displayName": "Chuck Reeves",
                        "active": true
                    },
                    "body": "Please note that:\r\n\r\n{code}\r\npublic function serialize()\r\n    {\r\n    \treturn serialize($this->_select->__toString);\r\n    }\r\n{code}\r\n\r\nShould be \r\n{code}\r\npublic function serialize()\r\n    {\r\n    \treturn serialize($this->_select->__toString());\r\n    }\r\n{code}\r\n\r\n__toString is a method call not a property. \r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=creeves1982",
                        "name": "creeves1982",
                        "displayName": "Chuck Reeves",
                        "active": true
                    },
                    "created": "2010-02-04T08:09:38.000+0000",
                    "updated": "2010-02-04T08:09:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/38282",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=creeves1982",
                        "name": "creeves1982",
                        "displayName": "Chuck Reeves",
                        "active": true
                    },
                    "body": "There is still an issue with the above fix.  The limit clause for the select statement will not be set until after the cache is checked.  When the cache is checked initially the query might look like the following:\r\n\r\nSELECT `_table`.* FROM `_table` ORDER BY `id` ASC\r\n\r\nAfter the cache is checked a call to getItems() is made to the adapter which will add the limit clause making the select statement:\r\n\r\nSELECT `_table`.* FROM `_table` ORDER BY `id` ASC LIMIT 10\r\n\r\nThat causes the generated md5 to change.  The fix would be to save the cache key to a class member and set that key on the 1st call to Zend_Paginator::_getCacheId() and unset on each call to Zend_Paginator::setItemCountPerPage() and Zend_Paginator::setCurrentPageNumber()\r\n\r\nBelow is my suggestion to help fix this issue:\r\nPlease note that _getCacheInternalId now accepts the page parameter\r\n\r\n{code}\r\nclass Zend_Paginator implements Countable, IteratorAggregate\r\n{\r\n\t\/\/...snip\r\n\t\/**\r\n\t* Saved the cache key to ensure that it will always be the same\r\n\t* from checking cache to saving.\r\n\t* @see http:\/\/framework.zend.com\/issues\/browse\/ZF-8731\r\n\t* @var unknown_type\r\n\t*\/\r\n\tprotected $_cacheKey = null;\r\n\r\n\t\/\/...snip\r\n\tpublic function setCurrentPageNumber($pageNumber)\r\n\t{\r\n\t\t$this->_currentPageNumber = (integer) $pageNumber;\r\n\t\t$this->_currentItems      = null;\r\n\t\t$this->_currentItemCount  = null;\r\n\t\t$this->_cacheKey          = null;\r\n\r\n\t\treturn $this;\r\n\t}\r\n\r\n    \t\/\/...snip\r\n\tpublic function setItemCountPerPage($itemCountPerPage)\r\n\t{\r\n\t\t$this->_itemCountPerPage = (integer) $itemCountPerPage;\r\n\t\tif ($this->_itemCountPerPage < 1) {\r\n\t\t\t$this->_itemCountPerPage = $this->getItemCountPerPage();\r\n\t\t}\r\n\t\t$this->_pageCount        = $this->_calculatePageCount();\r\n\t\t$this->_currentItems     = null;\r\n\t\t$this->_currentItemCount = null;\r\n\t\t$this->_cacheKey         = null;\r\n\r\n\t\treturn $this;\r\n\t}\r\n\t\r\n\t\/\/...snip\r\n\t\/**\r\n\t* Makes an Id for the cache\r\n\t* Depends on the adapter object and the page number\r\n\t*\r\n\t* Used to store item in cache from that Paginator instance\r\n\t*  and that current page\r\n\t*\r\n\t* @param int $page\r\n\t* @return string\r\n\t*\/\r\n\tprotected function _getCacheId($page = null)\r\n\t{\r\n\t\tif ($page === null) {\r\n\t\t\t$page = $this->getCurrentPageNumber();\r\n\t\t}\r\n\t\treturn self::CACHE_TAG_PREFIX . $page . '_' . $this->_getCacheInternalId($page);\r\n\t}\r\n\r\n\t\/**\r\n\t* Get the internal cache id\r\n\t* Depends on the adapter and the item count per page\r\n\t*\r\n\t* Used to tag that unique Paginator instance in cache\r\n\t*\r\n\t* @return string\r\n\t*\/\r\n\tprotected function _getCacheInternalId($page = null)\r\n\t{\r\n\t\tif (null == $this->_cacheKey){\r\n\t\t\tif ($page === null) {\r\n\t\t\t\t$page = $this->getCurrentPageNumber();\r\n\t\t\t}\r\n\r\n\t\t\t$this->_cacheKey\t= md5(serialize($this->getAdapter()) . $this->getItemCountPerPage() . $page); \r\n\t\t}\r\n\r\n\t\treturn $this->_cacheKey;\r\n\t}\r\n}\r\n{code}\r\n\r\n\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=creeves1982",
                        "name": "creeves1982",
                        "displayName": "Chuck Reeves",
                        "active": true
                    },
                    "created": "2010-02-05T12:47:33.000+0000",
                    "updated": "2010-02-05T12:47:33.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40699",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bate",
                        "name": "bate",
                        "displayName": "Marco Kaiser",
                        "active": true
                    },
                    "body": "fixed with r22302",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bate",
                        "name": "bate",
                        "displayName": "Marco Kaiser",
                        "active": true
                    },
                    "created": "2010-05-26T04:19:08.000+0000",
                    "updated": "2010-05-26T04:19:08.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8731\/transitions"
}