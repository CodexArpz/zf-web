{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10415",
    "key": "ZF-10415",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "bad performances with the method describeTable on several adapters (Db2, Pdo_Db2, Oracle)"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/21",
                "name": "Performance Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10415\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gregory.jarrige",
                "name": "gregory.jarrige",
                "displayName": "Gregory Jarrige",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-09-03T07:22:37.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-04-22T14:28:31.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I identified several problems on Zend_DB, in the method describeTable() of several adapters (Db2, Pdo_Db2, Oracle).\r\n\r\nHere is an example with the query specific for i5 DB2, but you'll find the same mistakes in the query specific for DB2 for Windows\/Linux :\r\n\r\n{code}\r\n\/\/ DB2 On I5 specific query\r\n$sql = \"SELECT DISTINCT C.TABLE_SCHEMA, C.TABLE_NAME, C.COLUMN_NAME, C.ORDINAL_POSITION,\r\n    C.DATA_TYPE, C.COLUMN_DEFAULT, C.NULLS ,C.LENGTH, C.SCALE, LEFT(C.IDENTITY,1),\r\n    LEFT(tc.TYPE, 1) AS tabconsttype, k.COLSEQ\r\n    FROM QSYS2.SYSCOLUMNS C\r\n    LEFT JOIN (QSYS2.syskeycst k JOIN QSYS2.SYSCST tc\r\n        ON (k.TABLE_SCHEMA = tc.TABLE_SCHEMA\r\n          AND k.TABLE_NAME = tc.TABLE_NAME\r\n          AND LEFT(tc.type,1) = 'P'))\r\n        ON (C.TABLE_SCHEMA = k.TABLE_SCHEMA\r\n           AND C.TABLE_NAME = k.TABLE_NAME\r\n           AND C.COLUMN_NAME = k.COLUMN_NAME)\r\n    WHERE \"\r\n     . $this->quoteInto('UPPER(C.TABLE_NAME) = UPPER(?)', $tableName);\r\n\r\nif ($schemaName) {\r\n    $sql .= $this->quoteInto(' AND UPPER(C.TABLE_SCHEMA) = UPPER(?)', $schemaName);\r\n}\r\n\r\n$sql .= \" ORDER BY C.ORDINAL_POSITION FOR FETCH ONLY\";\r\n{code}\r\n\r\nThe mistakes are :\r\n\r\n1 - it is a very bad practice to use the function UPPER on the columns C.TABLE_NAME and C.TABLE_SCHEMA : when you do that, the SQL engine of DB2 can't find an index optimized for the query, so he will parse all the table. It's very bad for performances, and completely useless, because all the characters in that system table are always uppercased. I have an i5 platform here with a table which contains 5 million of lines, can you imagine the result ? I'm not expert on Oracle database but I think that the problem is probably the same with the Oracle apdater.\r\n\r\n2 - the clause DISTINCT in the beginning of the table is very bad for performances, and very dangerous. Practically, the situation where $schemaName is unknown is unacceptable because, on a DB2 database, you can have 2 tables with the same name, in 2 different schemas, and with structures completely different. In that situation, merge the structure of the 2 tables with a DISTINCT clause would generate a datastructure completely wrong. With DB2, not define the schemaname should be simply forbidden. Another solution could be to use the DISTINCT function only if the schema name is unknown.\r\n\r\n3 - several versions of DB2 for i5 don't accept not to have a space after the comma, in functions like LEFT(C.IDENTITY,1) and LEFT(tc.type,1). For a better portability, it's better to have always a space after the comma, even if it seems ridiculous.\r\n\r\nA better implementation could be this one :\r\n\r\n{code}\r\n\/\/ DB2 On I5 specific query\r\nif ($schemaName != '') {\r\n   $distinct_function = '' ;\r\n} else {\r\n   $distinct_function = 'DISTINCT' ;\r\n}\r\n$sql = \"SELECT {$distinct_function} C.TABLE_SCHEMA, C.TABLE_NAME, C.COLUMN_NAME, C.ORDINAL_POSITION,\r\n    C.DATA_TYPE, C.COLUMN_DEFAULT, C.NULLS ,C.LENGTH, C.SCALE, LEFT(C.IDENTITY, 1),\r\n    LEFT(tc.TYPE, 1) AS tabconsttype, k.COLSEQ\r\n    FROM QSYS2.SYSCOLUMNS C\r\n    LEFT JOIN (QSYS2.syskeycst k JOIN QSYS2.SYSCST tc\r\n        ON (k.TABLE_SCHEMA = tc.TABLE_SCHEMA\r\n          AND k.TABLE_NAME = tc.TABLE_NAME\r\n          AND LEFT(tc.type, 1) = 'P'))\r\n        ON (C.TABLE_SCHEMA = k.TABLE_SCHEMA\r\n           AND C.TABLE_NAME = k.TABLE_NAME\r\n           AND C.COLUMN_NAME = k.COLUMN_NAME)\r\n    WHERE \"\r\n     . $this->quoteInto('C.TABLE_NAME = UPPER(?)', $tableName);\r\n\r\nif ($schemaName != '') {\r\n    $sql .= $this->quoteInto(' AND C.TABLE_SCHEMA = UPPER(?)', $schemaName);\r\n}\r\n\r\n$sql .= \" ORDER BY C.ORDINAL_POSITION FOR FETCH ONLY\";\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10415\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-7427",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7427",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10490",
                    "id": 10490,
                    "description": "Mini Release",
                    "name": "1.10.8",
                    "userReleaseDate": "25\/Aug\/10",
                    "archived": false,
                    "releaseDate": "2010-08-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10190",
                    "id": 10190,
                    "name": "Zend_Db_Adapter_Db2",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10135",
                    "id": 10135,
                    "name": "Zend_Db_Adapter_Oracle",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43493",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rodflohr",
                        "name": "rodflohr",
                        "displayName": "Rod Flohr",
                        "active": true
                    },
                    "body": "It is not always true that characters in QSYS2.SYSCOLUMNS are all upper case on the i5.  Quoting table names and column names in the CREATE TABLE will cause them to be case sensitive in the SYSCOLUMNS table:\r\n\r\nFrom a 5250 command line, STRSQL, and then\r\n\r\nCREATE TABLE SCHEMA\/\"inventory\"             \r\n    (\"PartNo\"         SMALLINT     NOT NULL,\r\n    \"Descr\"          VARCHAR(24),           \r\n    \"QOnHand\"        INT) \r\n\r\nthen:\r\n\r\nselect * from QSYS2\/SYSCOLUMNS where TABLE_NAME='inventory'  \r\n\r\nThe result of this will be:\r\n\r\n{{COLUMN_NAME     TABLE_NAME}}\r\n           \r\n{{PartNo          inventory}}\r\n{{Descr           inventory}}\r\n{{QOnHand         inventory}}\r\n\r\nIf you then do this (not using any quotes):\r\n\r\nCREATE TABLE SCHEMA\/inventory             \r\n    (PartNo         SMALLINT     NOT NULL,\r\n    Descr          VARCHAR(24),           \r\n    QOnHand        INT)                   \r\n\r\nYou will now have two tables, one with the mixed case table and column names, and one where they are all upper case.  Then, if you do this, using the UPPER() functions:\r\n\r\nselect * from QSYS2\/SYSCOLUMNS where UPPER(TABLE_NAME)=UPPER('inventory')   \r\n\r\nThe result would be:\r\n   \r\n{{COLUMN_NAME     TABLE_NAME}}\r\n           \r\n{{PartNo          inventory}}\r\n{{Descr           inventory}}\r\n{{QOnHand         inventory}}\r\n{{PARTNO          INVENTORY}}\r\n{{DESCR           INVENTORY}}\r\n{{QONHAND         INVENTORY}}\r\n\r\nLeaving out the UPPER() functions, the result of the select will depend on the case of the table name.  Doing this:\r\n\r\nselect * from QSYS2\/SYSCOLUMNS where TABLE_NAME='inventory'\r\n\r\ngives this:\r\n\r\n{{COLUMN_NAME     TABLE_NAME}}\r\n           \r\n{{PartNo          inventory}}\r\n{{Descr           inventory}}\r\n{{QOnHand         inventory}}\r\n                                       \r\nDoing this:\r\n\r\nselect * from QSYS2\/SYSCOLUMNS where TABLE_NAME='INVENTORY' \r\n\r\ngives this:\r\n\r\n{{COLUMN_NAME     TABLE_NAME}}\r\n           \r\n{{PARTNO          INVENTORY}}\r\n{{DESCR           INVENTORY}}\r\n{{QONHAND         INVENTORY}}\r\n\r\nSo, case sensitivity does need to be taken into account, although it is not clear whether using UPPER() really will always give the desired result.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rodflohr",
                        "name": "rodflohr",
                        "displayName": "Rod Flohr",
                        "active": true
                    },
                    "created": "2010-12-06T06:53:35.000+0000",
                    "updated": "2010-12-06T07:19:18.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43925",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gregory.jarrige",
                        "name": "gregory.jarrige",
                        "displayName": "Gregory Jarrige",
                        "active": true
                    },
                    "body": "I did not know it was possible to use the case-sensitivity whith STRSQL mode. Thank's a lot, Rod, for that information. I agree with you on the fact that the UPPER function is inappropriate in that context.\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gregory.jarrige",
                        "name": "gregory.jarrige",
                        "displayName": "Gregory Jarrige",
                        "active": true
                    },
                    "created": "2011-01-05T04:29:51.000+0000",
                    "updated": "2011-01-05T04:29:51.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10415\/transitions"
}