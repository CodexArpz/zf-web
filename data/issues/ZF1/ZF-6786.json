{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6786",
    "key": "ZF-6786",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "When encoding an non-associative array with a Zend_Json_Expr the result is the magic key: ____0"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField",
            "value": {
                "timeestimate": 0,
                "timespent": 30
            }
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6786\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10330",
                    "id": 10330,
                    "description": "Mini Release",
                    "name": "1.8.2",
                    "userReleaseDate": "27\/May\/09",
                    "archived": false,
                    "releaseDate": "2009-05-27",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-06-02T06:22:57.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mthielen",
                "name": "mthielen",
                "displayName": "Markus Thielen",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-05-23T02:57:58.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-06-02T06:22:57.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Zend_Json",
                "Zend_Json_Expr"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "This code:\n \n{code}$values = array();\n$values['plugins'] = \n  array(\n    new Zend_Json_Expr(\n      'new Ext.ux.PageSizePlugin()'\n    )\n  );\n\nreturn Zend_Json::encode(\t$values,\n    \t\t\t\tfalse,\n    \t\t\t\tarray('enableJsonExprFinder' => true));{code}\n\nreturns\n\n{code}{\"plugins\":[\"____0_1\"]}{code}\n\nwhat is obviously wrong.\n\nI created a fix in zend\/Json.php for this case. line 135:\n{code}if ($key == '') {\n\t$encodedResult = str_replace(\n    \t'\"' . $magicKey . '\"',\n    \t$value,\n    \t$encodedResult\n\t);\n} else {\n\t$encodedResult = str_replace(\n    \t'\"' . $key . '\":\"' . $magicKey . '\"',\n        '\"' . $key . '\":' . $value,\n        $encodedResult\n\t);\n}{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6786\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/worklog\/21858",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6786",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "comment": "Recoded Zend_Json::encode method to allow replacing of \"Zend_Json_Expr\" when a non associative array is passed as param to be encoded.",
                    "created": "2009-05-27T07:56:00.000+0000",
                    "updated": "2009-05-27T07:56:00.000+0000",
                    "started": "2009-05-27T07:53:00.000+0000",
                    "minutesSpent": 30
                }
            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                "name": "oreales",
                "displayName": "Oscar Reales",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11953",
                    "filename": "Json.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "created": "2009-05-27T08:01:05.000+0000",
                    "size": 14797,
                    "mimeType": "application\/x-php",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11953\/Json.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11943",
                    "filename": "Json.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mthielen",
                        "name": "mthielen",
                        "displayName": "Markus Thielen",
                        "active": true
                    },
                    "created": "2009-05-23T02:59:18.000+0000",
                    "size": 14602,
                    "mimeType": "application\/text",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11943\/Json.php"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10241",
                    "id": 10241,
                    "description": "Minor Release",
                    "name": "1.8.0",
                    "userReleaseDate": "30\/Apr\/09",
                    "archived": false,
                    "releaseDate": "2009-04-30",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10016",
                    "id": 10016,
                    "name": "Zend_Json",
                    "description": "serializes native PHP to JSON and decodes JSON to native PHP",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31288",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mthielen",
                        "name": "mthielen",
                        "displayName": "Markus Thielen",
                        "active": true
                    },
                    "body": "patches Json.php file",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mthielen",
                        "name": "mthielen",
                        "displayName": "Markus Thielen",
                        "active": true
                    },
                    "created": "2009-05-23T02:59:18.000+0000",
                    "updated": "2009-05-23T02:59:18.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31340",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Assigning to Oscar.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-05-25T18:34:43.000+0000",
                    "updated": "2009-05-25T18:34:43.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31341",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "body": "I encountered this behaviour too this week... confirmed ;)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "created": "2009-05-25T18:37:41.000+0000",
                    "updated": "2009-05-25T18:37:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31373",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "body": "working on it!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "created": "2009-05-27T03:16:26.000+0000",
                    "updated": "2009-05-27T03:16:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31385",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "body": "Ok this is what I get:\n\n1.- In the pre-encoding call to _recursiveJsonExprFinder function, when a non-assoc array is passed, the \"key\" is setted to \"null\". This happen because the function Zend_Json_Encoder::encodeUnicodeString returns null when an integer is passed as param.\n\n2.- Because of that, the after encoding replacing fails.\n\nIt could be fixed with the next patch mentioned before:\n\n{code}\nif ($key == '') {\n\t$encodedResult = str_replace(\n    \t'\"' . $magicKey . '\"',\n    \t$value,\n    \t$encodedResult\n\t);\n} else {\n\t$encodedResult = str_replace(\n    \t'\"' . $key . '\":\"' . $magicKey . '\"',\n        '\"' . $key . '\":' . $value,\n        $encodedResult\n\t);\n}\n{code}\n\nbut it nis not neccessary because with the actual code \"key\" is not neccesary anymore. It is enough replacing \"magicKey\" by its correspondant \"value\":\n\n{code}\n        \/\/only do post-proccessing to revert back the Zend_Json_Expr if any.\n        if (count($javascriptExpressions) > 0) {\n            $count = count($javascriptExpressions);\n            for($i = 0; $i < $count; $i++) {\n                \/\/$key      = $javascriptExpressions[$i]['key'];\/\/key is not neccesary\n                $magicKey = $javascriptExpressions[$i]['magicKey'];\n                $value    = $javascriptExpressions[$i]['value'];\n\n                $encodedResult = str_replace(\n                \/\/instead of replacing \"key:magicKey\", we replace directly magicKey by value because \"key\" never changes.\n                \/\/ '\"' . $key . '\":\"' . $magicKey . '\"',\n                \/\/'\"' . $key . '\":' . $value,\n               \n                    '\"' . $magicKey . '\"',\n                    $value,\n                    $encodedResult\n                );\n            }\n        }\n{code}\n\nAnyway, to avoid unneccesary function calls when the \"currentKey\" is an integer (non associative array) I changed also this code:\n\n{code}\n  \"magicKey\" =>  Zend_Json_Encoder::encodeUnicodeString($magicKey),\n{code}\n\nfor this:\n\n{code}\n  \"magicKey\" => (is_int($currentKey)) ? $magicKey : Zend_Json_Encoder::encodeUnicodeString($magicKey),\n{code}\n\nI have re-code \"Zend_Json\" and added a test to JsonTest.php to testing this bug. Test is OK now.\n\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "created": "2009-05-27T07:51:15.000+0000",
                    "updated": "2009-05-27T07:51:15.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31386",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "body": "Re-coded Zend_Json to fix issue, and avoid unnecessary calls to Zend_Json_Encoder::encodeUnicodeString();\ncomments on changes included (clean old code and comments in final version).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=oreales",
                        "name": "oreales",
                        "displayName": "Oscar Reales",
                        "active": true
                    },
                    "created": "2009-05-27T08:01:07.000+0000",
                    "updated": "2009-05-27T08:01:07.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6786\/transitions"
}