{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4370",
    "key": "ZF-4370",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Form::getValues returns invalid rendered array when using subforms"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4370\/votes",
                "votes": 5,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-04-15T06:46:35.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=sojuz",
                "name": "sojuz",
                "displayName": "Adam Mielko",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-09-24T05:59:01.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-03-18T08:15:22.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When using subforms in Zend_Form, getValues method returns subform values with empty key. In zf 1.5 it looks like this: array('value' => 1, 'value2' => 2, 'subform' => array(...))\nIn zf 1.6 it looks like this: array('value' => 1, 'value2' => 2, '' => array(...))"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4370\/watchers",
                "isWatching": false,
                "watchCount": 7
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-8078",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8078",
                    "type": {
                        "name": "Dependency",
                        "direction": "OUTBOUND",
                        "description": "depends on"
                    }
                },
                {
                    "issueKey": "ZF-9407",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9407",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-9456",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9456",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10240",
                    "id": 10240,
                    "description": "Minor Release",
                    "name": "1.6.0",
                    "userReleaseDate": "02\/Sep\/08",
                    "archived": false,
                    "releaseDate": "2008-09-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10029",
                    "id": 10029,
                    "name": "Zend_Form",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/25651",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=elazar",
                        "name": "elazar",
                        "displayName": "Matthew Turland",
                        "active": true
                    },
                    "body": "See the block below from Zend_Form::getValues().\n\n{code}\nforeach ($this->getSubForms() as $key => $subForm) {\n    $fValues = $this->_attachToArray($subForm->getValues(true), $subForm->getElementsBelongTo());\n    $values = array_merge($values, $fValues);\n}\n{code}\n\nThe issue described is caused by $subForm->setElementsBelongTo() never being called, which results in the call to $subForm->getElementsBelongsTo() returning a null value. The subsequent array_merge() call overrides the existing blank index on each iteration of the loop with the array from the last subform for which values were fetched. \n\nMaybe the return value of $subForm->getElementsBelongsTo() should be checked prior to the loop and $subForm->getName() used in the event that it's empty? Either that or just using $subForm->getName() outright would be my suggestion. When adding a subform to a form, it has to be present and unique anyway.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-11-04T08:55:08.000+0000",
                    "updated": "2009-04-14T19:08:33.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29446",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=harabanar",
                        "name": "harabanar",
                        "displayName": "Helgi Hrafn Halld\u00f3rsson",
                        "active": true
                    },
                    "body": "Any news on this issue ? This is a major bug when having multible subforms, beacuse you only get the values from one of the subforms :S\n\nplz let us know!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=harabanar",
                        "name": "harabanar",
                        "displayName": "Helgi Hrafn Halld\u00f3rsson",
                        "active": true
                    },
                    "created": "2009-03-13T01:42:07.000+0000",
                    "updated": "2009-03-13T01:42:07.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30143",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "I believe this is already fixed in recent versions of ZF. I performed the following test just now:\n{code}\n$sub = new Zend_Form_SubForm();\n$sub->setName('subform')\n    ->addElement('text', 'foo')\n    ->addElement('text', 'bar');\n\n$form = new Zend_Form();\n$form->addElement('text', 'foo')\n     ->addElement('text', 'bar')\n     ->addSubForm($sub, 'subform');\n\n$form->foo->setValue('FOO');\n$form->bar->setValue('BAR');\n$form->subform->foo->setValue('FOO');\n$form->subform->bar->setValue('BAR');\n\n$values = $form->getValues();\nvar_export($values);\n{code}\n\nI get the expected output:\n\n{code}\narray (\n  'foo' => 'FOO',\n  'bar' => 'BAR',\n  'subform' => \n  array (\n    'foo' => 'FOO',\n    'bar' => 'BAR',\n  ),\n)\n{code}\n\nI'm closing this for now. If you have a reproduce case that displays the issue you're reporting using current trunk, please re-open the issue and provide it.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-04-15T06:42:55.000+0000",
                    "updated": "2009-04-15T06:42:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30144",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "And just as a followup, I did a test with multiple sub forms and nested subforms as well:\n{code}\n$sub = new Zend_Form_SubForm();\n$sub->setName('subform')\n    ->addElement('text', 'foo')\n    ->addElement('text', 'bar');\n\n$sub2 = new Zend_Form_SubForm();\n$sub2->setName('subform2')\n     ->addElement('text', 'foo')\n     ->addElement('text', 'bar');\n\n$sub3 = new Zend_Form_SubForm();\n$sub3->setName('subform3')\n     ->addElement('text', 'foo')\n     ->addElement('text', 'bar');\n$sub2->addSubForm($sub3, 'subform3');\n$sub2->subform3->foo->setValue('FOO');\n$sub2->subform3->bar->setValue('BAR');\n\n$form = new Zend_Form();\n$form->addElement('text', 'foo')\n     ->addElement('text', 'bar')\n     ->addSubForm($sub, 'subform')\n     ->addSubForm($sub2, 'subform2');\n\n$form->foo->setValue('FOO');\n$form->bar->setValue('BAR');\n$form->subform->foo->setValue('FOO');\n$form->subform->bar->setValue('BAR');\n$form->subform2->foo->setValue('FOO');\n$form->subform2->bar->setValue('BAR');\n\n$values = $form->getValues();\nvar_export($values);\n{code}\n\nThis gave the expected output as well:\n\n{code}\narray (\n  'foo' => 'FOO',\n  'bar' => 'BAR',\n  'subform' => \n  array (\n    'foo' => 'FOO',\n    'bar' => 'BAR',\n  ),\n  'subform2' => \n  array (\n    'foo' => 'FOO',\n    'bar' => 'BAR',\n    'subform3' => \n    array (\n      'foo' => 'FOO',\n      'bar' => 'BAR',\n    ),\n  ),\n)\n{code}\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-04-15T06:46:14.000+0000",
                    "updated": "2009-04-15T06:46:14.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30173",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=remy215",
                        "name": "remy215",
                        "displayName": "Remy Damour",
                        "active": true
                    },
                    "body": "Hi,\nI've tried the above code on ZF 1.7.8 (latest stable release), and indeed it works.\n\nProblem is that it does not work if, instead of instanciating a Zend_Form_SubForm, you simply provide a Zend_Form:\n{code}\n$sub = new Zend_Form();\n$sub->setName('subform')\n    ->addElement('text', 'foo')\n    ->addElement('text', 'bar');\n\n$form = new Zend_Form();\n$form->addElement('text', 'foo')\n     ->addElement('text', 'bar')\n     ->addSubForm($sub, 'subform');\n\n$form->foo->setValue('FOO');\n$form->bar->setValue('BAR');\n$form->subform->foo->setValue('FOO');\n$form->subform->bar->setValue('BAR');\n\n$values = $form->getValues();\nvar_export($values);\n{code}\n\nThis gives the wrong output (subform name not used as key in array => multiple subforms overwrite one another):\n{code}\narray (\n  'foo' => 'FOO',\n  'bar' => 'BAR',\n  '' => \n  array (\n    'foo' => 'FOO',\n    'bar' => 'BAR',\n  ),\n)\n{code}\n\nBy the way, is it possible to make the call to {{$sub->setName('subform')}} optional since when we attach the subform, we do provide a name! {{->addSubForm($sub, 'subform');}}\n\nPS1: I did not find how to re-open the bug, I hope that commenting will automatically re-open it\nPS2: it has nothing to do with this bug, but please update the downloadable api documentation upon each release! (it's currently stuck on 1.7.2 and it's a real pain to regenerate it each time): http:\/\/framework.zend.com\/docs\/api",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=remy215",
                        "name": "remy215",
                        "displayName": "Remy Damour",
                        "active": true
                    },
                    "created": "2009-04-16T10:54:27.000+0000",
                    "updated": "2009-04-16T10:54:27.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31604",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=stephenminded",
                        "name": "stephenminded",
                        "displayName": "Steve Lounsbury",
                        "active": true
                    },
                    "body": "I can confirm the comment above as well (on 1.8.2). It only happens when using Zend_Form as a subform instead of Zend_Form_SubForm. \n\nAccording to the docs, this is perfectly legal: \"A sub form may be a Zend_Form object, or, more typically, a Zend_Form_SubForm object.\"\n\nPerhaps this needs to be opened as a new issue?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=stephenminded",
                        "name": "stephenminded",
                        "displayName": "Steve Lounsbury",
                        "active": true
                    },
                    "created": "2009-06-04T22:06:16.000+0000",
                    "updated": "2009-06-04T22:06:16.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33446",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=djvirgen",
                        "name": "djvirgen",
                        "displayName": "Hector Virgen",
                        "active": true
                    },
                    "body": "To add a Zend_Form object as a subform, you need to call $subform->setIsArray(true). This will allow $form->getValues() to produce the expected array.\n\n{code}\n$form = new MyForm(); \/\/ extends Zend_Form\n$subform = new MySubform(); \/\/ extends Zend_Form\n$subform->setIsArray(true);\n$form->addSubform($subform, 'mysubform');\n{code}\n\nAnother issue related to adding Zend_Form objects as subforms is that the subforms have their own <form> tag. The fix is to remove the \"Form\" decorator from each subform:\n\n{code}\n$form = new MyForm(); \/\/ extends Zend_Form\n$subform = new MySubform(); \/\/ extends Zend_Form\n$subform->setIsArray(true);\n$subform->removeDecorator('Form');\n$form->addSubform($subform, 'mysubform');\n{code}\n\nIt would be nice if Zend_Form::addSubform() handled these tasks automatically.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=djvirgen",
                        "name": "djvirgen",
                        "displayName": "Hector Virgen",
                        "active": true
                    },
                    "created": "2009-08-13T14:24:14.000+0000",
                    "updated": "2009-08-13T14:24:14.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35536",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=blocka",
                        "name": "blocka",
                        "displayName": "Avi Block",
                        "active": true
                    },
                    "body": "I don't believe this issue is closed. Matthew's tests did not hit the sweet spot, which is having multiple subforms of the same level. Only the last one is getting returned. Please fix this.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=blocka",
                        "name": "blocka",
                        "displayName": "Avi Block",
                        "active": true
                    },
                    "created": "2009-10-25T16:37:24.000+0000",
                    "updated": "2009-10-25T16:37:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/38916",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jamal",
                        "name": "jamal",
                        "displayName": "Jamal Fanaian",
                        "active": true
                    },
                    "body": "I am able to replicate what I understand the issue to be. It seems that array_merge is overwriting previous entries of the same subform. Using array_merge_recursive solves the issue. Here is an example on replicating it.\r\n\r\n{code}\r\n<?php\r\n\r\nrequire 'Zend\/Form.php';\r\nrequire 'Zend\/Form\/SubForm.php';\r\n\r\nclass MyForm extends Zend_Form\r\n{\r\n    public function init()\r\n    {\r\n        $this->addElement('text', 'foo');\r\n    }\r\n}\r\n\r\nclass MySubForm extends Zend_Form_SubForm\r\n{\r\n    static protected $formId = 0;\r\n\r\n    public function init()\r\n    {\r\n        $this->setElementsBelongTo('mysubform[' . self::$formId++ . ']');\r\n        $this->addElement('text', 'bar');\r\n    }\r\n}\r\n\r\n$data = array(\r\n    'foo' => 'one',\r\n    'mysubform' => array(\r\n        array(\r\n            'bar' => 'two',\r\n        ),\r\n        array(\r\n            'bar' => 'three',\r\n        ),\r\n    ),\r\n);\r\n\r\n\/\/ Method 1:\r\n\/\/ Simply calling Zend_Form::isValid() will not work because the form\r\n\/\/ has no knowledge of the SubForms.\r\n$form = new MyForm();\r\n$form->isValid($data);\r\nvar_dump($form->getValues());\r\n\/* Result:\r\narray(1) {\r\n  [\"foo\"]=>\r\n  string(3) \"one\"\r\n}\r\n*\/\r\n\r\n\/\/ Method 2: \r\n\/\/ So the second option is just to add the subforms and then try to\r\n\/\/ validate the data. This method almost works. The data is validated\r\n\/\/ correctly. The problem here is in Zend_Form::getValues(). The issue,\r\n\/\/ is that array_merge will overwrite each mysubform key even if they\r\n\/\/ have differing keys within it. The only way to solve this is by using\r\n\/\/ array_merge_recursive instead.\r\n$form = new MyForm();\r\n\r\nforeach ($data['mysubform'] as $key => $datasub) {\r\n    $subform = new MySubForm();\r\n    $form->addSubForm($subform, 'mysubform' . $key);\r\n}\r\n\r\n$form->isValid($data);\r\nvar_dump($form->getValues());\r\n\/* Result:\r\narray(3) {\r\n  [\"foo\"]=>\r\n  string(3) \"one\"\r\n  [\"mysubform0\"]=>\r\n  array(0) {\r\n  }\r\n  [\"mysubform1\"]=>\r\n  array(0) {\r\n  }\r\n}\r\n*\/\r\n\r\n\/\/ Now, changing array_merge to array_merge_recursive in \r\n\/\/ Zend\/Form.php:1308 solves the problem, yielding the expected result\r\n\/* Result:\r\narray(2) {\r\n  [\"foo\"]=>\r\n  string(3) \"one\"\r\n  [\"mysubform\"]=>\r\n  array(2) {\r\n    [0]=>\r\n    array(1) {\r\n      [\"bar\"]=>\r\n      string(3) \"two\"\r\n    }\r\n    [1]=>\r\n    array(1) {\r\n      [\"bar\"]=>\r\n      string(5) \"three\"\r\n    }\r\n  }\r\n}\r\n *\/\r\n{\/code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jamal",
                        "name": "jamal",
                        "displayName": "Jamal Fanaian",
                        "active": true
                    },
                    "created": "2010-03-01T15:10:40.000+0000",
                    "updated": "2010-03-01T15:10:40.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4370\/transitions"
}