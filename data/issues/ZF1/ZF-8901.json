{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8901",
    "key": "ZF-8901",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Adapter_Sqlsrv - sorting by two or more fields. Method limit work not correctly."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8901\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-04-16T08:13:55.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mzylinski",
                "name": "mzylinski",
                "displayName": "Michal Zylinski",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-01-22T02:43:31.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-04-16T08:13:55.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "class:Zend_Db_Adapter_Sqlsrv\r\nmethod: limit\r\nversion:svn trunk\r\nWhen data are sorting by two or more fields, method limit work not correctly.\r\n\r\nCurrent method limit:\r\n     public function limit($sql, $count, $offset = 0)\r\n     {\r\n        $count = intval($count);\r\n        if ($count <= 0) {\r\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\r\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument count=$count is not valid\");\r\n        }\r\n\r\n        $offset = intval($offset);\r\n        if ($offset < 0) {\r\n            \/** @see Zend_Db_Adapter_Exception *\/\r\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\r\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument offset=$offset is not valid\");\r\n        }\r\n\r\n        $orderby = stristr($sql, 'ORDER BY');\r\n        if ($orderby !== false) {\r\n            $sort  = (stripos($orderby, ' desc') !== false) ? 'desc' : 'asc';\r\n            $order = str_ireplace('ORDER BY', '', $orderby);\r\n            $order = trim(preg_replace('\/\\bASC\\b|\\bDESC\\b\/i', '', $order));\r\n        }\r\n\r\n        $sql = preg_replace('\/^SELECT\\s\/i', 'SELECT TOP ' . ($count+$offset) . ' ', $sql);\r\n\r\n        $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';\r\n        if ($orderby !== false) {\r\n            $sql .= ' ORDER BY ' . $order . ' ';\r\n            $sql .= (stripos($sort, 'asc') !== false) ? 'DESC' : 'ASC';\r\n        }\r\n        $sql .= ') AS outer_tbl';\r\n        if ($orderby !== false) {\r\n            $sql .= ' ORDER BY ' . $order . ' ' . $sort;\r\n        }\r\n\r\n        return $sql;\r\n    }\r\n\r\nsuggested solution (from Zend_Db_Adapter_Pdo_Mssql):\r\n     public function limit($sql, $count, $offset = 0)\r\n     {\r\n        $count = intval($count);\r\n        if ($count <= 0) {\r\n            \/** @see Zend_Db_Adapter_Exception *\/\r\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\r\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument count=$count is not valid\");\r\n        }\r\n\r\n        $offset = intval($offset);\r\n        if ($offset < 0) {\r\n            \/** @see Zend_Db_Adapter_Exception *\/\r\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\r\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument offset=$offset is not valid\");\r\n        }\r\n\r\n        $sql = preg_replace(\r\n            '\/^SELECT\\s+(DISTINCT\\s)?\/i',\r\n            'SELECT $1TOP ' . ($count+$offset) . ' ',\r\n            $sql\r\n            );\r\n        \r\n        if ($offset > 0) {\r\n\t        $orderby = stristr($sql, 'ORDER BY');\r\n\t        \r\n\t        if ($orderby !== false) {\r\n\t            $orderParts = explode(',', substr($orderby, 8));\r\n\t            $pregReplaceCount = null;\r\n\t            $orderbyInverseParts = array();\r\n\t            foreach ($orderParts as $orderPart) {\r\n\t            \t$orderPart = rtrim($orderPart);\r\n\t                $inv = preg_replace('\/\\s+desc$\/i', ' ASC', $orderPart, 1, $pregReplaceCount);\r\n\t                if ($pregReplaceCount) {\r\n\t                    $orderbyInverseParts[] = $inv;\r\n\t                    continue;\r\n\t                }\r\n\t                $inv = preg_replace('\/\\s+asc$\/i', ' DESC', $orderPart, 1, $pregReplaceCount);\r\n\t                if ($pregReplaceCount) {\r\n\t                    $orderbyInverseParts[] = $inv;\r\n\t                    continue;\r\n\t                } else {\r\n\t                    $orderbyInverseParts[] = $orderPart . ' DESC';\r\n\t                }\r\n\t            }\r\n\t            \r\n\t            $orderbyInverse = 'ORDER BY ' . implode(', ', $orderbyInverseParts);\r\n\t        }\r\n\t\r\n\t        \r\n\t\r\n\t\r\n\t        $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';\r\n\t        if ($orderby !== false) {\r\n\t            $sql .= ' ' . $orderbyInverse . ' ';\r\n\t        }\r\n\t        $sql .= ') AS outer_tbl';\r\n\t        if ($orderby !== false) {\r\n\t            $sql .= ' ' . $orderby;\r\n\t        }\r\n        }\r\n        \r\n        return $sql;\r\n    }\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8901\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                "name": "juokaz",
                "displayName": "Juozas Kaziukenas",
                "active": false
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10400",
                    "id": 10400,
                    "description": "Mini Release",
                    "name": "1.9.7",
                    "userReleaseDate": "11\/Jan\/10",
                    "archived": false,
                    "releaseDate": "2010-01-11",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/38579",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=patf",
                        "name": "patf",
                        "displayName": "Patrick Figel",
                        "active": true
                    },
                    "body": "This can be fixed by simply copy&pasting Zend_Db_Adapter_Pdo_Mssql's limit()-Method to Zend_Db_Adapter_Sqlsrv.\r\n\r\nWe've been hacking this function into Zend_Db_Adapter_Sqlsrv for quite a while now with each new release, would be nice to see it fixed.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=patf",
                        "name": "patf",
                        "displayName": "Patrick Figel",
                        "active": true
                    },
                    "created": "2010-02-19T08:20:04.000+0000",
                    "updated": "2010-02-19T08:20:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39896",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zukunft",
                        "name": "zukunft",
                        "displayName": "Timon Zielonka",
                        "active": true
                    },
                    "body": "I had the same problem, but it looks to me that in the suggested solution has some formatting problems. I copied the suggested solution, but this caused syntax errors for example at \"SELECT $1TOP\". So I used this little bit different code:\r\n\r\n...\r\n       $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';\r\n        if ($orderby !== false) {\r\n\t\t\/\/ new lines for SQL Server 2005\r\n\t\t$order_txt = str_ireplace('ORDER BY', '', $orderby);\r\n\t\t$order_invert = $order_txt;\r\n\t\tif (stripos($sort, 'asc') !== false) {\r\n\t            $order_invert = trim(preg_replace('\/ASC\/i', 'CSED', $order_invert));\r\n\t            $order_invert = trim(preg_replace('\/DESC\/i', 'ASC', $order_invert));\r\n\t            $order_invert = trim(preg_replace('\/CSED\/i', 'DESC', $order_invert));\r\n\t\t} else {\r\n\t            $order_invert = trim(preg_replace('\/DESC\/i', 'CSA', $order_invert));\r\n\t            $order_invert = trim(preg_replace('\/ASC\/i', 'DESC', $order_invert));\r\n\t            $order_invert = trim(preg_replace('\/CSA\/i', 'ASC', $order_invert));\r\n\t\t}\r\n\t\t$sql .= ' ORDER BY ' . $order_invert . ' ';\r\n\t\t\/\/ removed lines for SQL Server 2005\r\n\t\t\/\/$sql .= ' ORDER BY ' . $order . ' ';\r\n\t\t\/\/$sql .= (stripos($sort, 'asc') !== false) ? 'DESC' : 'ASC';\r\n        }\r\n        $sql .= ') AS outer_tbl';\r\n        if ($orderby !== false) {\r\n\t    \/\/ new lines for SQL Server 2005\r\n            $sql .= ' ORDER BY ' . $order_txt . ' ';\r\n\t    \/\/ removed lines for SQL Server 2005\r\n            \/\/$sql .= ' ORDER BY ' . $order . ' ' . $sort;\r\n        }\r\n...\r\n\r\nThis works as long as you do not have any fields called 'ASC' or 'DESC' ...\r\n\r\nBut it would be really good to see this but solved in the next framework version",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zukunft",
                        "name": "zukunft",
                        "displayName": "Timon Zielonka",
                        "active": true
                    },
                    "created": "2010-04-08T06:56:09.000+0000",
                    "updated": "2010-04-08T06:56:09.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40040",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "body": "Fixed in r21885",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "created": "2010-04-16T08:13:55.000+0000",
                    "updated": "2010-04-16T08:13:55.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8901\/transitions"
}