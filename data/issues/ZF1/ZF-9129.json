{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9129",
    "key": "ZF-9129",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Rule with assertion considered equivalent to rule without assertion"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9129\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-07-16T14:40:41.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=david+at+artefactual",
                "name": "david at artefactual",
                "displayName": "David Juhasz",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-02-09T16:57:55.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-07-16T14:40:41.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "In our project we'd like to add multiple rules with the same role, resource and permission, but a different assertion.  To illustrated I've created an example:\r\n\r\n{code}\r\nclass myResource extends Zend_Acl_Resource\r\n{\r\n  public $topic;\r\n\r\n  public function __construct($resourceId, $topic = null)\r\n  {\r\n    $this->_resourceId = (string) $resourceId;\r\n    $this->topic = (null !== $topic) ? (string) $topic : 'unclassified';\r\n  }\r\n}\r\n\r\nclass AssertTopic implements Zend_Acl_Assert_Interface\r\n{\r\n  protected $_testTopic;\r\n\r\n  public function __construct($topic)\r\n  {\r\n    $this->_testTopic = $topic;\r\n  }\r\n\r\n  public function assert(Zend_Acl $acl,\r\n                         Zend_Acl_Role_Interface $role = null,\r\n                         Zend_Acl_Resource_Interface $resource = null,\r\n                         $privilege = null)\r\n  {\r\n    return $resource->topic == $this->_testTopic; \r\n  }\r\n}\r\n\r\n$acl = new Zend_Acl;\r\n\r\n$acl->addRole(new Zend_Acl_Role('contributor'))\r\n    ->addRole(new Zend_Acl_Role('david'), 'contributor');\r\n\r\n$acl->add(new Zend_Acl_Resource('stories'));\r\n$acl->add(new myResource('story1', 'sports'), 'stories');\r\n$acl->add(new myResource('story2', 'news'), 'stories');\r\n\r\n$acl->allow('contributor', 'stories', 'edit');\r\n\r\n\/\/ David can only edit sports stories\r\n$acl->deny('david', 'stories', 'edit');\r\n$acl->allow('david', 'stories', 'edit', new AssertTopic('sports'));\r\n\r\n\/\/ David can delete sports stories \r\n$acl->allow('david', 'stories', 'delete', new AssertTopic('sports'));\r\n\r\nprintf(\"David %s edit story 1 because it's sports.\\n\", \r\n  $acl->isAllowed('david', 'story1', 'edit') ? 'can' : 'can not');\r\nprintf(\"David %s edit story 2 because it's news.\\n\", \r\n  $acl->isAllowed('david', 'story2', 'edit') ? 'can' : 'can not');\r\nprintf(\"David %s delete story 1 because it's sports.\\n\", \r\n  $acl->isAllowed('david', 'story1', 'delete') ? 'can' : 'can not');\r\nprintf(\"David %s delete story 2 because it's news.\\n\", \r\n  $acl->isAllowed('david', 'story2', 'delete') ? 'can' : 'can not');\r\n{code}\r\n\r\nThe output is:\r\nDavid can edit story 1 because it's sports.\r\nDavid can edit story 2 because it's news.\r\nDavid can delete story 1 because it's sports.\r\nDavid can not delete story 2 because it's news.\r\n\r\nWhen I echo the $_rules internal, it's clear that the allow rule for david with an assertion overwrites the previous deny rule:\r\n\r\n[\"edit\"]=>\r\n            array(2) {\r\n              [\"type\"]=>\r\n              string(10) \"TYPE_ALLOW\"\r\n              [\"assert\"]=>\r\n              object(AssertTopic)#8 (1) {\r\n                [\"_testTopic:protected\"]=>\r\n                string(6) \"sports\"\r\n              }\r\n\r\n\r\nEDIT: Fix code formatting\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9129\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10360",
                    "id": 10360,
                    "description": "Minor Release",
                    "name": "1.10.0",
                    "userReleaseDate": "27\/Jan\/10",
                    "archived": false,
                    "releaseDate": "2010-01-27",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10070",
                    "id": 10070,
                    "name": "Zend_Acl",
                    "description": "Access control list authorization component",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41543",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "While it might seem confusing, you are actually overwriting the rule in which you apply the Allow with the assertion for david.  Since the assertion does not match on news, it attempts to consult the next thing up in the inherited hierarchy which happens to the be contributor rule NOT the \"david deny rule\".  The \"david deny rule\" actually doesn't exist b\/c you are overwriting it.\r\n\r\nTo model what you want, perhaps try code that looks like this:\r\n\r\n{code}\r\n<?php\r\n\r\ninclude_once 'bootstrap.php';\r\n\r\nclass myResource extends Zend_Acl_Resource\r\n{\r\n  public $topic;\r\n\r\n  public function __construct($resourceId, $topic = null)\r\n  {\r\n    $this->_resourceId = (string) $resourceId;\r\n    $this->topic = (null !== $topic) ? (string) $topic : 'unclassified';\r\n  }\r\n}\r\n\r\nclass AssertTopic implements Zend_Acl_Assert_Interface\r\n{\r\n  protected $_testTopic;\r\n\r\n  public function __construct($topic)\r\n  {\r\n    $this->_testTopic = $topic;\r\n  }\r\n\r\n  public function assert(Zend_Acl $acl,\r\n                         Zend_Acl_Role_Interface $role = null,\r\n                         Zend_Acl_Resource_Interface $resource = null,\r\n                         $privilege = null)\r\n  {\r\n    return $resource->topic == $this->_testTopic; \r\n  }\r\n}\r\n\r\n$acl = new Zend_Acl;\r\n\r\n$acl->addRole('base_contributor')\r\n    ->addRole('contributor', 'base_contributor')\r\n    ->addRole('david', 'base_contributor');\r\n\r\n$acl->add(new Zend_Acl_Resource('stories'));\r\n$acl->add(new myResource('story1', 'sports'), 'stories');\r\n$acl->add(new myResource('story2', 'news'), 'stories');\r\n\r\n\/\/ base_constributors cannot edit, but general contributors can\r\n$acl->deny('base_contributor', 'stories', 'edit');\r\n$acl->allow('contributor', 'stories', 'edit');\r\n\r\n\/\/ David can only edit sports stories\r\n$acl->allow('david', 'stories', 'edit', new AssertTopic('sports'));\r\n\r\n\/\/ David can delete sports stories \r\n$acl->allow('david', 'stories', 'delete', new AssertTopic('sports'));\r\n\r\nprintf(\"David %s edit story 1 because it's sports.\\n\", \r\n  $acl->isAllowed('david', 'story1', 'edit') ? 'can' : 'can NOT');\r\nprintf(\"David %s edit story 2 because it's news.\\n\", \r\n  $acl->isAllowed('david', 'story2', 'edit') ? 'can' : 'can NOT');\r\nprintf(\"David %s delete story 1 because it's sports.\\n\", \r\n  $acl->isAllowed('david', 'story1', 'delete') ? 'can' : 'can NOT');\r\nprintf(\"David %s delete story 2 because it's news.\\n\", \r\n  $acl->isAllowed('david', 'story2', 'delete') ? 'can' : 'can NOT');\r\n\r\n\r\n\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2010-07-16T14:40:41.000+0000",
                    "updated": "2010-07-16T14:40:41.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9129\/transitions"
}