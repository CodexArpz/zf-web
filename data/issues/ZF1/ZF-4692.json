{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4692",
    "key": "ZF-4692",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Create new function Zend_Db_Table_Row->getDependentSelect()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4692\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                "name": "rhunwicks",
                "displayName": "Roger Hunwicks",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-10-23T08:29:48.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-05-29T02:32:19.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Zend_Db_Table_Row->findDependentRowset() returns a rowset from a linked table constrained by a foreign key. It does this by creating a Zend_Db_Table_Select object and passing it to Zend_Db_Table->fetchAll. \n\nfindDependentRowset() accepts a Zend_Db_Table_Select as an optional parameter, which we can use to further restrict the records returned.\n\nAt present when we find the dependent rowset we must query all rows at once (fetchAll). It would be better if we could just retrieve the Zend_Db_Table_Select representing the query and then execute it later. In particular this will allow us to set the ->limit() clause before running the query and thus only retrieve the rows we are interested in.\n\nMy use case is that I want to pass the child rows of a table to Zend_Paginator to display in a master-detail view:\n{code:none}\n\/\/ Get the child rows for display\n        $childTab = $this->_request->getParam('childtab', $table->getDefaultChild());\n        if (isset($childTab)) {\n   \t\t\/\/ Send variables to the view\n            $this->view->childTab = $childTab;\n            $select = $row->getDependentSelect($childTab);\n    \t\t$paginator = Zend_Paginator::factory($select, 'DbTableSelect'); \n            $paginator->setCurrentPageNumber($this->_request->getParam('page')); \n            $this->view->childPaginator = $paginator;\n        }{code}\n\nLooking at the documentation, using Zend_Db_Table_Select is the preferred way of integrating Zend_Db with Zend_Paginator, because we can use the limit() clause to avoid returning all the rows when we only want to display 10 of them. Zend_Paginator_Adapter_DbTable returns a Zend_Db_Table_Rowset from getItems().\n\nThis function would allow the use of Zend_Db_Table_Row and Zend_Db_Table_Rowset functions for handling relationships while retaining the performance benefits of a SELECT ... LIMIT statement.\n\nThe code changes required are trivial and do not alter existing functionality, the existing findDependentRowset is split into two portions: 1) build the select statment, 2) execute the fetchall. E.g.\n{code}    \/**\n     * Generate a select statement to query a dependent table to retrieve rows matching the current row.\n     *\n     * @param string|Zend_Db_Table_Abstract  $dependentTable\n     * @param string                         OPTIONAL $ruleKey\n     * @param Zend_Db_Table_Select           OPTIONAL $select\n     * @return Zend_Db_Table_Select \t\t Query result from $dependentTable\n     * @throws Zend_Db_Table_Row_Exception   If $dependentTable is not a table or is not loadable.\n     *\/\n    public function getDependentSelect($dependentTable, $ruleKey = null, Zend_Db_Table_Select $select = null)\n    {\n        $db = $this->_getTable()->getAdapter();\n\n        if (is_string($dependentTable)) {\n            try {\n                @Zend_Loader::loadClass($dependentTable);\n            } catch (Zend_Exception $e) {\n                require_once 'Zend\/Db\/Table\/Row\/Exception.php';\n                throw new Zend_Db_Table_Row_Exception($e->getMessage());\n            }\n            $dependentTable = new $dependentTable(array('db' => $db));\n        }\n        if (! $dependentTable instanceof Zend_Db_Table_Abstract) {\n            $type = gettype($dependentTable);\n            if ($type == 'object') {\n                $type = get_class($dependentTable);\n            }\n            require_once 'Zend\/Db\/Table\/Row\/Exception.php';\n            throw new Zend_Db_Table_Row_Exception(\"Dependent table must be a Zend_Db_Table_Abstract, but it is $type\");\n        }\n\n        if ($select === null) {\n            $select = $dependentTable->select();\n        } else {\n            $select->setTable($dependentTable);\n        }\n\n        $map = $this->_prepareReference($dependentTable, $this->_getTable(), $ruleKey);\n\n        for ($i = 0; $i < count($map[Zend_Db_Table_Abstract::COLUMNS]); ++$i) {\n            $parentColumnName = $db->foldCase($map[Zend_Db_Table_Abstract::REF_COLUMNS][$i]);\n            $value = $this->_data[$parentColumnName];\n            \/\/ Use adapter from dependent table to ensure correct query construction\n            $dependentDb = $dependentTable->getAdapter();\n            $dependentColumnName = $dependentDb->foldCase($map[Zend_Db_Table_Abstract::COLUMNS][$i]);\n            $dependentColumn = $dependentDb->quoteIdentifier($dependentColumnName, true);\n            $dependentInfo = $dependentTable->info();\n            $type = $dependentInfo[Zend_Db_Table_Abstract::METADATA][$dependentColumnName]['DATA_TYPE'];\n            $select->where(\"$dependentColumn = ?\", $value, $type);\n        }\n        \n        return $select;\n    }\n    \n    \/**\n     * Query a dependent table to retrieve rows matching the current row.\n     *\n     * @param string|Zend_Db_Table_Abstract  $dependentTable\n     * @param string                         OPTIONAL $ruleKey\n     * @param Zend_Db_Table_Select           OPTIONAL $select\n     * @return Zend_Db_Table_Rowset_Abstract Query result from $dependentTable\n     * @throws Zend_Db_Table_Row_Exception If $dependentTable is not a table or is not loadable.\n     *\/\n    public function findDependentRowset($dependentTable, $ruleKey = null, Zend_Db_Table_Select $select = null)\n    {\n        $select = $this->getDependentSelect($dependentTable, $ruleKey, $select);\n        return $dependentTable->fetchAll($select);\n    }{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/6",
                "name": "N\/A"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4692\/watchers",
                "isWatching": false,
                "watchCount": 4
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-6461",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6461",
                    "type": {
                        "name": "Duplicate",
                        "direction": "INBOUND",
                        "description": "is duplicated by"
                    }
                },
                {
                    "issueKey": "ZF-4186",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4186",
                    "type": {
                        "name": "Duplicate",
                        "direction": "INBOUND",
                        "description": "is duplicated by"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10250",
                    "id": 10250,
                    "description": "Mini Release",
                    "name": "1.7.3",
                    "userReleaseDate": "19\/Jan\/09",
                    "archived": false,
                    "releaseDate": "2009-01-19",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10133",
                    "id": 10133,
                    "name": "Zend_Db_Table",
                    "description": "Lightweight OO interface to database tables and rowsets.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30501",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "body": "There is a small(!) error in my findDependentRowset - it breaks if you pass in a string $dependentTable instead of a Zend_Db_Table_Abstract one. The correct code should be:\n{code}\n    public function findDependentRowset($dependentTable, $ruleKey = null, Zend_Db_Table_Select $select = null)\n    {\n        $select = $this->getDependentSelect($dependentTable, $ruleKey, $select);\n        return $select->getTable()->fetchAll($select);\n    }\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "created": "2009-04-29T00:22:45.000+0000",
                    "updated": "2009-04-29T00:22:45.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30502",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "body": "Sorry - I created a new issue ZF-6461 because I forgot I had already logged it as ZF-4692.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "created": "2009-04-29T00:25:39.000+0000",
                    "updated": "2009-04-29T00:25:39.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4692\/transitions"
}