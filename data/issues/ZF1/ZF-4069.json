{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4069",
    "key": "ZF-4069",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Captcha session problem."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4069\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/5",
                "name": "Cannot Reproduce"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2008-11-24T10:08:35.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                "name": "hedonism",
                "displayName": "Hristo Angelov",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-08-26T04:11:44.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2008-11-24T10:08:35.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I think i finally found where the problem is. In my previous post about Zend_Captcha bug [ZF-4045|http:\/\/framework.zend.com\/issues\/browse\/ZF-4045] Mathew write a little test which was working. I take a look at the code and i found that _setWord() method was never called before image rendering. And to be sure i make this:\n\n1\n\n{code}\n\n$captchaImage = new Zend_Captcha_Image();\n$captchaImage->setFont(Standart_Main::getDirs('fonts', 'arial.ttf'));\n$captchaImage->setFontSize(30);\n$captchaImage->setWordlen(6);\n$captchaImage->setImgDir(Standart_Main::getDirs('wwwStatic', array('images', 'captcha')));\n$captchaImage->setImgUrl(Zend_Registry::get('config')->host->static.'\/images\/captcha\/');\n$captchaImage->setWidth(175);\n$captchaImage->setHeight(75);\n$captchaImage->setName('captcha');\n        \necho '<div class=\"clear\">';\nZend_Debug::dump($_SESSION, 'Session in form creation');\necho '<\/div>';        \n\n{code}\n\n{quote}\n{code}\nSession in form creation array(1) {\n  [\"__ZF\"] => array(18) {\n    [\"Zend_Form_Captcha_4301dcf2ade0aae5b34a64d9719f975f\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_e61f811bef26075ee5c88fc1ea431226\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_f1e0b429de8b782275aec58ddf35e4b3\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_883b61c1e2dd12a6b18edfc5bc35dfd2\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_789955e17b8578ec129618ffe0913712\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_be5db0a55a046a86293c0ed7a0be80f8\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_5ec2a3f9eb5643323d69a60ae85bac7c\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_b8833adf1b7c4938fa7dcedf44dce759\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_01f4ad81a458f9da115c99eb1a995d05\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_00d9e7a613cfc22043db3bbb1c7c6c99\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_e299cef17faaf596368d9081ecb9c81b\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_6234991073d2155f0e81ee7853d666e0\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_6f1d445d2fa6d25812f4515803d4d07e\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_77a9a2d8f6584d04f87ab14fd1f5210e\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_41216c084bf35610732af2d300a697cb\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_7e1ba59576c5767a403b2f2a6379b76a\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_bf17b303bb5ff93a59411b2d2d0ba90b\"] => array(1) {\n      [\"ENT\"] => int(1219747167)\n    }\n    [\"Zend_Form_Captcha_363466da0b023ded1caaa7cfedba8e07\"] => array(1) {\n      [\"ENT\"] => int(1219747180)\n    }\n  }\n}\n\n{code}\n{quote}\n\n2\n\n{code}\n    public function isValid($value, $context = null)\n    {\n        $name = $this->getName();\n        \n        echo '<div class=\"clear\">';\n        Zend_Debug::dump($_SESSION, 'Session in isValid method');\n        echo '<\/div>';\n        \n        \n    \tif (!isset($context[$name]['input'])) {\n    \t\t$this->_error(self::MISSING_VALUE);\n    \t\treturn false;\n    \t}\n    \t$value = strtolower($context[$name]['input']);\n        $this->_setValue($value);\n\n    \tif (!isset($context[$name]['id'])) {\n    \t\t$this->_error(self::MISSING_ID);\n    \t\treturn false;\n    \t}\n        \n    \t$this->_id = $context[$name]['id'];\n    \tif ($value != $this->getWord()) {\n            $this->_error(self::BAD_CAPTCHA);\n            return false;\n        }\n        \n        return true;\n    }\n{code}\n\n{quote}\n{code}\n\nSession in isValid method array(1) {\n  [\"__ZF\"] => array(18) {\n    [\"Zend_Form_Captcha_4301dcf2ade0aae5b34a64d9719f975f\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_e61f811bef26075ee5c88fc1ea431226\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_f1e0b429de8b782275aec58ddf35e4b3\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_883b61c1e2dd12a6b18edfc5bc35dfd2\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_789955e17b8578ec129618ffe0913712\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_be5db0a55a046a86293c0ed7a0be80f8\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_5ec2a3f9eb5643323d69a60ae85bac7c\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_b8833adf1b7c4938fa7dcedf44dce759\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_01f4ad81a458f9da115c99eb1a995d05\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_00d9e7a613cfc22043db3bbb1c7c6c99\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_e299cef17faaf596368d9081ecb9c81b\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_6234991073d2155f0e81ee7853d666e0\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_6f1d445d2fa6d25812f4515803d4d07e\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_77a9a2d8f6584d04f87ab14fd1f5210e\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_41216c084bf35610732af2d300a697cb\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_7e1ba59576c5767a403b2f2a6379b76a\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_bf17b303bb5ff93a59411b2d2d0ba90b\"] => array(1) {\n      [\"ENT\"] => int(1219747167)\n    }\n    [\"Zend_Form_Captcha_363466da0b023ded1caaa7cfedba8e07\"] => array(1) {\n      [\"ENT\"] => int(1219747180)\n    }\n  }\n}\n\n{code}\n{quote}\n\n3\n\n{code}\n\n<?php echo $this->form; ?>\n    \n<div class=\"clear\"><?php Zend_Debug::dump($_SESSION, 'Session in view method'); ?><\/div>\n\n{code}\n\n{quote}\n{code}\n\nSession in view method array(3) {\n  [\"__ZF\"] => array(19) {\n    [\"Zend_Form_Captcha_4301dcf2ade0aae5b34a64d9719f975f\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_e61f811bef26075ee5c88fc1ea431226\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_f1e0b429de8b782275aec58ddf35e4b3\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_883b61c1e2dd12a6b18edfc5bc35dfd2\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_789955e17b8578ec129618ffe0913712\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_be5db0a55a046a86293c0ed7a0be80f8\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_5ec2a3f9eb5643323d69a60ae85bac7c\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_b8833adf1b7c4938fa7dcedf44dce759\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_01f4ad81a458f9da115c99eb1a995d05\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_00d9e7a613cfc22043db3bbb1c7c6c99\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_e299cef17faaf596368d9081ecb9c81b\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_6234991073d2155f0e81ee7853d666e0\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_6f1d445d2fa6d25812f4515803d4d07e\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_77a9a2d8f6584d04f87ab14fd1f5210e\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_41216c084bf35610732af2d300a697cb\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_7e1ba59576c5767a403b2f2a6379b76a\"] => array(0) {\n    }\n    [\"Zend_Form_Captcha_bf17b303bb5ff93a59411b2d2d0ba90b\"] => array(1) {\n      [\"ENT\"] => int(1219747167)\n    }\n    [\"Zend_Form_Captcha_363466da0b023ded1caaa7cfedba8e07\"] => array(2) {\n      [\"ENT\"] => int(1219747237)\n      [\"ENGH\"] => int(1)\n    }\n    [\"Zend_Form_Captcha_16f33623fde64152adb6faccfb2c6e52\"] => array(2) {\n      [\"ENGH\"] => int(1)\n      [\"ENT\"] => int(1219747237)\n    }\n  }\n  [\"Zend_Form_Captcha_363466da0b023ded1caaa7cfedba8e07\"] => array(1) {\n    [\"word\"] => NULL\n  }\n  [\"Zend_Form_Captcha_16f33623fde64152adb6faccfb2c6e52\"] => array(1) {\n    [\"word\"] => string(6) \"496at3\"\n  }\n}\n\n{code}\n{quote}\n\n*The problem is that word is not set before image is rendered.*"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4069\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11493",
                    "filename": "AdEditForm.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T04:46:08.000+0000",
                    "size": 3211,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11493\/AdEditForm.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11494",
                    "filename": "AdsController.php",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T04:47:47.000+0000",
                    "size": 6158,
                    "mimeType": "application\/octet-stream",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11494\/AdsController.php"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11536",
                    "filename": "captcha-test.zip",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-09-12T23:01:29.000+0000",
                    "size": 1591,
                    "mimeType": "application\/zip",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11536\/captcha-test.zip"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11495",
                    "filename": "CaptchaSimplifiedCase.zip",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-08-26T06:21:38.000+0000",
                    "size": 1933,
                    "mimeType": "application\/zip",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11495\/CaptchaSimplifiedCase.zip"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/11497",
                    "filename": "TestFormWithCaptcha.zip",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T08:29:00.000+0000",
                    "size": 14445,
                    "mimeType": "application\/zip",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/11497\/TestFormWithCaptcha.zip"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10050",
                    "id": 10050,
                    "description": "Minor Release Candidate",
                    "name": "1.6.0RC2",
                    "userReleaseDate": "11\/Aug\/08",
                    "archived": true,
                    "releaseDate": "2008-08-11",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10340",
                    "id": 10340,
                    "name": "Zend_Captcha",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23710",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "In the first example, you never call $captchaImage->generate() -- so of course no word is created in the session. Second, you have not provided a full reproduce case -- it's clear that you're using Zend_Form, but it's unclear how you have attached the element to the form, and the captcha to the element. \n\nPlease update with _JUST_ the code needed to reproduce the issue. At this time, I cannot reproduce the issue -- I have captchas working with forms just fine, and all unit tests are passing.\n\nRules for reporting bugs:\n* provide minimal code to reproduce the issue\n* provide expected result\n* provide actual result",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-08-26T04:39:50.000+0000",
                    "updated": "2008-08-26T04:39:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23711",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "I make some further investigation and i found that setting expiration hops to 3 makes validation works.\n\n{code}\n\n    public function getSession()\n    {\n        if (!isset($this->_session) || (null === $this->_session)) {\n            $id = $this->getId();\n            $this->_session = new $this->_sessionClass('Zend_Form_Captcha_' . $id);\n            $this->_session->setExpirationHops(3);\n            $this->_session->setExpirationSeconds($this->getTimeout());\n        }\n        return $this->_session;\n    }\n\n\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T04:44:03.000+0000",
                    "updated": "2008-08-26T04:44:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23712",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "Form",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T04:46:09.000+0000",
                    "updated": "2008-08-26T04:46:09.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23713",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "Controller",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T04:47:47.000+0000",
                    "updated": "2008-08-26T04:47:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23714",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Why do you need to set the expiration hops to 3? are you making XHR requests to the same form in the interim?\n\nIf this is the case, you can already modify this programmatically:\n{code}\n$captcha->getSession()->setExpirationHops(3);\n{code}\n\nPlease let me know if this solution works, ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-08-26T04:50:48.000+0000",
                    "updated": "2008-08-26T04:50:48.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23715",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "The following code does not work:\n\n{code}\n$captchaImage = new Zend_Captcha_Image();\n$captchaImage->setFont(Standart_Main::getDirs('fonts', 'arial.ttf'));\n$captchaImage->setFontSize(30);\n$captchaImage->setWordlen(6);\n$captchaImage->setImgDir(Standart_Main::getDirs('wwwStatic', array('images', 'captcha')));\n$captchaImage->setImgUrl(Zend_Registry::get('config')->host->static.'\/images\/captcha\/');\n$captchaImage->setWidth(175);\n$captchaImage->setHeight(75);\n$captchaImage->setName('captcha');\n$captchaImage->getSession()->setExpirationHops(10);\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T04:57:25.000+0000",
                    "updated": "2008-08-26T04:57:25.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23716",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "No I'm not making any XHR requests. Setting max hops with $captchaImage->getSession()->setExpirationHops(10); does not work. The reason is that max hops are set to different session id:\n\n{code}\n\n   [__ZF] => Array\n        (\n            [Zend_Form_Captcha_457b709c92ed453bbfe0c25d414711bb] => Array\n                (\n                    [ENGH] => 10\n                    [ENT] => 1219752531\n                )\n\n            [Zend_Form_Captcha_efaca28ac812e8879c0437972068a3bf] => Array\n                (\n                    [ENGH] => 1\n                    [ENT] => 1219752531\n                )\n\n        )\n\n    [Zend_Form_Captcha_efaca28ac812e8879c0437972068a3bf] => Array\n        (\n            [word] => no7ug2\n        )\n\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T05:11:11.000+0000",
                    "updated": "2008-08-26T05:11:11.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23718",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Simplified reproduce case that:\n* Modifies form to only have captcha element and submit button\n* hard codes paths for captcha images\n* Eliminates all but the form action from the controller\n* Includes a view script\n\nWith this setup, I still cannot reproduce the issue. However, I noticed something that may be a factor. Your form utilizes a sub form, and the captcha is included in that sub form. There was an issue with how captcha elements were namespaced with sub forms and forms that marked the elementsBelongTo property: http:\/\/framework.zend.com\/issues\/browse\/ZF-4038\n\nThis was fixed in trunk and the 1.6 release branch over the weekend, and may be the determining factor.\n\nIf you can, please grab ZF from svn and see if the issue is still present. At this point I cannot reproduce with current trunk.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-08-26T06:21:38.000+0000",
                    "updated": "2008-08-26T06:21:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23723",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "Hi there. I'm using the latest version of trunk. Here is the code to simple captcha test and still not working.Take a loog  at the latest uploaded archive.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T08:29:00.000+0000",
                    "updated": "2008-08-26T08:29:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23724",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "You can see the result in this [link|http:\/\/standart.xpucmo.info\/test\/captcha]",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T08:51:10.000+0000",
                    "updated": "2008-08-26T08:51:10.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23725",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "This failed for me until I removed the setExpirationHops() directive, at which point it worked perfectly.\n\nSo, first note: do not set the expiration hops greater than 1.\n\nSecond, if that still fails to work for you, my inclination is that it's environment specific. I'll need to know what OS you're using, which version of PHP, whether or not you're setting a custom session handler (and, if so, if the problem persists when you remove it), etc.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-08-26T09:05:37.000+0000",
                    "updated": "2008-08-26T09:05:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23728",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "I think i get it. I'm generating automatically CSS and JS files. So framework handles one request for HTML one for CSS and one for JS. That is why I'm having 3 hops.And i need really 3 hops because each user have 3 requests to framework.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-08-26T09:36:49.000+0000",
                    "updated": "2008-08-26T09:36:49.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/24470",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ota",
                        "name": "ota",
                        "displayName": "Ota Mares",
                        "active": true
                    },
                    "body": "Matthew i think the problem is that Zend Captcha pollutes the session namespace?\n\nGenerate a few captchas and check the $_SESSION array. I do not understand why there are a ton of Zend_Form_Captcha entries all with the assigned unique id.\nThis does not make sense to me because you dont have a way to check a specific captcha but only the last one generated?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ota",
                        "name": "ota",
                        "displayName": "Ota Mares",
                        "active": true
                    },
                    "created": "2008-09-12T04:24:02.000+0000",
                    "updated": "2008-09-12T04:24:02.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/24476",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Can you check with latest trunk from svn? I modified it to correct another issue a few days ago -- basically, I changed the setExpirationHops() method to pass a true value to the third parameter, which makes it utilize a _namespace_ hop. This should do several things: first, what it was correcting, which is to allow requests between display and the final validation (people were reporting that ajax requests made between displaying the form and form submission were invalidating the session, even though the namespace was never invoked); second, it should also result in no longer creating a token per request -- only per namespace requests (i.e., form display).\n\nLet me know if this solves the issue, so we can close this report.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-09-12T05:51:20.000+0000",
                    "updated": "2008-09-12T05:51:20.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/24490",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ota",
                        "name": "ota",
                        "displayName": "Ota Mares",
                        "active": true
                    },
                    "body": "Okay this seems to be fixed, tested on Opensuse 11, PHP 5.2.5 and latest SVN head revision 11372.\n\nWas this a fix for Zend_Session or Zend_Captcha?\nThe only thing i do not understand is why the namespace has to include the id? Wouldnt Zend_Form_Captcha be sufficient.\n\nEnclosed is the test script and result.\n\nTest script:\n<?php\n\n\/**\n * Extend include path\n *\/\n$includePaths = array(\n    '\/www\/_Test\/ota\/htdocs\/zend_captcha\/library\/'\n);\n\n$extendBy = '';\nforeach ($includePaths as $path) {\n    $extendBy .= $path . PATH_SEPARATOR;\n}\n\nset_include_path($extendBy . get_include_path());\n\n\n\/**\n * Session managment\n *\n * @see Zend_Session_Namespace\n *\/\nrequire_once 'Zend\/Session\/Namespace.php';\n\n\/**\n * Setup Session\n *\/\nZend_Session::setOptions(array(\n    'name'             => 'test',\n    'use_only_cookies' => 'off',  \/\/ Defaults to on because of security reasons\n));\n\n\/\/ Start session\nZend_Session::start();\n\n\/\/ init default namespace\n$defaultNamespace = new Zend_Session_Namespace('default');\n\n\/\/ regenerate session id to make session fixation harder\nif (!isset($defaultNamespace->initialized)) {\n    Zend_Session::regenerateId();\n    $defaultNamespace->initialized = true;\n}\n\n\/**\n * Setup Zend Captcha\n *\/\n\n$conf = array(\n    'imgdir' => '\/www\/_Test\/ota\/htdocs\/zend_captcha\/captchas\/',\n    'font' => '\/www\/_Test\/ota\/htdocs\/zend_captcha\/impact.ttf',\n    'fontsize' => 25,\n    'height' => 50,\n    'width' => 100,\n    'wordlen' => 4,\n);\n\n\/**\n * @see Zend_Captcha_Image\n *\/\nrequire_once 'Zend\/Captcha\/Image.php';\n\n$captcha = new Zend_Captcha_Image($conf);\n\n\/\/ generate a few captchas\n$captcha->generate();\n$captcha->generate();\n$captcha->generate();\n$captcha->generate();\n$captcha->generate();\n$captcha->generate();\n$captcha->generate();\n$captcha->generate();\n\n$captcha->isValid('wrong');\n\n\/\/ session namespace polluted\nvar_dump($_SESSION);\n\nResult:\narray(3) {\n  [\"default\"]=>\n  array(1) {\n    [\"initialized\"]=>\n    bool(true)\n  }\n  [\"__ZF\"]=>\n  array(1) {\n    [\"Zend_Form_Captcha_1503fdb96a9fa9817d510f364c4cd885\"]=>\n    array(2) {\n      [\"ENNH\"]=>\n      int(1)\n      [\"ENT\"]=>\n      int(1221232588)\n    }\n  }\n  [\"Zend_Form_Captcha_1503fdb96a9fa9817d510f364c4cd885\"]=>\n  array(1) {\n    [\"word\"]=>\n    string(4) \"nus9\"\n  }\n}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ota",
                        "name": "ota",
                        "displayName": "Ota Mares",
                        "active": true
                    },
                    "created": "2008-09-12T08:17:47.000+0000",
                    "updated": "2008-09-12T08:17:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/24491",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "No the problem still exists. The problem is that when i do:\n\n{code}\n$captcha->getSession()->setExpirationHops(6, null, true);  \n{code}\n\nthe result:\n\nsession before captcha is rendered:\n\n{code}\narray(3) {\n  [\"locale\"] => array(1) {\n    [\"code\"] => string(2) \"bg\"\n  }\n  [\"__ZF\"] => array(2) {\n    [\"Zend_Form_Captcha_74e64dd9f9d9e8bc2a274a55ca527445\"] => array(2) {\n      [\"ENNH\"] => int(6)\n      [\"ENT\"] => int(1221232382)\n    }\n    [\"Zend_Form_Captcha_6bc524305ceaa439b18907847602a05f\"] => array(2) {\n      [\"ENNH\"] => int(1)\n      [\"ENT\"] => int(1221232382)\n    }\n  }\n  [\"Zend_Form_Captcha_6bc524305ceaa439b18907847602a05f\"] => array(1) {\n    [\"word\"] => string(6) \"b47ag5\"\n  }\n}\n{code}\n\nsession after captcha is rendered\n\n{code}\narray(2) {\n  [\"locale\"] => array(1) {\n    [\"code\"] => string(2) \"bg\"\n  }\n  [\"__ZF\"] => array(1) {\n    [\"Zend_Form_Captcha_74e64dd9f9d9e8bc2a274a55ca527445\"] => array(2) {\n      [\"ENNH\"] => int(6)\n      [\"ENT\"] => int(1221232382)\n    }\n  }\n}\n\n{code}\n\nWhat i'm trying to explain is that before rendering captcha image the session key is different then after rendering. So the only thing that solves my problem is to do this:\n\n{code}\n\npublic function render(Zend_View_Interface $view = null)\n{\n    $content = parent::render($view);\n     $this->getElement('captcha')\n        ->getCaptcha()\n        ->getSession()\n        ->setExpirationHops(6)\n    ;\n    return $content;\n}\n\n{code}\n\nSo the problem is that session key is not the same after captcha image is rendered.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-09-12T08:20:32.000+0000",
                    "updated": "2008-09-12T08:20:32.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/24493",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ota",
                        "name": "ota",
                        "displayName": "Ota Mares",
                        "active": true
                    },
                    "body": "Hristo could you please provide a full test script that i and also others could utilize to reproduce your problem?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ota",
                        "name": "ota",
                        "displayName": "Ota Mares",
                        "active": true
                    },
                    "created": "2008-09-12T08:33:38.000+0000",
                    "updated": "2008-09-12T08:33:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/24515",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "body": "See comments in my last uploaded archive.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=hedonism",
                        "name": "hedonism",
                        "displayName": "Hristo Angelov",
                        "active": true
                    },
                    "created": "2008-09-12T23:01:31.000+0000",
                    "updated": "2008-09-12T23:01:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26636",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "The *only* time I can reproduce this is if I call setExpirationHops() manually. Even if I have resources that the MVC is handling (such as JS or CSS), with current trunk all works correctly as long as I do not call setExpirationHops() myself.\n\nSo, I'm closing this. Simply remove the setExpirationHops() calls.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-11-24T10:08:23.000+0000",
                    "updated": "2008-11-24T10:08:23.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4069\/transitions"
}