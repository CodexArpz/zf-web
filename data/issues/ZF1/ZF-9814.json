{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9814",
    "key": "ZF-9814",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Table doesn't scale to i5\/OS"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9814\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-05-06T09:32:50.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                "name": "ashawley",
                "displayName": "Aaron S. Hawley",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-05-06T09:23:05.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-10-21T11:41:42.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The query in Zend_Db_Adapter_Db2::describeTable() for i5\/OS runs very slow.  Though we have over 20 million distinct column names on the machine I'm using.  That's not uncommon for IBM i servers since they are so (overly?) database-integrated.\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9814\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/13057",
                    "filename": "Db2_describeTable-faster.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2010-05-06T09:33:21.000+0000",
                    "size": 1488,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/13057\/Db2_describeTable-faster.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10451",
                    "id": 10451,
                    "description": "Mini Release",
                    "name": "1.10.4",
                    "userReleaseDate": "28\/Apr\/10",
                    "archived": false,
                    "releaseDate": "2010-04-28",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10190",
                    "id": 10190,
                    "name": "Zend_Db_Adapter_Db2",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40403",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "I'm closing this as not an issue.\r\nTo prevent the describe table query being needed repeatedly, you may either use a meta-data cache, or hardcode the columns for each table into your Zend_Db_Table definition.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2010-05-06T09:32:51.000+0000",
                    "updated": "2010-05-06T09:32:51.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40404",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "I was able to improve performance significantly by removing the 4 calls to the scalar function UPPER() and the use of SELECT DISTINCT.\r\n\r\nUnfortunately, this loses case-folding (case-insensitive) nature of Zend_Db_Table, since SQL is case-insensitive with identifiers.  Seems ok as long as we enforce case-sensitivity in our code and database guidelines.  We'd rather leverage Zend_Db_Table than not.\r\n\r\nI'll inline the attached patch below:\r\n\r\n{noformat}\r\n2010-05-06  Aaron S. Hawley  <Aaron.Hawley@vtinfo.com>\r\n\r\n\t* Zend\/Db\/Adapter\/Db2.php (describeTable): Improve performance of\r\n\ti5\/OS query by avoiding UPPER() and DISTINCT.  It's not uncommon\r\n\tfor AS\/400 machines to have distinct columns numbering in the tens\r\n\tof millions.\r\n\r\n--- Zend\/Db\/Adapter\/Db2.php\t2010-04-29 12:37:50.021322300 -0400\r\n+++ Zend\/Db\/Adapter\/Db2.php\t2010-05-06 11:44:19.584306100 -0400\r\n@@ -399,7 +399,7 @@\r\n         } else {\r\n \r\n             \/\/ DB2 On I5 specific query\r\n-            $sql = \"SELECT DISTINCT C.TABLE_SCHEMA, C.TABLE_NAME, C.COLUMN_NAME, C.ORDINAL_POSITION,\r\n+            $sql = \"SELECT C.TABLE_SCHEMA, C.TABLE_NAME, C.COLUMN_NAME, C.ORDINAL_POSITION,\r\n                 C.DATA_TYPE, C.COLUMN_DEFAULT, C.NULLS ,C.LENGTH, C.SCALE, LEFT(C.IDENTITY,1),\r\n                 LEFT(tc.TYPE, 1) AS tabconsttype, k.COLSEQ\r\n                 FROM QSYS2.SYSCOLUMNS C\r\n@@ -411,10 +411,10 @@\r\n                        AND C.TABLE_NAME = k.TABLE_NAME\r\n                        AND C.COLUMN_NAME = k.COLUMN_NAME)\r\n                 WHERE \"\r\n-                 . $this->quoteInto('UPPER(C.TABLE_NAME) = UPPER(?)', $tableName);\r\n+                 . $this->quoteInto('C.TABLE_NAME = ?', $tableName);\r\n \r\n             if ($schemaName) {\r\n-                $sql .= $this->quoteInto(' AND UPPER(C.TABLE_SCHEMA) = UPPER(?)', $schemaName);\r\n+                $sql .= $this->quoteInto(' AND C.TABLE_SCHEMA = ?', $schemaName);\r\n             }\r\n \r\n             $sql .= \" ORDER BY C.ORDINAL_POSITION FOR FETCH ONLY\";\r\n{noformat}\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2010-05-06T09:33:26.000+0000",
                    "updated": "2010-05-06T09:33:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40405",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "Thanks for the quick reply.  I'm not sure the caching would work because I should have said \"never returns\" instead of \"very slow\".  So that really only leaves the option of hardcoding the meta data.\r\n\r\nCould we keep this issue open to see if other people have the issue as well?  It might take awhile.  Those of us writing PHP for the i are likely few and far between.  Thanks.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2010-05-06T09:49:22.000+0000",
                    "updated": "2010-05-06T09:49:22.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41286",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "Duplicate of ZF-6606",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2010-07-01T06:58:44.000+0000",
                    "updated": "2010-07-01T06:58:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42090",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=aseiden",
                        "name": "aseiden",
                        "displayName": "Alan Seiden",
                        "active": true
                    },
                    "body": "Metadata caching does work for me on i5. To reply to Aaron's comment about his script never returning, he may need to allow a larger timeout value in the script to allow time for the cache to be written (the first time through).\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=aseiden",
                        "name": "aseiden",
                        "displayName": "Alan Seiden",
                        "active": true
                    },
                    "created": "2010-08-24T11:02:26.000+0000",
                    "updated": "2010-08-24T11:02:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42091",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=aseiden",
                        "name": "aseiden",
                        "displayName": "Alan Seiden",
                        "active": true
                    },
                    "body": "Even though metadata caching for Zend_Db_Table does work for me on i5, and speeds up subsequent queries, I will avoid Zend_Db_Table when I can. I always fear that a real user will be the one to experience that slow first time through, as the cache is being written, causing a time-out for the unlucky user. I know that I can carefully make sure the cache is there before users hit the site, but I'd rather avoid even the possibility if I can.\r\n\r\nThat said, this technique does work, but if you use it on a production site, make sure all cached metadata is there before any users arrive.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=aseiden",
                        "name": "aseiden",
                        "displayName": "Alan Seiden",
                        "active": true
                    },
                    "created": "2010-08-24T11:38:35.000+0000",
                    "updated": "2010-08-24T11:38:35.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48756",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=christiand",
                        "name": "christiand",
                        "displayName": "Christian Dub\u00e9",
                        "active": true
                    },
                    "body": "With Aaron proposed \"fix\" my queries went from ~85sec to < 2sec\r\n\r\nI also added caching in my boostrap and now queries are almost instantaneous. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=christiand",
                        "name": "christiand",
                        "displayName": "Christian Dub\u00e9",
                        "active": true
                    },
                    "created": "2011-10-21T11:41:42.000+0000",
                    "updated": "2011-10-21T11:41:42.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9814\/transitions"
}