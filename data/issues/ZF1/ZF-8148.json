{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8148",
    "key": "ZF-8148",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Statement_Sqlsrv -> limit  () doesn't work properly when order clause  is not present"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8148\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-04-16T07:11:23.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                "name": "romeo.deepmind",
                "displayName": "Roman",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-10-26T08:10:45.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-01-20T13:15:02.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "if i do not set order clause limit ignores offset parameter\r\n\r\nsteps to reproduce: \r\ndo not set order clause in select"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8148\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                "name": "juokaz",
                "displayName": "Juozas Kaziukenas",
                "active": false
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10370",
                    "id": 10370,
                    "description": "Mini Release",
                    "name": "1.9.4",
                    "userReleaseDate": "13\/Oct\/09",
                    "archived": false,
                    "releaseDate": "2009-10-13",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35549",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "body": "I would say this is expected behavior. \r\n\r\nLimit is based on http:\/\/www.tech-recipes.com\/rx\/1868\/mimic_the_mysql_limit_feature_in_microsoft_sql_server\/\r\n\r\nIt does it like this:\r\n\r\n{{SELECT TOP 10 *\r\nFROM (SELECT TOP 20 * FROM Orders ORDER BY OrderDate) as T\r\nORDER BY OrderDate DESC}}\r\n\r\nOrdering is required in such query, because results need to be ordered and then sliced using \"TOP X\".\r\n\r\nDo you know better ways (compatible with old Mssql versions)?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "created": "2009-10-26T10:14:04.000+0000",
                    "updated": "2009-10-26T10:14:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35558",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                        "name": "romeo.deepmind",
                        "displayName": "Roman",
                        "active": true
                    },
                    "body": "maybe we can do default order on primary key?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                        "name": "romeo.deepmind",
                        "displayName": "Roman",
                        "active": true
                    },
                    "created": "2009-10-26T16:14:57.000+0000",
                    "updated": "2009-10-26T16:14:57.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35560",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "body": "This does sound logical, however I don't think it's correct way of doing this. Mainly because query like this:\r\n\r\nSELECT * FROM table\r\n\r\nis not the same as:\r\n\r\nSELECT * FROM table ORDER BY [primery_key] ASC\r\n\r\nHaving no order is literaly having no order - returned results have usually unpredictable ordering (correct me if I'm wrong). Currently I see solution to have an exception thrown, saying something like \"Zend_Db_Adapter_Sqlsrv::limit() expects a query with ordering\".",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "created": "2009-10-26T16:20:28.000+0000",
                    "updated": "2009-10-26T16:20:28.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35562",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                        "name": "romeo.deepmind",
                        "displayName": "Roman",
                        "active": true
                    },
                    "body": "yes, i think this will be a solution for this",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                        "name": "romeo.deepmind",
                        "displayName": "Roman",
                        "active": true
                    },
                    "created": "2009-10-26T18:13:36.000+0000",
                    "updated": "2009-10-26T18:13:36.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35572",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                        "name": "romeo.deepmind",
                        "displayName": "Roman",
                        "active": true
                    },
                    "body": "by the way! \r\n\r\neven if i have order clause, this query goes mad on the last page. say, if i have 26 records and i want to show 20 records per page. first page will be shown ok. the second page (as expected) must contain 6 records, but it will also contain 20 records! \r\n\r\nthis is because we have {{SELECT TOP 20}} at the begining of query.\r\n\r\nthe only way to solve it is to keep track of number of records in the table and use something like this \r\n\r\n{{if($offset + $limit) > $count \r\n$sel = \"SELECT TOP \" . $count - ($offset + $limit) . \" * From ...\"\r\n}}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=romeo.deepmind",
                        "name": "romeo.deepmind",
                        "displayName": "Roman",
                        "active": true
                    },
                    "created": "2009-10-27T10:33:18.000+0000",
                    "updated": "2009-10-27T10:33:18.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35942",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=pennedav",
                        "name": "pennedav",
                        "displayName": "David Penner",
                        "active": true
                    },
                    "body": "Also note that the implementation of {{Zend_Db_Adapter_Sqlsrv::limit()}} (ZF1.9.5) does not properly handle the case where the original query employs ORDER BY on more than one field.\r\n\r\nIf my original query is: \r\n\r\n{{$sql = SELECT * FROM T ORDER BY \"field_1\" DESC, \"field_2\" DESC}}\r\n\r\nThen {{limit($sql, 10, 1)}} returns:\r\n\r\n{{SELECT * FROM (SELECT TOP 10 * FROM (SELECT TOP 20 * FROM T ORDER BY \"field_1\" DESC, \"field_2\" DESC) AS inner_tbl ORDER BY \"field_1\" , \"field_2\" ASC) AS outer_tbl ORDER BY \"field_1\" , \"field_2\" DESC}}\r\n\r\nNote the absence of {{DESC}} after {{\"field_1\"}} in the last two ORDER BY clauses, which causes field_1 to be sorted ASC in both cases causing the final result set to be not what is expected given the original query.\r\n\r\nAs yet I have no patch or workaround to contribute.\r\n\r\nTo me this seems to be a bug not a feature, but if there's something I'm missing in all this let me know. :)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=pennedav",
                        "name": "pennedav",
                        "displayName": "David Penner",
                        "active": true
                    },
                    "created": "2009-11-11T13:25:05.000+0000",
                    "updated": "2009-11-11T13:25:05.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36987",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ankitaggarwal",
                        "name": "ankitaggarwal",
                        "displayName": "Ankit Aggarwal",
                        "active": true
                    },
                    "body": "@David Penner\r\n\r\nConfirming the same bug on my side. This issue was originally reported ([ZF-4099|http:\/\/zendframework.com\/issues\/browse\/ZF-4099]) and solved for the PDO_MSSQL Adapter, but not for the SqlSrv adapter, which is using the same old code from before. I assume copy\/pasting the PDO_MSSQL limit() method to the SqlSrv adapter's limit() method should function properly with maybe a few modifications here and there.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ankitaggarwal",
                        "name": "ankitaggarwal",
                        "displayName": "Ankit Aggarwal",
                        "active": true
                    },
                    "created": "2009-12-17T09:12:26.000+0000",
                    "updated": "2009-12-17T09:12:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36994",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=pennedav",
                        "name": "pennedav",
                        "displayName": "David Penner",
                        "active": true
                    },
                    "body": "@Ankit\r\n\r\nThank you for the workaround. I'll look into implementing that.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=pennedav",
                        "name": "pennedav",
                        "displayName": "David Penner",
                        "active": true
                    },
                    "created": "2009-12-17T11:05:34.000+0000",
                    "updated": "2009-12-17T11:05:34.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37247",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ankitaggarwal113",
                        "name": "ankitaggarwal113",
                        "displayName": "Ankit Aggarwal",
                        "active": true
                    },
                    "body": "@David\r\n\r\nAnother thing to note is the issue Roman brought up above, as both Pdo_Mssql and SqlSrv do not address it. If you have 26 results, and you want to only view 10 per page, then you should have three pages with 10, 10, and 6 results respectively. However, both manually calling limit() on your Db_Select object AND using the Zend_Paginator interface\/model (which I assume uses the limit() function of a Select object anyway) will show 10 items on page 3 instead of the desired 6.\r\n\r\nThe only way I can figure out how to get around this is, like stated, to keep track of the TotalCount or run a COUNT(*) query and use this value to change the query:\r\n\r\nSELECT * FROM (SELECT TOP X FROM (SELECT TOP Y FROM table ORDER BY xyz DESC as inner_tbl) order by xyz ASC as outer_tbl) order by xyz DESC\r\n\r\nwhere Y = Count + Offset (this is correct in the code as it is) and\r\nX = Count + Offset (this is how it is currently) UNLESS TotalCount < Count + Offset, where then X = TotalCount - Offset (as offset increases with the page number) or 0 if Offset > TotalCount.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ankitaggarwal113",
                        "name": "ankitaggarwal113",
                        "displayName": "Ankit Aggarwal",
                        "active": true
                    },
                    "created": "2009-12-30T12:42:23.000+0000",
                    "updated": "2009-12-30T12:42:23.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37522",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ankitaggarwal",
                        "name": "ankitaggarwal",
                        "displayName": "Ankit Aggarwal",
                        "active": true
                    },
                    "body": "SqlSrv driver can only be used with SQL Server 2005 or higher. The reason I bring this up is because SQL Server 2005 introduced the ROW_NUMBER() ranking function to mimic LIMIT. Thus, the best way for the Sqlsrv adapter to handle limit(), as we don't have to worry about backwards compatibility with MS SQL Server 2000 and earlier, would be something like the following:\r\n\r\n{noformat}\r\n$orderby = stristr($sql, 'ORDER BY');\r\n\r\nif (!$orderby) {\r\n    $sql = preg_replace(\r\n        '\/^SELECT\\s+(DISTINCT\\s)?\/i',\r\n        'SELECT $1TOP ' . ($count+$offset) . ' ',\r\n        $sql\r\n        );\r\n} else {\r\n    \/\/ Remove ORDER BY clause from $sql\r\n    $sql = preg_replace(\r\n        '\/\\s+ORDER BY(.*)\/',\r\n        '',\r\n        $sql\r\n        );\r\n    \/\/ Add ORDER BY clause as an argument for ROW_NUMBER()\r\n    $sql = \"SELECT ROW_NUMBER() OVER ($orderby) AS \\\"RowNumber\\\", * FROM ($sql) AS inner_tbl\";\r\n  \r\n    $start = $offset + 1;\r\n    $end = $offset + $count;\r\n\r\n    $sql = \"WITH outer_tbl AS ($sql) SELECT * FROM outer_tbl WHERE \\\"RowNumber\\\" BETWEEN $start AND $end\";\r\n}\r\n\r\nreturn $sql;\r\n{noformat}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ankitaggarwal",
                        "name": "ankitaggarwal",
                        "displayName": "Ankit Aggarwal",
                        "active": true
                    },
                    "created": "2010-01-08T12:17:28.000+0000",
                    "updated": "2010-01-08T12:17:28.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40028",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "body": "Fixed in r21878",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=juokaz",
                        "name": "juokaz",
                        "displayName": "Juozas Kaziukenas",
                        "active": false
                    },
                    "created": "2010-04-16T07:11:24.000+0000",
                    "updated": "2010-04-16T07:11:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44090",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "Appears this issue is reopened in ZF-10455.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2011-01-20T13:15:02.000+0000",
                    "updated": "2011-01-20T13:15:02.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8148\/transitions"
}