{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8267",
    "key": "ZF-8267",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Significant memory leak in Zend_Search_Lucene_Search_QueryHit"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8267\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-12-11T06:51:58.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=cpliakas",
                "name": "cpliakas",
                "displayName": "Chris Pliakas",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-11-09T20:07:23.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-12-11T07:30:01.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Searching an index with around 600 documents was consuming around 18M of memory.  After further investigation, I narrowed the problem down to the retrieval of field data via the Zend_Search_Lucene_Search_QueryHit object.  The following code examples illustrate the bug:\r\n\r\n{code:none} \r\n<?php\r\n\/\/ Normal page usage: 24285096\r\n\r\n$hits = $index->find($query);\r\nforeach ($hits as $hit) {\r\n  $value = $hit->nid;\r\n}\r\necho memory_get_usage(); \/\/ 42294776\r\n\r\n?>\r\n{code}\r\n\r\n{code:none} \r\n<?php\r\n\/\/ Executing same query with different retrieval method\r\n\r\n$hits = $index->find($query);\r\nforeach ($hits as $hit) {\r\n  $value = $index->getDocument($hit->id)->getFieldValue('nid');\r\n}\r\necho memory_get_usage(); \/\/ 25824168\r\n\r\n?>\r\n{code}\r\n\r\nThe issue was originally reported in the Search Lucene API module for Drupal at http:\/\/drupal.org\/node\/628254.  Although the easy workaround is to use method #2, method #1 is more terse and would be the preferable retrieval method.\r\n\r\nThanks for a great component,\r\nChris"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8267\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10300",
                    "id": 10300,
                    "description": "Mini Release",
                    "name": "1.7.8",
                    "userReleaseDate": "30\/Mar\/09",
                    "archived": false,
                    "releaseDate": "2009-03-30",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36861",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "That's not a memory leak. It's correct behavior.\r\n\r\nEach query hit object stores loaded document data. And it uses lazy loading.\r\n\r\nSo your second example doesn't load document data within query hit processing. You do it manually. But! manually loaded document goes out of scape at each \"foreach\" iteration.\r\n\r\nTry this code:\r\n{code}\r\n$hits = $index->find($query);\r\nforeach ($hits as $hit) {\r\n  $value = $hit->nid;\r\n}\r\nprintf(\"%d\\n\", memory_get_usage()); \/\/ 42294776\r\n\r\nunset($hits);\r\n\r\nprintf(\"%d\\n\", memory_get_usage());\r\n{code}\r\n\r\nunset($hits) destroys query hits objects and returns used memory.\r\n\r\nOn the other hand, you are right. It's not necessary to have documents stored in memory for some situations.\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2009-12-11T06:51:58.000+0000",
                    "updated": "2009-12-11T06:51:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36865",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=cpliakas",
                        "name": "cpliakas",
                        "displayName": "Chris Pliakas",
                        "active": true
                    },
                    "body": "Hey Alexander.\r\n\r\nThanks for the detailed explanation, and I see why this is happening.  In terms of my implementation on Drupal.org, the $hit->nid works great for the paged results, but there is a cool faceted search feature that scans the results and calculates the number of each facet in the result set.  Surprisingly this is very quick even with thousands of documents, but I was reaching the memory limit when using the $hit->nid method.  $index->getDocument($hit->id)->getFieldValue('nid') has a much smaller footprint and avoided the memory spike making the module much more scalable, and I don't really need to store the document in memory after it is iterated over anyways.  Drupal sites tends to take up a significant amount of memory, so the less I can use the better.\r\n\r\nThanks for a great component.  People on Drupal.org are finding it very useful.\r\n~Chris",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=cpliakas",
                        "name": "cpliakas",
                        "displayName": "Chris Pliakas",
                        "active": true
                    },
                    "created": "2009-12-11T07:30:01.000+0000",
                    "updated": "2009-12-11T07:30:01.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8267\/transitions"
}