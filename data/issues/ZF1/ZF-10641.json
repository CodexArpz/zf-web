{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10641",
    "key": "ZF-10641",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_View_Helper_Navigation_Menu::renderPartial() don't works with ACL"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10641\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fbale",
                "name": "fbale",
                "displayName": "Fabio Baleani",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-11-04T04:34:50.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-08-31T09:03:47.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hi all,\r\nI've tried ACL working with Zend_Navigation using view partials. This is done using the navigation menu view helper and invoking the \"setPartial()\" method, passing my partial view path in.\r\n\r\nThe problem is that when you tell it to use a partial, it skips the default rendering method (renderMenu()), which happens to also contain the logic for filtering out menu items based on ACL.\r\n\r\nI've temporarily fixed this by inserting a few lines into class Zend_View_Helper_Navigation_Menu, starting at row 596:\r\n\r\n{code:java}\r\n596\r\n597    \t$iterator = new RecursiveIteratorIterator(clone $container, RecursiveIteratorIterator::SELF_FIRST);\r\n598     foreach ($iterator as $page) {\r\n599         \/* @var $page Zend_Navigation_Page_Mvc *\/\r\n600         if (!$this->accept($page)) {\r\n601             $container->removePage($page);\r\n602         }\r\n603     }\r\n604\r\n605     $model = array(\r\n606         'container' => $container\r\n607     );\r\n608\r\n{code} \r\n\r\nBut this works only for items with depth=0... \r\n\r\nI hope this helps to find a solution...\r\nRegards, Fabio."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10641\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [
                "View_Helper"
            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                "name": "frosch",
                "displayName": "Frank Br\u00fcckner",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-10459",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10459",
                    "type": {
                        "name": "Dependency",
                        "direction": "OUTBOUND",
                        "description": "depends on"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10420",
                    "id": 10420,
                    "description": "Minor Release",
                    "name": "1.11.0",
                    "userReleaseDate": "02\/Nov\/10",
                    "archived": false,
                    "releaseDate": "2010-11-02",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10406",
                    "id": 10406,
                    "name": "Zend_Navigation",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42894",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Can you provide a reproduce case (preferably as a unit test), please? It should provide:\r\n* Minimal code necessary to reproduce the issue\r\n* Expected results\r\n* Actual results\r\n\r\nWe need this in order to better evaluate and diagnose the issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2010-11-08T11:50:03.000+0000",
                    "updated": "2010-11-08T11:50:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42902",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fbale",
                        "name": "fbale",
                        "displayName": "Fabio Baleani",
                        "active": true
                    },
                    "body": "This is the code:\r\n\r\nCONTROLLER:\r\n{code}\r\nclass TestmenuController extends Zend_Controller_Action {\r\n\tpublic function indexAction() {\r\n\t\t\/**\r\n\t\t * Setting up the menu\r\n\t\t *\/ \r\n\t\t$menu = array (\r\n\t\t\tarray (\r\n\t\t\t\t'label' => 'the first', \r\n\t\t\t\t'uri' => '#',\r\n\t\t\t\t'pages' => array (\r\n\t\t\t\t\tarray ('label' => 'child first one', 'uri' => '#' ), \r\n\t\t\t\t\tarray ('label' => 'child first two', 'uri' => '#' ) \r\n\t\t\t\t) \r\n\t\t\t), \r\n\t\t\tarray (\r\n\t\t\t\t'label' => 'the second', \r\n\t\t\t\t'uri' => '#', \r\n\t\t\t\t'resource' => 'secret',\r\n\t\t\t\t'pages' => array (\r\n\t\t\t\t\tarray ('label' => 'child one', 'uri' => '#' ), \r\n\t\t\t\t\tarray ('label' => 'child two', 'uri' => '#' ) \r\n\t\t\t\t) \r\n\t\t\t), \r\n\t\t\tarray (\r\n\t\t\t\t'label' => 'the third', \r\n\t\t\t\t'uri' => '#', \r\n\t\t\t\t'pages' => array (\r\n\t\t\t\t  array ('label'=>'another child', 'uri'=>'#', 'resource'=>'secret'),\r\n\t\t\t\t  array ('label'=>'another child', 'uri'=>'#', 'resource'=>'secret') \r\n\t\t\t\t) \r\n\t\t\t) \r\n\t\t);\r\n\t\t\r\n\t\t\/**\r\n\t\t * Setting up the ACL\r\n\t\t *\/\r\n\t\t$acl=new Zend_Acl();\r\n\t\t$acl->addResource('secret');\r\n\t\t$acl->addRole('user');\r\n\t\t$acl->deny('user','secret');\r\n\t\t\r\n\t\t\/**\r\n\t\t * Setting up the Navigator\r\n\t\t *\/ \r\n\t\t$navigator=new Zend_Navigation();\r\n\t\t$navigator->addPages($menu);\r\n\t\t$this->view->navigation($navigator)\r\n\t\t\t\t\t->setAcl($acl)\r\n\t\t\t\t\t->setRole('user');\r\n\t\t\r\n\t}\r\n}\r\n{code}\r\n\r\nVIEW:\r\nindex.phtml\r\n{code}\r\necho $this->navigation()->menu();\r\necho \"<hr>\";\r\necho $this->navigation()->menu()->setPartial('testmenu\/_partial.phtml');\r\n{code}\r\n_partial.phtml\r\n{code}\r\n$iterator = new RecursiveIteratorIterator($this->container, RecursiveIteratorIterator::SELF_FIRST);\r\nforeach ($iterator as $page) {\r\n    echo $this->navigation()->menu()->htmlify($page) . \"<br>\";\r\n}\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fbale",
                        "name": "fbale",
                        "displayName": "Fabio Baleani",
                        "active": true
                    },
                    "created": "2010-11-08T22:10:06.000+0000",
                    "updated": "2010-11-08T22:10:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42903",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fbale",
                        "name": "fbale",
                        "displayName": "Fabio Baleani",
                        "active": true
                    },
                    "body": "Expected results:\r\n\r\nthe first\r\nchild first one\r\nchild first two\r\nthe third\r\n---------------------------\r\nthe first\r\nchild first one\r\nchild first two\r\nthe third\r\n\r\n\r\nActual results:\r\n\r\nthe first\r\nchild first one\r\nchild first two\r\nthe third\r\n---------------------------\r\nthe first\r\nchild first one\r\nchild first two\r\nthe second\r\nchild one\r\nchild two\r\nthe third\r\nanother child\r\nanother child",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fbale",
                        "name": "fbale",
                        "displayName": "Fabio Baleani",
                        "active": true
                    },
                    "created": "2010-11-08T22:12:04.000+0000",
                    "updated": "2010-11-08T22:12:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44368",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kaiuwe",
                        "name": "kaiuwe",
                        "displayName": "Kai Uwe",
                        "active": true
                    },
                    "body": "{code:title=A simple workaround}\r\nforeach ($iterator as $page) {\r\n    if ($this->navigation()->menu()->accept($page)) {\r\n        echo $this->navigation()->menu()->htmlify($page) . \"<br>\";\r\n    }\r\n}\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kaiuwe",
                        "name": "kaiuwe",
                        "displayName": "Kai Uwe",
                        "active": true
                    },
                    "created": "2011-02-14T00:01:51.000+0000",
                    "updated": "2011-02-14T00:01:51.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44369",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kaiuwe",
                        "name": "kaiuwe",
                        "displayName": "Kai Uwe",
                        "active": true
                    },
                    "body": "My suggestion:\r\n{code:title=Example}\r\npublic function renderPartial(Zend_Navigation_Container $container = null,\r\n                              $partial = null)\r\n{\r\n    \/\/ ...\r\n    \r\n    if ($this->getUseAcl()) {\r\n        \/\/ ...\r\n        \r\n        foreach ($iterator as $page) {\r\n            if (!$this->accept($page)) {\r\n                $container->removePage($page);\r\n            }\r\n        }\r\n    }\r\n    \r\n    \/\/ ...\r\n}\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kaiuwe",
                        "name": "kaiuwe",
                        "displayName": "Kai Uwe",
                        "active": true
                    },
                    "created": "2011-02-14T00:13:44.000+0000",
                    "updated": "2011-02-14T00:13:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/45588",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kaiuwe",
                        "name": "kaiuwe",
                        "displayName": "Kai Uwe",
                        "active": true
                    },
                    "body": "Another idea:\r\n{code:title=Use the max depth options}\r\n\/\/ Create iterator\r\n$iterator = new RecursiveIteratorIterator($container,\r\n                    RecursiveIteratorIterator::SELF_FIRST);\r\n\r\n$maxDepth = $this->getMaxDepth();\r\nif (is_int($maxDepth)) {\r\n    $iterator->setMaxDepth($maxDepth);\r\n}\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kaiuwe",
                        "name": "kaiuwe",
                        "displayName": "Kai Uwe",
                        "active": true
                    },
                    "created": "2011-03-24T09:08:36.000+0000",
                    "updated": "2011-03-24T09:08:36.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48372",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "body": "{quote}But this works only for items with depth=0...{quote}\r\nIt's very ugly. I'm looking for a solution.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "created": "2011-09-08T08:02:54.000+0000",
                    "updated": "2011-09-08T08:02:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48675",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "body": "I have found a solution and I will write some unit tests.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "created": "2011-10-11T21:48:23.000+0000",
                    "updated": "2011-10-11T21:48:23.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10641\/transitions"
}