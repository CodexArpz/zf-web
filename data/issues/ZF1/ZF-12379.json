{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12379",
    "key": "ZF-12379",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Captcha \/ Session issues - isValid() returns false even when input is correct after a certain number of attemps (expiration hops)"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12379\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                "name": "chealer",
                "displayName": "Filipus Klutiero",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2012-08-21T00:40:58.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-08-25T01:21:54.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "This reports a combination of issues with Zend_Captcha which may also involve Zend_Session. Basically, after Zend generates a CAPTCHA, the first attempt goes well. However, if the first attempts due to incorrect input, further attempts fail regardless of the input. I identified some problems in Zend's code, but I can't point exactly to where the problem is or suggest a fix. My debugger (XDebug with Eclipse) is showing some really strange stuff (but then, I know the debugger is half-broken).\r\nZend maintainers are advised to take a deep breath and have appropriate beverage nearby before going further.\r\n\r\nI discovered this issue while testing Tiki Wiki CMS Groupware, which uses Zend_Captcha since version 6. A demo of version 9, on which I found the problem, is available on http:\/\/demo.tiki.org\/9x\/tiki-index.php\r\nHowever, reproducing the scenario will require some configuration.\r\nIn Tiki's case, a user can make 2 attempts to solve the CAPTCHA. If the input is wrong in both cases, further attempts will fail regardless of the input. Zend reports the verification code was mis-typed even if the code was typed correctly. By default, only 1 attempt works fine (Tiki allows 2 because it uses setExpirationHops(2)).\r\n\r\nThe relevant part of isValid() is:\r\n\r\n        if ($input !== $this->getWord()) {\r\n            $this->_error(self::BAD_CAPTCHA);\r\n            return false;\r\n        }\r\n\r\ngetWord() reads:\r\n\r\n    \/**\r\n     * Get captcha word\r\n     *\r\n     * @return string\r\n     *\/\r\n    public function getWord()\r\n    {\r\n        if (empty($this->_word)) {\r\n            $session     = $this->getSession();\r\n            $this->_word = $session->word;\r\n        }\r\n        return $this->_word;\r\n    }\r\n\r\nSome unclear issue with sessions causes getWord() to return null or the empty string in some cases, rather than the verification code. isValid() does not expect that and reports the input as invalid, even though the real problem was in fetching the actual verification code.\r\n\r\nWhatever number of expiration hops is initially set, that number is set to 1 in getSession(), so any number above 2 won't work correctly. The session namespace for some foo CAPTCHA is stored in session array $_SESSION['foo'], which is managed by a second session array, $_SESSION['__ZF']['Zend_Form_Captcha_foo']. The latter array's ENNH element defines the number of hops to expiration, and decreases each hop. Session expiration is managed by Zend_Session_Namespace's constructor. Therefore, what should happen is that a first request generates the CAPTCHA and creates these session arrays, which should be set to expire the next hop. Then, regardless of the input submitted, the namespace should expire and both arrays should be unset. But that's not what happens. Since getSession() sets expiration to 1 hop after the namespace is constructed, $_SESSION['__ZF']['Zend_Form_Captcha_foo'] remains (so only $_SESSION['foo'] actually disappears). To make things worst, on the next request, $_SESSION['foo'] is also recreated. I failed to figure out why. In the end, both arrays are defined, when they should both be gone. And $_SESSION['foo'] does not contain the original data, but rather maps the word key to the empty string, hence isValid() rejects any non-empty string. It's worth noting that if all CAPTCHAs become the empty string, this would constitute a security threat allowing to trivially defeat Zend_Captcha, although I haven't verified this.\r\n\r\nI'm providing a quick testcase for this. Before running zend_captcha.php, the Zend component needs to be made a symbolic link to a Zend installation. I also suggest to destroy any pre-existing session. To test, open the file, then add 2 GET parameters for the id and the input. For example, if the CAPTCHA generated has id 15517fa872b888710cefe41d0bff0c4a and code f5sac2, then hit zend_captcha.php?input=f5sac2&id=15517fa872b888710cefe41d0bff0c4a\r\nThe verification will work the first time. But if you simply refresh the page, the test will claim the input is invalid.\r\n\r\nAgain, the affected code is too large for me to recommend a patch, but I imagine isValid() and getSession() will need changes."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12379\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=stas",
                "name": "stas",
                "displayName": "Stanislav Malyshev",
                "active": false
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/11080",
                    "id": 11080,
                    "description": "Mini Release",
                    "name": "1.11.12",
                    "userReleaseDate": "22\/Jun\/12",
                    "archived": false,
                    "releaseDate": "2012-06-22",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10340",
                    "id": 10340,
                    "name": "Zend_Captcha",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10096",
                    "id": 10096,
                    "name": "Zend_Session",
                    "description": "A standardized interface to common functionality found in or indigenous to site session implementations. ",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51651",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "body": "Sorry, it seems I cannot attach files to this ticket. Ask me for the testcase.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "created": "2012-08-21T00:47:49.000+0000",
                    "updated": "2012-08-21T00:47:49.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51686",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "body": "@[~chealer]\r\nYou must fill out the [CLA|http:\/\/framework.zend.com\/cla] and then you can add files.\r\n\r\nWe need a complete and short example to reproduce the problem but without any code from a third party!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "created": "2012-08-23T20:43:11.000+0000",
                    "updated": "2012-08-23T20:43:11.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51693",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "body": "Well, I don't intend to send any \"contribution\" to Zend, so I have no desire to send the CLA.\r\n\r\nThe testcase is based on Tiki's code, but trivial (ignoring the font included).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "created": "2012-08-24T02:52:18.000+0000",
                    "updated": "2012-08-24T02:52:18.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51695",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "body": "[~chealer]\r\nHave I missed something or where is the testcase? We need some code.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "created": "2012-08-24T07:35:50.000+0000",
                    "updated": "2012-08-24T07:35:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51703",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "body": "Frank, the testcase is on my PC. If I understand correctly, I cannot attach files to this ticket without having sent the Individual Contributor License Agreement. Since I have no intention to become a Contributor, I am not going to send the CLA, and therefore am not going to attach the testcase here. As I said, ask me if you want it.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "created": "2012-08-24T12:12:39.000+0000",
                    "updated": "2012-08-24T12:12:39.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51705",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "body": "Simple solution: Use [Gist|https:\/\/gist.github.com\/] or any other similar service! :)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=frosch",
                        "name": "frosch",
                        "displayName": "Frank Br\u00fcckner",
                        "active": true
                    },
                    "created": "2012-08-24T13:53:07.000+0000",
                    "updated": "2012-08-24T13:53:07.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51720",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "body": "My testcase is not just text. However, I pasted the code to http:\/\/paste.debian.net\/185493\/",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=chealer",
                        "name": "chealer",
                        "displayName": "Filipus Klutiero",
                        "active": true
                    },
                    "created": "2012-08-25T01:21:54.000+0000",
                    "updated": "2012-08-25T01:21:54.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12379\/transitions"
}