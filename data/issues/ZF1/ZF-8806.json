{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8806",
    "key": "ZF-8806",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Problem using Zend_Currency with setlocale()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8806\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10360",
                    "id": 10360,
                    "description": "Minor Release",
                    "name": "1.10.0",
                    "userReleaseDate": "27\/Jan\/10",
                    "archived": false,
                    "releaseDate": "2010-01-27",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-01-23T13:35:27.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=swepp",
                "name": "swepp",
                "displayName": "swepp GmbH",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-01-13T05:43:00.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-01-23T13:35:28.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "We have a problem with Zend_Currency getting the right format.\r\nThe code below describe our problem:\r\n\r\n{noformat}\r\n<?php\r\nsetlocale(LC_ALL, 'de_DE');\r\n$locale   = new Zend_Locale('de_DE');\r\n$currency = new Zend_Currency(null, $locale);\r\necho $currency->toCurrency(25);\r\n{noformat}\r\n\r\nThe toCurrency() function echo's: 250,00 \u20ac instead of 25,00 \u20ac.\r\nIf you comment out setLocale(LC_ALL, 'de_DE'), everything work as aspected.\r\nWe use this script on a debian machine with PHP 5.2.6 and Zend Framework 1.8.5 and the language-package 'de_DE' (ISO-8859-1) installed."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8806\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                "name": "thomas",
                "displayName": "Thomas Weidner",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10410",
                    "id": 10410,
                    "description": "Security release",
                    "name": "1.8.5",
                    "userReleaseDate": "11\/Jan\/10",
                    "archived": false,
                    "releaseDate": "2010-01-11",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10071",
                    "id": 10071,
                    "name": "Zend_Currency",
                    "description": "Zend_Currency is a Class which handles all Currency related functions and is locale aware.",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10073",
                    "id": 10073,
                    "name": "Zend_Locale",
                    "description": "Zend_Locale is a basic wrapper for all I18N and L10N issues for the Zend Framework. It provides the userbasically with access to translation functionality. It can handle different source file types for translation.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37662",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "body": "On trunk I get '25,00\u00a0\u20ac'. Could you please test if this issue also occurs on trunk?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "created": "2010-01-13T06:20:31.000+0000",
                    "updated": "2010-01-13T06:20:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37666",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=swepp",
                        "name": "swepp",
                        "displayName": "swepp GmbH",
                        "active": true
                    },
                    "body": "We used the actual trunk and the problem still exists.\r\n\r\nIf your have \r\n\r\nAre you sure that your language-pack 'de_DE' is ISO-8859-1 and not UTF-8 and is installed on your server? Otherwise the php-internal function setlocale() would return false and the code will work as aspected. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=swepp",
                        "name": "swepp",
                        "displayName": "swepp GmbH",
                        "active": true
                    },
                    "created": "2010-01-13T07:00:50.000+0000",
                    "updated": "2010-01-13T07:00:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37667",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "body": "Thomas is German (or somewhere close to Germany), I will leave that up to him as he has probably installed those already.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=freak",
                        "name": "freak",
                        "displayName": "Dolf Schimmel (Freeaqingme)",
                        "active": true
                    },
                    "created": "2010-01-13T07:07:31.000+0000",
                    "updated": "2010-01-13T07:07:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37668",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "You should note that Zend_Currency and it's dependend classes don't use setlocale().\r\n\r\nAnd it should also be noted that the value \"25\" will never return 250... this could only occur when you give \"25.0\" and the value does not match the locale.\r\n\r\nBtw: You are using 1.8.5...\r\nAs I remember Zend_Locale had a bug in past according to extended locales which has been fixed several months ago.\r\n\r\nSomething like \"de-DE@ISO-8859-1,Latn\" would not have worked in such an installation when you use automatic detection of locales. There was no problem when you set the locale manually.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2010-01-13T07:07:50.000+0000",
                    "updated": "2010-01-13T07:07:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37800",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=acoghlan@churchworks.com",
                        "name": "acoghlan@churchworks.com",
                        "displayName": "Andrew Coghlan",
                        "active": true
                    },
                    "body": "I also have this issue.  I have a system using the Zend_Currency class.  If I set the locale to en_GB and use Zend_Currency to display a number (say 500) it will return \u00a3500.00 as expected.  If however I set the locale to de_DE it returns 5.000,00.  I have tracked down what's happening, and the cause of the problem is in the Zend_Locale_Format::toNumber() method which is called in line 150 of Zend_Currency::toCurrency() (v1.9.7).  I have also identified the issue as existing in v1.8.2 and 1.8.5.  \r\n\r\nExample 1 - passing in a $valueof (string)500.00\r\nIn this example, the value being passed to is Zend_Locale_Format::toNumber() in my example is a string '500.00'.  (note that I've used a '.' for the decimal despite the locale being de_DE - should be a ','.  The rest of my description takes place in Zend_Locale_Format::toNumber() and any line numbers refer to that method in v1.9.7.\r\n\r\nline 295 normalises the $value, which essentially removes the thousand separator and any + sign, and this is the problem.  Since I'm passing in an english formed number and the locale is de_DE, it strips out the de_DE thousand sep (a .) changing my $value from 500.00 to 50000, and this is the amount it returns as $value.\r\n\r\nline 340 runs Zend_Locale_Math::round() which works fine, changing my $value from 50000 to 50000.0.  No value change there, and it's still a string (which is fine).\r\n\r\nline 361 runs the normalise method again, this time repeating the same issue as before - stripping out the de_DE thousand separator (a '.') thus changing my $value from 50000.0 to 500000.\r\n\r\nExample 2 - passing in a $value of (int)500\r\nIn this example the $value being passed to toNumber() is an int.  We are still using a locale of de_DE.\r\n\r\nThis time the line 295 returns a string '500' which is fine.  There were no thousand or decimal characters to get confused.\r\n\r\nLine 340 runs as expected, changing the string from '500' to '500.0' (again, note the '.' not ',', even though our locale is de_DE which uses ',' for decimal and '.' for the thousand seperator).\r\n\r\nLine 361 runs again, and deletes the thousand seperator from the locale data (the '.') changing my number from 500.0 to 5000, and that is what gets returned.\r\n\r\nExample 3 - passing in a $value of (double)1500.50\r\nThis causes the same issues as Example 2, except this time line 340 round() changes my converted string of '1500.5' to '15005.0'.  I'll let you debug it to work out why.\r\n\r\nLooking through, it seems that the Zend_Locale_Math::normalize() method is assuming that it is getting an int or double type value, which actually works fine.  The problem is that there is no validation on this, and if you pass it a string everything goes wrong.  This issue is resolved if you convert the $value being passed to the normalize method to either an int or double before running it through - the system takes care of things for you at that point, although I am still testing this out as a solution.\r\n\r\nThis is a pretty critical issue for us: we run a browser based app with a large finance componant and as we are moving into Europe we are finding that this is making some parts of our system totally unuseable.  I'm kind of suprised that this hasnt come up before!\r\n\r\nOk - so the box is a CentOS 5.4 server running latest build of Zend Core.  The linux locale is set to en_GB.UTF-8 just incase that makes a difference.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=acoghlan@churchworks.com",
                        "name": "acoghlan@churchworks.com",
                        "displayName": "Andrew Coghlan",
                        "active": true
                    },
                    "created": "2010-01-18T07:41:55.000+0000",
                    "updated": "2010-01-18T07:41:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37803",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Thanks for this detailed report.\r\n\r\nI'll try to reproduce this in my envirinments with the given description... when I need additional infos I'll come back to you.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2010-01-18T10:06:08.000+0000",
                    "updated": "2010-01-18T10:06:08.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37971",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Related to your example 1:\r\nWhen you define that your input IS german but give a english string then there is no issue at all.\r\n\r\nIn german the string \"500.00\" is like giving the integer 50000.\r\n\r\nSo your output of 50000 IS correct. When you would not have given a string, but a integer or a float then the things are different again.\r\n\r\n\r\nRelated to your example 2:\r\nI can not verify this behaviour.\r\nLine 340 detects the point by strpos. Line 361 is a bracket.\r\nBut Line 373 localizes the previous normalized value.\r\nThe value itself is build later.\r\n\r\n\r\nRelated to your example 3:\r\nI can also not verify this behaviour.\r\n\r\n\r\nAs the given linenumbers and also the described results are not reproducable with the actual release I think that this already has been fixed in past.\r\n\r\nTry the actual 1.10RC... several changes which have been done in the last months are integrated in this release. I expect that this issue has already be fixed in past.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2010-01-23T10:31:24.000+0000",
                    "updated": "2010-01-23T10:31:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/37976",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Closing as fixed for 1.10",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2010-01-23T13:35:28.000+0000",
                    "updated": "2010-01-23T13:35:28.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8806\/transitions"
}