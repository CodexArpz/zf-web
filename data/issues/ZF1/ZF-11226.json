{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11226",
    "key": "ZF-11226",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Mime::encodeBase64 split multi-bytes word imperfectly"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11226\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=immez",
                "name": "immez",
                "displayName": "immez",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-03-26T03:35:46.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-03-31T23:49:31.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Base64",
                "Zend_Mime"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hi, I am using the Zend Framework 1.10.6.\r\nI encountered a problem when I am sending mails using Zend_Mail.\r\nThere are wrong (or imperfect) encoded subjects in my sent mails.\r\nIn most cases it doesn't matter but it failed at some E-mail service provider.\r\n\r\nBecause the function Zend_Mime::encodeBase64Header can return the encoded string in multilines whose lengths are limited in Zend_Mime::LINELENGTH. In the utf-8 case I encountered such a problem: The multi-bytes word may be splited in incorrect way, here is an example:\r\n\r\n(correct case)\r\n        $email = new Zend_Mail('UTF-8');\r\n        $email->setHeaderEncoding(Zend_Mime::ENCODING_BASE64);\r\n        $subject = '\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341'; \/\/ 20 Chinese characters\r\n        $email->setSubject($subject);\r\n\r\nThen the subject will be encoded as \r\n\"=?UTF-8?B?5LiA5LqM5LiJ5Zub5LqU5YWt5LiD5YWr5Lmd5Y2B5LiA5LqM5LiJ5Zub5LqU?=\r\n =?UTF-8?B?5YWt5LiD5YWr5Lmd5Y2B?=\"\r\n\r\nIf we decode it line by line (some E-mail service provider do so, for example mail.sohu.com, an huge E-mail service provider in China), we can correctly obtain the origin Chinese characters in two parts: \"\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u4e00\u4e8c\u4e09\u56db\u4e94\" and \"\u516d\u4e03\u516b\u4e5d\u5341\".\r\n\r\nBut if we add some half-width symbols into the string, for example, spaces:\r\n\r\n        $subject = ' \u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341'; \/\/ 20 Chinese characters with an space in the front\r\n\r\nIt will be encoded into\r\n\"=?UTF-8?B?IOS4gOS6jOS4ieWbm+S6lOWFreS4g+WFq+S5neWNgeS4gOS6jOS4ieWbm+S6?=\r\n =?UTF-8?B?lOWFreS4g+WFq+S5neWNgQ==?=\"\r\n\r\nNow we will get an wrong result when we try to decode it line by line, because the character '\u4e94' was splited into two parts, and then be decoded incorrectly. Although most E-mail service provider can wisely avoid this problem by compose the encoded string beforehand, but some do not. So in the mail.sohu.com subjects list, the user will see the subject as \"\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u4e00\u4e8c\u4e09\u56db***\u516d\u4e03\u516b\u4e5d\u5341\".\r\n\r\nThis problem can be solved in a simple way: split the origin string into parts in prior, ensure that the length of each part is shorter than the Zend_MIME::LINELENGTH(In the 4:3 ratio), Then encode and compose them. I think that Gmail and some E-mail service provider do it in this way. i.e. maybe we can rewrite the function Zend_Mime::encodeBase64 as below:\r\n\r\n    public static function encodeBase64($str,\r\n        $lineLength = self::LINELENGTH,\r\n        $lineEnd = self::LINEEND)\r\n    {\r\n        $lineLimit    = floor($lineLength * 3 \/4);\r\n        $encoding     = mb_detect_encoding($str);\r\n        $encodedLines = array();\r\n        while(strlen($str)>0){\r\n            $encodedLine    = mb_strcut($str, 0, $lineLimit, $encoding);\r\n            $encodedLines[] = base64_encode(rtrim($encodedLine));\r\n            $str = mb_strcut($str, $lineLimit, strlen($str), $encoding);\r\n            $line++;\r\n        }\r\n        return implode($lineEnd, $encodedLines);\r\n    }\r\n\r\nSo, could someone tell me that if it is a bug of this function? Or it is designed so that I should do the prior splitting by myself manually ? Or there are other methods\/parameters to avoid this problem? Thanks for your answer!"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11226\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [
                "Zend_Mime"
            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beberlei",
                "name": "beberlei",
                "displayName": "Benjamin Eberlei",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10470",
                    "id": 10470,
                    "description": "Mini Release",
                    "name": "1.10.6",
                    "userReleaseDate": "22\/Jun\/10",
                    "archived": false,
                    "releaseDate": "2010-06-22",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10540",
                    "id": 10540,
                    "description": "Mini Release",
                    "name": "1.11.4",
                    "userReleaseDate": "03\/Mar\/11",
                    "archived": false,
                    "releaseDate": "2011-03-03",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10019",
                    "id": 10019,
                    "name": "Zend_Mime",
                    "description": "support class for handling multi-part MIME messages",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [

            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11226\/transitions"
}