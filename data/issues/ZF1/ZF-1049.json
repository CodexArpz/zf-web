{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1049",
    "key": "ZF-1049",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Problem with Zend_Locale_Format and setlocale()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1049\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10140",
                    "id": 10140,
                    "description": "Mini Release",
                    "name": "1.0.3",
                    "userReleaseDate": "30\/Nov\/07",
                    "archived": true,
                    "releaseDate": "2007-11-30",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2007-07-23T05:02:13.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                "name": "gmillet",
                "displayName": "Guillaume Millet",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-03-14T05:26:53.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2007-11-15T13:56:00.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I've had some troubles using Zend_Locale_Format ::toFloat() along with setlocale().\n\nHere is a sample code to illustrate the issue :\n\n{code}\nrequire_once('Zend\/Loader.php');\n\nZend_Loader::loadClass('Zend_Locale');\n\n\/\/ setlocale(LC_ALL, 'fr_FR@euro');\n$locale_fr = new Zend_Locale('fr_FR');\n$locale_en = new Zend_Locale('en_US');\n$params_fr = array('precision' => 2, 'locale' => $locale_fr);\n$params_en = array('precision' => 2, 'locale' => $locale_en);\n$myFloat = 1234.5;\n$test1 = Zend_Locale_Format::toFloat($myFloat, $params_fr);\n$test2 = Zend_Locale_Format::toFloat($myFloat, $params_en);\nvar_dump($test1);\nvar_dump($test2);\n{code}\n\nThe problem comes from the setlocale() call : if it is not present, everything goes fine but when I set PHP's locale to French, I can't get toFloat() to work.\n\nOutput *without* setlocale() :\n\n{code}\nstring(9) \"1 234,50\" string(8) \"1,234.50\"\n{code}\n\nOutput *with* setlocale() :\n\n{code}\nstring(4) \"0,00\" string(4) \"0.00\"\n{code}\n\nThe server I work on is a Linux box (Debian stable), and AFAIK, the standard locale is 'C'. I'm using PHP version 5.2.1 with the BCmath extension enabled. Regarding the framework, I had this problem while I was using the 0.8.0 version and it is still present in the 3912 SVN version.\n\nLast thing, I quote a short part of Thomas' last answer on the mailing list :\n\n??So toNumberFormat does not have to parse for the decimal point, because the input is not a string but a integer\/float value.??\n\nAre you 100% positive about that ? I'm saying that because when I see a piece of code like the following :\n{code}\n\/\/ get number parts\nif (iconv_strpos($value, '.') !== false) {\n{code}\nin toNumberFormat(), my first guess would be that you are actually looking for the decimal separator in the input value.\n\nThis seems to be confirmed by a short trace I ran on this part of code :\n\n{code}\n--- Format.php.orig\t2007-03-14 09:48:00.000000000 +0100\n+++ Format.php\t2007-03-14 10:37:43.000000000 +0100\n@@ -385,10 +385,12 @@\n                     $precstr = $precstr . str_pad(\"0\", ($options['precision'] - iconv_strlen($precstr)), \"0\");\n                 }\n             }\n+\t\t\tdie('strpos true : ' . $precstr);\n         } else {\n             if ($options['precision'] > 0) {\n                 $precstr = str_pad(\"0\", ($options['precision']), \"0\");\n             }\n+\t\t\tdie('strpos false : ' . $precstr);\n         }\n         if ($options['precision'] === null) {\n             if (isset($precstr)) {\n{code}\n\nOutput *without* setlocale() :\n\n{code}\nstrpos true : 50\n{code}\n\nOutput *with* setlocale() :\n\n{code}\nstrpos false : 00\n{code}\n\nBehaviour of this part of code is different whether the locale is set to French or not.\n\nHopefully there's enough information in this description, if not just let me know :)"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1049\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                "name": "thomas",
                "displayName": "Thomas Weidner",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-1061",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1061",
                    "type": {
                        "name": "Dependency",
                        "direction": "OUTBOUND",
                        "description": "depends on"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10021",
                    "id": 10021,
                    "description": "Preview release; DB, Filter, Log",
                    "name": "0.8.0",
                    "userReleaseDate": "21\/Feb\/07",
                    "archived": true,
                    "releaseDate": "2007-02-21",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10073",
                    "id": 10073,
                    "name": "Zend_Locale",
                    "description": "Zend_Locale is a basic wrapper for all I18N and L10N issues for the Zend Framework. It provides the userbasically with access to translation functionality. It can handle different source file types for translation.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13324",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "I am sure.\n\nPlease try this code so we can see if iconv_strpos works on your system:\n\n{code}\n$value = 12345.50;\nprint \"\\n\".$value;\nprint \"\\n\".iconv_strpos($value, '.');\t\n    setlocale(LC_ALL, 'fr_FR@euro');\nprint \"\\n\".$value;\nprint \"\\n\".iconv_strpos($value, '.');\t\n{code}\n\nI see 2 possible problems:\n1.) setLocale has false settings on your OS.\n2.) BCMath is set to precision 0 within php.ini.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-03-14T07:50:27.000+0000",
                    "updated": "2007-03-14T07:50:27.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13326",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                        "name": "gmillet",
                        "displayName": "Guillaume Millet",
                        "active": true
                    },
                    "body": "Just tried your code, here is the result :\n\n{code}\n\n12345.5\n5\n12345,5\n{code}\n\nYou were also right, bcmath's scale was indeed set to 0. My sysadmin changed it to 10 but the output stayed the same.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                        "name": "gmillet",
                        "displayName": "Guillaume Millet",
                        "active": true
                    },
                    "created": "2007-03-14T09:11:07.000+0000",
                    "updated": "2007-03-14T09:11:07.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13327",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "I know...\n\nYou have 2 problems.\nOne which your sysadmin fixed. And one which I will fix ;-)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-03-14T09:37:08.000+0000",
                    "updated": "2007-03-14T09:37:08.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13328",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "I just committed a new version which should solve your problem if the php.ini settings are correct. (maximum precision settings)\nPlease try SVN 3926 or higher.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-03-14T11:23:57.000+0000",
                    "updated": "2007-03-14T11:23:57.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13350",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                        "name": "gmillet",
                        "displayName": "Guillaume Millet",
                        "active": true
                    },
                    "body": "I just tried with SVN version 3953.\n\nProblem seems to be fixed, at least for the part in toNumberFormat(). However, I still can't get it to work when the locale is set to French.\n\nI ran a few tests and it seems to me that Gavin's new implementation of the Zend_Locale_Math::round() method, which is called in toNumber(), may have broken your fix. For example, the value of $op1 after this block :\n\n{code}\nif (($decPos = strpos($op1, '.')) === false) {\n            $op1 .= '.0';\n            $decPos = $length;\n            $length += 2;\n}\n{code}\n\nis 1234,5.0 with setlocale() and 1234.5 without and this is the value that is used in toNumberFormat().",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                        "name": "gmillet",
                        "displayName": "Guillaume Millet",
                        "active": true
                    },
                    "created": "2007-03-15T05:51:50.000+0000",
                    "updated": "2007-03-15T05:51:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13351",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "I know this... I've seen the problem after gavin changed my \"tiny\" ;-) implementation.\nI already wrote gavin about his fault... he will change it to work the same way like the old implementation.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-03-15T06:19:42.000+0000",
                    "updated": "2007-03-15T06:19:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13352",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Fix has been broken due to changes for ZF-1054.\nPlease fix your fix.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-03-15T06:21:50.000+0000",
                    "updated": "2007-03-15T06:21:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13355",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "body": "The Zend_Locale_Math class is not locale-aware, nor should it be locale-aware.\nThe Zend_Locale_Math class is a simple proxy between PHP functions and BCMath.\nBCMath is not locale-aware, and does not support thousands separator characters, or decimal separator characters other than a period ('.').\n\nThe previous implementation of Zend_Locale_Math::round() method failed on many cases (see unit test).\nThe new implementation produces correct results for more than 200,000 test cases I tried.\n\nAlso, usually we should add a unit test before closing an issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "created": "2007-03-15T11:02:39.000+0000",
                    "updated": "2007-03-15T11:02:39.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13385",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Problem not reproducable.\n\nProbably fixed with 3972. Changed internal handling of toNumber\/-Format.\nSee previous additionally comments from the devteam.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-03-15T15:45:06.000+0000",
                    "updated": "2007-03-15T15:45:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13390",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "body": "Reproducible on the [ZF Community Server|http:\/\/framework.zend.com\/wiki\/display\/ZFDEV\/Sandbox].\nPost request to fw-server@lists.zend.com to obtain an account.\n\nUnit test testToFloatSetlocale() committed to FormatTest.php",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "created": "2007-03-15T18:09:25.000+0000",
                    "updated": "2007-03-15T18:09:25.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13391",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "body": "{quote}$ php AllTests.php\nX-Powered-By: PHP\/5.1.6\nContent-type: text\/html\n\nPHPUnit 3.0.0 by Sebastian Bergmann.\n\n.......................F.\n\nTime: 00:08\n\nThere was 1 failure:\n\n1) testToFloatSetlocale(Zend_Locale_FormatTest)\nFailed asserting that <string:1\u00c2 234,50> is equal to <string:0,00>.\n\/var\/www\/html\/zftrunk\/tests\/Zend\/Locale\/FormatTest.php:758\n\/var\/www\/html\/zftrunk\/tests\/Zend\/Locale\/AllTests.php:44\n\/var\/www\/html\/zftrunk\/tests\/Zend\/Locale\/AllTests.php:60\n\nFAILURES!\nTests: 25, Failures: 1.\n\nzfdev Locale 701$ svn update\nAt revision 3991.\n\nzfdev Locale 702$ uname -a\nLinux www.zfdev.com 2.6.9-42.EL #1 Wed Jul 12 23:16:43 EDT 2006 i686 i686 i386 GNU\/Linux\n\nzfdev Locale 703$ php -v\nPHP 5.1.6 (cgi-fcgi) (built: Oct 24 2006 19:38:28)\nCopyright (c) 1997-2006 The PHP Group\nZend Engine v2.1.0, Copyright (c) 1998-2006 Zend Technologies\n{quote}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "created": "2007-03-15T18:13:37.000+0000",
                    "updated": "2007-03-15T18:13:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13447",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "body": "Guillaume Millet, would you have time to test the patch attached to ZF-1061?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gavin",
                        "name": "gavin",
                        "displayName": "Gavin",
                        "active": true
                    },
                    "created": "2007-03-16T12:44:50.000+0000",
                    "updated": "2007-03-16T12:44:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13500",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                        "name": "gmillet",
                        "displayName": "Guillaume Millet",
                        "active": true
                    },
                    "body": "I can, but which version should I apply the patch on ?\n\nAnyway, I gave a try at the SVN version 4108 and now the output of my test file changes from :\n{code}string(9) \"1 234,50\" string(8) \"1,234.50\"{code} *without* setlocale() to :\n{code}string(9) \"1 234,00\" string(8) \"1,234.00\"{code} *with* setlocale().",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gmillet",
                        "name": "gmillet",
                        "displayName": "Guillaume Millet",
                        "active": true
                    },
                    "created": "2007-03-19T04:50:57.000+0000",
                    "updated": "2007-03-19T04:50:57.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/15933",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Problems are solved with SVN 5806.\n\nCould you please verify if it's working for you ?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-07-21T06:11:45.000+0000",
                    "updated": "2007-07-21T06:11:45.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1049\/transitions"
}