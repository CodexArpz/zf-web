{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1432",
    "key": "ZF-1432",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Indexing for 2 documents produces invalid search results."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1432\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10090",
                    "id": 10090,
                    "description": "Release Candidate 2",
                    "name": "1.0.0 RC2",
                    "userReleaseDate": "08\/Jun\/07",
                    "archived": true,
                    "releaseDate": "2007-06-08",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2007-05-31T11:25:12.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                "name": "kharchenkoav",
                "displayName": "Andrew Kharchenko",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-05-25T04:28:07.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2007-07-05T14:44:13.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hello. \nHere is the problem I've got using Lucene Search Engine. \nIt produces different results on the same query after each document indexing.\n\nAdditional info: \nOS: Debian Linux\nFramework version: Trunk, April, 10  2007 update.\nPHP: 5.1.6 version\n\nWorkflow process in one script with comments:\n\n\/\/engine initialization\n$engine = new Zend_Search_Lucene($GLOBALS[\"LUCENE_DATA_DIR\"].\"\/knowledgebase\");\n$engine->setMaxBufferedDocs(1);\n$engine->setMaxMergeDocs(PHP_INT_MAX);\n$engine->setMergeFactor(100);\n\n\/\/init analyzer\n$analyzer = new Zend_Search_Lucene_Analysis_Analyzer_Common_TextNum_CaseInsensitive();\n$short_words_filter = new Zend_Search_Lucene_Analysis_TokenFilter_ShortWords(2);\n$analyzer->addFilter($short_words_filter);\nZend_Search_Lucene_Analysis_Analyzer::setDefault($analyzer);\n\n\/\/Here is the document reindexing index already contains\n\n\/\/delete old data\n$query = new Zend_Search_Lucene_Search_Query_MultiTerm();\n$query->addTerm(new Zend_Search_Lucene_Index_Term(458, 'object_id'), true);\n$query->addTerm(new Zend_Search_Lucene_Index_Term(8, 'object_type'), true);\n$query->addTerm(new Zend_Search_Lucene_Index_Term(0, 'sub_id'), true);\n$result = $engine->find($query);\nforeach ($result as $hit) {\n\t$engine->delete($hit->id);\n}\n$engine->Commit();\n\n\/\/add document again\n$document = new Zend_Search_Lucene_Document();\n\n$document->addField(Zend_Search_Lucene_Field::Text('metadata', \"496 testing phrase in class 1 0_0_0\"));\n$document->addField(Zend_Search_Lucene_Field::Keyword('object_id', 458));\n$document->addField(Zend_Search_Lucene_Field::Keyword('object_type', 8));\n$document->addField(Zend_Search_Lucene_Field::Keyword('sub_id', 0));\n$document->addField(Zend_Search_Lucene_Field::Text('title', \"firstclass\"));\n$document->addField(Zend_Search_Lucene_Field::Text('refcode', \"Refcode firstclass\"));\n$document->addField(Zend_Search_Lucene_Field::Text('date_created', 20070514151854));\n$document->addField(Zend_Search_Lucene_Field::Text('date_modified', 20070514151854));\n$document->addField(Zend_Search_Lucene_Field::UnStored('contents', \"\"));\n\n$engine->addDocument($document);\n$engine->commit();\n$engine->optimize();\n\n\/\/search for word 'firstclass' here by all text fields, it returns correct, just added document\n\n$query = new Zend_Search_Lucene_Search_Query_Boolean();\n$object_type_subquery = new Zend_Search_Lucene_Search_Query_Boolean();\n$current_subquery = new Zend_Search_Lucene_Search_Query_Term(new Zend_Search_Lucene_Index_Term(8, 'object_type'));\n$object_type_subquery->addSubquery( $current_subquery );\n$area_subquery = new Zend_Search_Lucene_Search_Query_Boolean();\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"title:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"refcode:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"metadata:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"contents:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n\n$query->addSubquery($object_type_subquery, true);\n$query->addSubquery($area_subquery, true);\n$result = $engine->find($query);\n\n\/\/displaying result ok, it produces the string contains correct object id\nforeach ($result as $hit) {\n\t$doc = $hit->getDocument();\n\t$object_id = $doc->getFieldValue(\"object_id\");\n\t$object_type = $doc->getFieldValue(\"object_type\");\n\t$relevancy = $hit->score;\n\techo \"($object_id, $object_type, $relevancy)\\n\";\n}\n\/\/output is \"(458, 8, 6.78011962683)\"\n\/\/then adding another document the same way\n\n\/\/delete old data\n$query = new Zend_Search_Lucene_Search_Query_MultiTerm();\n$query->addTerm(new Zend_Search_Lucene_Index_Term(472, 'object_id'), true);\n$query->addTerm(new Zend_Search_Lucene_Index_Term(8, 'object_type'), true);\n$query->addTerm(new Zend_Search_Lucene_Index_Term(0, 'sub_id'), true);\n$result = $engine->find($query);\nforeach ($result as $hit) {\n\t$engine->delete($hit->id);\n}\n$engine->Commit();\n\n$document = new Zend_Search_Lucene_Document();\n\n$document->addField(Zend_Search_Lucene_Field::Text('metadata', \"511 444 0_0_0\"));\n$document->addField(Zend_Search_Lucene_Field::Keyword('object_id', 472));\n$document->addField(Zend_Search_Lucene_Field::Keyword('object_type', 8));\n$document->addField(Zend_Search_Lucene_Field::Keyword('sub_id', 0));\n$document->addField(Zend_Search_Lucene_Field::Text('title', \"444\"));\n$document->addField(Zend_Search_Lucene_Field::Text('refcode', \"1\"));\n$document->addField(Zend_Search_Lucene_Field::Text('date_created', 20070521152550));\n$document->addField(Zend_Search_Lucene_Field::Text('date_modified', 20070521152550));\n$document->addField(Zend_Search_Lucene_Field::UnStored('contents', \"\"));\n\n$engine->addDocument($document);\n$engine->commit();\n$engine->optimize();\n\n\/\/trying to search by the same query but get different result somewhy - it returns the last added document and skips the first one document\n\/\/the forthcoming result is opposite - the result should contain first document and shouldn't contain the second.\n\n$query = new Zend_Search_Lucene_Search_Query_Boolean();\n$object_type_subquery = new Zend_Search_Lucene_Search_Query_Boolean();\n$current_subquery = new Zend_Search_Lucene_Search_Query_Term(new Zend_Search_Lucene_Index_Term(8, 'object_type'));\n$object_type_subquery->addSubquery( $current_subquery );\n\n$area_subquery = new Zend_Search_Lucene_Search_Query_Boolean();\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"title:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"refcode:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"metadata:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n$current_subquery = Zend_Search_Lucene_Search_QueryParser::parse(\"contents:(firstclass)\");\n$area_subquery->addSubquery( $current_subquery );\n\n$query->addSubquery($object_type_subquery, true);\n$query->addSubquery($area_subquery, true);\n$result = $engine->find($query);\n\nforeach ($result as $hit) {\n\t$doc = $hit->getDocument();\n\t$object_id = $doc->getFieldValue(\"object_id\");\n\t$object_type = $doc->getFieldValue(\"object_type\");\n\t$relevancy = $hit->score;\n\techo \"($object_id, $object_type, $relevancy)\\n\";\n}\n\n\/\/output is (472, 8, 6.78011962683)\n\n\/\/end of script\n\nPlease take a look the problem and comment this behavior\n\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1432\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/10500",
                    "filename": "knowledgebase.zip",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "created": "2007-05-25T04:29:11.000+0000",
                    "size": 116924,
                    "mimeType": "application\/x-zip-compressed",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/10500\/knowledgebase.zip"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14774",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "body": "Here is the indexing storage directory archive",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "created": "2007-05-25T04:29:11.000+0000",
                    "updated": "2007-05-25T04:29:11.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14791",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "Hi Andrew!\n\nGreat thanks for detailed description of the problem. I'll look into this soon (but may be not early than Monday).\n\n\nPS One suggestion, do not use ' new Zend_Search_Lucene(...)', but 'Zend_Search_Lucene::open(...)' or 'Zend_Search_Lucene::create(...)'. It doesn't affect your problem, but is preferable.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-05-25T06:45:32.000+0000",
                    "updated": "2007-05-25T06:45:32.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14819",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "I can not reproduce the problem in my environment (Linux, PHP V5.1.4\/V5.2.1, ZF current SVN version.\n\nIt looks like already fixed. Try to use current SVN version or latest snapshot.\nIf it doesn't help, please give me a result of:\n------------\necho $query->__toString() . \"\\n\";\n------\nafter each \"$result = $engine->find($query);\" call.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-05-28T08:00:04.000+0000",
                    "updated": "2007-05-28T08:00:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14854",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "body": "Here are some results from my tests...\nAfter switching to the current version and reindexing all data the problem appeared again with the same data and test script \n(I mean the different results on the same query). But after switching to Zend_Search_Lucene::open(...) open storage method \nand reindexing again all data, problem dissapears for some time. Then I've left simple \"open storage\/optimize storage\/close \nstorage\" script and todays morning the same problem appears again with the same test script.\n\nThe result of (echo $query->__toString() . \"\\n\";) is the same all time. It is the following:\n\n+((object_type:8)) +((((title:firstclass))) (((refcode:firstclass))) (((metadata:firstclass))) (((contents:firstclass)))) \n\nPlease comment this behavior or try to give me some keys for more detailed data report.\nFeel free to contact me directly (andrew@netive.ru) if you need any details.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "created": "2007-05-30T03:13:52.000+0000",
                    "updated": "2007-05-30T03:13:52.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14892",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "Fixed.\n\nThe problem arises if index containing deleted documents is optimized. \nDeleted documents stored fields were not skipped, but assigned to the followed document.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2007-05-31T11:25:12.000+0000",
                    "updated": "2007-05-31T11:25:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14960",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "body": "Many many thanks, Alexander.\nAll works fine with my tests. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kharchenkoav",
                        "name": "kharchenkoav",
                        "displayName": "Andrew Kharchenko",
                        "active": true
                    },
                    "created": "2007-06-05T02:41:11.000+0000",
                    "updated": "2007-06-05T02:41:11.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1432\/transitions"
}