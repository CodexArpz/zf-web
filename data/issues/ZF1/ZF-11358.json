{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11358",
    "key": "ZF-11358",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Test_PHPUnit_ControllerTestCase, problem when doing multiple dispatches in one test"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11358\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=flytony",
                "name": "flytony",
                "displayName": "Anton St\u00f6ckl",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-05-10T18:40:41.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-05-10T18:40:41.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Seems this is related to ZF-4511 and should be fixed according to that, but maybe the case is a bit different.\r\n\r\nAccording to the first example in http:\/\/framework.zend.com\/manual\/1.11\/en\/zend.test.phpunit.html this should work, so I assume the thrown errors might be the problem?\r\n\r\n* Both dispatched actions cause an error thrown by the controller action, which is catched by the error controller, which is displaying the 500 page.\r\n* The first dispatch does the expected thing and passes the test, but the second fails for the controller assertion.\r\n* When I call my tearDown() and setUp() functions between the two cases it works fine for both.\r\n* When I only call my setUp() it also works (seems the work done in my tearDown() is also triggered by Zend_Test_PHPUnit_ControllerTestCase:setUp() ??\r\n* When I don't call setUp() or $this->resetRequest()->resetResponse() at all it ends in an error instead of a failure.\r\n* When I split this into two distinct tests it also works.\r\n \r\n\r\n{code:xml|title=My test|borderStyle=solid}\r\nclass IndexControllerTest extends ControllerTestCase\r\n{\r\n\r\n    public function testSearchAction_tag_contains_invalid_chars()\r\n    {\r\n        $this->request->setMethod('POST');\r\n        $this->request->setPost(array(\r\n            'apikey' => 'whatever',\r\n        \t'tag' => 'ab@cd',\r\n        ));\r\n        $this->dispatch('\/index\/search');\r\n        $this->assertController('error');\r\n        $this->assertAction('error');\r\n        $this->assertResponseCode(500);\r\n\r\n        $this->resetRequest()->resetResponse();\r\n        $this->request->setMethod('POST');\r\n        $this->request->setPost(array(\r\n            'apikey' => 'whatever',\r\n        \t'tag' => 'ab<script type=\"text\/javascript\" src=\"hacker.js\"><\/script>cd',\r\n        ));\r\n        $this->dispatch('\/index\/search');\r\n        $this->assertController('error');     --> this is line 69\r\n        $this->assertAction('error');\r\n        $this->assertResponseCode(500);\r\n        $this->tearDown();\r\n\r\n    }\r\n}\r\n{code}\r\n\r\n{code:xml|title=My base class ControllerTestCase|borderStyle=solid}\r\nrequire_once 'Zend\/Test\/PHPUnit\/ControllerTestCase.php';\r\n\r\nclass ControllerTestCase extends Zend_Test_PHPUnit_ControllerTestCase\r\n{\r\n    \/**\r\n     * @var Zend_Application\r\n    *\/\r\n    protected $application;\r\n\r\n    public function setUp()\r\n    {\r\n        $this->bootstrap = array($this, 'appBootstrap');\r\n        parent::setUp();\r\n    }\r\n\r\n    public function appBootstrap()\r\n    {\r\n        $this->application = new Zend_Application(APPLICATION_ENV, APPLICATION_PATH . '\/configs\/application.ini');\r\n        $this->application->bootstrap();\r\n    }\r\n\r\n    public function tearDown()\r\n    {\r\n        \/\/ reset some resources\r\n        $this->resetRequest()->resetResponse();\r\n        $this->request->setPost(array());\r\n        $this->request->setQuery(array());\r\n    }\r\n}\r\n{code}\r\n\r\n{code:xml|title=Output of PHPUnit with assertion failing (resetting of request and response done)|borderStyle=solid}\r\n1) IndexControllerTest::testSearchAction_tag_contains_invalid_chars\r\nFailed asserting last controller used <\"index\"> was \"error\"\r\n\r\n\/var\/www\/libraries\/ZendFramework-1.11.6\/library\/Zend\/Test\/PHPUnit\/ControllerTestCase.php:1000\r\n\/home\/tony\/Zend\/workspaces\/DefaultWorkspace7\/VoycerTagservice\/tests\/application\/IndexControllerTest.php:69\r\n{code}\r\n\r\n{code:xml|title=Output of PHPUnit with assertion erroring (NO resetting of request and response done)|borderStyle=solid}\r\nThere was 1 error:\r\n\r\n1) IndexControllerTest::testSearchAction_tag_contains_invalid_chars\r\nVC_Exception: parameter \"tag\" is missing or contains invalid characters\r\n\r\n\/home\/tony\/Zend\/workspaces\/DefaultWorkspace7\/VoycerTagservice\/application\/controllers\/IndexController.php:46\r\n\/var\/www\/libraries\/ZendFramework-1.11.6\/library\/Zend\/Controller\/Action.php:513\r\n\/var\/www\/libraries\/ZendFramework-1.11.6\/library\/Zend\/Controller\/Dispatcher\/Standard.php:295\r\n\/var\/www\/libraries\/ZendFramework-1.11.6\/library\/Zend\/Controller\/Front.php:954\r\n\/var\/www\/libraries\/ZendFramework-1.11.6\/library\/Zend\/Test\/PHPUnit\/ControllerTestCase.php:208\r\n\/home\/tony\/Zend\/workspaces\/DefaultWorkspace7\/VoycerTagservice\/tests\/application\/IndexControllerTest.php:69\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11358\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10550",
                    "id": 10550,
                    "description": "Mini Release",
                    "name": "1.11.5",
                    "userReleaseDate": "07\/Apr\/11",
                    "archived": false,
                    "releaseDate": "2011-04-07",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10580",
                    "id": 10580,
                    "description": "Mini Release",
                    "name": "1.11.6",
                    "userReleaseDate": "05\/May\/11",
                    "archived": false,
                    "releaseDate": "2011-05-05",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10312",
                    "id": 10312,
                    "name": "Zend_Test_PHPUnit",
                    "description": "PHPUnit test scaffolding for ZF MVC applications",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [

            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11358\/transitions"
}