{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10486",
    "key": "ZF-10486",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Db_Profiler doesn't take into account the DESCRIBE queries used internally"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10486\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=poisa",
                "name": "poisa",
                "displayName": "Julian Vidal",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-09-22T13:00:23.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T21:37:42.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "If I have a class like this one...\r\n\r\n{code}class Application_Model_DbTable_Languages extends Zend_Db_Table_Abstract\r\n{\r\n\r\n    protected $_name = 'languages';\r\n    protected $_primary = 'id_lang';\r\n\r\n}{code}\r\n\r\n... the framework will do a DESCRIBE TABLE query (at least on MySQL) before using it to gather info about the table.\r\nI can see those queries piling up on the MySQL log but the profiler won't take them into account using:\r\n\r\n{code}$adapter = Zend_Db_Table::getDefaultAdapter();\r\n$profiler = $adapter->getProfiler();\r\nvar_dump($profiler->getTotalNumQueries());\r\nvar_dump($profiler->getQueryProfiles(null, true));{code}\r\n\r\nWhen I set up the metadata cache the queries are not executed and the profiler still shows the same amount of queries as before.\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10486\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10490",
                    "id": 10490,
                    "description": "Mini Release",
                    "name": "1.10.8",
                    "userReleaseDate": "25\/Aug\/10",
                    "archived": false,
                    "releaseDate": "2010-08-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10134",
                    "id": 10134,
                    "name": "Zend_Db_Profiler",
                    "description": "Profiler decorator for Zend_Db, to measure time of queries and other database access operations.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42342",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "This is by design as you would not want to hide anything that might happening between your application and the database by default.\r\n\r\nThere are two work arounds for you: the first is to extend the profiler and check the first few characters of each query to determine if you want to log it.  The second is to give Zend_Db_Table a cache object so that it can cache the results of the DESCRIBE table lookup that it is doing.\r\n\r\nIf anything, this is a feature request of Zend_Db_Profiler to selectively \"listen in\" on specific query types.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2010-09-23T06:40:33.000+0000",
                    "updated": "2010-09-23T06:40:33.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42346",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=poisa",
                        "name": "poisa",
                        "displayName": "Julian Vidal",
                        "active": true
                    },
                    "body": "{quote}you would not want to hide anything that might happening between your application and the database by default.{quote}\r\n\r\nBut it _is_ hiding all the DESCRIBE queries. I think I might have not explained the problem correctly.\r\n\r\nLet me tell you how I came across this which might explain why I reported it as a bug rather than a feature request.\r\n\r\nA website I did got a popularity spike and MySQL started maxing out on its number of connections. The first thing I did was fire the profiler and do some math based on the result of getTotalNumQueries() and the hits reported by apache. The math didn't add up so I put the app in a sandbox and found that my ZF app was executing more queries than the profiler was reporting! This ended up having nothing to do with the actual website problem but it is how I learned that the DESCRIBE queries where not getting logged by the profiler. \r\n\r\nIt thought that this was an odd default ZF behavior and started looking whether I could enable full logging in the profiler but apparently the profiler was set to show all the queries (but was obviously failing to log the DESCRIBE ones).\r\n\r\nI made the metadata cache comment as a sort of test case to provide some proof that the profiler wasn't logging correctly (according to my understandind of what it should do, that is). Basically what I meant was that for a _single_ database *fetchAll()* operation:\r\n\r\n||_||Actual Query Count in MySQL log||Query Count on Profiler||\r\n|Without metadata cache|2|1|\r\n|With metadata cache|1|1|\r\n\r\n\r\nI don't think I'm ZF savvy enough yet to extend the profiler, but sounds like a fun enough challenge!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=poisa",
                        "name": "poisa",
                        "displayName": "Julian Vidal",
                        "active": true
                    },
                    "created": "2010-09-23T07:33:21.000+0000",
                    "updated": "2010-09-23T07:33:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42362",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "Are you using Mysqli or PDO_Mysql adapter?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2010-09-24T12:07:02.000+0000",
                    "updated": "2010-09-24T12:07:02.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42371",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=poisa",
                        "name": "poisa",
                        "displayName": "Julian Vidal",
                        "active": true
                    },
                    "body": "Ralph, I completely forgot that there was another adapter available to me! \r\n\r\nMy tests were using the mysqli adapter and also I wasn't specifying any charset. The MySQL version I'm using is  5.1.36. Here are the results of some more tests I've made, this time specifying a charset. Instead of giving you the query count I'll just copy paste the queries straight from the mysql log and profiler. \r\n\r\n_I removed the timestamps and connection number from the mysql logs to make it more readable._\r\n\r\n{code:title=Test code|borderStyle=solid}\r\nclass IndexController extends Zend_Controller_Action\r\n{\r\n\r\n    public function indexAction()\r\n    {\r\n        $languageTable = new Application_Model_DbTable_Languages();\r\n        $languageTable->fetchAll();\r\n\r\n        $profiler = $languageTable->getAdapter()->getProfiler();\r\n        Zend_Debug::dump($profiler->getQueryProfiles(null, true));\r\n\r\n        die();\r\n    }\r\n\r\n}\r\n{code}\r\n\r\nI've marked in {color:red}red{color} all the things I believe the profiler is failing to log.\r\n\r\nh2. mysqli (without metadata cache)\r\n\r\n|| MySQL log || Profiler ||\r\n|{color:red} Connect\troot@localhost on test{color}\r\nQuery\t{color:red} SET NAMES utf8{color}\r\nQuery\t{color:red} DESCRIBE `languages`{color}\r\nPrepare\tSELECT `languages`.* FROM `languages`\r\nExecute\tSELECT `languages`.* FROM `languages`\r\nReset stmt\t\r\nClose stmt\t\r\nQuit|SELECT `languages`.* FROM `languages`\r\n\r\n\r\nh2. mysqli (with metadata cache)\r\n\r\n|| MySQL log || Profiler ||\r\n|{color:red}Connect\troot@localhost on test{color}\r\nQuery\t{color:red}SET NAMES utf8{color}\r\nPrepare\tSELECT `languages`.* FROM `languages`\r\nExecute\tSELECT `languages`.* FROM `languages`\r\nReset stmt\r\nClose stmt\r\nQuit|SELECT `languages`.* FROM `languages`\r\n\r\n----\r\n\r\nh2. pdo_mysql (without metadata cache)\r\n\r\n|| MySQL log || Profiler ||\r\n|Connect\troot@localhost on test\r\nQuery\t{color:red}SET NAMES 'utf8'{color}\r\nQuery\tDESCRIBE `languages`\r\nQuery\tSELECT `languages`.* FROM `languages`\r\nQuit|connect\r\nDESCRIBE `languages`\r\nSELECT `languages`.* FROM `languages`\r\n\r\n\r\nh2. pdo_mysql (with metadata cache)\r\n\r\n|| MySQL log || Profiler ||\r\n|Connect\troot@localhost on test\r\nQuery\t{color:red}SET NAMES 'utf8'{color}\r\nQuery\tSELECT `languages`.* FROM `languages`\r\nQuit|connect\r\nSELECT `languages`.* FROM `languages`",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=poisa",
                        "name": "poisa",
                        "displayName": "Julian Vidal",
                        "active": true
                    },
                    "created": "2010-09-25T09:34:45.000+0000",
                    "updated": "2010-09-25T09:34:45.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10486\/transitions"
}