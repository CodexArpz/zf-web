{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6258",
    "key": "ZF-6258",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "File upload with rename filter pseudo random failing"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6258\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10241",
                    "id": 10241,
                    "description": "Minor Release",
                    "name": "1.8.0",
                    "userReleaseDate": "30\/Apr\/09",
                    "archived": false,
                    "releaseDate": "2009-04-30",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-04-10T08:38:27.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladev",
                "name": "vladev",
                "displayName": "Emil Ivanov",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-04-10T03:20:30.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-04-11T00:34:17.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Using trunk (via svn:externals).\n\nI noticed a while ago in the svn log that there has been an optimization added to Zend_File_Transfer to avoid moving a file twice when there is a rename filter in place.\n\nBut in the rename filter there is a check:\n{code:title=\"Zend_Filter_File_Rename, line 151\"}\nif (!file_exists($file['source'])) {\n    return $value;\n}\n{code}\n\nWhat this basically does it that it bails out silently (?) if the file is not there, returning the original given filename. But the problem is that the file is actually NOT there since it hasn't been moved yet (the rename optimization I guess) - so the rename filter returns the original name, instead of the new name, and the file is not renamed.\nThe second time I try to upload the same file it magically works since there is a stale copy of the previous attempt.\n\nNot sure I explained it the best way but I'm quite confused :)\nAsk, and I will try to provide more feedback, if necessary."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6258\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                "name": "thomas",
                "displayName": "Thomas Weidner",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10241",
                    "id": 10241,
                    "description": "Minor Release",
                    "name": "1.8.0",
                    "userReleaseDate": "30\/Apr\/09",
                    "archived": false,
                    "releaseDate": "2009-04-30",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10320",
                    "id": 10320,
                    "name": "Zend_File_Transfer",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30070",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "When \"the file is not there\", then is has not been transferred from the client to PHP.\nBecause the file check is done on the file within the temporary directory.\n\nNo temporary file, means no upload, which means, no new name...",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2009-04-10T04:42:50.000+0000",
                    "updated": "2009-04-10T04:42:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30071",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladev",
                        "name": "vladev",
                        "displayName": "Emil Ivanov",
                        "active": true
                    },
                    "body": "I knew that explanation would blew up. ;)\n\nThe file got to the server - it's in the \/tmp dir under the name PHP gave it (something like \/tmp\/adyU639A)\nAs far as I understand the Zend_File_Transfer component will then move it to the destination (set via setDestination()).\nThen the rename filter would be applied, moving it yet again to it's last location.\n\nYou've introduced a check for the rename filter in the adapter to skip one moving (which is a very good idea).\n\nLet's write the locations where the file ends up in the non-optimized case:\n\n{code}\nPHP               Zend_File_Transfer               Rename filter\n \/tmp\/adyU639A -> \/home\/me\/myapp\/upload\/car.jpg -> \/home\/me\/myapp\/cars\/as5d675123\n{code}\n\nWhat the rename filter check (based on debuging I did) is for the existence of the second path (...\/car.jpg) - which apparently does not exist since the file hasn't beed moved yet by the Zend_FIle_Transfer component.\n\nHere are the places I think the bug can be found:\n\n{code:title=\"Zend_File_Transfer_Adapter_Http, line 162\"}\nif ($rename !== null) {\n    $filename = $rename->getNewName($directory . $content['name']);\n    $key = array_search('Rename', $this->_files[$file]['filters']);\n    unset($this->_files[$file]['filters'][$key]);\n}\n{code}\nThe path passes to getNewName() is the path in the middle (the example above).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladev",
                        "name": "vladev",
                        "displayName": "Emil Ivanov",
                        "active": true
                    },
                    "created": "2009-04-10T05:03:04.000+0000",
                    "updated": "2009-04-10T05:03:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30073",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "Fixed with r14818\nProblem occured when not giving source",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2009-04-10T08:38:24.000+0000",
                    "updated": "2009-04-10T08:38:24.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30084",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladev",
                        "name": "vladev",
                        "displayName": "Emil Ivanov",
                        "active": true
                    },
                    "body": "Awesome! Thank you very much. :)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladev",
                        "name": "vladev",
                        "displayName": "Emil Ivanov",
                        "active": true
                    },
                    "created": "2009-04-11T00:34:04.000+0000",
                    "updated": "2009-04-11T00:34:04.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6258\/transitions"
}