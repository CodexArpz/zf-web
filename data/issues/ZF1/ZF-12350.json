{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12350",
    "key": "ZF-12350",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Function preDispatch called twice in case of module specific bootstrap"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12350\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/4",
                "name": "Incomplete"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-07-27T09:43:59.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                "name": "piteer1",
                "displayName": "Piotr Deszy\u0144ski",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2012-07-27T09:35:25.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-07-27T16:05:43.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "This bug occures while using modular ZF1 structure and module specific Bootstrap class. To reproduce this bug:\r\n\r\n1. Create empty ZF1 project (I was using ZF Tool) and make it default modular structure.\r\n2. Add following settings into application.ini:\r\n{noformat}\r\nresources.frontController.moduleDirectory   = APPLICATION_PATH \"\/modules\"\r\nresources.modules[] =\r\n{noformat}\r\n3. Add to default module empty boostrap class:\r\n{noformat}\r\n<?php\r\n\r\nclass Default_Bootstrap extends Zend_Application_Bootstrap_Bootstrap {\r\n}\r\n{noformat}\r\n\r\n4. Create any FrontController Plugin with preDispatch method and add it using application.ini for e.g.:\r\n{noformat}\r\nresources.frontController.plugins.dispatchTest = \"Test_Controller_Plugin_DispatchTest\"\r\n{noformat}\r\n\r\nFrom now on preDispatch method will be called more than once. This leads to confusion.\r\n\r\nTo fix this behaviour it's needed to remove module specific Bootstrap.\r\n\r\nExpected behaviour:\r\n\r\nPreDispatch called only once."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12350\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                "name": "bittarman",
                "displayName": "Ryan Mauger",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10981",
                    "id": 10981,
                    "description": "Mini Release",
                    "name": "1.11.11",
                    "userReleaseDate": "29\/Sep\/11",
                    "archived": false,
                    "releaseDate": "2011-09-29",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/11080",
                    "id": 11080,
                    "description": "Mini Release",
                    "name": "1.11.12",
                    "userReleaseDate": "22\/Jun\/12",
                    "archived": false,
                    "releaseDate": "2012-06-22",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10390",
                    "id": 10390,
                    "name": "Zend_Application",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51441",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "This sounds more like the common problem of not having a favicon.ico, or another missing file which is referenced in the output html (like a link to a stylesheet which is broken).\r\n\r\nCould you clarify how you are determining that preDispatch is called twice?\r\n\r\nPlease also note, that preDispatch will also be called more than once on requests involving the error controller, or any use of _forward in a controller, or if you change the requested controller \/ action, as all of these methods involve running a second iteration of the dispatch loop.\r\n\r\nI'm going to close this issue as preDispatch being called more than  once is expected behaviour in many circumstances.\r\n\r\nPlease provide a clear, reproduce case, and documentation of how you are observing preDispatch being called more than once if you wish to re-open, so that we can rule out all of the legitimate use cases where this is normal behaviour.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2012-07-27T09:43:59.000+0000",
                    "updated": "2012-07-27T09:43:59.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51447",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                        "name": "piteer1",
                        "displayName": "Piotr Deszy\u0144ski",
                        "active": true
                    },
                    "body": "I tried this while using curl instead of a browser (so this shouldn't make favicon.ico request). Additionally it's like I wrote: when you remove module specific Bootstrap, everything behaves like it should. There is no _forward call, there is no error either.\r\n\r\nI will write again how to reproduce this bug:\r\n\r\n1. Create new empty ZF project (using ZF tool) in zf1-project directory\r\n2. cd zf1-project\r\n3. mkdir application\/modules\/default\r\n4. mv application\/controllers application\/modules\/default\r\n5. mv application\/views application\/modules\/default\r\n6. Create test plugin:\r\n{noformat}\r\n<?php\r\n\r\nclass Test_Controller_Plugin_Test extends Zend_Controller_Plugin_Abstract {\r\n\r\n    public function preDispatch(Zend_Controller_Request_Abstract $request) {\r\n        var_dump('pre dispatch');\r\n    }\r\n}\r\n\r\n{noformat}\r\nand put it into file 'library\/Test\/Controller\/Plugin\/Test.php'\r\n\r\n\r\n7. Add following settings into application.ini:\r\n{noformat}\r\nautoloaderNamespaces.Test = \"Test_\"\r\nresources.frontController.moduleDirectory   = APPLICATION_PATH \"\/modules\"\r\nresources.modules[] =\r\nresources.frontController.plugins.test = \"Test_Controller_Plugin_Test\"\r\n\r\n{noformat}\r\n\r\n8. Create Bootstrap class for default module:\r\n{noformat}\r\n<?php\r\n\r\nclass Default_Bootstrap extends Zend_Application_Bootstrap_Bootstrap {\r\n}\r\n{noformat}\r\n\r\nand put this code into 'application\/modules\/default\/Bootstrap.php'\r\n\r\n9. Open a browser or use cURL to test (for e.g. localhost\/zf1-project\/public) the text 'pre dispatch' will be seen twice.\r\n\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                        "name": "piteer1",
                        "displayName": "Piotr Deszy\u0144ski",
                        "active": true
                    },
                    "created": "2012-07-27T13:45:02.000+0000",
                    "updated": "2012-07-27T13:45:02.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51448",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                        "name": "piteer1",
                        "displayName": "Piotr Deszy\u0144ski",
                        "active": true
                    },
                    "body": "Additionally you can change Plugin class to:\r\n\r\n{noformat}\r\n<?php\r\n\r\nclass Test_Controller_Plugin_Test extends Zend_Controller_Plugin_Abstract {\r\n\r\n    private static $_preDispatchCalled = 0;\r\n\r\n    public function preDispatch(Zend_Controller_Request_Abstract $request) {\r\n        self::$_preDispatchCalled++;\r\n    }\r\n\r\n    public static function getDispatchCalled() {\r\n        return self::$_preDispatchCalled;\r\n    }\r\n}\r\n{noformat}\r\n\r\nAnd run a test:\r\n\r\n{noformat}\r\n<?php\r\n\r\nclass IndexControllerTest extends Zend_Test_PHPUnit_ControllerTestCase\r\n{\r\n\r\n    public function setUp()\r\n    {\r\n        $this->bootstrap = new Zend_Application(APPLICATION_ENV, APPLICATION_PATH . '\/configs\/application.ini');\r\n        parent::setUp();\r\n    }\r\n\r\n    public function testPreDispatchOnce() {\r\n        $this->dispatch('\/');\r\n        $this->assertTrue(Test_Controller_Plugin_Test::getDispatchCalled() === 1);\r\n    }\r\n\r\n\r\n}\r\n{noformat}\r\n\r\nThis test will fail whether it shoulnd't have",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                        "name": "piteer1",
                        "displayName": "Piotr Deszy\u0144ski",
                        "active": true
                    },
                    "created": "2012-07-27T14:00:11.000+0000",
                    "updated": "2012-07-27T14:00:11.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51450",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "Given the steps you outlined, there are no controllers in your new 'default' module, so there would have been a controller not found exception, looping the request to the error controller.\r\ntry creating application\/modules\/default\/controllers\/IndexController.php and in it put:\r\n\r\n{code}\r\n<?php\r\n\r\nclass IndexController extends Zend_Controller_Action\r\n{\r\n    public function indexAction()\r\n    {\r\n        $this->getHelper('viewRenderer')->setNeverRender(true);\r\n    }\r\n}\r\n{code}\r\n\r\nThis should make your test pass (it does for me). Also, this is expected behaviour.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2012-07-27T14:22:26.000+0000",
                    "updated": "2012-07-27T14:23:49.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51452",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "body": "Additionally, I've just noticed I did one thing different from you when creating the test, I used  Zend_Application_Module_Bootstap as the bootstrap for the 'default' module as it is a module bootstrap the way you have used it. Having two or more Zend_Application_Bootstrap_Bootstrap bootstraps will cause unexpected problems also, as this is not its intended use.\r\n\r\nYou would save yourself some pain by not having a 'default' module in the modules directory, as this really isn't the way that your application will behave anyway.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bittarman",
                        "name": "bittarman",
                        "displayName": "Ryan Mauger",
                        "active": true
                    },
                    "created": "2012-07-27T14:36:47.000+0000",
                    "updated": "2012-07-27T14:36:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51457",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                        "name": "piteer1",
                        "displayName": "Piotr Deszy\u0144ski",
                        "active": true
                    },
                    "body": "Yes, thank you. probably that was the cause. Sorry for the problem.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=piteer1",
                        "name": "piteer1",
                        "displayName": "Piotr Deszy\u0144ski",
                        "active": true
                    },
                    "created": "2012-07-27T16:05:43.000+0000",
                    "updated": "2012-07-27T16:05:43.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12350\/transitions"
}