{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7520",
    "key": "ZF-7520",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "fsocken does not implement a timeout  in Zend_Queue_Stomp_Client_Connection"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField",
            "value": {
                "timeestimate": 0,
                "timespent": 30
            }
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7520\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-11-20T20:53:28.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                "name": "kkarank",
                "displayName": "Dheeraj Saxena",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-08-07T10:54:06.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T20:53:28.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Stomp",
                "Zend_Queue"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "The Fsockopen function does not currently implement a timeout which means that if the broker is down then queue->send results in php timeout. I have gone through the code and it does'nt look like there is any other config parameter that can take care of this. I had to manually add a timeout parameter to the fsockopen call to make queue->send work (throw an exception) in case the ActiveMq broker was not running"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7520\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/worklog\/21869",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7520",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "comment": "Ran several manual tests to try and replicate reporter's error.",
                    "created": "2009-08-08T10:15:51.000+0000",
                    "updated": "2009-08-08T10:15:51.000+0000",
                    "started": "2009-08-08T09:45:00.000+0000",
                    "minutesSpent": 30
                }
            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10320",
                    "id": 10320,
                    "description": "Minor Release",
                    "name": "1.9.0",
                    "userReleaseDate": "31\/Jul\/09",
                    "archived": false,
                    "releaseDate": "2009-07-31",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10421",
                    "id": 10421,
                    "name": "Zend_Queue",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33291",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Setting component to Zend_Queue and assigning to Justin.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2009-08-07T11:47:43.000+0000",
                    "updated": "2009-08-07T11:47:43.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33311",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "Hi,\n\nThank you for reporting this bug.  I am not clear on what you are reporting as being broken.  The fsockopen function will use the default \"default_socket_timeout\" function.  \n\nI will check into the send function (php:fwrite()) needing a timeout...\n\n-daniel\n\n\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T09:40:58.000+0000",
                    "updated": "2009-08-08T09:40:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33313",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "I manually tested this.\n\nIf the Activemq adapter is not up, then I get a connection refused error:\n\nZend_Queue_Exception: Unable to connect to tcp:\/\/127.0.0.1; error = Connection refused ( errno = 111 ) in [filtered]\/trunk\/library\/Zend\/Queue\/Stomp\/Client\/Connection.php on line 76\n\nI will next test for what happens when I terminate the ActiveMQ while recieving messages.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T10:06:53.000+0000",
                    "updated": "2009-08-08T10:06:53.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33317",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "I have manually tested terminating the ActiveMQ broker while it was running, while sending \"Hello world\" messages to it.\n\nI got the following error:\n\n>php test.php\nSending Hello world 1\nSending Hello world 2\nSending Hello world 3\nSending Hello world 4\nSending Hello world 5\nSending Hello world 6\nSending Hello world 7\nSending Hello world 8\nSending Hello world 9\nSending Hello world 10\n\nZend_Queue_Exception: No bytes written in [filtered]\/ZF\/trunk\/library\/Zend\/Queue\/Stomp\/Client\/Connection.php on line 161\n\nCall Stack:\n    0.0003     100136   1. {main}() [filtered]\/ZF\/trunk\/test.php:0\n    9.0591    1008432   2. Zend_Queue->send() [filtered]\/ZF\/trunk\/test.php:21\n    9.0591    1008432   3. Zend_Queue_Adapter_Activemq->send() [filtered]\/ZF\/trunk\/library\/Zend\/Queue.php:416\n    9.0593    1008432   4. Zend_Queue_Stomp_Client->send() [filtered]\/ZF\/trunk\/library\/Zend\/Queue\/Adapter\/Activemq.php:263\n    9.0593    1008432   5. Zend_Queue_Stomp_Client_Connection->write() [filtered]\/ZF\/trunk\/library\/Zend\/Queue\/Stomp\/Client.php:138\n\n\nFatal error: Exception thrown without a stack frame in Unknown on line 0\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T10:13:00.000+0000",
                    "updated": "2009-08-08T10:13:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33318",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "Could you provide more information about the bug you have received?  And if possible, please provide the get_ini('default_socket_timeout') setting.\n\n-daniel",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T10:14:39.000+0000",
                    "updated": "2009-08-08T10:14:48.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33321",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "body": "Thats strange,\n\nThe code I am seeing in 1.9 RC1 distro is\n\n{code}\n....\n$this->_socket = fsockopen($str, $port, $errno, $errstr,10);\n        \n        \/\/ the code below is all the same\n         if ($this->_socket === false) {\n            \/\/ aparently there is some reason that fsockopen will return false\n            \/\/ but it normally throws an error.\n            require_once 'Zend\/Queue\/Exception.php';\n            throw new Zend_Queue_Exception(\"Unable to connect to $str; error = $errstr ( errno = $errno )\");\n        }\n {\/code}\n\nthe fsockopen call is not inside a try\/catch so I am not sure how the exception is being thrown? The code does not get to the point where it can check if the socket is open and is a valid resource.\n\nAnyways, default_socket_timeout is set to 60 secs in my php.ini and the page making the request to my broker times out after that. All fine and dandy there.\n\nThe problem is that \na) while 60 secs timeout maybe valid for a webpage it is IMHO on the higher side for talking to a broker whose only job is to accect a message and put it on a queue. if it is down it is down and i am not aware of any application that can bring figure out that a broker is down and then bring it back up cleanly within 60 secs.\nb) I could make a manual call to set smaller timeout through default_socket_connection but the way I have coded my logic - if the broker is down then i dehydrate my data onto the filesystem and db and that leg of the transaction has its own latency. Of course, once the broker times out I could set another timeout before commencing the dehydration process but all that is too much hackery i think.\n\nI have reported this as a minor issue as it is not the end of the world if fsockopen can not be invoked using a custom timeout but if it can be then it would save a lot of working around.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kkarank",
                        "name": "kkarank",
                        "displayName": "Dheeraj Saxena",
                        "active": true
                    },
                    "created": "2009-08-08T11:31:05.000+0000",
                    "updated": "2009-08-08T11:31:05.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33323",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "In regards to the distro here is the file from 1.9.0rc1\n\nhttp:\/\/framework.zend.com\/svn\/framework\/standard\/tags\/release-1.9.0rc1\/library\/Zend\/Queue\/Stomp\/Client\/Connection.php\n\nI suspect you may have modified this file on your system.\n\n--\n\nif fsockopen cannot open the file it returns a false value\n\n http:\/\/us3.php.net\/fsockopen\n\nthen following line which checks if ( $this->socket === false ) will then throw the exception.  \n\n--\n\nIn regards to the request for a \"driverOptions\" open_timeout I don't see any problem about this.  I will check with Justin first and then code it if he is happy about the idea.\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-08T12:44:39.000+0000",
                    "updated": "2009-08-08T12:44:39.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33351",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "This turned out to be much more of a bigger change than I thought.\n\nI sent an email to zf-contributors requesting help as solving this problem would involve changing the API for the \"best\" solution and the least best solution \"a patch\" would involve making a static class variable in Zend_Queue_Stomp_Client_Connection.\n\nBelow is the email I sent to zf-contributors\n\nHello,\n\nSomeone recently brought to my attention that fsockopen's dependency on get_ini('default_socket_timeout') was really inconvenient in a web application because it is 60 seconds by default. ( http:\/\/www.php.net\/manual\/en\/ini.list.php )\n\nI thought about it, and I agreed that this was probably unreasonable and should allowed to be set in some manner via a configuration setting.\n\nHowever, implementing this change has become fairly difficult because of the \"depth\" of the final class that needs to be modified.\n\nZend_Queue is a class that returns a Zend_Queue + an adapter attached on.  The adapter in this question is Activemq.  However, Activemq uses Stomp (a simple protocol for messaging), but the Stomp uses another class for actually doing the connection IO.\n\nSo in affect, a configuration change passed to\n\nZend_Queue($options['timeout']) -> Activemq -> Stomp wrapper -> Stomp IO.\n\nIn eagle hindsight, I should have made the \"connection\" options an associative array for several of the constructor calls instead of using open($scheme, $host, $port...).  Does anyone have any suggestions for fixing this that don't involve an API change, which I understand is verbotten between minor revisions.\n\nThe best that comes to my mind is to use a class variable\n\nclass Zend_Queue_Stomp_Client_Connection {\n    static protected $timeout = 10;\n    static public function getTimeout() {\n        return $this->timeout;\n    }\n\n    static public function setTimeout() { ... }\n}\n\nThis saves me from disrupting a large section of code to implement a minor \"useful\" change, but I don't like this idea of setting a \"singleton\" -in effect, global configuration variable.  Then in Zend Frameworks 2.0 - fix this flaw, which\nshould allow API changes. \n\nDoes anyone know a better solution?\n\n\n-daniel\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-08-09T18:47:36.000+0000",
                    "updated": "2009-08-09T18:47:36.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34748",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "body": "From the response I got back, I think implementing static functions or updating the manual (Zend_Queue) so that the ini_setting is set properly is the best method.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=danlo",
                        "name": "danlo",
                        "displayName": "Daniel Lo",
                        "active": true
                    },
                    "created": "2009-09-20T17:05:19.000+0000",
                    "updated": "2009-09-20T17:05:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/52799",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Bulk change of all issues last updated before 1st January 2010 as \"Won't Fix\".\r\n\r\nFeel free to re-open and provide a patch if you want to fix this issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-11-20T20:53:28.000+0000",
                    "updated": "2012-11-20T20:53:28.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7520\/transitions"
}