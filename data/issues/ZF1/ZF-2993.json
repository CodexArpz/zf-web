{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2993",
    "key": "ZF-2993",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Layout renders twice on ViewRenderer exception"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2993\/votes",
                "votes": 5,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10240",
                    "id": 10240,
                    "description": "Minor Release",
                    "name": "1.6.0",
                    "userReleaseDate": "02\/Sep\/08",
                    "archived": false,
                    "releaseDate": "2008-09-02",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2008-08-06T22:38:44.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=psharp",
                "name": "psharp",
                "displayName": "Philip Sharp",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-03-28T14:08:25.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2008-09-02T10:39:04.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Given a TestController with actions \"succesful\" and \"missingviewscript\", configured to use the following layout:\n{code}\n[DEFAULT LAYOUT HEADER]\n<?php \n    echo $this->layout()->content;\n?>\n[DEFAULT LAYOUT FOOTER]\n{code}\n\nAnd an ErrorController, configured to use the following layout:\n{code}\n[ERROR LAYOUT HEADER]\n<?php \n    echo $this->layout()->content;\n?>\n[ERROR LAYOUT FOOTER]\n{code}\n\nWith the following defaults unchanged:\nZend_Controller_Front::_throwExceptions is false, Zend_Layout::_mvcSuccessfulActionOnly is true, and Zend_Controller_Action_Helper_ViewRenderer and Zend_Controller_Plugin_ErrorHandler are enabled.\n\n\/test\/succesful expected and seen:\n{code}\n[DEFAULT LAYOUT HEADER]\n(TestController::succesfulAction output)\n[DEFAULT LAYOUT FOOTER]\n{code}\n\n\/test\/missingaction expected and seen:\n{code}\nERROR LAYOUT HEADER]\n(ErrorController::errorAction output)\n[ERROR LAYOUT FOOTER]\n{code}\n\n\/test\/missingviewscript expected:\n{code}\n[ERROR LAYOUT HEADER]\n(ErrorController::errorAction output)\n[ERROR LAYOUT FOOTER]\n{code}\n\n\/test\/missingviewscript seen:\n{code}\n[ERROR LAYOUT HEADER]\n[DEFAULT LAYOUT HEADER]\n\n[DEFAULT LAYOUT FOOTER]\n(ErrorController::errorAction output)\n[ERROR LAYOUT FOOTER]\n{code}\n\nThis appears to occur because when _throwExceptions is false, the exception thrown by Zend_Controller_Action_Helper_ViewRenderer is caught and Zend_Layout_Controller_Action_Helper_Layout::postDispatch() is allowed to run, setting _isActionControllerSuccessful to true. Therefore the default layout is rendered around the empty content of missingviewscriptAction, then the error layout is rendered around this content and the errorAction content.\n\nThe preferred bahavior would be to skip rendering of the layout around the missingviewscriptAction, either by default or through configuration."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/customFieldOption\/10037",
                "value": "   Must Have"
            }
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2993\/watchers",
                "isWatching": false,
                "watchCount": 6
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10174",
                    "id": 10174,
                    "description": "Mini Release",
                    "name": "1.5.1",
                    "userReleaseDate": "25\/Mar\/08",
                    "archived": true,
                    "releaseDate": "2008-03-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10270",
                    "id": 10270,
                    "name": "Zend_Layout",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/20521",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Assigning to Ralph for triage.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-03-28T14:21:32.000+0000",
                    "updated": "2008-03-28T14:21:32.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/20524",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jtai",
                        "name": "jtai",
                        "displayName": "Jonathan Tai",
                        "active": true
                    },
                    "body": "Also, if you add another action to TestController called \"viewscriptexception\" and a corresponding viewscriptexception.pthml that throws an exception, you get the same double-render issue.  \n\nThe way I understand it, here's what's happening.  The following assumes that the error handler, view renderer, and layout plugins are all active.\n\nZend_Controller_Front::dispatch() calls the Zend_Controller_Action::dispatch()\n\nZend_Controller_Action::dispatch() calls $this->$action(), which returns normally (no exception is thrown yet)\n\nZend_Controller_Action::dispatch() calls $this->_helper->notifyPostDispatch()\n\nThe layout helper gets notified first.  In Zend_Layout_Controller_Action_Helper_Layout::postDispatch(), $this->_isActionControllerSuccessful is set to true.\n\nThe viewrenderer helper gets notified next.  In Zend_Controller_Action_Helper_ViewRenderer::postDispatch(), $this->render() is called.  This is where the trouble begins - in Philip's example, the view script is not found (thus generating an exception); in my example, the view script is found but it throws an exception.\n\nControl now returns to the front controller (Zend_Controller_Front::dispatch()).  The exception is caught, and $this->_response->setExecption() is called.  Next, Zend_Controller_Front::dispatch() calls $this->_plugins->postDispatch().\n\nThe layout plugin is again notified first.  Zend_Layout_Controller_Plugin_Layout::postDispatch() runs, and since isActionControllerSuccessful was set to true earlier, it doesn't return early.  An empty layout is rendered.\n\nThe errorhandler is notified next.  Zend_Controller_Plugin_ErrorHandler::postDispatch() runs, sets a bunch of stuff, forwards to the error controllre, which renders again, causing the second layout and error content to be rendered.\n\n\n\nThe way I've found to band-aid over the issue is to apply the following patch:\n\n{code}\n--- library\/Zend\/Layout\/Controller\/Plugin\/Layout.php  Wed Mar 19 22:28:37 2008 -0700\n+++ library\/Zend\/Layout\/Controller\/Plugin\/Layout.php  Wed Mar 19 23:11:40 2008 -0700\n@@ -123,8 +123,14 @@\n             return;\n         }\n \n-        $response   = $this->getResponse();\n-        $content    = $response->getBody(true);\n+        $response = $this->getResponse();\n+\n+        \/\/ Return early if an exception was thrown, unless this is the error handler\n+        if ($response->isException() && !$request->getParam('error_handler')) {\n+            return;\n+        }\n+\n+        $content = $response->getBody(true);\n         $contentKey = $layout->getContentKey();\n \n         if (isset($content['default'])) {\n{code}\n\nThis causes the first run through Zend_Layout_Controller_Plugin_Layout::postDispatch() to return early, because the response already has its exception set, but no error handler has been set yet, since the error handler plugin has not yet run.  The second run through Zend_Layout_Controller_Plugin_Layout::postDispatch() renders the layout and the error content, as expected.  \n\nThere are two problems with this patch that are immediately obvious.  First, it doesn't take mvcSuccessfulActionOnly into account.  If mvcSuccessfulActionOnly is set to false, this patch will still cause the layout to not render the first time around.  Another problem is that the fix is hard-coded to detect behavior of the error handler plugin, which links the two classes together in a way that they probably shouldn't be linked.  In particular, if the error handler plugin was disabled, exceptions would never be rendered with a layout.  So this patch is not probably not ready to be applied as-is.  But I hope it illustrates the problem and makes getting to a real fix easier.\n\nFinally, I'd like to mention that the documentation for mvcSuccessfulActionOnly on http:\/\/framework.zend.com\/manual\/en\/zend.layout.options.html has a typo in it - \"flag\" is incorrectly spelled as \"flat\".",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jtai",
                        "name": "jtai",
                        "displayName": "Jonathan Tai",
                        "active": true
                    },
                    "created": "2008-03-29T03:14:30.000+0000",
                    "updated": "2008-03-29T03:14:30.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/21679",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Scheduling for next mini release",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-05-09T11:51:34.000+0000",
                    "updated": "2008-05-09T11:51:34.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23121",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "There is actually a simple fix for this you can put into your bootstrap file.  Before the call to use Zend_Layout::startMvc(\/* ... *\/); try explicitly added the ViewRenderer to the Broker.\n\nThe call would basically look like this:\n\n{code}\nZend_Controller_Action_HelperBroker::addHelper(new Zend_Controller_Action_Helper_ViewRenderer());\nZend_Layout::startMvc(array('layout' => 'default', 'layoutPath' => APPLICATION_PATH . '\/layouts\/'));\n{code}\n\nWhat this allows to happen is that the viewRenderer will run before the Layout action helper and will be able to detect if a view script exception had occured, thus affecting whether or not Zend_Layout can detect if there was a SuccessfulAction.\n\nThe real solution which I have been working on is implementing a better stack for the Zend_Controller_Action_HelperBroker.  This is turning out to be more than a few line fix, so I think it would be best to use the above workaround in 1.5.x and then I will introduce the HelperBroker_Stack in 1.6 as a new feature.\n\nHaving a proper stack will allow Zend_Controller to register the ViewRenderer at a specific predetermined location in the stack, and will also allow Zend_Layout to register its action helper at a predetermined location in the stack.  If both can go into known locations, we can ensure that the viewRenderer (And all other future action helpers - system or user), can be assured that they can run before the layout action helper thus - fixing the problem of \"unkown state regarding successful action controllers\".",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2008-07-26T12:42:06.000+0000",
                    "updated": "2008-07-26T12:42:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23122",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "Moving to next minor release at it includes a new feature.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2008-07-26T12:42:40.000+0000",
                    "updated": "2008-07-26T12:42:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23370",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "Fixed at r10734 in trunk.\nFixed at r10746 in release 1.6 branch.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2008-08-06T22:38:44.000+0000",
                    "updated": "2008-08-06T22:38:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/23988",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Updating for the 1.6.0 release.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-09-02T10:39:04.000+0000",
                    "updated": "2008-09-02T10:39:04.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2993\/transitions"
}