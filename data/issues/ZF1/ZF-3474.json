{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3474",
    "key": "ZF-3474",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Controller_Router_Route_Regex won't assemble when used with xml config"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3474\/votes",
                "votes": 3,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2008-10-30T18:12:03.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=naneau",
                "name": "naneau",
                "displayName": "Maurice Fonk",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-06-18T03:54:18.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-04-04T19:13:00.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When setting a reverse route through an xml config file, the assemble method of the regex route fails. The _getMappedValues method expects it's map to be in index => key form:\n\n{code}\n$index = (!is_int($key)) ? array_search($key, $this->_map, true) : $key;\n{code}\n\nthis will fail when used with xml, which doesn't support this, a sample config could contain:\n{code}\n<map>\n    <id>\n        1\n    <\/id>\n    <title>\n        2\n    <\/title>\n<\/map>\n{code}\n\nBy limitation of xml this is different from the ini config and manual setup. When parsing the url this isn't a problem, but the assemble method fails to get any parts from the  _getMappedValues method to parse into the query string and throws an exception. It can easily solved by modifying the method a little:\n\n{code}\n$index = (!is_int($key)) ? array_search($key, $this->_map, true) : $key;\nif (false !== $index) {\n\t$return[$index] = $values[$key];\n} elseif (isset($this->_map[$key])) {\n\t\/\/non-numerical setup\n\t$return[$key] = $this->_map[$key];\n}\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3474\/watchers",
                "isWatching": false,
                "watchCount": 4
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-5558",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5558",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-2312",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2312",
                    "type": {
                        "name": "Dependency",
                        "direction": "INBOUND",
                        "description": "is dependecy of"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10011",
                    "id": 10011,
                    "name": "Zend_Controller",
                    "description": "front controller, including router and dispatcher",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/22687",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=naneau",
                        "name": "naneau",
                        "displayName": "Maurice Fonk",
                        "active": true
                    },
                    "body": "Alternatively, a simple {code}array_flip($map){code} in the getInstance() method would do the trick too",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=naneau",
                        "name": "naneau",
                        "displayName": "Maurice Fonk",
                        "active": true
                    },
                    "created": "2008-06-30T05:27:40.000+0000",
                    "updated": "2008-06-30T05:27:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/25543",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Actually, the example shown here is missing the \"reverse\" URL format configuration option; without this, route assembly cannot happen. The reverse URL format was added as without it, assembling regex URLs was basically guesswork when complex regexen were used, and doing it entirely based on the map did not have consistent results. \n\nTo get your example working, simply provide a \"reverse\" URL format in your configuration, in printf format, such as the following:\n\n{code}\n<?xml version=\"1.0\"?>\n<configOptions>\n    <production>\n        <routes>\n            <archive>\n                <type>Zend_Controller_Router_Route_Regex<\/type>\n                <route>archive\/(\\d+)<\/route>\n                <defaults>\n                    <controller>archive<\/controller>\n                    <action>show<\/action>\n                <\/defaults>\n                <map>\n                    <year>1<\/year>\n                <\/map>\n                <reverse>archive\/%s<\/reverse>\n            <\/archive>\n        <\/routes>\n    <\/production>\n<\/configOptions>\n{code}\n\nThis is true even of INI configurations; the INI equivalent of the above looks like this:\n\n{code}\n[production]\nroutes.archive.type = \"Zend_Controller_Router_Route_Regex\"\nroutes.archive.route = \"archive\/(\\d+)\"\nroutes.archive.defaults.controller = \"archive\"\nroutes.archive.defaults.action = \"show\"\nroutes.archive.map.year = 1\nroutes.archive.reverse = \"archive\/%s\"\n{code}\n\nPlaceholders will be replaced with the value specified by the matching index from the map. In other words, if you pass a \"year\" value, that maps to the index \"1\", and will thus be passed as the first argument to vsprintf().\n\nAll of this is documented in the Regex route documentation: http:\/\/framework.zend.com\/manual\/en\/zend.controller.router.html#zend.controller.router.routes.regex\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-10-30T18:11:45.000+0000",
                    "updated": "2008-10-30T18:11:45.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33147",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=morex",
                        "name": "morex",
                        "displayName": "John",
                        "active": true
                    },
                    "body": "The problem still occurs in ZF1.9.\nI've written a little fix to allow the use of both mapping formats\n{code}\nroutes.archive.map.year = 1\n{code}\n\nand \n\n{code}\nroutes.archive.map.1 = year\n{code}\n \nto assemble an url. In according to the given example\n{code}\n#somewhere in a view\n\n<?= $this->url(array(\n        'controller' => 'archive',\n        'action'     => 'show',       \n        'year'       => 4\n    ), 'archive') ?>\n{code}\n\n{code}\n    public function __construct($route, $defaults = array(), $map = array(), $reverse = null)\n    {\n        $this->_regex    = $route;\n        $this->_defaults = (array) $defaults;\n        $this->_reverse  = $reverse; \n        $this->_setMap( (array) $map );\n    }\n\n    protected function _setMap(array $map)\n    {\n         $this->_map = array();\n\n         foreach($map as $key => $val)\n         {\n            if( is_int($key) ) {\n                $this->_map[$key] = $val;\n            } else {\n                $this->_map[$val] = $key;\n            }\n        }\n    }\n{code}\n\nI hope this \"bug\" will fixed one day officially.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=morex",
                        "name": "morex",
                        "displayName": "John",
                        "active": true
                    },
                    "created": "2009-08-03T02:57:19.000+0000",
                    "updated": "2009-08-03T02:57:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39801",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=448191",
                        "name": "448191",
                        "displayName": "John Kleijn",
                        "active": true
                    },
                    "body": "This issue still exists. Seems to be an issue with the difference in Zend_Config_Ini and Zend_Config_Xml, though.\r\n\r\nThis makes it impossible to use XML files for regex route config which really is a PITA cause INI files are not the best suited for high nesting levels.\r\n\r\nThis works:\r\n\r\nwidget_forwarder.type = Zend_Controller_Router_Route_Regex\r\nwidget_forwarder.reverse = widget\/%s\/%d\/%s\r\nwidget_forwarder.route = \"widget\/(.*)\/(.*)\/(.*)\"\r\nwidget_forwarder.defaults.module = system\r\nwidget_forwarder.defaults.controller = widgets\r\nwidget_forwarder.defaults.action = forward\r\nwidget_forwarder.map.type = 1\r\nwidget_forwarder.map.id = 2\r\nwidget_forwarder.map.params = 3\r\n\r\nThis is of course way too simple to warrant a regex route, but still. This fails:\r\n\r\n<widget_forwarder type=\"Zend_Controller_Router_Route_Regex\">\r\n\t<reverse>widget\/%s\/%d\/%s<\/reverse>\r\n\t<route>widget\/(.*)\/(.*)\/(.*)<\/route>\r\n\t<map>\r\n\t\t<type>1<\/type>\r\n\t\t<id>2<\/id>\r\n\t\t<params>3<\/params>\r\n\t<\/map>\r\n\t<defaults module=\"system\" controller=\"widgets\" action=\"forward\" \/>\r\n<\/widget_forwarder>\r\n\r\nUsing attributes (<map type=\"1\" etc) makes no difference, the result is always:\r\n\r\nPHPUnit 3.4.11 by Sebastian Bergmann.\r\n\r\n....................................E...\r\n\r\nTime: 1 second, Memory: 119.25Mb\r\n\r\nThere was 1 error:\r\n\r\n1) eyeopen_tests_controller_action_system_WidgetControllerTest::testCanForwardCommandFromWidget\r\nZend_Controller_Router_Exception: Cannot assemble. Too few arguments?\r\n\r\n\/usr\/share\/php\/Zend\/Controller\/Router\/Route\/Regex.php:196\r\n\/usr\/share\/php\/Zend\/Controller\/Router\/Rewrite.php:441\r\n\/usr\/share\/php\/Zend\/Controller\/Action\/Helper\/Url.php:99\r\n\r\nA dirty var_dump() reveals that the issue is exactly as described in this ticket.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=448191",
                        "name": "448191",
                        "displayName": "John Kleijn",
                        "active": true
                    },
                    "created": "2010-04-04T18:32:18.000+0000",
                    "updated": "2010-04-04T19:13:00.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3474\/transitions"
}