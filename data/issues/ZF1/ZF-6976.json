{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6976",
    "key": "ZF-6976",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Controller_Router_Route_Chain doesn't reset pathInfo in request"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6976\/votes",
                "votes": 5,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zooh",
                "name": "zooh",
                "displayName": "Edward Surov",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-06-10T07:50:14.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-01-19T15:07:20.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Let's suppose we're trying to match the following URL:\n\/part1\/part2\/part3a\nAnd we have the following chains:\npart1->part2->part3a\npart1->part2->part3b\n\nLast chain tries to match our URL and fails on the last part. Then first chain tries to match... but not the whole URL, because $request->getPathInfo() returns only part3a now!\nThe solution is to call $request->setPathInfo($path) before returning false from inside the foreach() that iterates the routes, not only after finishing the foreach().\n\nP.S.: I tried to avoid patching the ZF source by extending Zend_Controller_Router_Route_Chain with my custom class, but Zend_Controller_Router_Route_Abstract cannot be tuned to use my class in chain() method - it's hardcoded there."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6976\/watchers",
                "isWatching": false,
                "watchCount": 6
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12421",
                    "filename": "Chain.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zooh",
                        "name": "zooh",
                        "displayName": "Edward Surov",
                        "active": true
                    },
                    "created": "2009-11-23T16:21:16.000+0000",
                    "size": 626,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12421\/Chain.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10011",
                    "id": 10011,
                    "name": "Zend_Controller",
                    "description": "front controller, including router and dispatcher",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36443",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zooh",
                        "name": "zooh",
                        "displayName": "Edward Surov",
                        "active": true
                    },
                    "body": "Important notice: this bug occurs only if part3b route's getVersion() returns 2 or greater.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zooh",
                        "name": "zooh",
                        "displayName": "Edward Surov",
                        "active": true
                    },
                    "created": "2009-11-23T15:29:13.000+0000",
                    "updated": "2009-11-23T15:29:13.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36447",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zooh",
                        "name": "zooh",
                        "displayName": "Edward Surov",
                        "active": true
                    },
                    "body": "This patch solves the problem.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=zooh",
                        "name": "zooh",
                        "displayName": "Edward Surov",
                        "active": true
                    },
                    "created": "2009-11-23T16:21:19.000+0000",
                    "updated": "2009-11-23T16:21:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40819",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=petermoolenaar",
                        "name": "petermoolenaar",
                        "displayName": "Peter Moolenaar",
                        "active": true
                    },
                    "body": "I'm having the same issue... It affects (at least) version 1.10\r\n\r\nAlthough this patch does fix the problem related to the Chain route, the problem might be more related to modifying the Request_Http object.\r\nActually changing the Request_Http object to pass along some modifications seems to be a bit misplaced or am I missing something important??\r\n\r\nUsing the actual request object in a route (version 2) seems feasible, but it might not be when dealing with chained routes. Any thoughts?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=petermoolenaar",
                        "name": "petermoolenaar",
                        "displayName": "Peter Moolenaar",
                        "active": true
                    },
                    "created": "2010-06-01T06:19:21.000+0000",
                    "updated": "2010-06-01T06:19:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49534",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=k2s",
                        "name": "k2s",
                        "displayName": "Martin Minka",
                        "active": true
                    },
                    "body": "The provided patch solves the problem. The chain class is calling $request->setPathInfo($path) in case that it finds match, but it doesn't do it when not (places where return false; is calles).\r\n\r\nI am providing test where it is shown how evaluating route A is influencing route B evaluation.\r\n\r\nOutput of this test is:\r\n{code}\r\n1. test matches, path info=\/xxx\/too\r\nB route matches: yes\r\n2. test fails which is correct, path info=xxx\/too\r\nA route matches: no\r\n3. test fails which is wrong, reason is that the route A has change path info=too\r\nB route matches: no\r\nfinished.\r\n{code}\r\n\r\nSource:\r\n\r\n{code}\r\nrequire_once 'Zend\/Controller\/Router\/Rewrite.php';\r\nrequire_once 'Zend\/Controller\/Dispatcher\/Standard.php';\r\nrequire_once 'Zend\/Controller\/Router\/Route\/Chain.php';\r\nrequire_once 'Zend\/Controller\/Router\/Route.php';\r\nrequire_once 'Zend\/Controller\/Router\/Route\/Module.php';\r\nrequire_once 'Zend\/Controller\/Router\/Route\/Static.php';\r\nrequire_once 'Zend\/Controller\/Router\/Route\/Regex.php';\r\nrequire_once 'Zend\/Controller\/Router\/Route\/Hostname.php';\r\n\r\n\r\nrequire_once 'Zend\/Controller\/Request\/Http.php';\r\n\r\n$prefixRoute = new Zend_Controller_Router_Route('\/xxx\/');\r\n\r\n$_SERVER['HTTP_HOST'] = 'www.test.com';\r\n$request = new Zend_Controller_Request_Http(\"http:\/\/www.test.com\/xxx\/too\");\r\n\r\n$a = getRouteA($prefixRoute);\r\n$b = getRouteB($prefixRoute);\r\n\r\necho \"1. test matches, path info=\".$request->getPathInfo().PHP_EOL;\r\necho \"B route matches: \".($b->match($request) ? \"yes\" : \"no\").PHP_EOL;\r\necho \"2. test fails which is correct, path info=\".$request->getPathInfo().PHP_EOL;\r\necho \"A route matches: \".($a->match($request) ? \"yes\" : \"no\").PHP_EOL;\r\necho \"3. test fails which is wrong, reason is that the route A has change path info=\".$request->getPathInfo().PHP_EOL;\r\necho \"B route matches: \".($b->match($request) ? \"yes\" : \"no\").PHP_EOL;\r\ndie(\"finished.\");\r\n\r\n\/*** helpers ***\/\r\nfunction getRouter()\r\n{\r\n    $router = new Zend_Controller_Router_Rewrite();\r\n    $router->removeDefaultRoutes();\r\n    return $router;\r\n}\r\n\r\nfunction getRouteA($prefixRoute)\r\n{\r\n    $chain = new Zend_Controller_Router_Route_Chain();\r\n    $foo = new Zend_Controller_Router_Route_Hostname('www.zend.com', array('foo' => 1));\r\n    $bar = new Zend_Controller_Router_Route_Static('bar', array('bar' => 2));\r\n    $chain->chain($foo)->chain($bar);\r\n    return $prefixRoute->chain($chain);\r\n}\r\n\r\nfunction getRouteB($prefixRoute)\r\n{\r\n    $too = new Zend_Controller_Router_Route_Static('too', array('ok' => 1));\r\n    return $prefixRoute->chain($too);\r\n}\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=k2s",
                        "name": "k2s",
                        "displayName": "Martin Minka",
                        "active": true
                    },
                    "created": "2012-01-19T15:07:20.000+0000",
                    "updated": "2012-01-19T15:07:20.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6976\/transitions"
}