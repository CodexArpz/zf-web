{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7846",
    "key": "ZF-7846",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Add exception to describeTable() to identify missing metadata"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7846\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-11-20T20:53:29.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                "name": "rhunwicks",
                "displayName": "Roger Hunwicks",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-09-15T02:28:58.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T20:53:29.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "With Zend_Db_Table_Adapter_Oracle (and probably with the other adapters) it is possible for the SQL query used by describeTable() to work successfully, but return no data. For example, if the table does not exist, or the user does not have any privileges on the table then the query returns an empty array and describeTable() completes successfully.\n\nIf the database adapter cannot get any metadata successfully, then it is unlikely that the application is going to work correctly, even if all the necessary information is specified in the concrete Zend_Db_Table class, but the error will not be apparent immediately and will be harder to debug as a result.\n\nIn my case I was receiving: \n{noformat}Uncaught exception 'Zend_Db_Table_Exception' with message 'A table must have a primary key, but none was found' in \/usr\/local\/zend\/share\/ZendFramework\/library\/Zend\/Db\/Table\/Abstract.php:784{noformat}\n\nThe error message also includes no indication of which concrete class is causing the error. In my case it was because we had forgotten to grant SELECT privileges to the application user on the table in question.\n\nGiven that describeTable() is almost always used in conjunction with Zend_Db_Table, and that the Zend_Db_Table will likely fail if the database adapter can't work out the metadata, even if it isn't going to use it, I think that it would be better if describeTable() treated missing metadata as an exception. E.g. change\n{code}    public function describeTable($tableName, $schemaName = null)\n    {\n        <snip>\n        $stmt = $this->query($sql, $bind);\n\n        \/**\n         * Use FETCH_NUM so we are not dependent on the CASE attribute of the PDO connection\n         *\/\n        $result = $stmt->fetchAll(Zend_Db::FETCH_NUM);{code}\nto\n{code}    public function describeTable($tableName, $schemaName = null)\n    {\n        <snip>\n        $stmt = $this->query($sql, $bind);\n\n        \/**\n         * Use FETCH_NUM so we are not dependent on the CASE attribute of the PDO connection\n         *\/\n        $result = $stmt->fetchAll(Zend_Db::FETCH_NUM);\n        if ($result === array()) {\n            $table = $schemaName !== null ? $schemaName . '.' . $tableName : $tableName;\n            $message = 'Cannot identify columns or primary key for table ' . $table .\n                       '; check that the table exists and that privileges ' .\n                       'have been granted to user ' . $this->_config['username'];\n            throw new Zend_Db_Adapter_Oracle_Exception($message);\n        }{code}\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7846\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-7070",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7070",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10340",
                    "id": 10340,
                    "description": "Mini Release",
                    "name": "1.8.4",
                    "userReleaseDate": "23\/Jun\/09",
                    "archived": false,
                    "releaseDate": "2009-06-23",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10320",
                    "id": 10320,
                    "description": "Minor Release",
                    "name": "1.9.0",
                    "userReleaseDate": "31\/Jul\/09",
                    "archived": false,
                    "releaseDate": "2009-07-31",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10350",
                    "id": 10350,
                    "description": "Mini Release",
                    "name": "1.9.1",
                    "userReleaseDate": "11\/Aug\/09",
                    "archived": false,
                    "releaseDate": "2009-08-11",
                    "released": true
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10361",
                    "id": 10361,
                    "description": "Mini Release",
                    "name": "1.9.2",
                    "userReleaseDate": "25\/Aug\/09",
                    "archived": false,
                    "releaseDate": "2009-08-25",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10135",
                    "id": 10135,
                    "name": "Zend_Db_Adapter_Oracle",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34456",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "body": "This is a similar issue for Zend_Db_Adapter_Pdo_Pgsql. My solution would work for this issue to.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "created": "2009-09-15T02:32:58.000+0000",
                    "updated": "2009-09-15T02:32:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34459",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "body": "I have thought of one circumstance where describeTable() brings back an empty array, but that the application could work correctly anyway.\n\nIf the $_name for the table is actually a synonym, then the query will fail (because the table doesn't exist) but the application would continue to work correctly (assuming that the concrete Zend_Db_Table class has all the necessary metadata in it).\n\nI have thought of two fixes for this:\n\n# describeTable() tries to find a public or private synonym with that name and then re-executes the describe table, before raising the error. It would be better to do this only when the query returns no rows, rather than all the time, to avoid an unnecessary database query in the usual use case. I don't know if this error and\/or solution would apply to non-Oracle database adapters. \n# Expect the application developer to override Zend_Db_Table_Abstract::_setupMetadata() where it fails but the application developer knows the application will work anyway. This might be worth mentioning specifically in the user guide.\n\nThe synonym approach has the advantage that it saves the developer having to create the metadata manually for those tables. This code works for the synonym method:\n{code}\n        $result = $stmt->fetchAll(Zend_Db::FETCH_NUM);\n        \/\/ Raise an exception if the database adapter cannot find the table\n        \/\/ but check for a synonym first\n        if ($result === array()) {\n            $sql = \"SELECT TABLE_NAME, TABLE_OWNER\n                    FROM ALL_SYNONYMS\n                    WHERE SYNONYM_NAME = UPPER(:TBNAME)\";\n            $bind[':TBNAME'] = $tableName;\n            if ($schemaName) {\n                $sql .= ' AND OWNER = UPPER(:SCNAME)';\n                $bind[':SCNAME'] = $schemaName;\n            }\n            $stmt = $this->query($sql, $bind);\n            foreach ($stmt->fetchAll(Zend_Db::FETCH_NUM) as $synonym) {\n                $result = $this->describeTable($synonym[0], $synonym[1]);\n                if ($result !== array()) {\n                    break;\n                }\n            }\n        }\n        if ($result === array()) {\n        $table = $schemaName !== null ? $schemaName . '.' . $tableName : $tableName;\n            $message = 'Cannot identify columns or primary key for table ' . $table .\n                       '; check that the table exists and that privileges ' .\n                       'have been granted to user ' . $this->_config['username'];\n            throw new Zend_Db_Adapter_Oracle_Exception($message);\n\n        }\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rhunwicks",
                        "name": "rhunwicks",
                        "displayName": "Roger Hunwicks",
                        "active": true
                    },
                    "created": "2009-09-15T05:46:42.000+0000",
                    "updated": "2009-09-15T05:46:42.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35033",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ldean",
                        "name": "ldean",
                        "displayName": "Laura Dean",
                        "active": true
                    },
                    "body": "Well, I was looking for a way to check if a table exists in a certain database, and it looks like describeTable could do that now but not if this change goes in so I think I'll watch this issue and see what happens.  I suppose I could use listTables instead.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ldean",
                        "name": "ldean",
                        "displayName": "Laura Dean",
                        "active": true
                    },
                    "created": "2009-10-01T07:33:55.000+0000",
                    "updated": "2009-10-01T07:33:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/52810",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Bulk change of all issues last updated before 1st January 2010 as \"Won't Fix\".\r\n\r\nFeel free to re-open and provide a patch if you want to fix this issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-11-20T20:53:29.000+0000",
                    "updated": "2012-11-20T20:53:29.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7846\/transitions"
}