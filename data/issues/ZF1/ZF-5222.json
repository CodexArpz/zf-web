{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5222",
    "key": "ZF-5222",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Form::getValues() mishandles SubForms data when elementsBelongTo is set"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5222\/votes",
                "votes": 4,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/3",
                "name": "Duplicate"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2010-04-16T09:46:30.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=darkbluedove",
                "name": "darkbluedove",
                "displayName": "Vivek Chandran",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-12-11T19:53:15.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2010-04-16T09:46:51.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When setting elementsBelongTo for a Zend_Form_SubForm to either an empty value '' (isArray() == false) or to an array such as \"__children[Employees][Company][__ids][pk_33]\" these methods do not handle the arrays properly:\n\ngetValues()\ngetErrors()\ngetMessages()\n\n1.) Not all subforms are arrays, such as when elementsBelongTo is set empty.  This causes extra levels in the returned array structure due to calling _attachToArray() with empty $arrayPath.  Analogous calls to _dissolveArray() correctly check for isArray().\n\n2.) When collecting data recursively from subforms, only data from the last subform is kept because array_merge() overwrites array entries where the first key is the same among the subforms.  Note that array_merge() works for the simple case where just the subform name (or simple elementsBelongTo) is used for the value keys.  Using array_merge_recursive() instead of array_merge() fixes this bug when elementsBelongTo is set to a deeper array structure.\n\nFor example, sibling subforms may typically have elementsBelongTo set to common base arrays with only the last key differing:\n\n    __children[Employees][Company][__ids][pk_33]\n    __children[Employees][Company][__ids][pk_31]\n    __children[Employees][Company][__ids][pk_58]\n\n\nHere is a proposed patch:\n\n{noformat}\nIndex: Zend\/Form.php\n===================================================================\n--- Zend\/Form.php\t(revision 11917)\n+++ Zend\/Form.php\t(working copy)\n@@ -1282,8 +1282,20 @@\n             }\n         }\n         foreach ($this->getSubForms() as $key => $subForm) {\n-            $fValues = $this->_attachToArray($subForm->getValues(true), $subForm->getElementsBelongTo());\n-            $values = array_merge($values, $fValues);\n+            $fValues = $subForm->getValues(true);\n+            \n+            \/\/ Not all subForms are arrays, such as when elementsBelongTo is set empty\n+            if ($subForm->isArray()) {\n+                $fValues = $this->_attachToArray($fValues, $subForm->getElementsBelongTo());\n+            }\n+\n+            \/\/ Need to use array_merge_recursive() instead of array_merge() because\n+            \/\/ elementsBelongTo when set for sibling subForms may typically\n+            \/\/ have common base arrays; for example:\n+            \/\/     __children[Users][ManagementCompany][__ids][pk_33]\n+            \/\/     __children[Users][ManagementCompany][__ids][pk_31]\n+            \/\/     __children[Users][ManagementCompany][__ids][pk_58]\n+            $values = array_merge_recursive($values, $fValues);\n         }\n \n         if (!$suppressArrayNotation && $this->isArray()) {\n@@ -2208,8 +2220,20 @@\n                 $errors[$key] = $element->getErrors();\n             }\n             foreach ($this->getSubForms() as $key => $subForm) {\n-                $fErrors = $this->_attachToArray($subForm->getErrors(), $subForm->getElementsBelongTo());\n-                $errors = array_merge($errors, $fErrors);\n+                $fErrors = $subForm->getErrors();\n+                \n+                \/\/ Not all subForms are arrays, such as when elementsBelongTo is set empty\n+                if ($subForm->isArray()) {\n+                    $fErrors = $this->_attachToArray($fErrors, $subForm->getElementsBelongTo());\n+                }\n+\n+                \/\/ Need to use array_merge_recursive() instead of array_merge() because\n+                \/\/ elementsBelongTo when set for sibling subForms may typically\n+                \/\/ have common base arrays; for example:\n+                \/\/     __children[Users][ManagementCompany][__ids][pk_33]\n+                \/\/     __children[Users][ManagementCompany][__ids][pk_31]\n+                \/\/     __children[Users][ManagementCompany][__ids][pk_58]\n+                $errors = array_merge_recursive($errors, $fErrors);\n             }\n         }\n         return $errors;\n@@ -2261,8 +2285,18 @@\n             $fMessages = $subForm->getMessages(null, true);\n             if (!empty($fMessages)) {\n                 if (array_key_exists($key, $arrayKeys)) {\n-                    $fMessages = $this->_attachToArray($fMessages, $arrayKeys[$key]);\n-                    $messages = array_merge($messages, $fMessages);\n+                    \/\/ Not all subForms are arrays, such as when elementsBelongTo is set empty\n+                    if ($subForm->isArray()) {\n+                        $fMessages = $this->_attachToArray($fMessages, $arrayKeys[$key]);\n+                    }\n+\n+                    \/\/ Need to use array_merge_recursive() instead of array_merge() because\n+                    \/\/ elementsBelongTo when set for sibling subForms may typically\n+                    \/\/ have common base arrays; for example:\n+                    \/\/     __children[Users][ManagementCompany][__ids][pk_33]\n+                    \/\/     __children[Users][ManagementCompany][__ids][pk_31]\n+                    \/\/     __children[Users][ManagementCompany][__ids][pk_58]\n+                    $messages = array_merge_recursive($messages, $fMessages);\n                 } else {\n                     $messages[$key] = $fMessages;\n                 }\n{noformat}\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5222\/watchers",
                "isWatching": false,
                "watchCount": 6
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                "name": "alab",
                "displayName": "Christian Albrecht",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-9467",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9467",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-9584",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9584",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-9593",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9593",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-8078",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-8078",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10251",
                    "id": 10251,
                    "description": "Mini Release",
                    "name": "1.6.2",
                    "userReleaseDate": "13\/Oct\/08",
                    "archived": false,
                    "releaseDate": "2008-10-13",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10029",
                    "id": 10029,
                    "name": "Zend_Form",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39346",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "body": "getValues() is Fixed in [ZF-9584] and in [ZF-9586].",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "created": "2010-03-18T08:37:40.000+0000",
                    "updated": "2010-04-01T09:09:13.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39350",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "body": "getErrors Fixed in [ZF-9467]",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "created": "2010-03-18T10:24:24.000+0000",
                    "updated": "2010-04-01T04:36:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39547",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "body": "Reopened because suggested fix is not reviewed and committed yet.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "created": "2010-03-25T13:23:59.000+0000",
                    "updated": "2010-03-25T13:23:59.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39724",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "body": "getMessages Fixed in ZF-9593",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "created": "2010-04-02T00:56:03.000+0000",
                    "updated": "2010-04-02T00:56:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40050",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "body": "Resolving as duplicate of ZF-9584, ZF-9586, ZF-9467 and ZF-9593\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "created": "2010-04-16T09:46:30.000+0000",
                    "updated": "2010-04-16T09:46:51.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-5222\/transitions"
}