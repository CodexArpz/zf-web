{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6265",
    "key": "ZF-6265",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend Rest Result.php does not handle invalid XML properly - error handlers are ignored"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6265\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10360",
                    "id": 10360,
                    "description": "Minor Release",
                    "name": "1.10.0",
                    "userReleaseDate": "27\/Jan\/10",
                    "archived": false,
                    "releaseDate": "2010-01-27",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-11-14T04:24:25.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=jplush76",
                "name": "jplush76",
                "displayName": "Jim Plush",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-04-10T13:41:12.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-11-14T04:24:25.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "client",
                "error",
                "handler",
                "rest",
                "result",
                "simplexml"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "If you take a look at file Zend\/Rest\/Result.php you'll see in the __construct method the following code:\r\n\r\n{code}\r\n public function __construct($data)\r\n    {\r\n        set_error_handler(array($this, 'handleXmlErrors'));\r\n        $this->_sxml = simplexml_load_string($data);\r\n        if($this->_sxml === false) {\r\n            $this->handleXmlErrors(0, \"An error occured while parsing the REST response with simplexml.\");\r\n        } else {\r\n            restore_error_handler();\r\n        }\r\n    }\r\n{code}\r\n\r\nyou're setting the error handler to use \"handleXmlErrors\" which in that method it attempts to restore the error handler and throw an exception. If you take a look at the php docs http:\/\/us.php.net\/restore_error_handler \r\nyou'll see the NOTE: Note: Calling restore_error_handler() from the error_handler function is ignored. \r\n\r\nWhich means once the error occurs it jumps into handleXmlErrors and the restore called is ignored and when the exception is thrown execution stops at the simplexml_load_string line and is passed backed to the caller. The restoration of the error handler never occurs. To work around I had to restore the error handler in my controller in the \"catch\" section of my try catch .\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/customFieldOption\/10037",
                "value": "   Must Have"
            }
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6265\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                "name": "satoruyoshida",
                "displayName": "Satoru Yoshida",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10300",
                    "id": 10300,
                    "description": "Mini Release",
                    "name": "1.7.8",
                    "userReleaseDate": "30\/Mar\/09",
                    "archived": false,
                    "releaseDate": "2009-03-30",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10094",
                    "id": 10094,
                    "name": "Zend_Rest_Client",
                    "description": "Client for executing Rest requests.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32556",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alpeb",
                        "name": "alpeb",
                        "displayName": "Alejandro Pedraza",
                        "active": true
                    },
                    "body": "I've stumbled across this one as well. Something like the following patch could fix it, but for some reason the error string that I store in $this->_errstr gets chopped after leaving the error handler function:\n\n{noformat}\nIndex: Result.php\n===================================================================\n--- Result.php\t(revision 16697)\n+++ Result.php\t(working copy)\n@@ -32,6 +32,8 @@\n      *\/\n     protected $_sxml;\n \n+    private $_errstr = false;\n+\n     \/**\n      * Constructor\n      *\n@@ -42,10 +44,14 @@\n     {\n         set_error_handler(array($this, 'handleXmlErrors'));\n         $this->_sxml = simplexml_load_string($data);\n+        restore_error_handler();\n         if($this->_sxml === false) {\n-            $this->handleXmlErrors(0, \"An error occured while parsing the REST response with simplexml.\");\n-        } else {\n-            restore_error_handler();\n+            require_once \"Zend\/Rest\/Client\/Result\/Exception.php\";\n+            if (isset($this->_errstr)) {\n+                throw new Zend_Rest_Client_Result_Exception(\"REST Response Error: \".$this->_errstr);\n+            } else {\n+                throw new Zend_Rest_Client_Result_Exception(\"An error occured while parsing the REST response with simplexml.\");\n+            }\n         }\n     }\n \n@@ -57,13 +63,10 @@\n      * @param string $errfile\n      * @param string $errline\n      * @param array  $errcontext\n-     * @throws Zend_Result_Client_Result_Exception\n      *\/\n     public function handleXmlErrors($errno, $errstr, $errfile = null, $errline = null, array $errcontext = null)\n     {\n-        restore_error_handler();\n-        require_once \"Zend\/Rest\/Client\/Result\/Exception.php\";\n-        throw new Zend_Rest_Client_Result_Exception(\"REST Response Error: \".$errstr);\n+        $this->_errstr = $errstr;\n     }\n \n     \/**\n{noformat}\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alpeb",
                        "name": "alpeb",
                        "displayName": "Alejandro Pedraza",
                        "active": true
                    },
                    "created": "2009-07-14T06:12:37.000+0000",
                    "updated": "2009-07-14T06:12:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36006",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                        "name": "satoruyoshida",
                        "displayName": "Satoru Yoshida",
                        "active": true
                    },
                    "body": "Solved in SVN r18973.\r\n\r\nI think it could be next mini release if the handleXmlErrors() would be private.\r\n\r\nBut now it should be next minor to avoid BC problem, I think.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                        "name": "satoruyoshida",
                        "displayName": "Satoru Yoshida",
                        "active": true
                    },
                    "created": "2009-11-14T04:24:25.000+0000",
                    "updated": "2009-11-14T04:24:25.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6265\/transitions"
}