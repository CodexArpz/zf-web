{
    "expand": "html",
    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-853",
    "key": "ZF-853",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "MS SQL Server:  limit() function does not behave as expected when no order is applied"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField",
            "value": {
                "timeoriginalestimate": 2880,
                "timeestimate": 2880
            }
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-853\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/version\/10361",
                    "id": 10361,
                    "description": "Mini Release",
                    "name": "1.9.2",
                    "userReleaseDate": "25\/Aug\/09",
                    "archived": false,
                    "releaseDate": "2009-08-25",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-08-25T20:50:52.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=jayson",
                "name": "jayson",
                "displayName": "Jayson Minard",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-02-05T03:49:03.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-08-25T20:50:51.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "mssql"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "(!) The approach of having the adapter help limit the query makes it much more difficult to accomplish, and it might be better for items like the select class to have adapter specific construction of queries.  People writing their own queries will unlikely call the limit method directly, so only auto-generated queries will need it.  Therefore make the query building smarter rather than trying to make the limit() function so smart.\n\n*The MS SQL Server limit() function in class  Zend_Db_Adapter_Pdo_Mssql is not correct.*\n\nFor example, it takes the source query: \n\n{code}\nselect * from HumanResources.Employee emp;\n{code}\n\nand with a limit applied of 10 count records at offset 5 generates:\n\n{code}\nSELECT * FROM (SELECT TOP 10 * FROM (SELECT TOP 15 * from HumanResources.Employee emp) AS inner_tbl) AS outer_tbl\n{code}\n\nIn effect the generated query selects the first 10 rows rather than the 5th-15th.  To break it down, the inner most query returns the top 15 rows, then the next outer takes those top 15 and grabs the top 10 which makes the most inner query meaningless.\n\nThis is due to the fact that the system relies on the \"order by\" clause of the query to get the records it wants and without the clause being present it does not add one (what would it order by anyway?)\n\n(!) If it can't handle a query that does not have \"order by\" and it is deemed that limit() only works with ordered queries, then an exception should be thrown indicating the query is invalid just as the other parameters are checked at the top of the method.\n\nAlso, *for SQL Server 2005* the best approach for paging like this is (which really should be special cased since it is a special feature just for this purpose):\n\n{code}\nSELECT * FROM\n(SELECT ROW_NUMBER() OVER (ORDER BY EmployeeID) AS rnum, * FROM HumanResources.Employee) AS EmpWithRNUM\nwhere rnum >= 5 and rnum <= 15\n{code}\n\n*For older versions or cases where you have no known \"order by\"*, the best way is really to use temporary tables or one of the other odd paging choices.  \n\nYou can try this style if you know the primary key.  This version does anti-joins with index scans while the original version (as implemented) causes 2 sorts followed by an index scan.\n\n{code}\nselect top 15 * from HumanResources.Employee emp\nwhere emp.EmployeeID not in (select top 5 emp2.EmployeeID from HumanResources.Employee emp2)\n{code}\n\n(!) Other things this limit() function breaks on is \"union\" queries and possibly other queries where it will place an accidental \"order by\" into the wrong place.\n\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/priority\/6",
                "name": "N\/A"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-853\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-4099",
                    "issue": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4099",
                    "type": {
                        "name": "Related",
                        "direction": "OUTBOUND",
                        "description": "is related to"
                    }
                },
                {
                    "issueKey": "ZF-1037",
                    "issue": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1037",
                    "type": {
                        "name": "Duplicate",
                        "direction": "INBOUND",
                        "description": "is duplicated by"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/version\/10020",
                    "id": 10020,
                    "description": "Preview Release; I18N, Acl, Auth, Session",
                    "name": "0.7.0",
                    "userReleaseDate": "18\/Jan\/07",
                    "archived": true,
                    "releaseDate": "2007-01-18",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/17362",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "body": "As possible pre-solution we should just add an paragraph to the documentation describing problems without orderby with MSSQL adapter.",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                        "name": "thomas",
                        "displayName": "Thomas Weidner",
                        "active": true
                    },
                    "created": "2007-10-30T15:17:22.000+0000",
                    "updated": "2007-10-30T15:17:22.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/18049",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=snover",
                        "name": "snover",
                        "displayName": "C Snover",
                        "active": true
                    },
                    "body": "The limit function also does not work if you are sorting by multiple columns. This change I've made seems to work okay but there might be a way to make it more efficient:\n\n{code}\n     public function limit($sql, $count, $offset = 0)\n     {\n        $count = intval($count);\n        if ($count <= 0) {\n            \/** @see Zend_Db_Adapter_Exception *\/\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument count=$count is not valid\");\n        }\n\n        $offset = intval($offset);\n        if ($offset < 0) {\n            \/** @see Zend_Db_Adapter_Exception *\/\n            require_once 'Zend\/Db\/Adapter\/Exception.php';\n            throw new Zend_Db_Adapter_Exception(\"LIMIT argument offset=$offset is not valid\");\n        }\n\n        $orderby = stristr($sql, 'ORDER BY');\n        if ($orderby !== false) {\n            $order = str_ireplace('ORDER BY', '', $orderby);\n        }\n\n        $sql = preg_replace('\/^SELECT\\s\/i', 'SELECT TOP ' . ($count+$offset) . ' ', $sql);\n\n        $sql = 'SELECT * FROM (SELECT TOP ' . $count . ' * FROM (' . $sql . ') AS inner_tbl';\n        if ($orderby !== false) {\n            $sql .= ' ORDER BY ';\n            \/\/ PHP doesn't avoid re-replacing strings when you pass an array\n            \/\/ to its string replacement functions, so add junk that doesn't match\n            \/\/ the original regular expression and then run an extra pass\n            $outer_order = preg_replace(array('\/\\bASC\\b\/', '\/\\bDESC\\b\/'), array('_DESC', '_ASC'), $order);\n            $outer_order = str_replace(array('_DESC', '_ASC'), array('DESC', 'ASC'), $outer_order);\n            $sql .= $outer_order . ' ';\n        }\n        $sql .= ') AS outer_tbl';\n        if ($orderby !== false) {\n            $sql .= ' ORDER BY ' . $order;\n        }\n\n        return $sql;\n    }\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=snover",
                        "name": "snover",
                        "displayName": "C Snover",
                        "active": true
                    },
                    "created": "2007-12-24T22:11:42.000+0000",
                    "updated": "2007-12-24T22:11:42.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/18050",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=snover",
                        "name": "snover",
                        "displayName": "C Snover",
                        "active": true
                    },
                    "body": "Whoops. And those definitely should be case-insensitive regular expressions.\n{code}$outer_order = preg_replace(array('\/\\bASC\\b\/i', '\/\\bDESC\\b\/i'), array('_DESC', '_ASC'), $order);{code}\nnot\n{code}$outer_order = preg_replace(array('\/\\bASC\\b\/', '\/\\bDESC\\b\/'), array('_DESC', '_ASC'), $order);{code}",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=snover",
                        "name": "snover",
                        "displayName": "C Snover",
                        "active": true
                    },
                    "created": "2007-12-24T22:13:50.000+0000",
                    "updated": "2007-12-24T22:13:50.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/20084",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "This issue should have been fixed for the 1.5 release.",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-03-21T17:05:29.000+0000",
                    "updated": "2008-03-21T17:05:29.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/20340",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Please categorize\/fix as needed.",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-03-25T20:43:57.000+0000",
                    "updated": "2008-03-25T20:43:57.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/21031",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "This doesn't appear to have been fixed in 1.5.0. Please update if this is not correct.",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-04-18T13:12:02.000+0000",
                    "updated": "2008-04-18T13:12:02.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/27024",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "body": "All three are concern ORDER BY behavior in limit() method",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=nix0n",
                        "name": "nix0n",
                        "displayName": "Adam VanBerlo",
                        "active": true
                    },
                    "created": "2008-12-04T15:18:33.000+0000",
                    "updated": "2008-12-04T15:18:33.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/27932",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "I will attempt to test this issue within 2 weeks.",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-01-09T13:30:52.000+0000",
                    "updated": "2009-01-09T13:30:52.000+0000"
                },
                {
                    "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/comment\/33928",
                    "author": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "Fixed in 1.9.2 with ms sql limit() updates",
                    "updateAuthor": {
                        "self": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-08-25T20:50:51.000+0000",
                    "updated": "2009-08-25T20:50:51.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/framework.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-853\/transitions"
}