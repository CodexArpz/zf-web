{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7853",
    "key": "ZF-7853",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Problem with highlightMatches() function"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7853\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-11-20T20:52:42.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                "name": "junglefish",
                "displayName": "Michael Casey",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-09-16T00:55:32.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T20:52:42.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Html",
                "highlightMatches",
                "search-lucene"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Specific example of error follows:\n\nI have a .pptx document that contains this text string: \"... Data Protection Module Karen Brown, DPO Johnny McSweeney ...\". The document appears to be indexed correctly.\n\nUsing both quoted and un-quoted strings, if I do a search for \"Karen\" or \"Karen Brown\", the results come back fine, and using the highlightMatches() function, the keywords are highlighted. However, if I do a search for \"Module Karen Brown\" I get the following error:\n\n[Notice] Trying to get property of non-object\nPOST \/SilverStripe\/search-lucene\/\n\nLine 293 in D:\\wamp\\www\\ZendFramework-1.9.1\\library\\Zend\\Search\\Lucene\\Document\\Html.php\nSource\n\n284  foreach ($matchedTokens as $token) {\n285      \/\/ Cut text after matched token\n286      $node->splitText($token->getEndOffset());\n287\n288       \/\/ Cut matched node\n289      $matchedWordNode = $node->splitText($token->getStartOffset());\n290\n291      \/\/ Retrieve HTML string representation for highlihted word\n292       $fullCallbackparamsList = $params;\n293      array_unshift($fullCallbackparamsList, $matchedWordNode->nodeValue);\n294      $highlightedWordNodeSetHtml = call_user_func_array($callback, $fullCallbackparamsList);\n295\n296      \/\/ Transform HTML string to a DOM representation and automatically transform retrieved string\n297      \/\/ into valid XHTML (It's automatically done by loadHTML() method)\n298      $highlightedWordNodeSetDomDocument = new DOMDocument('1.0', 'UTF-8');\n299      $success = @$highlightedWordNodeSetDomDocument->\n\n\nMy totally stripped down output code looks a bit like this:\n\nforeach ($results as $result) {\n   $myVar = $query->highlightMatches($result->body);\n   echo $myVar;\n}\n\nIf I alter: $myVar = $query->highlightMatches($result->body);\nto: $myVar = $result->body;\nthe error no longer occurs, but of course, the keywords are no longer highlighted.\n\nThis is just one specific example, but I get similar difficulties with .xlsx and .docx documents, and random combinations of search terms.\n\nInterestingly, I don't get the same problem with documents created from database queries.\n\n\n(NB. I originally sent this issue to Maarten Balliauw, who suggested I submit it to the Issue Tracker as it affects multiple lucene modules.) \n\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7853\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12284",
                    "filename": "EDPS presentation redacted.pptx",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-05T07:19:19.000+0000",
                    "size": 23540,
                    "mimeType": "application\/vnd.openxmlformats-officedocument.presentationml.presentation",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12284\/EDPS+presentation+redacted.pptx"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10350",
                    "id": 10350,
                    "description": "Mini Release",
                    "name": "1.9.1",
                    "userReleaseDate": "11\/Aug\/09",
                    "archived": false,
                    "releaseDate": "2009-08-11",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35071",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "My first idea was that it's utf-8 processing related problem (DOMText::splitText() method needs binary offset instead of character offset), but it was wrong. I think I have found and fixed problem, so it will be commited soon.\nBTW could you prepare test document and attach it to the issue?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2009-10-05T06:47:01.000+0000",
                    "updated": "2009-10-05T06:47:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35073",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "Hi Alexander\n\nI can't unfortunately give you the *actual* document as it's confidential to the business of this office. Instead, I've prepared a very cut-down single page version of the same document, which contains the bits that were giving me problems. I hope that's enough to be getting on with.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-05T07:17:56.000+0000",
                    "updated": "2009-10-05T07:17:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35074",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "Cut-down version of test file.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-05T07:19:23.000+0000",
                    "updated": "2009-10-05T07:19:23.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35077",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "body": "Michael, I've tried document you attached to the issue and haven't got a error.\n\nCould you give a ZF version number you use now? Similar problem was fixed earlier.\n\nSecond question is a way you get $query. Does it only:\n{code}\n$query = Zend_Search_Lucene_Search_QueryParser::parse('Module Karen Brown');\n{code}\n???\n\nBTW My test code:\n{code}\n$doc = Zend_Search_Lucene_Document_Pptx::loadPptxFile($pathToTestPptxFile, true);\n\n$index = Zend_Search_Lucene::create('index');\n$index->addDocument($doc);\n\n$query = Zend_Search_Lucene_Search_QueryParser::parse('Module Karen Brown');\n\n$results = $index->find($query);\nforeach ($results as $result) { $myVar = $query->highlightMatches($result->body); echo $myVar; }\n{code}\n\nMoreover, this code may be reduced to the following:\n{code}\n$doc = Zend_Search_Lucene_Document_Pptx::loadPptxFile($pathToTestPptxFile, true);\n$query = Zend_Search_Lucene_Search_QueryParser::parse('Module Karen Brown');\nvar_dump($query->highlightMatches($doc->body));\n{code}\n\nPlease try it in your environment.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                        "name": "alexander",
                        "displayName": "Alexander Veremyev",
                        "active": true
                    },
                    "created": "2009-10-05T09:55:44.000+0000",
                    "updated": "2009-10-05T09:55:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35119",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "Hi Alexander\n\nAm using: ZendFramework-1.9.1\n\nMy indexing code looks like this:\n\n$doc = Zend_Search_Lucene_Document_Pptx::loadPptxFile($doc_filenameandpath, true);\n$doc->addField(Zend_Search_Lucene_Field::Keyword('key', $doc_filename));\n... other addFields()...\n$index->addDocument($doc);\n\nMy search code looks like this:\n(note that $searchString would contain, in this example, 'Module Karen Brown' or 'Karen Brown', etc)\n\n$userQuery = Zend_Search_Lucene_Search_QueryParser::parse($searchString);\n$query = new Zend_Search_Lucene_Search_Query_Boolean(); \n$query->addSubquery($userQuery, true); \n$index = Zend_Search_Lucene::open($pathToIndexes . $indexName . '\\\\');  \n$results = $index->find($query);  \n\nThe major difference appears to be that I pass the string into Zend_Search_Lucene_Search_QueryParser and then pass that into Zend_Search_Lucene_Search_Query_Boolean(). You are doing it all in one step. \n\nI'll convert my code to look more like yours, but do you think this is significant when we're talking about highlightMatches()?\n\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-08T05:29:18.000+0000",
                    "updated": "2009-10-08T05:29:18.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35126",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "Alexander\n\nNope, it's just the same.\n\nIf I condense my original three lines:\n\n\t$userQuery = Zend_Search_Lucene_Search_QueryParser::parse($searchString);\n\t$query = new Zend_Search_Lucene_Search_Query_Boolean(); \n\t$query->addSubquery($userQuery, true \/* required *\/); \n\nto this single line:\n\n\t$query = Zend_Search_Lucene_Search_QueryParser::parse($searchString);\n\nI get exactly the same error in exactly the same circumstances.\n\nm\\",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-08T08:09:41.000+0000",
                    "updated": "2009-10-08T08:09:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35131",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "Could it actually be the word \"Module\" that is causing the problem? Is it some kind of reserved word..?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-09T00:31:13.000+0000",
                    "updated": "2009-10-09T00:31:13.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35132",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "I mentioned that because:\n\n\"Modul Karen Brown\" does not cause the error,\n\"Module aren Brown\" does cause the error.\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-09T00:33:44.000+0000",
                    "updated": "2009-10-09T00:33:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35210",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "body": "Hi Alexander\n\nThis issue is no longer an issue :-)\n\nI moved the application I was building to a new server, ready for its official release. On the new server, this problem has entirely disappeared! \n\nWhat is strange is that I'm using the same code, which has simply been copied across, and I'm even using the same test file! The only difference is in the server infrastructure (one was an XP workstation and the other is a Windows 2003 server) and I'm fairly certain that can't have been the issue.\n\nBut anyway, as it appears you can't replicate the issue, and it's no longer a concern for me, I guess I'm happy for the issue to be closed.\n\nThanks for your help.\n\nm\\",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=junglefish",
                        "name": "junglefish",
                        "displayName": "Michael Casey",
                        "active": true
                    },
                    "created": "2009-10-14T06:27:16.000+0000",
                    "updated": "2009-10-14T06:27:16.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/52416",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "body": "Bulk change of all issues last updated before 1st January 2010 as \"Won't Fix\".\r\n\r\nFeel free to re-open and provide a patch if you want to fix this issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=rob",
                        "name": "rob",
                        "displayName": "Rob Allen",
                        "active": true
                    },
                    "created": "2012-11-20T20:52:42.000+0000",
                    "updated": "2012-11-20T20:52:42.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7853\/transitions"
}