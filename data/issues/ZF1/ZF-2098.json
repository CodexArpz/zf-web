{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2098",
    "key": "ZF-2098",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Problem with Content-Length value using raw POST data with mbstring extension"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2098\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10320",
                    "id": 10320,
                    "description": "Minor Release",
                    "name": "1.9.0",
                    "userReleaseDate": "31\/Jul\/09",
                    "archived": false,
                    "releaseDate": "2009-07-31",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-07-24T11:24:42.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bdeshong",
                "name": "bdeshong",
                "displayName": "Brian DeShong",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-10-24T15:36:53.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-11-17T20:52:37.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When using Zend_Http_Client to POST raw data, the strlen() function is called to determine the value for the Content-length header.  However, when using the mbstring extension and overriding the string functions (mbstring.func_overload = 4), the strlen() call (which is overridden using mb_strlen()) must be made with the second argument of \"ASCII\".  With string functions overridden by mbstring, the byte count of the raw POST data is less than its actual size as multibyte characters will be counted a single character.\r\n\r\nThe patch below corrects the problem by performing an ini_get() and checking the value to see if the bit for string function overriding is set.  If it is, the Content-length will be set accordingly by calling $this->setHeaders('content-length', strlen($this->raw_post_data, 'ASCII'));.\r\n\r\nThis patch was generated against trunk as of 10\/24\/2007.\r\n\r\n{code}\r\n--- library\/Zend\/Http\/Client.php    (revision 6682)\r\n+++ library\/Zend\/Http\/Client.php    (working copy)\r\n@@ -913,7 +913,15 @@\r\n\r\n         \/\/ If we have raw_post_data set, just use it as the body.\r\n         if (isset($this->raw_post_data)) {\r\n-            $this->setHeaders('Content-length', strlen($this->raw_post_data));\r\n+            \/\/ If user is not overriding string functions with mbstring, the\r\n+            \/\/ call to strlen() with the data is sufficient.  Otherwise,\r\n+            \/\/ ensure that we have the ASCII byte count for the POST data.\r\n+            if (!ini_get('mbstring.func_overload') & 4) {\r\n+                $this->setHeaders('content-length', strlen($this->raw_post_data));\r\n+            } else {\r\n+                $this->setHeaders('content-length', strlen($this->raw_post_data, 'ASCII'));\r\n+             }\r\n+\r\n             return $this->raw_post_data;\r\n         }\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2098\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                "name": "shahar",
                "displayName": "Shahar Evron",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-6218",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6218",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10015",
                    "id": 10015,
                    "name": "Zend_Http_Client",
                    "description": "performs HTTP requests",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/20268",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "body": "Please categorize\/fix as needed.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wil",
                        "name": "wil",
                        "displayName": "Wil Sinclair",
                        "active": true
                    },
                    "created": "2008-03-25T20:37:21.000+0000",
                    "updated": "2008-03-25T20:37:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26420",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beberlei",
                        "name": "beberlei",
                        "displayName": "Benjamin Eberlei",
                        "active": true
                    },
                    "body": "First: the bitmask is 2 for str functions not 4.\n\nSecond, I cannot reproduce this issue, either with a setting in php.ini oder with ini_set. my testcase looks as following:\n\nThis is added into Zend_Http_Client_TestAdapterTest.\n\n{code}    \/**\n     * Tests that overriding strlen with mb_strlen via php.ini option is recognized.\n     *\n     * @group ZF-2098\n     *\/\n    public function testStrlenFunctionOverrideByMbstringIsRecognized()\n    {\n        $client = new Zend_Http_Client('http:\/\/example.com', array('adapter' => $this->adapter));\n        $string = \"asdf\u00f6\u00e4\u00fc\u20ac\";\n\n        $previousSetting = ini_get(\"mbstring.func_overload\");\n\n        ini_set(\"mbstring.func_overload\", 0);\n        $client->setRawData($string);\n        $client->request(\"POST\");\n\n        echo $client->getLastRequest();\n\n        ini_set(\"mbstring.func_overload\", 2);\n        $client->setRawData($string);\n        $client->request(\"POST\");\n\n        echo $client->getLastRequest();\n    }{code}\n\nany additional feedback or a fixed testsuite?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beberlei",
                        "name": "beberlei",
                        "displayName": "Benjamin Eberlei",
                        "active": true
                    },
                    "created": "2008-11-15T10:02:50.000+0000",
                    "updated": "2008-11-15T10:02:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26428",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bdeshong",
                        "name": "bdeshong",
                        "displayName": "Brian DeShong",
                        "active": true
                    },
                    "body": "A thread was started on the forums about this bug about a year ago:\n\nhttp:\/\/www.nabble.com\/Utility-functions:-Calculating-binary-string-length-td13431218.html\n\n\nI'm looking to try and reproduce it again. The particular use case I was running into was when POSTing the raw contents of a binary file to a virus scanning HTTP service.\n\nIn that case, if the file was, say, 500 bytes, the Content-Length header was being set to less than 500 bytes because certain multi-byte characters were being counted as 1 byte instead of 2.\n\nI'm taking a look into this now to try to reproduce.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bdeshong",
                        "name": "bdeshong",
                        "displayName": "Brian DeShong",
                        "active": true
                    },
                    "created": "2008-11-15T14:56:44.000+0000",
                    "updated": "2008-11-15T14:56:44.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26429",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bdeshong",
                        "name": "bdeshong",
                        "displayName": "Brian DeShong",
                        "active": true
                    },
                    "body": "I was able to reproduce this using an older version of Zend Framework and 1.6.2 on a RHEL4 machine.\n\nMy file is 19,620 bytes on disk.  $string is the value of file_get_contents() for the file on disk.  In this case, I've got mbstring.func_overload set to 6.\n\nprint \"ASCII strlen = \" . strlen($string) . \"\\n\";\nprint \"mb strlen = \" . mb_strlen($string) . \"\\n\";\nprint \"mb strlen ASCII = \" . mb_strlen($string, 'ASCII') . \"\\n\";\n\n\n...yields:\n\nASCII strlen = 13389\nmb strlen = 13389\nmb strlen ASCII = 19620\n\n\n...which means that Content-Length is being set to 13,389 bytes in the HTTP request:\n\nPOST \/ HTTP\/1.1\nHost: localhost\nConnection: close\nAccept-encoding: gzip, deflate\nContent-Type: application\/x-www-form-urlencoded\nUser-Agent: Zend_Http_Client\nContent-Length: 13389\n\nThis is using PHP 5.2.2.  Note that I was NOT able to reproduce this on my Mac running Leopard and PHP 5.2.6, which is surprising.\n\nHope this helps!  Sorry, though, it's been quite some time since I've looked into this issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bdeshong",
                        "name": "bdeshong",
                        "displayName": "Brian DeShong",
                        "active": true
                    },
                    "created": "2008-11-15T15:28:37.000+0000",
                    "updated": "2008-11-15T15:28:37.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26440",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "body": "I was able to reproduce and create some tests for this, and it seem to depend on the current locale. I will try to share some tests and perhaps some fix code later this week.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "created": "2008-11-17T10:15:41.000+0000",
                    "updated": "2008-11-17T10:15:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32909",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "body": "Surprisingly, I actually fixed this in rev. 17041.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=shahar",
                        "name": "shahar",
                        "displayName": "Shahar Evron",
                        "active": true
                    },
                    "created": "2009-07-24T11:24:38.000+0000",
                    "updated": "2009-07-24T11:24:38.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/36074",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                        "name": "satoruyoshida",
                        "displayName": "Satoru Yoshida",
                        "active": true
                    },
                    "body": "I set fix version. I find this at SVN r17118 in 1.9 branch.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=satoruyoshida",
                        "name": "satoruyoshida",
                        "displayName": "Satoru Yoshida",
                        "active": true
                    },
                    "created": "2009-11-17T20:52:37.000+0000",
                    "updated": "2009-11-17T20:52:37.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-2098\/transitions"
}