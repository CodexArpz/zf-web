{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4790",
    "key": "ZF-4790",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Limit() for DB2"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/12",
                "name": "Coding Standards Violation",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4790\/votes",
                "votes": 4,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos@gmail.com",
                "name": "maitrepylos@gmail.com",
                "displayName": "Ernaelsten G\u00e9rard",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-11-04T04:19:00.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-05-13T15:17:05.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hello,\nThe ROW_NUMBER() OVER(), is a select with random order. To avoid this, you must define an \"ORDER BY\" clause in the OVER().\n\nSee the official IBM documentation : \n\nROW_NUMBER specifies that a sequential row number is computed for the row that is defined by the ordering, starting with 1 for the first row. If the ORDER BY clause is not specified in the window, the row numbers are assigned to the rows in an arbitrary order, as the rows are returned (but not according to any ORDER BY clause in the select-statement). You can use ROW_NUMBER to number the result rows of a query. Row numbers also enable easy formulation of queries for computing histogram statistics (quantile computations), and they enable formation of other OLAP specifications (for example, moving sums, moving averages, and so on). \n\n{code:title=Issue Zend_Db_Adapter_Db2|borderStyle=solid}\n    function limit  ($sql, $count, $offset = 0){\n...... \n       $limit_sql = \"SELECT z2.*\n            FROM (\n                SELECT ROW_NUMBER() OVER() AS \\\"ZEND_DB_ROWNUM\\\", z1.*\n                FROM (\n                    \" . $sql . \"\n                ) z1\n            ) z2\n            WHERE z2.zend_db_rownum BETWEEN \" . ($offset+1) . \" AND \" . ($offset+$count);\n        return $limit_sql;\n\n\n{code}\n\n{code:title=Proposed Solution|borderStyle=solid}\n  function limit  ($sql, $count, $offset = 0,$attribut,$order='ASC'){\n...... \n       $limit_sql = \"SELECT z2.*\n            FROM (\n                SELECT ROW_NUMBER() OVER(\". $attribut .\" \". $order .\") AS \\\"ZEND_DB_ROWNUM\\\", z1.*\n                FROM (\n                    \" . $sql . \"\n                ) z1\n            ) z2\n            WHERE z2.zend_db_rownum BETWEEN \" . ($offset+1) . \" AND \" . ($offset+$count);\n        return $limit_sql;\n\n\n{code}\n\t\n\n  "
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4790\/watchers",
                "isWatching": false,
                "watchCount": 4
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-10980",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10980",
                    "type": {
                        "name": "Sub-Task",
                        "direction": "OUTBOUND"
                    }
                }
            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10190",
                    "id": 10190,
                    "name": "Zend_Db_Adapter_Db2",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28080",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "is this still an issue?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2009-01-11T21:49:55.000+0000",
                    "updated": "2009-01-11T21:49:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/28089",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos",
                        "name": "maitrepylos",
                        "displayName": "Ernaelsten",
                        "active": true
                    },
                    "body": "For 1.7.2, Yes",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos",
                        "name": "maitrepylos",
                        "displayName": "Ernaelsten",
                        "active": true
                    },
                    "created": "2009-01-11T23:07:51.000+0000",
                    "updated": "2009-01-11T23:07:51.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41661",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "A similar issue as this was solved in ZF-8148 for Zend_Db_Adapter_Sqlsrv back in April.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2010-07-21T13:02:46.000+0000",
                    "updated": "2010-07-21T13:02:46.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44102",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "In addition to ZF-10980, here's two tests for DB2 that uses a profiler to check the SQL generated by the testAdapterLimit and testAdapterLimitOffset tests from TestCommon.php.  The point is to express what the SQL should be.  These tests don't need to be a permanent part of the test suite, although they could.  The idea is to make it dead simple to study any proposed fixes in the short term -- \"write the tests first\", test-driven development, yadda-yadda.\r\n\r\n{noformat}\r\nIndex: tests\/Zend\/Db\/Adapter\/Db2Test.php\r\n===================================================================\r\n--- tests\/Zend\/Db\/Adapter\/Db2Test.php\t(revision 23613)\r\n+++ tests\/Zend\/Db\/Adapter\/Db2Test.php\t(working copy)\r\n@@ -365,6 +365,62 @@\r\n         $this->markTestSkipped($this->getDriver() . ' does not have TEXT field type');\r\n     }\r\n \r\n+    public function testLimit()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $this->testAdapterLimit();\r\n+\r\n+        $profiler = $this->_db->getProfiler();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler',\r\n+                                $profiler);\r\n+\r\n+        $profile = $profiler->getLastQueryProfile();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler_Query',\r\n+                                $profile);\r\n+\r\n+        $this->assertEquals(Zend_Db_Profiler::SELECT,\r\n+                            $profile->getQueryType());\r\n+\r\n+        $qry = 'SELECT * FROM \"zfproducts\" ORDER BY \"product_id\" FETCH FIRST 1 ROWS ONLY';\r\n+        $this->assertEquals($qry, $profile->getQuery());\r\n+    }\r\n+\r\n+    public function testLimitOffset()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $this->testAdapterLimitOffset();\r\n+\r\n+        $profiler = $this->_db->getProfiler();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler',\r\n+                                $profiler);\r\n+\r\n+        $profile = $profiler->getLastQueryProfile();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler_Query',\r\n+                                $profile);\r\n+\r\n+        $this->assertEquals(Zend_Db_Profiler::SELECT,\r\n+                            $profile->getQueryType());\r\n+\r\n+        $qry = 'SELECT z2.*\r\n+            FROM (\r\n+                SELECT ROW_NUMBER() OVER(ORDER BY \"product_id\") AS \"ZEND_DB_ROWNUM\", z1.*\r\n+                FROM (\r\n+                    SELECT * FROM \"zfproducts\"\r\n+                ) z1\r\n+            ) z2\r\n+            WHERE z2.zend_db_rownum BETWEEN 2 AND 2';\r\n+\r\n+        $this->assertEquals($qry, $profile->getQuery(),\r\n+'ZF-4790: Zend_Db_Adapter_Db2::limit() needs to specify proper OVER()');\r\n+\r\n+    }\r\n+\r\n     public function getDriver()\r\n     {\r\n         return 'Db2';\r\n{noformat}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2011-01-21T10:17:52.000+0000",
                    "updated": "2011-01-21T10:17:52.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44346",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "Here's a proposed fix with some tests.  The tests are against the change suggested in ZF-10980.\r\n\r\nThis also proposes letting the user specify the {{ROW_NUMBER() OVER() AS \"ZEND_DB_ROWNUM\"}} syntax in their query.  I'm thinking this could help in the corner cases where the naive solution to extract the ORDER BY statement becomes a hindrance.\r\n\r\n{noformat}\r\nIndex: library\/Zend\/Db\/Adapter\/Db2.php\r\n===================================================================\r\n--- library\/Zend\/Db\/Adapter\/Db2.php\t(revision 23692)\r\n+++ library\/Zend\/Db\/Adapter\/Db2.php\t(working copy)\r\n@@ -685,6 +685,24 @@\r\n             return $limit_sql;\r\n         }\r\n \r\n+        $select = stripos($sql, 'SELECT');\r\n+        $rownum = strpos($sql, 'ZEND_DB_ROWNUM');\r\n+        if (false === $rownum && false !== $select) {\r\n+            $order = preg_match('\/ORDER\\s+BY\/i', $sql, $matches);\r\n+            if ($order > 0) {\r\n+                $order_pos = strpos($sql, $matches[$order - 1]);\r\n+                $order = substr($sql, $order_pos);\r\n+                $sql = substr($sql, 0, $order_pos - 1);\r\n+            } else {\r\n+                $order = '';\r\n+            }\r\n+            $sql = \"SELECT ROW_NUMBER() OVER($order) AS \\\"ZEND_DB_ROWNUM\\\", z1.*\r\n+                FROM (\r\n+                    $sql\r\n+                ) z1\";\r\n+                    \r\n+        }\r\n+\r\n         \/**\r\n          * DB2 does not implement the LIMIT clause as some RDBMS do.\r\n          * We have to simulate it with subqueries and ROWNUM.\r\n@@ -693,10 +711,7 @@\r\n          *\/\r\n         $limit_sql = \"SELECT z2.*\r\n             FROM (\r\n-                SELECT ROW_NUMBER() OVER() AS \\\"ZEND_DB_ROWNUM\\\", z1.*\r\n-                FROM (\r\n-                    \" . $sql . \"\r\n-                ) z1\r\n+                \" . $sql . \"\r\n             ) z2\r\n             WHERE z2.zend_db_rownum BETWEEN \" . ($offset+1) . \" AND \" . ($offset+$count);\r\n         return $limit_sql;\r\nIndex: tests\/Zend\/Db\/Adapter\/Db2Test.php\r\n===================================================================\r\n--- tests\/Zend\/Db\/Adapter\/Db2Test.php\t(revision 23692)\r\n+++ tests\/Zend\/Db\/Adapter\/Db2Test.php\t(working copy)\r\n@@ -365,6 +365,191 @@\r\n         $this->markTestSkipped($this->getDriver() . ' does not have TEXT field type');\r\n     }\r\n \r\n+    public function testLimitWithRownum()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $products = $this->_db->quoteIdentifier('zfproducts');\r\n+        $product_id = $this->_db->quoteIdentifier('product_id');\r\n+\r\n+        $sql = $this->_db->limit(\"SELECT $products.*, ROW_NUMBER() OVER(ORDER BY $product_id DESC) AS \\\"ZEND_DB_ROWNUM\\\" FROM $products\", 1);\r\n+\r\n+        $stmt = $this->_db->query($sql);\r\n+        $result = $stmt->fetchAll();\r\n+        $this->assertEquals(1, count($result),\r\n+            'Expecting row count to be 1');\r\n+        $this->assertEquals(2, count($result[0]),\r\n+            'Expecting column count to be 2');\r\n+        $this->assertEquals(3, $result[0]['product_id'],\r\n+            'Expecting to get product_id 3');\r\n+\r\n+        \/\/ Check that extra field ZEND_DB_ROWNUM isn't present\r\n+        \/\/ (particulary with Db2 & Oracle)\r\n+        $this->assertArrayNotHasKey('zend_db_rownum', $result[0]);\r\n+        $this->assertArrayNotHasKey('ZEND_DB_ROWNUM', $result[0]);\r\n+\r\n+        $profiler = $this->_db->getProfiler();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler',\r\n+                                $profiler);\r\n+\r\n+        $profile = $profiler->getLastQueryProfile();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler_Query',\r\n+                                $profile);\r\n+\r\n+        $this->assertEquals(Zend_Db_Profiler::SELECT,\r\n+                            $profile->getQueryType());\r\n+\r\n+        $qry = \"SELECT $products.*, ROW_NUMBER() OVER(ORDER BY $product_id DESC) AS \\\"ZEND_DB_ROWNUM\\\" FROM $products FETCH FIRST 1 ROWS ONLY\";\r\n+\r\n+        $this->assertEquals($qry, $profile->getQuery(),\r\n+'ZF-4790: Zend_Db_Adapter_Db2::limit() needs to specify proper OVER()');\r\n+    }\r\n+\r\n+    public function testLimitOffsetWithRownum()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $products = $this->_db->quoteIdentifier('zfproducts');\r\n+        $product_id = $this->_db->quoteIdentifier('product_id');\r\n+\r\n+        $sql = $this->_db->limit(\"SELECT * FROM (SELECT $products.*, ROW_NUMBER() OVER(ORDER BY $product_id DESC) AS \\\"ZEND_DB_ROWNUM\\\" FROM $products) zfp\", 1, 2);\r\n+\r\n+        $stmt = $this->_db->query($sql);\r\n+        $result = $stmt->fetchAll();\r\n+        $this->assertEquals(1, count($result),\r\n+            'Expecting row count to be 1');\r\n+        $this->assertEquals(2, count($result[0]),\r\n+            'Expecting column count to be 2');\r\n+        $this->assertEquals(1, $result[0]['product_id'],\r\n+            'Expecting to get product_id 1');\r\n+\r\n+        \/\/ Check that extra field ZEND_DB_ROWNUM isn't present\r\n+        \/\/ (particulary with Db2 & Oracle)\r\n+        $this->assertArrayNotHasKey('zend_db_rownum', $result[0]);\r\n+        $this->assertArrayNotHasKey('ZEND_DB_ROWNUM', $result[0]);\r\n+\r\n+        $profiler = $this->_db->getProfiler();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler',\r\n+                                $profiler);\r\n+\r\n+        $profile = $profiler->getLastQueryProfile();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler_Query',\r\n+                                $profile);\r\n+\r\n+        $this->assertEquals(Zend_Db_Profiler::SELECT,\r\n+                            $profile->getQueryType());\r\n+\r\n+        $qry = \"SELECT z2.*\r\n+            FROM (\r\n+                SELECT * FROM (SELECT $products.*, ROW_NUMBER() OVER(ORDER BY $product_id DESC) AS \\\"ZEND_DB_ROWNUM\\\" FROM $products) zfp\r\n+            ) z2\r\n+            WHERE z2.zend_db_rownum BETWEEN 3 AND 3\";\r\n+\r\n+        $this->assertEquals($qry, $profile->getQuery(),\r\n+'ZF-4790: Zend_Db_Adapter_Db2::limit() needs to specify proper OVER()');\r\n+    }\r\n+\r\n+    public function testLimitOffsetWithSubselect()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $products = $this->_db->quoteIdentifier('zfproducts');\r\n+        $product_id = $this->_db->quoteIdentifier('product_id');\r\n+\r\n+        $sql = $this->_db->limit(\"SELECT * FROM (SELECT * FROM $products) zfp ORDER BY $product_id DESC\", 1, 2);\r\n+\r\n+        $stmt = $this->_db->query($sql);\r\n+        $result = $stmt->fetchAll();\r\n+        $this->assertEquals(1, count($result),\r\n+            'Expecting row count to be 1');\r\n+        $this->assertEquals(2, count($result[0]),\r\n+            'Expecting column count to be 2');\r\n+        $this->assertEquals(1, $result[0]['product_id'],\r\n+            'Expecting to get product_id 1');\r\n+\r\n+        \/\/ Check that extra field ZEND_DB_ROWNUM isn't present\r\n+        \/\/ (particulary with Db2 & Oracle)\r\n+        $this->assertArrayNotHasKey('zend_db_rownum', $result[0]);\r\n+        $this->assertArrayNotHasKey('ZEND_DB_ROWNUM', $result[0]);\r\n+\r\n+        $profiler = $this->_db->getProfiler();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler',\r\n+                                $profiler);\r\n+\r\n+        $profile = $profiler->getLastQueryProfile();\r\n+        $this->assertInstanceOf('Zend_Db_Profiler_Query',\r\n+                                $profile);\r\n+\r\n+        $this->assertEquals(Zend_Db_Profiler::SELECT,\r\n+                            $profile->getQueryType());\r\n+\r\n+        $qry = \"SELECT z2.*\r\n+            FROM (\r\n+                SELECT ROW_NUMBER() OVER(ORDER BY $product_id DESC) AS \\\"ZEND_DB_ROWNUM\\\", z1.*\r\n+                FROM (\r\n+                    SELECT * FROM (SELECT * FROM $products) zfp\r\n+                ) z1\r\n+            ) z2\r\n+            WHERE z2.zend_db_rownum BETWEEN 3 AND 3\";\r\n+\r\n+        $this->assertEquals($qry, $profile->getQuery(),\r\n+'ZF-4790: Zend_Db_Adapter_Db2::limit() needs to specify proper OVER()');\r\n+\r\n+    }\r\n+\r\n+    \/**\r\n+     * @expectedException Zend_Db_Statement_Db2_Exception\r\n+     *\/\r\n+    public function testLimitOffsetWithSubselectOrderby()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $products = $this->_db->quoteIdentifier('zfproducts');\r\n+        $product_id = $this->_db->quoteIdentifier('product_id');\r\n+\r\n+        $sql = $this->_db->limit(\"SELECT * FROM (SELECT * FROM $products ORDER BY $product_id)\", 1, 2);\r\n+\r\n+        try {\r\n+            $stmt = $this->_db->query($sql);\r\n+            $result = $stmt->fetchAll();\r\n+        } catch (Zend_Db_Statement_Db2_Exception $e) {\r\n+            $this->assertContains('Token ) was not valid.', $e->getMessage());\r\n+            throw $e;\r\n+        }\r\n+    }\r\n+\r\n+    \/**\r\n+     * @expectedException Zend_Db_Statement_Db2_Exception\r\n+     *\/\r\n+    public function testLimitOffsetWithSubselectWithTwoOrderby()\r\n+    {\r\n+        $profiler = new Zend_Db_Profiler();\r\n+        $profiler->setEnabled(true);\r\n+        $this->_db->setProfiler($profiler);\r\n+\r\n+        $products = $this->_db->quoteIdentifier('zfproducts');\r\n+        $product_id = $this->_db->quoteIdentifier('product_id');\r\n+\r\n+        $sql = $this->_db->limit(\"SELECT * FROM (SELECT * FROM $products ORDER BY $product_id) ORDER BY $product_id\", 1, 2);\r\n+\r\n+        try {\r\n+            $stmt = $this->_db->query($sql);\r\n+            $result = $stmt->fetchAll();\r\n+        } catch (Zend_Db_Statement_Db2_Exception $e) {\r\n+            $this->assertContains('Keyword BY not expected.', $e->getMessage());\r\n+            throw $e;\r\n+        }\r\n+    }\r\n+\r\n+\r\n     public function getDriver()\r\n     {\r\n         return 'Db2';\r\n{noformat}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2011-02-11T12:45:31.000+0000",
                    "updated": "2011-02-11T12:45:31.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44351",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos@gmail.com",
                        "name": "maitrepylos@gmail.com",
                        "displayName": "Ernaelsten G\u00e9rard",
                        "active": true
                    },
                    "body": "I like this proposal.\r\n\r\nBut after two years is it really necessary to deal with it?\r\n\r\nG\u00e9rard",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos@gmail.com",
                        "name": "maitrepylos@gmail.com",
                        "displayName": "Ernaelsten G\u00e9rard",
                        "active": true
                    },
                    "created": "2011-02-12T11:41:00.000+0000",
                    "updated": "2011-02-12T11:41:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44363",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "G\u00e9rard, you are no longer interested in it?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2011-02-13T10:10:00.000+0000",
                    "updated": "2011-02-13T10:10:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44364",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos@gmail.com",
                        "name": "maitrepylos@gmail.com",
                        "displayName": "Ernaelsten G\u00e9rard",
                        "active": true
                    },
                    "body": "Of course it does, but I wonder if there is a necessity, because in two years, two people are interested in the problem.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=maitrepylos@gmail.com",
                        "name": "maitrepylos@gmail.com",
                        "displayName": "Ernaelsten G\u00e9rard",
                        "active": true
                    },
                    "created": "2011-02-13T11:26:06.000+0000",
                    "updated": "2011-02-13T11:26:06.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44374",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "body": "Yeah, clearly there are very few people using DB2.  And of those people, very few using PHP.  And of those, very few using Zend Framework.  And of those, very few using Zend_Db::limit().  Zend has an offering for the IBM AS\/400, so the importance of this functionality may increase.\r\n\r\nhttp:\/\/www.zend.com\/en\/products\/server\/zend-server-ibm-i",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ashawley",
                        "name": "ashawley",
                        "displayName": "Aaron S. Hawley",
                        "active": true
                    },
                    "created": "2011-02-14T05:27:03.000+0000",
                    "updated": "2011-02-14T05:27:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/46574",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=aseiden",
                        "name": "aseiden",
                        "displayName": "Alan Seiden",
                        "active": true
                    },
                    "body": "Aaron's patch worked for me. I am one of those people using DB2, Zend Framework and Zend_Db::limit() on IBM i (formerly AS\/400).\r\n\r\nThe limit() problem causes Zend_Paginator_DbSelect not to work properly. The paginator's results for pages 2 and up are returned in random order, ignoring any ORDER BY specified in the select.\r\n\r\nThanks to Aaron's patch, my application's pagination is now working properly. I'd say this is an important bug fix as more IBM i developers begin to write pagination code with ZF.\r\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=aseiden",
                        "name": "aseiden",
                        "displayName": "Alan Seiden",
                        "active": true
                    },
                    "created": "2011-05-13T15:17:05.000+0000",
                    "updated": "2011-05-13T15:17:05.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-4790\/transitions"
}