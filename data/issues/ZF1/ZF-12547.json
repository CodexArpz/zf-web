{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12547",
    "key": "ZF-12547",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Gettext adapter cannot translate plurals when the target language has only one plural form"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12547\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/8",
                "name": "Issue Moved"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2013-04-05T16:06:54.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fisharebest",
                "name": "fisharebest",
                "displayName": "fisharebest",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2013-03-22T13:57:08.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2013-04-05T16:06:55.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When a target language only has one plural form, calls to {{Zend_Translate::plural()}} just return the first character of the string.\r\n\r\nConsider these two translation files (French - 2 plural forms, Turkish - 1 plural form).  Compile them with the command \"msgfmt XX.po -o XX.mo\"\r\n\r\n{code:title=fr.po}\r\nmsgid \"\"\r\nmsgstr \"\"\r\n\"Content-Type: text\/plain; charset=UTF-8\\n\"\r\n\"Plural-Forms: nplurals=2; plural=n > 1;\\n\"\r\n\r\nmsgid \"There is %d fish\"\r\nmsgid_plural \"There are %d fishes\"\r\nmsgstr[0] \"Il ya %d poisson\"\r\nmsgstr[1] \"Il ya %d poissons\"\r\n{code}\r\n\r\n{code:title=tr.po}\r\nmsgid \"\"\r\nmsgstr \"\"\r\n\"Content-Type: text\/plain; charset=UTF-8\\n\"\r\n\"Plural-Forms: nplurals=1; plural=0;\\n\"\r\n\r\nmsgid \"There is %d fish\"\r\nmsgid_plural \"There are %d fishes\"\r\nmsgstr[0] \"%d bal\u0131klar var\"\r\n{code}\r\n\r\nHere is a test script\r\n\r\n{code:title=test.php}\r\nrequire 'Zend\/Translate.php';\r\n\r\n\/\/ A language with more than one plural form - works OK\r\n$translate = new Zend_Translate('gettext', 'fr.mo', 'fr');\r\nfor ($i=0; $i<5; ++$i) {\r\n    echo $translate->plural('There is %d fish', 'There are %d fishes', $i), PHP_EOL;\r\n}\r\n\r\n\/\/ A language with only one plural form - does not work\r\n$translate = new Zend_Translate('gettext', 'tr.mo', 'tr');\r\nfor ($i=0; $i<5; ++$i) {\r\n    echo $translate->plural('There is %d fish', 'There are %d fishes', $i), PHP_EOL;\r\n}\r\n{code}\r\n\r\nThe actual output is\r\n\r\n{code:borderStye=solid}\r\nIl ya %d poisson\r\nIl ya %d poisson\r\nIl ya %d poissons\r\nIl ya %d poissons\r\nIl ya %d poissons\r\n%\r\n%\r\n%\r\n%\r\n%\r\n{code}\r\n\r\nNote that the turkish translations contain just the first character of the sring.\r\n\r\nThis comes from code in {{Zend_Translate_Adapter::plural()}} which assumes that plural translations are always arrays.  The [0] operator is finding the first character of a string, not the first element of an array.\r\n\r\n{code:tite=Zend_Translate_Plural 760-764 and 777-780}\r\n            $rule = Zend_Translate_Plural::getPlural($number, $locale);\r\n            if (isset($this->_translate[$locale][$plural[0]][$rule])) {\r\n                $this->_routed = array();\r\n                return $this->_translate[$locale][$plural[0]][$rule];\r\n            }\r\n{code}\r\n\r\nAs far as I can tell, the bug comes from Zend_Translate_Adapter_Gettext, and can be fixed by the following patch\r\n\r\n{code:title=Gettext.php.patch}\r\nIndex: Gettext.php\r\n===================================================================\r\n--- Gettext.php\t(revision 25275)\r\n+++ Gettext.php\t(working copy)\r\n@@ -122,7 +122,7 @@\r\n                 fseek($this->_file, $transtemp[$count * 2 + 2]);\r\n                 $translate = fread($this->_file, $transtemp[$count * 2 + 1]);\r\n                 $translate = explode(\"\\0\", $translate);\r\n-                if ((count($original) > 1) && (count($translate) > 1)) {\r\n+                if (count($original) > 1) {\r\n                     $this->_data[$locale][$original[0]] = $translate;\r\n                     array_shift($original);\r\n                     foreach ($original as $orig) {\r\n{code}\r\n\r\nAn explanation for the patch is that a translation is defined as a plural if there are more than one ENGLISH forms.  It does not matter whether there is only one TRANSLATED form.\r\n\r\nWith the patch, the test script outputs the expected values:\r\n\r\n{code:borderStyle=solid}\r\nIl ya %d poisson\r\nIl ya %d poisson\r\nIl ya %d poissons\r\nIl ya %d poissons\r\nIl ya %d poissons\r\n%d bal\u0131klar var\r\n%d bal\u0131klar var\r\n%d bal\u0131klar var\r\n%d bal\u0131klar var\r\n%d bal\u0131klar var\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12547\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/11182",
                    "id": 11182,
                    "description": "Mini Release",
                    "name": "1.12.1",
                    "userReleaseDate": "18\/Dec\/12",
                    "archived": false,
                    "releaseDate": "2012-12-18",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10099",
                    "id": 10099,
                    "name": "Zend_Translate",
                    "description": "Provides translation functionality, based on standards such as TMX and Gettext.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/53474",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "body": "This issue has been closed on Jira and moved to GitHub for issue tracking.  To continue following the resolution of this issues, please visit: https:\/\/github.com\/zendframework\/zf1\/issues\/66",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                        "name": "ralph",
                        "displayName": "Ralph Schindler",
                        "active": true
                    },
                    "created": "2013-04-05T16:06:55.000+0000",
                    "updated": "2013-04-05T16:06:55.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12547\/transitions"
}