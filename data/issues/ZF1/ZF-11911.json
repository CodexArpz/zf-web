{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11911",
    "key": "ZF-11911",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Long cache ids cause the file backend to produce too long file names"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11911\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/2",
                "name": "Won't Fix"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2012-01-08T15:29:44.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=davidfuhr",
                "name": "davidfuhr",
                "displayName": "David Fuhr",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-11-25T11:10:08.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-02-26T18:43:11.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "cache",
                "file"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "We are generating our cache ids partly dynamic. In some cases they can be very long. If the get too long the file backend fails saving them as it creates the file names using the ids.\r\n\r\nDifferent file systems have different length limits: http:\/\/en.wikipedia.org\/wiki\/Comparison_of_file_systems#Limits\r\n\r\nThis could be fixed on application level, but i believe it is better to fix this on framework level as the limitations on length are backend specific.\r\n\r\nI've created a patch against the trunk (r24565) which introduces a new config option (\"max_file_length\"). This enables automatic file name shortening using the hashed cache id (to minimize the risk of id collisions). The option is disabled by default to keep BC. I suggest to set it to 255 as this seems to be the limit for most of the common file systems (ext2\/3\/4, ntfs, jfs, xfs, btrfs, ...).\r\n\r\nA test case to reproduce the problem is also included.\r\n\r\n{noformat}\r\n### Eclipse Workspace Patch 1.0\r\n#P ZendFramework-trunk\r\nIndex: library\/Zend\/Cache\/Backend\/File.php\r\n===================================================================\r\n--- library\/Zend\/Cache\/Backend\/File.php\t(Revision 24565)\r\n+++ library\/Zend\/Cache\/Backend\/File.php\t(Arbeitskopie)\r\n@@ -96,6 +96,7 @@\r\n         'hashed_directory_umask' => 0700,\r\n         'file_name_prefix' => 'zend_cache',\r\n         'cache_file_umask' => 0600,\r\n+        'max_file_length' => null,\r\n         'metadatas_array_max_size' => 100\r\n     );\r\n \r\n@@ -863,6 +864,15 @@\r\n     {\r\n         $prefix = $this->_options['file_name_prefix'];\r\n         $result = $prefix . '---' . $id;\r\n+        \r\n+        if (null !== $this->_options['max_file_length']) {\r\n+            $path = $this->_path($result);\r\n+            if (strlen($path . $result) > $this->_options['max_file_length']) {\r\n+                $idHash = md5($result);\r\n+                $result = substr($result, 0, $this->_options['max_file_length'] - strlen($path) - strlen($idHash)) . $idHash;\r\n+            }\r\n+        }\r\n+        \r\n         return $result;\r\n     }\r\n \r\nIndex: tests\/Zend\/Cache\/FileBackendTest.php\r\n===================================================================\r\n--- tests\/Zend\/Cache\/FileBackendTest.php\t(Revision 24565)\r\n+++ tests\/Zend\/Cache\/FileBackendTest.php\t(Arbeitskopie)\r\n@@ -120,7 +120,20 @@\r\n         $res = $this->_instance->save('data to cache', 'foo', array('tag1', 'tag2'));\r\n         $this->assertFalse($res);\r\n     }\r\n-\r\n+    \r\n+    \/**\r\n+     * Tests if long file names are prevented\r\n+     *\r\n+     * Depending on the FS there are different limits for the maximum file\r\n+     * name length. Most FS' limit is 255 bytes or characters.\r\n+     *\r\n+     * @link http:\/\/en.wikipedia.org\/wiki\/Comparison_of_file_systems#Limits\r\n+     *\/\r\n+    public function testSaveWithVeryLongCacheId()\r\n+    {\r\n+        $cacheId = str_pad('', 300, 'a');\r\n+        $this->_instance->setOption('max_file_length', 255);\r\n+        $res = $this->_instance->save('data to cache', $cacheId);\r\n+        $this->assertTrue($res);\r\n+    }\r\n }\r\n-\r\n-\r\n{noformat}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11911\/watchers",
                "isWatching": false,
                "watchCount": 0
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/6",
                "name": "Closed"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mabe",
                "name": "mabe",
                "displayName": "Marc Bennewitz (private)",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10981",
                    "id": 10981,
                    "description": "Mini Release",
                    "name": "1.11.11",
                    "userReleaseDate": "29\/Sep\/11",
                    "archived": false,
                    "releaseDate": "2011-09-29",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10028",
                    "id": 10028,
                    "name": "Zend_Cache",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49189",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "You will need to sign and submit a CLA before we can include your suggested fix in Zend Framework.\r\nSee here: http:\/\/framework.zend.com\/wiki\/display\/ZFPROP\/Contributor+License+Agreement",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2011-11-30T14:06:53.000+0000",
                    "updated": "2011-11-30T14:06:53.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49292",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=davidfuhr",
                        "name": "davidfuhr",
                        "displayName": "David Fuhr",
                        "active": true
                    },
                    "body": "CLA is singed end sent.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=davidfuhr",
                        "name": "davidfuhr",
                        "displayName": "David Fuhr",
                        "active": true
                    },
                    "created": "2011-12-21T08:39:23.000+0000",
                    "updated": "2011-12-21T08:39:23.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49436",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mabe",
                        "name": "mabe",
                        "displayName": "Marc Bennewitz (private)",
                        "active": true
                    },
                    "body": "The way you go doesn't work because it's changing the cache ids and methods like getIds no longer works as expected.\r\n\r\nYou can simply hash the cache id in your application before calling the cache.\r\n\r\nOn ZF2 you can get information about the backend how long the key can be.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mabe",
                        "name": "mabe",
                        "displayName": "Marc Bennewitz (private)",
                        "active": true
                    },
                    "created": "2012-01-08T15:29:44.000+0000",
                    "updated": "2012-01-08T15:29:44.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11911\/transitions"
}