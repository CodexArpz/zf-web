{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3465",
    "key": "ZF-3465",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "dispatcher - error when removing default routes"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3465\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2008-11-25T06:55:04.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=xorock",
                "name": "xorock",
                "displayName": "Marek",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2008-06-17T00:18:25.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-07-29T15:49:02.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I think there is a bug in Zend\/Controller\/Dispatcher\/Standard.php line 247.\nNow: if (!$this->getParam('useDefaultControllerAlways') && !empty($controller)) {\nShould be: if (!$this->getParam('useDefaultControllerAlways') && empty($controller)) {\n\nWhy? Even if we remove default routes ($router->removeDefaultRoutes(); ) we are always being redirected to index\/index controller\/action. So:\n$front->throwExceptions(true) + $router->removeDefaultRoutes() = index\/index\n$front->throwExceptions(true) + #$router->removeDefaultRoutes() = exception\n\nAccording to docs (http:\/\/framework.zend.com\/manual\/en\/zend.controller.exceptions.html#zend.controller.exceptions.handling) \n$dispatcher->setParam('useDefaultControllerAlways', true);\nshould switch between exception and default controller but now it isn't.\n\nOf course, I could be wrong :)\n\nedit: yes, it's definitely a bug. I've chcecked all possible combinations with routes \/ errorplugin \/ exception and now it's fine."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/2",
                "name": "Critical"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3465\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10181",
                    "id": 10181,
                    "description": "Mini Release",
                    "name": " 1.5.2",
                    "userReleaseDate": "15\/May\/08",
                    "archived": true,
                    "releaseDate": "2008-05-15",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10011",
                    "id": 10011,
                    "name": "Zend_Controller",
                    "description": "front controller, including router and dispatcher",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26644",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Actually, the current behavior is correct. When the useDefaultControllerAlways is set to true, then isDispatchable() will always return true -- because it will resolve the invalid or empty controller to the default controller. I've tested extensively, and it works exactly as expected.\n\nThe one issue I've had with this is if I set the parameter *after* dispatch() has already been called on the front controller -- i.e., from a plugin. In such a case, by the time that routeStartup() has hit, pushing the parameters into the front controller will have no effect on the router or dispatcher. If this is what you are doing, you may need to push that setParam() into your bootstrap or index.php prior to calling dispatch().",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-11-24T11:36:59.000+0000",
                    "updated": "2008-11-24T11:36:59.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26658",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=xorock",
                        "name": "xorock",
                        "displayName": "Marek",
                        "active": true
                    },
                    "body": "Sorry, I can't agree with You. My bootstrap.php:\n  $frontController = Zend_Controller_Front::getInstance();\n  $frontController->throwExceptions(true);\n  $frontController->setRouter($router);\n  $frontController->setParam('noViewRenderer', true);\n  $frontController->setParam('useDefaultControllerAlways', true);\n  $frontController->setControllerDirectory('..\/application\/modules\/default\/controllers');\n  $frontController->registerPlugin(...some plugins here...);\n\n  $frontController->returnResponse(true);\n  $response = $frontController->dispatch();\n  \n  \/*My own class for handling headers.*\/\n  $response->sendResponse();\n\nAnd let's try my code, set $frontController->setParam('useDefaultControllerAlways', false); and go to http:\/\/domain\/non\/existent -> Invalid controller specified. Now $frontController->throwExceptions(false); -> Action \"error\" does not exist and was not trapped in __call(). W can read http:\/\/framework.zend.com\/manual\/en\/zend.controller.exceptions.html \"By default, the error handler plugin is registered and active...By passing a boolean true value to this method, you can tell the front controller that instead of aggregating exceptions in the response object or using the error handler plugin, you'd rather handle them yourself.\". So as You can see everything is working as it should. \n\nNow use default ZF code. $frontController->setParam('useDefaultControllerAlways', false); and go to http:\/\/domain\/non\/existent -> index\/index was loaded. Why? $frontController->throwExceptions(false); -> index\/index . Nothing is working. You can also search google - there are several sites where people complain of such strange behavior.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=xorock",
                        "name": "xorock",
                        "displayName": "Marek",
                        "active": true
                    },
                    "created": "2008-11-24T22:44:29.000+0000",
                    "updated": "2008-11-24T22:44:29.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26674",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "I have done exactly what you suggest: I used a stock ZF install, with only an IndexController and ErrorController defined, and set the useDefaultControllerAlways param to false. In such a case, passing an invalid controller correctly goes to the ErrorController. Toggling the flag to true, I correctly go to the IndexController. This is exactly the behavior that is expected. \n\nThat said, I think I know where the confusion lies: when an action is also provided via the URL. Let's look at the flow:\n\n* invalid controller detected\n* controller rewritten to IndexController\n* action called on IndexController\n* IndexController does not find action method, and invokes __call()\n* __call() recognizes that an undefined action was called, and throws an exception\n* the ErrorHandler plugin detects the exception and invokes the ErrorController\n\nSo, the useDefaultControllerAlways flag is doing exactly as it should. The problem is that there is an expectation that the action controller will fall back to a default action as well. And that's the real issue here.\n\nI'm re-opening the issue and noting that when the default controller is selected in such a case that the default action as defined in the dispatcher should also be utilized.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-11-25T05:11:26.000+0000",
                    "updated": "2008-11-25T05:11:26.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26676",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=xorock",
                        "name": "xorock",
                        "displayName": "Marek",
                        "active": true
                    },
                    "body": "It was some time ago when I reported this bug so I forgot real problem here was $router->removeDefaultRoutes(). What You said is valid for general, default routes. Could You please explain to me what exactly should  happen if we changed ZF default routing?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=xorock",
                        "name": "xorock",
                        "displayName": "Marek",
                        "active": true
                    },
                    "created": "2008-11-25T06:39:19.000+0000",
                    "updated": "2008-11-25T06:39:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/26677",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Resolved in r12822 in trunk and r12823 in 1.7 release branch",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2008-11-25T06:55:04.000+0000",
                    "updated": "2008-11-25T06:55:04.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/29518",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quipo",
                        "name": "quipo",
                        "displayName": "Lorenzo Alberton",
                        "active": true
                    },
                    "body": "I can confirm this. Removing the default routes, the error controller is never called.  Changing \"!empty($controller)\" to \"empty($controller)\", as suggested by the bug reporter, fixed the issue for me too.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quipo",
                        "name": "quipo",
                        "displayName": "Lorenzo Alberton",
                        "active": true
                    },
                    "created": "2009-03-17T04:25:19.000+0000",
                    "updated": "2009-03-17T04:25:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/31369",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quipo",
                        "name": "quipo",
                        "displayName": "Lorenzo Alberton",
                        "active": true
                    },
                    "body": "This bug is marked as resolved, but I can still reproduce it in the latest release (1.8.1).   As reported by Marek, the problem happens when calling $router->removeDefaultRoutes(), and can be fixed by removing the \"!\" sign from within the \"!empty($controller)\" check.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quipo",
                        "name": "quipo",
                        "displayName": "Lorenzo Alberton",
                        "active": true
                    },
                    "created": "2009-05-26T15:37:21.000+0000",
                    "updated": "2009-05-26T15:37:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32815",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=etaty",
                        "name": "etaty",
                        "displayName": "etaty",
                        "active": true
                    },
                    "body": "Still in 1.8.4\nZend\\Controller\\Dispatcher\\Standard.php\n\nline 239 :\nif (!$this->getParam('useDefaultControllerAlways') && !empty($controller)) {\n\nnew line 239 :\nif (!$this->getParam('useDefaultControllerAlways') && empty($controller)) {",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=etaty",
                        "name": "etaty",
                        "displayName": "etaty",
                        "active": true
                    },
                    "created": "2009-07-21T16:36:07.000+0000",
                    "updated": "2009-07-21T16:36:07.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/33033",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=truehl",
                        "name": "truehl",
                        "displayName": "Thorsten Ruehl",
                        "active": true
                    },
                    "body": "same problem here, Zend Framework 1.8.1\n\nFor us this worked to disable the default routing in some projects:\n\n{noformat}\nIndex: libs\/zfw-1_8_1\/Zend\/Controller\/Dispatcher\/Standard.php\n===================================================================\n--- libs\/zfw-1_8_1\/Zend\/Controller\/Dispatcher\/Standard.php      (revision 5938)\n+++ libs\/zfw-1_8_1\/Zend\/Controller\/Dispatcher\/Standard.php      (working copy)\n@@ -236,9 +236,14 @@\n          *\/\n         if (!$this->isDispatchable($request)) {\n             $controller = $request->getControllerName();\n-            if (!$this->getParam('useDefaultControllerAlways') && !empty($controller)) {\n+            # see: http:\/\/framework.zend.com\/issues\/browse\/ZF-3465\n+            if (!$this->getParam('useDefaultControllerAlways')) {\n                 require_once 'Zend\/Controller\/Dispatcher\/Exception.php';\n-                throw new Zend_Controller_Dispatcher_Exception('Invalid controller specified (' . $request->getControllerName() . ')');\n+                if(!empty($controller)) {\n+                    throw new Zend_Controller_Dispatcher_Exception('Invalid controller specified (' . $request->getControllerName() . ')');\n+                } else {\n+                    throw new Zend_Controller_Dispatcher_Exception('No controller determined and useDefaultControllerAlways is disabled!');\n+                }\n             }\n\n             $className = $this->getDefaultControllerClass($request);\n{noformat}\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=truehl",
                        "name": "truehl",
                        "displayName": "Thorsten Ruehl",
                        "active": true
                    },
                    "created": "2009-07-29T15:48:58.000+0000",
                    "updated": "2009-07-29T15:48:58.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-3465\/transitions"
}