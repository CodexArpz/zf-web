{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9710",
    "key": "ZF-9710",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "When having subforms FormErrors produce bad html markup."
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9710\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10540",
                    "id": 10540,
                    "description": "Mini Release",
                    "name": "1.11.4",
                    "userReleaseDate": "03\/Mar\/11",
                    "archived": false,
                    "releaseDate": "2011-03-03",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2011-02-22T13:05:08.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=sergiomedinag",
                "name": "sergiomedinag",
                "displayName": "Sergio Medina",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-04-19T09:35:34.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-02-22T13:05:10.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "This only happens when having subforms in a form with the Zend_Form_Decorator_FormErrors. To produce the error:\r\n{code:java}\r\nclass Form_User extends Zend_Form\r\n{\r\n    public function init()\r\n    {\r\n        $this->addElement('text', 'name', array(\r\n            'label' => 'Name',\r\n            'required' => true,\r\n            'validators' => array(\r\n                new Zend_Validate_Alnum(true)\r\n            )\r\n        ));\r\n\r\n        $this->addElement('text', 'email', array(\r\n            'label' => 'Email',\r\n            'required' => true,\r\n            'validators' => array(\r\n                new Zend_Validate_EmailAddress()\r\n            )\r\n        ));\r\n\r\n        $subform = new Zend_Form_SubForm();\r\n\r\n        $subform->addElement('text', 'address', array(\r\n            'label' => 'Address',\r\n            'required' => true,\r\n            'validators' => array(\r\n                new Zend_Validate_Alnum(true)\r\n            )\r\n        ));\r\n\r\n        $subform->addElement('text', 'phone', array(\r\n            'label' => 'Phone number',\r\n            'required' => true\r\n        ));\r\n\r\n        $this->addSubForm($subform, 'location');\r\n\r\n        $this->addElement('submit', 'submit');\r\n\r\n        $this->addDecorators(array(\r\n            new Zend_Form_Decorator_FormErrors(),\r\n            new Zend_Form_Decorator_FormElements(),\r\n            new Zend_Form_Decorator_HtmlTag(array(\r\n                'tag' => 'dl', 'class' => 'zend_form'\r\n            )),\r\n            new Zend_Form_Decorator_Form(),\r\n        ));\r\n    }\r\n}\r\n{code}\r\n\r\nWhen submiting with missing or wrong values it will produce:\r\n\r\n{code:html}\r\n<ul>\r\n    <li>Element Label\r\n      <ul>\r\n           <li>Errors<\/li>\r\n      <\/ul>\r\n\r\n    <\/li>\r\n    <li>Element Label\r\n      <ul>\r\n           <li>Errors<\/li>\r\n      <\/ul>\r\n\r\n    <\/li>\r\n    <ul>\r\n      <li>Subform element Label\r\n        <ul>\r\n           <li>Errors<\/li>\r\n        <\/ul>\r\n       <\/li>\r\n    <\/ul>\r\n  \r\n<\/ul>\r\n{code}\r\n\r\nThe problem seems to be in the protected method _recurseSubform."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9710\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                "name": "matthew",
                "displayName": "Matthew Weier O'Phinney",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10470",
                    "id": 10470,
                    "description": "Mini Release",
                    "name": "1.10.6",
                    "userReleaseDate": "22\/Jun\/10",
                    "archived": false,
                    "releaseDate": "2010-06-22",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10029",
                    "id": 10029,
                    "name": "Zend_Form",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40666",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "body": "Fixed in trunk r22270 and merged into 1.10 release branch",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alab",
                        "name": "alab",
                        "displayName": "Christian Albrecht",
                        "active": true
                    },
                    "created": "2010-05-24T09:12:14.000+0000",
                    "updated": "2010-05-24T09:12:14.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41344",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=djmabo",
                        "name": "djmabo",
                        "displayName": "Marian B\u00f6hmer",
                        "active": true
                    },
                    "body": "It seems to be not fixed. Subform without elements produces:\r\n<ul class=\"form-errors\"><ul class=\"form-errors\"><\/ul><\/ul>",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=djmabo",
                        "name": "djmabo",
                        "displayName": "Marian B\u00f6hmer",
                        "active": true
                    },
                    "created": "2010-07-05T07:08:30.000+0000",
                    "updated": "2010-07-05T07:08:30.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42251",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "body": "There seems to be no check on if the subform is actually rendering any markup. \r\n\r\nMimicking the behavior from its own render() method, the following patch fixes the issue [~djmabo] is seeing\r\n\r\n{code:title=patch.diff}\r\nIndex: FormErrors.php\r\n===================================================================\r\n--- FormErrors.php\t(revision 22929)\r\n+++ FormErrors.php\t(working copy)\r\n@@ -451,9 +451,13 @@\r\n                              .  $this->getMarkupListItemEnd();\r\n                 }\r\n             } else if ($subitem instanceof Zend_Form && !$this->ignoreSubForms()) {\r\n-                $content .= $this->getMarkupListStart()\r\n-                          . $this->_recurseForm($subitem, $view)\r\n-                          . $this->getMarkupListEnd();\r\n+                $markup = $this->_recurseForm($subitem, $view);\r\n+\r\n+                if (!empty($markup)) {\r\n+                    $content .= $this->getMarkupListStart()\r\n+                              . $markup\r\n+                              . $this->getMarkupListEnd();\r\n+                }\r\n             }\r\n         }\r\n         return $content;\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "created": "2010-09-14T10:43:47.000+0000",
                    "updated": "2010-09-14T10:43:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/42516",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "body": "Any comments on the proposed patch?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "created": "2010-10-13T20:57:55.000+0000",
                    "updated": "2010-10-13T20:57:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43539",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fabius",
                        "name": "fabius",
                        "displayName": "Fabio Almeida",
                        "active": true
                    },
                    "body": "I confirm this bug is still around in 1.11.1.\r\n\r\nThe proposed patch works fine for me.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fabius",
                        "name": "fabius",
                        "displayName": "Fabio Almeida",
                        "active": true
                    },
                    "created": "2010-12-09T06:16:09.000+0000",
                    "updated": "2010-12-09T06:16:09.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44083",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "body": "I can confirm this bug is still around in 1.11.2.\r\n\r\nThis patch will adds a test case for this issue to the FormErrorsTest test class:\r\n\r\n{code:title=FormErrors.diff}Index: Zend\/Form\/Decorator\/FormErrorsTest.php\r\n===================================================================\r\n--- Zend\/Form\/Decorator\/FormErrorsTest.php\t(revision 23642)\r\n+++ Zend\/Form\/Decorator\/FormErrorsTest.php\t(working copy)\r\n@@ -138,6 +138,18 @@\r\n         $this->assertSame($content, $this->decorator->render($content));\r\n     }\r\n \r\n+    public function testNotGeneratingSubformErrorMarkupWrappingWhenNoErrors()\r\n+    {\r\n+        $form1 = new Zend_Form_SubForm();\r\n+        $form2 = new Zend_Form();\r\n+        $form2->addSubForm($form1, 'sub');\r\n+        $form2->setView($this->getView());\r\n+        $this->decorator->setElement($form2);\r\n+\r\n+        $content = 'test content';\r\n+        $this->assertSame($content, $this->decorator->render($content));\r\n+    }\r\n+\r\n     public function testRenderRendersAllErrorMessages()\r\n     {\r\n         $this->setupForm();\r\n@@ -289,6 +301,7 @@\r\n         $this->assertNotContains('form-badness', $html);\r\n     }\r\n \r\n+\r\n     \/**\r\n      * @dataProvider markupOptionMethodsProvider\r\n      *\/\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "created": "2011-01-20T12:49:33.000+0000",
                    "updated": "2011-01-20T12:49:33.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44108",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Actually, that test case is flawed -- there's no way it can produce the value \"test content\" from rendering. The output actually rendered is \"<ul class=\"form-errors\"><ul class=\"form-errors\"><\/ul><\/ul>\" -- which makes sense to me. Can you clarify the test case?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2011-01-21T14:49:00.000+0000",
                    "updated": "2011-01-21T14:49:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44194",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "body": "I disagree. $this->decorator->render($content) does indeed render 'test content' (the FormErrors decorator prepends or appends error messages to the standard output of a form).  A number of the other tests use a similar method calling render() (indeed, thats where I copied it from). The complete output is actually:\r\n{code}\r\ntest content\r\n<ul class=\"form-errors\"><ul class=\"form-errors\"><\/ul><\/ul>\r\n{code}\r\n\r\nWhere as the correctly patched code outputs:\r\n{code}\r\ntest content\r\n{code}\r\n\r\nSo, in summary, in the case where a form has no errors, the Zend_Form_Decorator_FormErrors::render($content) merely returns $content. \r\n\r\n{code:title=Zend_Form_Decorator_FormErrors::render(), FormErrors.php, lines 91-95}\r\n        $markup = $this->_recurseForm($form, $view);\r\n\r\n        if (empty($markup)) {\r\n            return $content;\r\n        }\r\n{code}\r\n\r\nThis is true for the case where a form has NO subforms.\r\n\r\nIn the case where a form has a subform, during the _recurseForm method, the decorator ALWAYS wraps the output from the recursive response to _recurseForm even when the response is empty.\r\n\r\n{code:title=Zend_Form_Decorator_FormErrors::_recurseForm(), FormErrors.php, lines 453-457}\r\n            } else if ($subitem instanceof Zend_Form && !$this->ignoreSubForms()) {\r\n                $content .= $this->getMarkupListStart()\r\n                          . $this->_recurseForm($subitem, $view)\r\n                          . $this->getMarkupListEnd();\r\n            }\r\n{code}\r\n\r\nSo when FormErrors decorates a form with no errors and no subforms, the return from render is merely the form itself. When FormErrors decorates a form with no errors and at least one subform also with NO errors, the return from render is \"<ul class=\"form-errors\"><ul class=\"form-errors\"><\/ul><\/ul>\" (the inner <ul> from the lines 453-457 above, and the outer <ul> caused by code continuing past line 95 highlighted above).\r\n\r\nThis behavior is invalid, and I believe the test case I've provided correctly identifies the problem.\r\n\r\nThe patch I've proposed above checks makes _recurseForm check for a non-empty response from $this->_recurseForm($subitem, $view) before wrapping it with the error list start\/end markup, just as render() does with the over-all response from _recurseForm().",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=beeboo",
                        "name": "beeboo",
                        "displayName": "B. Charbonneau",
                        "active": true
                    },
                    "created": "2011-01-26T11:29:01.000+0000",
                    "updated": "2011-01-26T11:29:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/44542",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "body": "Unit test case added and patch applied.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=matthew",
                        "name": "matthew",
                        "displayName": "Matthew Weier O'Phinney",
                        "active": true
                    },
                    "created": "2011-02-22T13:05:08.000+0000",
                    "updated": "2011-02-22T13:05:08.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-9710\/transitions"
}