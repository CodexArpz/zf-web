{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7688",
    "key": "ZF-7688",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Strange tokenizing from analyzer"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7688\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mindexpander",
                "name": "mindexpander",
                "displayName": "Erik Wijdemans",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-08-25T23:29:01.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2011-08-09T15:29:05.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "I have an index with a Zend_Search_Lucene_Analysis_Analyzer_Common_Utf8Num_CaseInsensitive analyzer. \n\nWhen I query the index with the query \"foo_bar*\" (without quotes) I get the following exception: \nZend_Search_Lucene_Search_QueryParserException' with message 'Wildcard search is supported only for non-multiple word terms' in Zend\/Search\/Lucene\/Search\/Query\/Preprocessing\/Term.php:182\n\nI get no exception when I query with the query \"foo bar*\".\n\nI've looked within Term.php and in the first example with \"foo_bar*\" as query, the analyzer tokenizes the query into 'foo' and 'bar' but in the second example to only 'bar'. The first example given me therefor an exception because on line 180:\n{{\nif (count($tokens) > 1) {\nthrow exception;\n} }}\n\nI'm a bit confused on how the analyzer works because if the analyzer tokenizes words in cases of characters like an underscore or an '@'-sign *and* with plain spaces I would expect to get an exception in both cases. For some reason, it doesn't seem to tokenize the query \"foo bar*\" into 2 tokens where I would've expected it.\n\nNow, to work around this I could rerun the analyzer to check if the query got tokenized into multiple tokens. If the only 1 token is found i could append a wildcard (because my app requires it that way) and otherwise I should not append it.\n\nIs this just a limitation of the module or doesn't the analyzer work properly?\nPlease shine some light into this one :) Thanks!"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7688\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=alexander",
                "name": "alexander",
                "displayName": "Alexander Veremyev",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-7685",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7685",
                    "type": {
                        "name": "Duplicate",
                        "direction": "OUTBOUND",
                        "description": "duplicates"
                    }
                },
                {
                    "issueKey": "ZF-7738",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7738",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12174",
                    "filename": "multi-token-plus-dummy-indexer-highlighting.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-30T18:36:30.000+0000",
                    "size": 52761,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12174\/multi-token-plus-dummy-indexer-highlighting.patch"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12169",
                    "filename": "preprocessor_multi_token_awareness.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-28T09:00:55.000+0000",
                    "size": 9246,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12169\/preprocessor_multi_token_awareness.patch"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12173",
                    "filename": "preprocessor_multi_token_awareness_and_highlighting.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-30T14:56:43.000+0000",
                    "size": 11341,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12173\/preprocessor_multi_token_awareness_and_highlighting.patch"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/attachment\/12166",
                    "filename": "Term.php.patch",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-28T04:42:20.000+0000",
                    "size": 3729,
                    "mimeType": "text\/plain",
                    "content": "http:\/\/fw02.zend.com\/issues\/secure\/attachment\/12166\/Term.php.patch"
                }
            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10340",
                    "id": 10340,
                    "description": "Mini Release",
                    "name": "1.8.4",
                    "userReleaseDate": "23\/Jun\/09",
                    "archived": false,
                    "releaseDate": "2009-06-23",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10021",
                    "id": 10021,
                    "name": "Zend_Search_Lucene",
                    "description": "pure PHP robust, general purpose text search engine",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34000",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "I was able to reproduce this.\n\nquery parser turns \"foo_bar*\"  (with quotes) into\nZend_Search_Lucene_Search_Query_Boolean Object\n(\n    [_subqueries:private] => Array\n        (\n            [0] => Zend_Search_Lucene_Search_Query_Preprocessing_Phrase Object\n                (\n                    [_phrase:private] => foo_bar*\n                    [_phraseEncoding:private] => utf-8\n                    [_field:private] => \n                    [_slop:private] => \n                    [_matches:protected] => \n                    [_boost:private] => 1\n                    [_weight:protected] => \n                    [_currentColorIndex:private] => 0\n                )\n\n        )\n\n    [_signs:private] => Array\n        (\n            [0] => \n        )\n\n    [_resVector:private] => \n    [_coord:private] => \n    [_boost:private] => 1\n    [_weight:protected] => \n    [_currentColorIndex:private] => 0\n)\nwhich is ok. same with \"foo bar*\"\n\nfoo bar*  turns into\nZend_Search_Lucene_Search_Query_Boolean Object\n(\n    [_subqueries:private] => Array\n        (\n            [0] => Zend_Search_Lucene_Search_Query_Preprocessing_Term Object\n                (\n                    [_word:private] => foo\n                    [_encoding:private] => utf-8\n                    [_field:private] => \n                    [_matches:protected] => \n                    [_boost:private] => 1\n                    [_weight:protected] => \n                    [_currentColorIndex:private] => 0\n                )\n\n            [1] => Zend_Search_Lucene_Search_Query_Preprocessing_Term Object\n                (\n                    [_word:private] => bar*\n                    [_encoding:private] => utf-8\n                    [_field:private] => \n                    [_matches:protected] => \n                    [_boost:private] => 1\n                    [_weight:protected] => \n                    [_currentColorIndex:private] => 0\n                )\n\n        )\n\n    [_signs:private] => Array\n        (\n            [0] => \n            [1] => \n        )\n\n    [_resVector:private] => \n    [_coord:private] => \n    [_boost:private] => 1\n    [_weight:protected] => \n    [_currentColorIndex:private] => 0\n)\nwhich is ok too (of which both \"foo\" and \"bar*\" do not cause issues because each of them have a count($tokens) of 1 within Term.php line 182\n\n\"foo_bar*\" however leads to\nend_Search_Lucene_Search_Query_Boolean Object\n(\n    [_subqueries:private] => Array\n        (\n            [0] => Zend_Search_Lucene_Search_Query_Preprocessing_Term Object\n                (\n                    [_word:private] => foo_bar*\n                    [_encoding:private] => utf-8\n                    [_field:private] => \n                    [_matches:protected] => \n                    [_boost:private] => 1\n                    [_weight:protected] => \n                    [_currentColorIndex:private] => 0\n                )\n\n        )\n\n    [_signs:private] => Array\n        (\n            [0] => \n        )\n\n    [_resVector:private] => \n    [_coord:private] => \n    [_boost:private] => 1\n    [_weight:protected] => \n    [_currentColorIndex:private] => 0\n)\nthat leads to \"foo_bar\" being passed as argument 0 ($subPatterns[0]) in\nclass Zend_Search_Lucene_Search_Query_Preprocessing_Term line 180:\n$tokens = Zend_Search_Lucene_Analysis_Analyzer::getDefault()->tokenize($subPattern[0], $subPatternsEncoding);\nwhich leads to the following array:\n(\n    [0] => Zend_Search_Lucene_Analysis_Token Object\n        (\n            [_termText:private] => foo\n            [_startOffset:private] => 0\n            [_endOffset:private] => 3\n            [_positionIncrement:private] => 1\n        )\n\n    [1] => Zend_Search_Lucene_Analysis_Token Object\n        (\n            [_termText:private] => bar\n            [_startOffset:private] => 4\n            [_endOffset:private] => 7\n            [_positionIncrement:private] => 1\n        )\n\n)\nwhich has a count() of 2 and raises the above error!\n\n\n\nso basically it comes down to\n\nfoo bar* is interpreted as \nfoo OR bar*\n\nwhile\nfoo_bar* (doe to the space interpretation of _ in the analyzer but NOT by the query analyzer)\nis interpreted as something weird like (semantic wise)\n(foo OR bar)*\nwhich doesn't work.\n\n\nI run into the exact same symtom when building an analyzer that returned more than one result token for the same source token (synonyme analyzer) and accidentally using that on a query string.\n\nWork around: make sure no tokens in a query string contain characters that get interpreted as <space> by the analyzer OR set the default analyzer to a self written one that treats underscore and similar characters as non spaces\n\nfix: don't know, maybe change AnalyzerCommon's default behaviour regarding underscores ?\n\nI really hope this wiki software keeps my formatting or this will be really hard to read ;)\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-27T09:11:13.000+0000",
                    "updated": "2009-08-27T09:11:13.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34006",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "Hmm formatting is still semi ok.\n\nI wonder, why does Term.php do a tokenisation of the pattern in line 180, just to add all the tokens back together into one string in line 186, and in between complain if its more than one?\n\nI guess throwing the original error is valid because a search for foo_bar* would never succeed, since the index (due to _ being interpreted as space by the tokenizer) only stored\n\"foo\"\nand \"barblub\"\neven if the indexed text had \"foo_barblub\" in it\n\nso what the user really wanted \"foo_bar*\" to be turned to is not a query wildcard to \"foo_bar*\" but a\nZend_Search_Lucene_Search_Query_Phrase (\narray(\"foo\",\"bar*\")\n)\nwith bar* interpreted as a wildcard query.\n\nHOWEVER this is only true if (count($tokens) >1) because of \"foo_bar\" gets tokenized as two separate words due to a char interpreted as space.\n\nassuming you had a synonyme analyzer that had \"bar\" listed as synonyme for \"foo\"\n\nthen \"foo*\" would rise the same error in Term.php line 182 due to count=2\nhowever what the user wanted there is either\nfoo* OR bar*\nor\nfoo* without searching for bar\n\nhow to solve that? - I'd suggest to not use multi-token analyzers on query strings. Its unnecceasary if both variants are already stored in the index anyway.\nfoo_bar* could then be safely turned into a phrase search (if phrase searches containing wildcard queries is valid in itself, didn't test that ;)\n\n(I am currently working on a patch to submit that allows TokenFilters that create multiple tokens out of one, like Java Lucene does. I have the code working here, but I'm waiting for my CLA being approved ;)\n ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-27T09:39:11.000+0000",
                    "updated": "2009-08-27T09:39:11.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34034",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "The equivalent error occurs when doing a fuzzy search for something like\n\nmod_php~\n\nFatal error:  Uncaught exception 'Zend_Search_Lucene_Search_QueryParserException' with message 'Fuzzy search is supported only for non-multiple word terms' in \/home\/raven\/studium\/zendtest\/Zend\/Search\/Lucene\/Search\/Query\/Preprocessing\/Fuzzy.php:217\nStack trace:\n#0 Zend\/Search\/Lucene\/Search\/Query\/Preprocessing\/Fuzzy.php(130): Zend_Search_Lucene_Search_Query_Preprocessing_Fuzzy->rewrite(Object(Zend_Search_Lucene))\n#1 Zend\/Search\/Lucene\/Search\/Query\/Boolean.php(146): Zend_Search_Lucene_Search_Query_Preprocessing_Fuzzy->rewrite(Object(Zend_Search_Lucene))\n#2 Zend\/Search\/Lucene.php(905): Zend_Search_Lucene_Search_Query_Boolean->rewrite(Object(Zend_Search_Lucene))\n#3 [internal function]: Zend_Search_Lucene->find(Object(Zend_Search_Lucene_Search_Query_Boolean))\n#4 Zend\/Search\/Lucene\/Proxy.php(346): call_user_func_array(Array, Array)\n#5 index.php(355): Zend_Search_Lucene_Proxy->find in \/Zend\/Search\/Lucene\/Search\/Query\/Preprocessing\/Fuzzy.php on line 217",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-28T02:38:12.000+0000",
                    "updated": "2009-08-28T02:38:12.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34038",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "This patch fixes this issue for foo_bar* by returning a phrase query that has foo in position 0 and all possible matching terms for a bar* wildcard query in posion 1\n\nKnown bugs:\n\nA search for foo*_bar* will not raise the original error ( since the partial string \"_bar\" creates only one token with text \"bar\") therefore it will be turned into a wildcard query for foo*bar* as with the old code.\n\nfoo*bar* will not find foo_bar in the index since only foo and bar have been indexed.\n\nIt may be necessary to change the indicator when to split the pattern up into several. count($analyzer->tokenize()) seems to be a bad indicator since it will give 1 for a string like \"_foo\".\nPossible but hacky solution: test wether tokenize(\"x\".$x) leads to array(\"x\".$y) or array(\"x\",$y) (comma versus dot)\nMr Veremyev, what do you think?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-28T04:42:21.000+0000",
                    "updated": "2009-08-28T04:42:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34049",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "I added another patch. (preprocessor_multi_token_awareness.patch)\n\nIt adds complete multi token awareness to both the Fuzzy and the Term preprocessor, taking \n$token->getPositionIncrement() into account to create exact phrase queries in case a substring within a fuzzy or wildcard term gets tokenized into multiple tokens.\n\nI tested it briefly before posting on both the original foo_bar* problems as well as \"real\" alternative token scenarios (tokenizer returning two alternative tokens for the same string) and combinations of those.\n\nUnfortunately I did not come up with a more sensible test wether the first character in a \"subPattern\" is treated as a word boundary by the used analyzer, so I used the previously described hack :(\n\nDo you know a better way?\n\nMaybe trying to tokenize the first character only and see if there is a non empty result?\n(but then one has to worry about encoding and multibytenesses too)\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-28T09:00:55.000+0000",
                    "updated": "2009-08-28T09:00:55.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34087",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "Another patch.\n\nI fixed the test for wether the first character of a subPattern is tokenisable or not in a IMHO reasonable way.\n\nThere is a problem with the fixed pattern search however, which is, the existing highlighting code won't work.\n\nI need to take this as an opportunity to say that I heartly disagree with the way highlighting is done currently, because it duplicates functionality both in code and exection.\n\nIn a bad way.\n\nAnd A lot!\n\nWith the cascaded protected _highlightMatches() function within queries, simple queries (for example Query_Term) just highlight EXACT matches, thus needing the $document->highlight function to tokenize the entire document.\n\nFor every single query term.\n\nWorse, with complicated tokens like Fuzzy or Wildcard, the Query's highlight function itself has to tokenize the document AGAIN to find matches - for every single Fuzzy\/Wildcard term - which then are given back to the highlighter class to tokenize the document AGAIN to finally highlight them.\n\nEverywhere and all the _highlightMatches() function also duplicates the functionality of rewrite(), doing more or less the same things and stumbling over the same pitfalls (mostly in combination with strings that create multiple tokens)\n\nIn practice (as in production setup) I had cases where the search took 3 seconds, and the highlighting of 10 relatively short result excerpts kept the servers CPU busy for 40!!! seconds. That is completely and utterly unusable for a production web application (I have to say though,  there were quite many terms in that index due to a synonym plus stem analyzer being used (around 100k terms)\n\n\nIt would be easier (and faster) to just INDEX the to be highlighted document into a temporary In-Memory Lucene Index, and then rewrite the query and feed $query->getQueryTerms() to the $highlighter.\n\nBut in practice even that would be overkill.\nIn 99.99% of the cases the to be highlighted text is text stored somewhere in the index ANYWAY, since the to be highlighted text is part of a document originally indexed, AKA a search result.\nSo calling $query->rewrite() with the search index would provide all the required data to highlight the result.\n\nI used this approach in this patch.\nPro: It fixes highlighting: Everything the query finds is also highlighted succesfully\nContra: It changes the API: Calling highlightMatches() on a non-rewritten query will rise an exception.\n\nBetter probably would be to do the temporary indexing solution mentioned above.\n\nIn practice (as in my production setup)  I went one step further. We didn't even use the DocumentHTML class for highlighting, the highlighting code instead called:\n\n$analyzer->tokenize() on the to be highlighted document ONCE and stored the result in an array.\n\nThen I called $query()->rewrite()->getQueryTokens() and stored that in a second array.\n\nPHP's array_intersect() gives me all the tokens matched in the to be highlighted text. Including their string positions.\nAll thats needed is to use mb_substr() (its multi-byte safe - unlike the original DocumentHTML highlight code!) on the original texts to get the raw, non tokenized versions of the to be highligted words.\n\na simple preg_replace later and the text is highlighted. No DOM class involved. (But thats up to the user of course)\n\nSpeedup between Lucene's Highlighter and mine with the same 10 documents and the same index: 40 seconds went down to 0.8, thats factor 50!\n\nAll in all this tells me, Zend Lucene needs some serieous internal redesign as far as highlighting goes. BADLY.\n\nSo I don't really care wether my fix currently breaks the original highlighting code ;)\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-30T14:56:45.000+0000",
                    "updated": "2009-08-30T14:56:45.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34088",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "Ok. Highlighting - new style :)\n\nThis patch gets rid of all protected _highlightMatches() functions in all Queries\n\nQuery->highlightmatches and htmlFragmentHighlightMatches() now create a new \"dummy\" index\n(class Zend_Search_Lucene_TempIndex)\nwhich has the ability to temporarily store a single document (or a few documents)\nwhich is promptly added via addDocument() from the provided HTML code\n(which correctly tokenizes said document using the default-analyzer and stores found terms in an array)\n\nthen $query->rewrite(...) is called with this index, to rewrite the query based on the dummy index containing only the terms found in the to be highlighted text.\n\nwhich then are forwarded to the highlighter itself.\n\nI didn't test it with range queries though, but from how Range->rewrite() looks, all needed functions are supported, too.\n\nHenceforth multi-terms should no longer be a problem >:)\n\nCode might need cleanup and some alterations to be conformous with Zend and Lucene coding rules and policies, though I tried to keep it tidy ;)\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-30T18:36:30.000+0000",
                    "updated": "2009-08-30T18:36:30.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/34104",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "body": "I put the patches fixing this bug into seperate issues ( ZF-7738, ZF-7736 ) , since they somehow outgrew the context of this particular issue.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=corvuscorax",
                        "name": "corvuscorax",
                        "displayName": "Corvus Corax",
                        "active": true
                    },
                    "created": "2009-08-31T10:18:41.000+0000",
                    "updated": "2009-08-31T10:18:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/47908",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=sylvestre",
                        "name": "sylvestre",
                        "displayName": "Sylvestre Ledru",
                        "active": true
                    },
                    "body": "Is there any chance that, one day, this bug could be fixed ? \r\nI have many users who are complaining about the underscore breaking the search ...\r\n\r\nWhat kind of alternatives are available to Zend Lucene ?\r\n\r\nThanks",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=sylvestre",
                        "name": "sylvestre",
                        "displayName": "Sylvestre Ledru",
                        "active": true
                    },
                    "created": "2011-08-09T15:29:05.000+0000",
                    "updated": "2011-08-09T15:29:05.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7688\/transitions"
}