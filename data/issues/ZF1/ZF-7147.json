{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7147",
    "key": "ZF-7147",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "when drawing text, allow to align text on left\/right\/center it"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7147\/votes",
                "votes": 6,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=remy215",
                "name": "remy215",
                "displayName": "Remy Damour",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-06-27T17:04:28.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T21:37:27.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Hi,\n\nI felt the need to subclass Zend_Pdf_Page::drawText() to add possibility to align text on right (instead of left as default behaviour) or to center it horizontally.\nIt would be real great to have it handled natively by ZF, it would increase a lot flexibility on pdf generation.\n\nBelow is the code used (it requires to be able to retrieve width of text to be drawn and makes use of code presented in ZF-7146).\n{code}<?php\nrequire_once 'Zend\/Pdf.php';\n\n\/**\n * Represent an order\/bill pdf\n *\/\nclass Library_Pdf_Base extends Zend_Pdf\n{\n\t\/**\n\t * Align text at left of provided coordinates\n\t *\/\n\tconst TEXT_ALIGN_LEFT = 'left';\n\t\n\t\/**\n\t * Align text at right of provided coordinates\n\t *\/\n\tconst TEXT_ALIGN_RIGHT = 'right';\n\t\n\t\/**\n\t * Center-text horizontally within provided coordinates\n\t *\/\n\tconst TEXT_ALIGN_CENTER = 'center';\n\t\n\t\/**\n\t * Extension of basic draw-text function to allow it to vertically center text\n\t *\n\t * @param Zend_Pdf_Page $page\n\t * @param string $text\n\t * @param int $x1\n\t * @param int $y1\n\t * @param int $x2\n\t * @param int $position\n\t * @param string $encoding\n\t * @return self\n\t *\/\n\tpublic function drawText(Zend_Pdf_Page $page, $text, $x1, $y1, $x2 = null, $position = self::TEXT_ALIGN_LEFT, $encoding = null)\n\t{\n\t\t$bottom = $y1; \/\/ could do the same for vertical-centering\n\t\t\n\t\tswitch ($position) {\n\t\t\tcase self::TEXT_ALIGN_LEFT:\n\t\t\t\t$left = $x1;\n\t\t\t\tbreak;\n\t\t\tcase self::TEXT_ALIGN_RIGHT:\n\t\t\t\t$text_width = $this->getTextWidth($text, $page->getFont(), $page->getFontSize());\n\t\t\t\t$left = $x1 - $text_width;\n\t\t\t\tbreak;\n\t\t\tcase self::TEXT_ALIGN_CENTER:\n\t\t\t\tif (null === $x2) {\n\t\t\t\t\tthrow new Exception(\"Cannot center text horizontally, x2 is not provided\");\n\t\t\t\t}\n\t\t\t\t$text_width = $this->getTextWidth($text, $page->getFont(), $page->getFontSize());\n\t\t\t\t$box_width = $x2 - $x1;\n\t\t\t\t$left = $x1 + ($box_width - $text_width) \/ 2;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tthrow new Exception(\"Invalid position value \\\"$position\\\"\");\n\t\t}\n\t\t\n\t\t\/\/ display multi-line text\n\t\tforeach (explode(PHP_EOL, $text) as $i => $line) {\n\t\t\t$page->drawText($line, $left, $bottom - $i * $page->getFontSize(), $encoding);\n\t\t}\n\t\treturn $this;\n\t}\n\t\n\t\/**\n\t * Return length of generated string in points\n\t *\n\t * @param string $string\n\t * @param Zend_Pdf_Resource_Font $font\n\t * @param int $font_size\n\t * @return double\n\t *\/\n\tpublic function getTextWidth($text, Zend_Pdf_Resource_Font $font, $font_size) \n\t{\n\t\t$drawing_text = iconv('', 'UTF-16BE', $text);\n\t\t$characters    = array();\n\t\tfor ($i = 0; $i < strlen($drawing_text); $i++) {\n\t\t\t$characters[] = (ord($drawing_text[$i++]) << 8) | ord ($drawing_text[$i]);\n\t\t}\n\t\t$glyphs        = $font->glyphNumbersForCharacters($characters);\n\t\t$widths        = $font->widthsForGlyphs($glyphs);\n\t\t$text_width   = (array_sum($widths) \/ $font->getUnitsPerEm()) * $font_size;\n\t\treturn $text_width;\t\n\t}\n}{code}\n\nSo far it did the job for me. We could even go further and add an $y2 argument to the function to allow to center text vertically too.\nThis is extremely useful when drawing table cells, if we want to center our text within cell (both horizontally & vertically).\n\nAlong with ZF-7145 which extend ::drawText() to render multi-line text, it improves a lot text-drawing functionnalities of Zend_Pdf.\n\nRegards,\nRemy\n\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7147\/watchers",
                "isWatching": false,
                "watchCount": 5
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10340",
                    "id": 10340,
                    "description": "Mini Release",
                    "name": "1.8.4",
                    "userReleaseDate": "23\/Jun\/09",
                    "archived": false,
                    "releaseDate": "2009-06-23",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10020",
                    "id": 10020,
                    "name": "Zend_Pdf",
                    "description": "pure PHP manipulation engine for composing PDFs",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/32236",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=remy215",
                        "name": "remy215",
                        "displayName": "Remy Damour",
                        "active": true
                    },
                    "body": "normally I would have extended Zend_Pdf_Page instead of Zend_Pdf, but as stated in http:\/\/framework.zend.com\/issues\/browse\/ZF-7144, subclasses of Zend_Pdf_Page are hard to transparently use with Zend_Pdf => as a quick fix I subclassed Zend_Pdf and thus add extra first argument to function call (Zend_Pdf_Page $page).",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=remy215",
                        "name": "remy215",
                        "displayName": "Remy Damour",
                        "active": true
                    },
                    "created": "2009-06-27T17:43:27.000+0000",
                    "updated": "2009-06-27T17:43:27.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35160",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=neraath",
                        "name": "neraath",
                        "displayName": "Christopher Weldon",
                        "active": true
                    },
                    "body": "I'm gonna have to say this particular implementation is *very* useful. I just implemented it on a project and it seems to be working fairly well. There are some standards violations in it that require correction, but I'm definitely voting to include this on the next minor release. ",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=neraath",
                        "name": "neraath",
                        "displayName": "Christopher Weldon",
                        "active": true
                    },
                    "created": "2009-10-11T12:23:54.000+0000",
                    "updated": "2009-10-11T12:23:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/35962",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fernando_mm",
                        "name": "fernando_mm",
                        "displayName": "Fernando Morgenstern",
                        "active": true
                    },
                    "body": "Are there any plans to include this on the next ZF version? It is indeed really useful!",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fernando_mm",
                        "name": "fernando_mm",
                        "displayName": "Fernando Morgenstern",
                        "active": true
                    },
                    "created": "2009-11-12T07:46:14.000+0000",
                    "updated": "2009-11-12T07:46:14.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/39238",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quintinventer",
                        "name": "quintinventer",
                        "displayName": "Quintin Venter",
                        "active": true
                    },
                    "body": "This code helped me a lot when I needed to create pdfs with aligned text. Thanks Remy.\r\n\r\nI got a text wrapper from the following blog http:\/\/blog.alfbox.net\/index.php\/2008\/06\/04\/wrapping-text-for-zend-pdf\/.\r\n\r\nWith these two examples I could create pdfs with wrapping text that could also align left, right and center. There was a minor issue with the center text as a very long string would calculate a negative value for the left x coordinate.\r\n\r\nI had to move the loop at the bottom of the function up to make up for this so that each individual line would get recalculated.\r\n\r\nExample code to follow:\r\n\r\n{code}\r\ncase self::TEXT_ALIGN_CENTER:\r\n\t\r\n\tif (null === $x2) {\r\n\t\tthrow new Exception('Cannot center text horizontally, x2 is not provided for function drawText.');\r\n\t}\r\n\t\/\/ we run the for each here as the x coord for each line needs to be recalculated\r\n\tforeach ( explode( PHP_EOL, $sText ) as $i => $sLine ) {\r\n\t\r\n\t\t$iTextWidth = $this->getTextWidth( $sLine, $page->getFont(), $page->getFontSize() );\r\n\t\t$box_width = $x2 - $x1;\r\n\t\t$iLeft = $x1 + (($box_width - $iTextWidth) \/ 2);\r\n\t\t\r\n\t\t$page->drawText( $sLine, $iLeft, $iBottom - $i * $page->getFontSize(), $encoding );\r\n\t}\r\n\treturn $this;\r\n\tbreak;\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=quintinventer",
                        "name": "quintinventer",
                        "displayName": "Quintin Venter",
                        "active": true
                    },
                    "created": "2010-03-15T08:24:56.000+0000",
                    "updated": "2010-03-15T08:24:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40527",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fozzyuw",
                        "name": "fozzyuw",
                        "displayName": "John Bertucci",
                        "active": true
                    },
                    "body": "Just a note, while Remy's code is very useful, it is not multi-byte character safe.  Special characters such as the trademark sign will throw off the size calculation and the alignment won't line-up anymore.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fozzyuw",
                        "name": "fozzyuw",
                        "displayName": "John Bertucci",
                        "active": true
                    },
                    "created": "2010-05-18T07:02:40.000+0000",
                    "updated": "2010-05-18T07:02:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/40529",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fozzyuw",
                        "name": "fozzyuw",
                        "displayName": "John Bertucci",
                        "active": true
                    },
                    "body": "Just as a follow up (as I work to understand how this Zend_PDF works with regards to fonts and widths) it appears it might not be Remy's code, per say, that's at fault, but the Zend_Pdf_Resource_Font class\/functions.\r\n\r\nI ran two test words \"T E S T\" and \"T \u00c9 S T\" and looked that the results of the functions \"glyphNumbersForCharacters\" and \"widthsForGlyphs\" that Zend_Pdf_Resource_Font returns:\r\n\r\n\tglyphNumbersForCharacters\twidthsForGlyphs\t\tglyphNumbersForCharacters\twidthsForGlyphs\r\nT\t53\t611\tT\t53\t611\r\n\t1\t278\t\t1\t278\r\nE\t38\t667\t\u00c9\t293\t722\r\n\t\t\t\t122\t1000\r\n\t1\t278\t\t1\t278\r\nS\t52\t667\tS\t52\t667\r\n\t1\t278\t\t1\t278\r\nT\t53\t611\tT\t53\t611\r\n\t\t\t\t\t\r\ntotal width\t\t3390\t\t\t4390\r\n\r\nWhat you can see is, special characters (I've tried this on \u00c9 (E with accent acute), \u00a9 (copyright), \u2122 (trademark), \u2022 (bullet), and they all have similar results.\r\n\r\nBoth functions see these special characters as multiple characters.  In the above example, '\u00c9' is assigned a glyph number 293 and 122.  The first glyph's size is larger than the non-accented \"E\" by 55.  On top of that, it adds an additional 1000 width by adding that extra glyph space.\r\n\r\nEnd result... Remy's code breaks because because of these special characters.  The issue seems to be with the Zend_Pdf_Resource_Font class and these functions.  Logically, Remy's code works.  However, it could be misunderstanding what it should expect from the glyph functions or the glyph functions aren't working right.\r\n\r\nI would think, for a special character like '\u00c9', you should get a different glyph number (293 instead of 38) but it should have the same width of 'E' and there shouldn't be an extra glyph added.\r\n\r\nI've not looked at how these functions work, I'll be doing that next, but I'm not sure I'll know what's going on at that point.  There might need to be a different way to determine the size of a given string.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fozzyuw",
                        "name": "fozzyuw",
                        "displayName": "John Bertucci",
                        "active": true
                    },
                    "created": "2010-05-18T08:06:01.000+0000",
                    "updated": "2010-05-18T08:06:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/41236",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kingkarl85",
                        "name": "kingkarl85",
                        "displayName": "Karl Mikkelsen",
                        "active": true
                    },
                    "body": "i don't think you should extend drawText as this will break all existing code hooking into (param changes).\r\n\r\nI would be inclined to call this drawTextBox and link in the multi line code and introducte a $y2 for the height component.\r\n\r\nThis would make things very flexible as you would be using the regular draw text to produce the line.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=kingkarl85",
                        "name": "kingkarl85",
                        "displayName": "Karl Mikkelsen",
                        "active": true
                    },
                    "created": "2010-06-28T18:29:38.000+0000",
                    "updated": "2010-06-28T18:29:38.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-7147\/transitions"
}