{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6352",
    "key": "ZF-6352",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Cache::save() encoding problem"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6352\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/6",
                "name": "Not an Issue"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2009-04-20T10:51:04.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=teuzz",
                "name": "teuzz",
                "displayName": "Jiri Helmich",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2009-04-20T01:43:46.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2009-05-01T00:32:28.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Cache",
                "Paginator"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "When using Zend_Cache::start() to save a paginator object, encoding of stored db query result gets broken (originally UTF-8).\n\nif (!$this->view->frontPageArticles = $this->_cache->load('frontPageArticles'))\n{\n\t$content = new CMS_Model_Content();\n\t$this->view->frontPageArticles = $content->getFrontpageContent($this->_params['page']); \/\/gets Zend_Paginator object\n\t$this->_cache->save($this->view->frontPageArticles,'frontPageArticles');\t\t\t\t\n}\n\nWhen the last line of code is commented (and cache purged), everything is ok (chars like \u011b\u0161\u010d\u0159... are displayed correctly).\n\nZF 1.8"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6352\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                "name": "fab",
                "displayName": "Fabien MARTY",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10028",
                    "id": 10028,
                    "name": "Zend_Cache",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30279",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "body": "please provide a little piece of code to reproduce the problem because there is already a unit test about UTF8 into cache records and there is no problem about it\n\nI close this issue because I think that you have an HTTP header problem or something like that. With default configuration, Zend_Cache_Frontend_Page does not save the \"content-type\" http header (but there are some options to do that) and IMHO your problem is here.\n\nIf I'm wrong, please reopen this issue with a little piece of code to reproduce your UTF8 problem.\n\nRegards\n\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "created": "2009-04-20T10:51:00.000+0000",
                    "updated": "2009-04-20T10:51:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30285",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=teuzz",
                        "name": "teuzz",
                        "displayName": "Jiri Helmich",
                        "active": true
                    },
                    "body": "Well, as you can see here: http:\/\/frontend.pctuning.cz\/ , there isn't a problem with whole page but only with the content touched by Zend_Cache (the main article, which is, I think, clear).\n\nThe code:\n\n1) Bootstrap:\n\n$cache = Zend_Cache::factory(\n\t\t\t'Core',\n\t\t\t'File',\n\t\t\tarray(\n\t\t\t\t'lifetime' => (15*60),\n\t\t\t\t'automatic_serialization' => true,\n\t\t\t\t'caching' => CACHE_ENABLED\n\t\t\t),\n\t\t\tarray(\n\t\t\t\t'cache_dir' => '..\/store\/cache\/'\n\t\t\t)\n\t\t);\nZend_Registry::set('MainCache',$cache);\n\n2) Controller:\n\nprivate $_cache;\n\t\n\tpublic function init()\n\t{\n\t\t$this->_params = $this->getRequest()->getUserParams();\n\t\t$this->_cache = Zend_Registry::get('MainCache');\n\t}\n\t\n\tpublic function indexAction()\n\t{\n\t\t\n\t\tif (!$this->view->frontPageArticles = $this->_cache->load('frontPageArticles'))\n\t\t{\n\t\t\t$content = new CMS_DbTable_Content();\n\t\t\t$this->view->frontPageArticles = $content->getFrontpageContent($this->_params['page']);\n\t\t\t$this->_cache->save($this->view->frontPageArticles,'frontPageArticles');\t\t\t\t\n\t\t} \n\t}\n\n3) CMS_DbTable_Content\n\npublic function getFrontpageContent($page = 0)\n\t\t{\n\t\t\t\n\t\t\t$select = $this->select();\n\t\t\t$select->setIntegrityCheck(false);\n\t\t\t\n\t\t\t$select->from('content')\n\t\t\t\t\t->joinInner(\n\t\t\t\t\t\t'content_frontpage',\n\t\t\t\t\t\t'content_frontpage.content_id = content.id',\n\t\t\t\t\t\tarray()\n\t\t\t\t\t)\n\t\t\t\t\t->order('content.created DESC')\n\t\t\t\t\t->where('content.state = 1');\n\t\t\t\t\t\n\t\t\t\t\t$paginator = new Zend_Paginator(new Zend_Paginator_Adapter_DbTableSelect($select));\n\t\t\t\t\t$paginator->setItemCountPerPage(15);\n\t\t\t\t\t$paginator->setCurrentPageNumber($page);\n\t\t\t\t\t\n\t\t\treturn $paginator;\n\t\t\t\n\t\t}\n\nSo as you can see, I do not cache whole page but only the returned paginator object - if I'm right, the query is proccessed after calling getCurrentItems(), so I do not really cache any data from database, so that's more weird that the data I get after calling getCurrentItems are broken.\n\nAnd I did not forget to call set names utf-8 :-)",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=teuzz",
                        "name": "teuzz",
                        "displayName": "Jiri Helmich",
                        "active": true
                    },
                    "created": "2009-04-20T14:56:47.000+0000",
                    "updated": "2009-04-20T14:56:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30304",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "body": "I don't know. Your code is too complex. I can't reproduce this on my linux box.\n\nCan you try a unit test :\n- you save UTF8 chars into a cache record\n- you read this cache record\n\nthen you compare these two strings",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "created": "2009-04-21T12:30:58.000+0000",
                    "updated": "2009-04-21T12:30:58.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30529",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=tt",
                        "name": "tt",
                        "displayName": "TT",
                        "active": true
                    },
                    "body": "I can confirm this issue. If you save a Zend_Paginator object in the cache (I only tested file cache), the result that is loaded from the cache has messed up UTF-8 encoded strings.\n\n\n{noformat} \n$frontendOptions = array(\n   'caching' => true,\n   'lifetime' => 7200, \n   'automatic_serialization' => true\n);\n\n$backendOptions = array(\n    'cache_dir' => 'cache\/' \n);\n\n$cache = Zend_Cache::factory('Core', 'File', $frontendOptions, $backendOptions);\n\n\/\/Zend_Db_Table_Select object\n$select = $this->select();\n\n$paginator = Zend_Paginator::factory($select );\n$paginator->setItemCountPerPage(10);\n$paginator->setCurrentPageNumber(1);\n\n$cache->save($paginator, 'a_cache_id');\n\n$cachedPaginator = $cache->load('a_cache_id');\n{noformat} \n\n\nThe UTF-8 chars in $paginator are fine, in $cachedPaginator they are messed up.\n",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=tt",
                        "name": "tt",
                        "displayName": "TT",
                        "active": true
                    },
                    "created": "2009-04-29T18:54:18.000+0000",
                    "updated": "2009-04-29T18:54:18.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30563",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "body": "I suppose this is a Zend_Paginator or a Zend_Db_Table_Select or a serialize() issue.\n\nCan you try in your configuration to store UTF8 chars (with automatic_serialization = false) and without other objects (only UTF8 chars !) and to retrieve them from cache ?\n\nthanks",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "created": "2009-04-30T10:58:17.000+0000",
                    "updated": "2009-04-30T10:58:17.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30564",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "body": "after reading http:\/\/fr.php.net\/unserialize comments about utf8\n\nI think it's a unserialize() issue\n\nplease do the little test I propose in my last comment\n\nand do it also with automatic_serialization = true",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "created": "2009-04-30T11:00:19.000+0000",
                    "updated": "2009-04-30T11:00:19.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30576",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=tt",
                        "name": "tt",
                        "displayName": "TT",
                        "active": true
                    },
                    "body": "I did some more testing and it seems to have to do with serialization, probably the Zend_Db_Table_Select and not the Zend_Paginator. I only tested with Zend_Paginator using a  Zend_Db_Table_Select though.\n\nThis is strange:\n\nApparently serializing a Zend_Paginator object that includes a result of a Zend_Db_Table_Select breaks the UTF-8.\n{noformat} \n$paginatorObject = serialize($paginatorObject );\t\n$paginatorObject = unserialize($paginatorObject );\n\n\/\/broken UTF-8\nforeach ($paginatorObject as $result) {\n\tvar_dump($result);\n}\n{noformat} \n\nNow the funny part. If we iterate over the paginator result right before serializing it, the UTF-8 will NOT be broken!\n{noformat} \n\/\/itareate to preserve UTF-8\nforeach ($paginatorObject as $result) {\n}\t\n\n$paginatorObject = serialize($paginatorObject );\t\n$paginatorObject = unserialize($paginatorObject );\n\n\/\/working UTF-8\nforeach ($paginatorObject as $result) {\n\tvar_dump($result);\n}\n{noformat} \n\nBasically this is my dirty quick fix for now. Right before I save the paginator object in the cache, I iterate over it once.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=tt",
                        "name": "tt",
                        "displayName": "TT",
                        "active": true
                    },
                    "created": "2009-04-30T19:16:41.000+0000",
                    "updated": "2009-04-30T19:16:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/30578",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "body": "So, it is not a Zend_Cache issue.\n\nMaybe open a new one for Zend_Paginator ?\n\nMaybe, try with the latest version of PHP before",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=fab",
                        "name": "fab",
                        "displayName": "Fabien MARTY",
                        "active": true
                    },
                    "created": "2009-05-01T00:32:16.000+0000",
                    "updated": "2009-05-01T00:32:16.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-6352\/transitions"
}