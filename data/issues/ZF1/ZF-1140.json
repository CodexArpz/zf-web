{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1140",
    "key": "ZF-1140",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Support sequences and natural keys on insert()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1140\/votes",
                "votes": 2,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "resolution": {
            "name": "resolution",
            "type": "com.atlassian.jira.issue.resolution.Resolution",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/resolution\/1",
                "name": "Fixed"
            }
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10080",
                    "id": 10080,
                    "description": "Beta Release; bug fixes",
                    "name": "0.9.3",
                    "userReleaseDate": "05\/May\/07",
                    "archived": true,
                    "releaseDate": "2007-05-05",
                    "released": true
                }
            ]
        },
        "resolutiondate": {
            "name": "resolutiondate",
            "type": "java.util.Date",
            "value": "2007-05-03T17:26:17.000+0000"
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                "name": "bkarwin",
                "displayName": "Bill Karwin",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2007-03-26T16:05:21.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2007-07-05T14:43:59.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Oracle, DB2, and PostgreSQL use sequences instead of auto-increment or identity columns.\n\nBut Zend_Db_Table assumes that after an INSERT, the lastInsertId() method returns the most recently generated value for the current table.\n\nThis improvement consists of the following:\n- Define abstract methods lastSequenceId() and nextSequenceId() in the Zend_Db_Adapter_Abstract class.  Adapters that do not support sequences should throw an exception if these methods are called.\n- In Zend_Db_Table_Abstract, add a protected class variable $_sequence.  If this is Boolean true, then use auto-increment; if this is boolean false, then user is responsible for setting primary key values (throw exception if no values specified); if this is a string, use this as the name of the sequence in the Zend_Db_Table::insert() method, generate a value, use it in the INSERT, and return it from insert().\n\nThe default value of $_sequence is true, for backward compatibility (and probably the more common cases).\n\nIn PostgreSQL and Oracle, which require named sequences, the user must define the sequence by setting $_sequence to a string value in his Table class, or else the variable must be Boolean false.\n\nIn DB2, which permits either explicit named sequences or else the table DDL can include the name of a sequence to use for generating values, the user may define $_sequence to a name, or else he may set it to Boolean values true or false.\n\nIn Microsoft SQL Server, MySQL, and SQLite, the user may only set the $_sequence variable to Boolean values true or false."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1140\/watchers",
                "isWatching": false,
                "watchCount": 3
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/5",
                "name": "Resolved"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                "name": "bkarwin",
                "displayName": "Bill Karwin",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [
                {
                    "issueKey": "ZF-78",
                    "issue": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-78",
                    "type": {
                        "name": "Related",
                        "direction": "INBOUND",
                        "description": "is related to"
                    }
                }
            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10060",
                    "id": 10060,
                    "description": "Beta Release; bug fixes",
                    "name": "0.9.1",
                    "userReleaseDate": "23\/Mar\/07",
                    "archived": true,
                    "releaseDate": "2007-03-23",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10133",
                    "id": 10133,
                    "name": "Zend_Db_Table",
                    "description": "Lightweight OO interface to database tables and rowsets.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13914",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gearhead",
                        "name": "gearhead",
                        "displayName": "Bryce Lohr",
                        "active": true
                    },
                    "body": "Currently, Zend_Db_Adapter_Abstract::lastInsertId() has optional parameters. The Pgsql adapter class uses these optional parameters to effectively define the sequence name to use. So, calling lastInsertId() will return the last value used by the given sequence. Do the improvements suggested in this issue break or change the current behavior?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=gearhead",
                        "name": "gearhead",
                        "displayName": "Bryce Lohr",
                        "active": true
                    },
                    "created": "2007-04-03T12:47:00.000+0000",
                    "updated": "2007-04-03T12:47:00.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13918",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "There should be no breakage to current functionality.  The proposed solution would add new methods lastSequenceId($sequenceName) and nextSequenceId($sequenceName).\n\nThe behavior of the current lastInsertId([$tableName, [$primaryKey]]) would allow the arguments to form a sequence name by the current conventional format, and then call lastSequenceId() with the synthesized sequence name.  \n\nBut in addition, if you have a sequence with a name that doesn't match the conventional format, you can call lastSequenceId() directly, passing the name of your sequence.\n\nThe behavior in the Zend_Db_Table_Abstract::insert() method would be to call lastSequenceId() directly, if is_string($this->_sequence) is true.  So in your table class, you'd have to declare the name of the sequence explicitly.  This also would not break backward compatibility, because the way it is implemented currently, I don't think the Table class's insert() method can work with PostgreSQL\/Oracle\/DB2 anyway.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-04-03T14:09:47.000+0000",
                    "updated": "2007-04-03T14:09:47.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/13929",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "Revision 4335 contains some clean-up to the lastInsertId() method, and new methods lastSequenceId() and nextSequenceId().",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-04-03T15:16:30.000+0000",
                    "updated": "2007-04-03T15:16:30.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14159",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mfcn",
                        "name": "mfcn",
                        "displayName": "Manuel Ferreira",
                        "active": true
                    },
                    "body": "I guess the value of $_sequencename attribute may be defined in method Zend_Db_Adapter_Pdo_Pgsql::describeTable() changing the string sql to add the sequence name of primary key as below:\n\n{code}\npublic function describeTable($tableName, $schemaName = null)\n    {\n        $sql = \"SELECT\n                a.attnum,\n                n.nspname,\n                c.relname,\n                a.attname AS colname,\n                t.typname AS type,\n                a.atttypmod,\n                FORMAT_TYPE(a.atttypid, a.atttypmod) AS complete_type,\n                d.adsrc AS default_value,\n                a.attnotnull AS notnull,\n                a.attlen AS length,\n                co.contype,\n                ARRAY_TO_STRING(co.conkey, ',') AS conkey,\n+             CASE WHEN co.contype = 'p' THEN\n+                          (SELECT relname FROM pg_class WHERE reltype = (CAST(a.attrelid AS int) - 1))\n+             ELSE ''\n+             END AS sequencename\n            FROM pg_attribute AS a\n                JOIN pg_class AS c ON a.attrelid = c.oid\n                JOIN pg_namespace AS n ON c.relnamespace = n.oid\n                JOIN pg_type AS t ON a.atttypid = t.oid\n                LEFT OUTER JOIN pg_constraint AS co ON (co.conrelid = c.oid\n                    AND a.attnum = ANY(co.conkey) AND co.contype = 'p')\n                LEFT OUTER JOIN pg_attrdef AS d ON d.adrelid = c.oid AND d.adnum = a.attnum\n            WHERE a.attnum > 0 AND c.relname = \".$this->quote($tableName);\n\n        if ($schemaName) {\n            $sql .= \" AND n.nspname = \".$this->quote($schemaName);\n        }\n        ...\n}\n\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mfcn",
                        "name": "mfcn",
                        "displayName": "Manuel Ferreira",
                        "active": true
                    },
                    "created": "2007-04-12T14:02:54.000+0000",
                    "updated": "2007-04-12T14:02:54.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14413",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "Revisions 4642, 4643, 4644, 4645 contain code and unit tests to support sequences for Oracle, PostgreSQL, and DB2.\n\nThere are still some stubbed-out unit tests for supporting natural keys.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-05-01T13:34:27.000+0000",
                    "updated": "2007-05-01T13:34:27.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14418",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "Manuel, I guess the change you show is meant to use a sequence that is \"owned\" by a specific column of a specific table, as would be created implicitly by declaring a column with the SERIAL pseudotype.\n\nMy understanding is that it is not necessary to gather this information; if you are using an implicitly-created sequence with a SERIAL column, simply insert NULL to the column or omit the column from the column-list in an INSERT.  The sequence is invoked automatically by the PostgreSQL server and the next value is generated.\n\nThe usage that I'm implementing to declare the name of the sequence as a string is intended for cases where you do not have a SERIAL column, but instead you are using a sequence *explicitly*.  This matches typical usage in Oracle, for example.  It's useful if you want one sequence to generate values for multiple tables.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-05-01T15:57:03.000+0000",
                    "updated": "2007-05-01T15:57:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/14446",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "body": "This is now complete.  As of revision 4697.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=bkarwin",
                        "name": "bkarwin",
                        "displayName": "Bill Karwin",
                        "active": true
                    },
                    "created": "2007-05-03T17:26:17.000+0000",
                    "updated": "2007-05-03T17:26:17.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-1140\/transitions"
}