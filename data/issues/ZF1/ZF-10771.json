{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10771",
    "key": "ZF-10771",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "SMTP Login Enable support for \"you are already authenticated\""
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10771\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wade.womersley",
                "name": "wade.womersley",
                "displayName": "Wade Womersley",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2010-12-03T03:15:26.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-11-20T21:37:52.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels"
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Just found a bug in Zend_Mail_Protocol_Smtp_Auth_Login where if you are already authenticated the login fails which causes emails to not be sent. The error is in the auth() function where after sending AUTH LOGIN it expects a 334 response code. Looking at the latest release that seems to have fixed Zend_Mail_Protocol_Abstract's issue of not returning the full message. I decided the best solution would be to add the return code to the exception thrown by _expect and catch it in Auth_Login.\r\nh3. Zend_Mail_Protocol_Abstract\r\n*throw new Zend_Mail_Protocol_Exception($errMsg);* -> *throw new Zend_Mail_Protocol_Exception($errMsg, $cmd);*\r\n\r\nh3. Zend_Mail_Protocol_Smtp_Auth_Login\r\n{code}\r\n    public function auth()\r\n    {\r\n        \/\/ Ensure AUTH has not already been initiated.\r\n        parent::auth();\r\n        \r\n        $this->_send('AUTH LOGIN');\r\n        \r\n        try\r\n        {\r\n            $response = $this->_expect(334);\r\n        }\r\n        catch(Zend_Mail_Protocol_Exception $ex)\r\n        {\r\n            if($ex->getCode() == 503 && strpos($ex->getMessage(), 'authenticated') !== false)\r\n            {\r\n                $this->_auth = true;\r\n                return;\r\n            }    \r\n        }\r\n        \r\n        $this->_send(base64_encode($this->_username));\r\n        $this->_expect(334);\r\n        $this->_send(base64_encode($this->_password));\r\n        $this->_expect(235);\r\n        $this->_auth = true;\r\n    }\r\n{code}"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10771\/watchers",
                "isWatching": false,
                "watchCount": 1
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [

            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User"
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10501",
                    "id": 10501,
                    "description": "Mini Release",
                    "name": "1.11.1",
                    "userReleaseDate": "30\/Nov\/10",
                    "archived": false,
                    "releaseDate": "2010-11-30",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10018",
                    "id": 10018,
                    "name": "Zend_Mail",
                    "description": "high-level utility to build MIME-compliant messages and send using a mail transport adapter",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43436",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "body": "Hi Wade.  Under what conditions would you be 'already authenticated' prior to calling $protocol->auth() ?  As soon as you call auth(), $this->_auth is set to true so that subsequent calls throw an exception.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "created": "2010-12-03T04:00:08.000+0000",
                    "updated": "2010-12-03T04:00:08.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43438",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wade.womersley",
                        "name": "wade.womersley",
                        "displayName": "Wade Womersley",
                        "active": true
                    },
                    "body": "Easy, when your IP gets auto validated due to POP3 before SMTP. We have web servers in our office and PC's in use by people too. All our data goes over 4 connections to the web: as a result of this, our IP addresses get auto white listed on the SMTP server due to POP3 before SMTP so when Zend tries to connect from one of those IP's it gets an \"already authenticated\" response.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wade.womersley",
                        "name": "wade.womersley",
                        "displayName": "Wade Womersley",
                        "active": true
                    },
                    "created": "2010-12-03T04:05:21.000+0000",
                    "updated": "2010-12-03T04:05:21.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43439",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "body": "What is the MTA (SMTP server) on the other end?  The only mention in [RFC4954|http:\/\/tools.ietf.org\/html\/rfc4954] of 503 being a permissible response to AUTH is:\r\n\r\n{quote}\r\nAfter an AUTH command has been successfully completed, no more\r\nAUTH commands may be issued in the same session.  After a\r\nsuccessful AUTH command completes, a server MUST reject any\r\nfurther AUTH commands with a 503 reply.\r\n{quote}\r\n\r\nEven if the user is authenticated via POP3, it seems to me from this description that the first AUTH should be accepted.\r\n\r\nHowever, RFC or not, if this is standard behavior with POP3-before-SMTP then I agree that it should be supported in the protocol adapter.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "created": "2010-12-03T04:21:40.000+0000",
                    "updated": "2010-12-03T04:21:40.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43440",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wade.womersley",
                        "name": "wade.womersley",
                        "displayName": "Wade Womersley",
                        "active": true
                    },
                    "body": "It is indeed due to whitelisting, did a quick Google and found on [this page|http:\/\/kb.parallels.com\/1390], this:\r\n{quote}\r\n- If you see \"503 you are already authenticated\" message after entering the \"auth login\" command, there are two possible reasons:\r\na) you already were authorized via POP3 authorization.\r\nb) your IP is listed in white list, and you don't need to be authenticated in this case.\r\n{quote}\r\n\r\nI know our server will temporarily whitelist if you authenticate via POP3 first but it also means some servers support perma-whitelisting and therefore the current Login code would always fail if run behind that.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=wade.womersley",
                        "name": "wade.womersley",
                        "displayName": "Wade Womersley",
                        "active": true
                    },
                    "created": "2010-12-03T04:30:36.000+0000",
                    "updated": "2010-12-03T04:30:36.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/43449",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "body": "One concern with your proposed solution comes to mind.  Consider this scenario:\r\n\r\n# You specify credentials for SMTP AUTH (i.e. username: foo)\r\n# You previously authenticated against POP3 (or whatever other mechanism) with user name \"foo2\"\r\n# The server rejects the AUTH, but your solution catches this exception\r\n# Your proposed solution handles the 503 by discarding the exception and flipping the auth flag to true in the protocol adapter\r\n\r\nYou asked to AUTH under \"foo\" but now you're auth'd under \"foo2\" and don't know it.  \r\n\r\nThis could cause various unexpected behaviors.  In some systems, the username you're AUTH'd against dictates certain headers in outgoing mail (i.e. \"From\").  You might get confusing rejections trying to send from \"foo@mydomain.com\" when unexpectedly auth'd under \"foo2\" because \"foo@mydomain.com\" is not a permitted sender for foo2. Or, perhaps outgoing mail would be automatically set to be \"from\" that user.\r\n\r\nWouldn't it be better to handle this at the application level?  i.e. try\/catch the \"already authenticated\" exception and then re-try without authentication?\r\n\r\nIf the SMTP error code (503) is made available in the exception then you could gracefully handle this on the application side.  ZF-10741 which should be applied soon to trunk takes care of adding SMTP codes to the thrown exception so it would give you this capability.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=mjh_ca",
                        "name": "mjh_ca",
                        "displayName": "Marc Hodgins",
                        "active": true
                    },
                    "created": "2010-12-03T17:26:16.000+0000",
                    "updated": "2010-12-03T17:26:16.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-10771\/transitions"
}