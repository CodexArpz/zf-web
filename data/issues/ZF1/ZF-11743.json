{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11743",
    "key": "ZF-11743",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "New Method: Zend_Db_Adapter_Abstract::refreshConnection()"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/4",
                "name": "Improvement",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11743\/votes",
                "votes": 1,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=henryhayes",
                "name": "henryhayes",
                "displayName": "Henry Hayes",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2011-09-15T11:52:15.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-04-06T11:09:38.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "Zend_Db_Adapter_Abstract"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "All of the *Zend_Db_Adapter* classes extend *Zend_Db_Adapter_Abstract*.\r\n\r\nWhen forking a process the db connection get's copied to the child processes. If a child exits before the parent, the current database connection is closed. Since the connection is shared between the child and the parent process, when the parent process tries to use the db resource, say to clean up after the child, it gets a \"MySQL has gone away\" error.\r\n\r\nI am proposing that a new method is added to the *Zend_Db_Adapter_Abstract* class that does two simple things.\r\n\r\n# Close any existing connections\r\n# Open a new connection\r\n\r\n{code}\r\n\r\n\r\n    \/**\r\n     * Closes the connection and opens a new one.\r\n     *\r\n     * @return void\r\n     *\/\r\n    public function refreshConnection()\r\n    {\r\n        if ($this->isConnected()) {\r\n            $this->closeConnection();\r\n        }\r\n        $this->_connect();\r\n    }\r\n\r\n\r\n{code}\r\n\r\nThis can be called from any parent process for the new child and in the parent process after the child is spawned.\r\n\r\n*Example of scenario where an error would occur:*\r\n\r\n{code}\r\n$this->_dbConnInfo = new Zend_Config_Array(\/* db connection information file *\/);\r\n\r\n$db = Zend_Db::factory($this->_dbConnInfo);\r\nZend_Db_Table::setDefaultAdapter($db);\r\n\r\n\/\/ Do some mysql set-up queries here\r\n\r\n$pid = pcntl_fork();\r\nif ($pid) {\r\n    \/\/ we are the parent\r\n\r\n    pcntl_wait($status); \/\/Protect against Zombie children\r\n\r\n    \/\/ Any mysql statement here will result in gone away error\r\n    \r\n} else {\r\n    \/\/ we are the child\r\n    \/\/ do some mysql processing\r\n}\r\n{code}\r\n\r\n*Example of error fixed:*\r\n\r\n{code}\r\n$this->_dbConnInfo = new Zend_Config_Array(\/* db connection information file *\/);\r\n\r\n$db = Zend_Db::factory($this->_dbConnInfo);\r\nZend_Db_Table::setDefaultAdapter($db);\r\n\r\n\/\/ Do some mysql setup queries here\r\n\r\n$pid = pcntl_fork();\r\n\r\n\/\/ This will completely fix this issue\r\n$db->refreshConnection();\r\n\r\nif ($pid) {\r\n    \/\/ we are the parent\r\n\r\n    pcntl_wait($status); \/\/Protect against Zombie children\r\n\r\n    \/\/ Any mysql statement here will result in gone away error\r\n    \r\n} else {\r\n    \/\/ we are the child\r\n    \/\/ do some mysql processing\r\n}\r\n{code}\r\n\r\nI know that this could also be done by simply running the functionality inside the proposed method. Adding this method saves code duplication and is very handy to have.\r\n\r\nPutting this method in the *Zend_Db_Adapter_Abstract* class also means that it can be used in any Zend_Db_Adapter class."
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/4",
                "name": "Minor"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11743\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [
                "zf-crteam-review"
            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=ralph",
                "name": "ralph",
                "displayName": "Ralph Schindler",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10980",
                    "id": 10980,
                    "description": "Mini Release",
                    "name": "1.11.10",
                    "userReleaseDate": "04\/Aug\/11",
                    "archived": false,
                    "releaseDate": "2011-08-04",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10012",
                    "id": 10012,
                    "name": "Zend_Db",
                    "description": "interfaces, APIs, and adapters for various third-party data stores",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48444",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=henryhayes",
                        "name": "henryhayes",
                        "displayName": "Henry Hayes",
                        "active": true
                    },
                    "body": "Here is the finished method for *Zend_Db_Adapter_Abstract*\r\n\r\n{code}\r\n    \/**\r\n     * Closes the connection and opens a new one - non-persistent only.\r\n     *\r\n     * This method is used to release an existing database connection and\r\n     * create a new one. Does not work with a persistent connection.\r\n     *\r\n     * @link http:\/\/framework.zend.com\/issues\/browse\/ZF-11743\r\n     *\r\n     * @return void\r\n     *\/\r\n    public function refreshConnection()\r\n    {\r\n        if (array_key_exists('persistent', $this->_config) && $this->_config['persistent'] == true) {\r\n\r\n            throw new Zend_Db_Adapter_Exception('Persistent connections cannot be refreshed.');\r\n        }\r\n\r\n        if ($this->isConnected()) {\r\n            $this->closeConnection();\r\n\r\n        }\r\n\r\n        $this->_connect();\r\n\r\n        return $this;\r\n    }\r\n{code}\r\n\r\nI have also created complimenting method for the *Zend_Db_Table_Abstract* class:\r\n\r\n{code}\r\n\r\n    \/**\r\n     * Resets the default adapter - disconects and then reconnects.\r\n     *\r\n     * @return void\r\n     *\/\r\n    public static function resetDefaultAdapter()\r\n    {\r\n        if (is_null(self::getDefaultAdapter())) {\r\n            return;\r\n        }\r\n\r\n        $db = self::getDefaultAdapter();\r\n        $db->refreshConnection();\r\n    }\r\n\r\n{code}\r\n\r\nThis is great for when you need to reset the database connection from anywhere in the app. I.e.\r\n\r\n{code}\r\n\r\nZend_Db_Table::resetDefaultAdapter();\r\n\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=henryhayes",
                        "name": "henryhayes",
                        "displayName": "Henry Hayes",
                        "active": true
                    },
                    "created": "2011-09-15T15:16:45.000+0000",
                    "updated": "2011-09-15T15:16:45.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48446",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=evan.pro",
                        "name": "evan.pro",
                        "displayName": "Evan Coury",
                        "active": true
                    },
                    "body": "Am I correct by saying this is only really needed because _connect is protected, so it's difficult to accomplish this in user-land code? I've personally ran into the issue outlined here with pcntl_fork(), and in my case I simply extended the adapter to provide the refreshConnection() functionality. So the question is: do we need or want this in the abstract adapter as proposed, and are there any other use-cases for performing such a re-connect beyond when the process is forked and you have two processes sharing the same connection resource?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=evan.pro",
                        "name": "evan.pro",
                        "displayName": "Evan Coury",
                        "active": true
                    },
                    "created": "2011-09-15T17:08:50.000+0000",
                    "updated": "2011-09-15T17:08:50.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/48449",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=henryhayes",
                        "name": "henryhayes",
                        "displayName": "Henry Hayes",
                        "active": true
                    },
                    "body": "I take your point. I believe it is required. Especially in the Abstract class. Extending the adapter is a work around for this problem not a solution.Making the *_connect()* method public would not solve the issue as it returns if a connection exists. To accomplish what this new method does, you have to wite three lines of code; check for connection, disconnect and connect. This new method does all this for your and hence, reducing code duplication in your application.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=henryhayes",
                        "name": "henryhayes",
                        "displayName": "Henry Hayes",
                        "active": true
                    },
                    "created": "2011-09-15T20:29:14.000+0000",
                    "updated": "2011-09-15T20:29:14.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/49920",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "body": "Is this something which should be included in ZF 1.12?",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=adamlundrigan",
                        "name": "adamlundrigan",
                        "displayName": "Adam Lundrigan",
                        "active": true
                    },
                    "created": "2012-03-05T22:48:56.000+0000",
                    "updated": "2012-03-05T22:48:56.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50207",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=styx",
                        "name": "styx",
                        "displayName": "Pawel Chuchmala",
                        "active": true
                    },
                    "body": "I think that adapter should autorefresh connction. This error occur also if you set short timeout in mysql server and your script has long job between thow DB operation. Workaround described at: http:\/\/www.lornajane.net\/posts\/2011\/dealing-with-mysql-gone-away-in-zend-framework",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=styx",
                        "name": "styx",
                        "displayName": "Pawel Chuchmala",
                        "active": true
                    },
                    "created": "2012-04-06T11:09:38.000+0000",
                    "updated": "2012-04-06T11:09:38.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-11743\/transitions"
}