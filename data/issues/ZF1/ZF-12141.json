{
    "expand": "html",
    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12141",
    "key": "ZF-12141",
    "fields": {
        "summary": {
            "name": "summary",
            "type": "java.lang.String",
            "value": "Zend_Date::toString returns wrong date for some 'php' formats"
        },
        "timetracking": {
            "name": "timetracking",
            "type": "com.atlassian.jira.issue.fields.TimeTrackingSystemField"
        },
        "issuetype": {
            "name": "issuetype",
            "type": "com.atlassian.jira.issue.issuetype.IssueType",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issueType\/1",
                "name": "Bug",
                "subtask": false
            }
        },
        "votes": {
            "name": "votes",
            "type": "com.atlassian.jira.issue.fields.VotesSystemField",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12141\/votes",
                "votes": 0,
                "hasVoted": false
            }
        },
        "security": {
            "name": "security",
            "type": "com.atlassian.jira.issue.security.IssueSecurityLevel"
        },
        "fixVersions": {
            "name": "fixVersions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [

            ]
        },
        "reporter": {
            "name": "reporter",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                "name": "vladm",
                "displayName": "Vladyslav Mustafin",
                "active": true
            }
        },
        "created": {
            "name": "created",
            "type": "java.util.Date",
            "value": "2012-04-09T13:56:27.000+0000"
        },
        "updated": {
            "name": "updated",
            "type": "java.util.Date",
            "value": "2012-08-11T08:08:38.000+0000"
        },
        "customfield_10041": {
            "name": "Tags",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:labels",
            "value": [
                "date"
            ]
        },
        "description": {
            "name": "description",
            "type": "java.lang.String",
            "value": "Simple example:\r\n{code}\r\n$date = new Zend_Date();\r\necho $date->toString(DateTime::ATOM, 'php'); \/\/ 2012-04-09\\UTC12:21:48+00:00\r\n{code}\r\nThis code display 2012-04-09\\UTC12:21:48+00:00 but 2012-04-09T12:21:48+00:00 is expected instead.\r\n\r\nBut example bellow works as expected:\r\n{code}\r\n$date = new Zend_Date();\r\necho $date->toString(Zend_Date::ATOM); \/\/ 2012-04-09T12:21:48+00:00\r\n{code}\r\n\r\nThe basic problem is that Zend_Date::toString uses Zend_Locale_Format::convertPhpToIsoFormat for php format type that works incorrectly with formats that contain symbols are escaped with backslash (\\T in example). Zend_Locale_Format::convertPhpToIsoFormat just splits format string to array and convert each symbol to ISO separately. But it should be more complicated. The simplest way to fix it is to get escaped symbol right after backslash and put it into single quotes so Zend_Date will parse it as comment.\r\n"
        },
        "priority": {
            "name": "priority",
            "type": "com.atlassian.jira.issue.priority.Priority",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/priority\/3",
                "name": "Major"
            }
        },
        "duedate": {
            "name": "duedate",
            "type": "java.util.Date"
        },
        "customfield_10022": {
            "name": "Fix Version Priority",
            "type": "com.atlassian.jira.plugin.system.customfieldtypes:select"
        },
        "watcher": {
            "name": "watcher",
            "type": "watcher",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12141\/watchers",
                "isWatching": false,
                "watchCount": 2
            }
        },
        "worklog": {
            "name": "worklog",
            "type": "worklog",
            "value": [

            ]
        },
        "status": {
            "name": "status",
            "type": "com.atlassian.jira.issue.status.Status",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/status\/1",
                "name": "Open"
            }
        },
        "labels": {
            "name": "labels",
            "type": "com.atlassian.jira.issue.label.Label",
            "value": [
                "zend_date"
            ]
        },
        "assignee": {
            "name": "assignee",
            "type": "com.opensymphony.user.User",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=thomas",
                "name": "thomas",
                "displayName": "Thomas Weidner",
                "active": true
            }
        },
        "links": {
            "name": "links",
            "type": "issuelinks",
            "value": [

            ]
        },
        "attachment": {
            "name": "attachment",
            "type": "attachment",
            "value": [

            ]
        },
        "sub-tasks": {
            "name": "sub-tasks",
            "type": "issuelinks",
            "value": [

            ]
        },
        "versions": {
            "name": "versions",
            "type": "com.atlassian.jira.project.version.Version",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/version\/10981",
                    "id": 10981,
                    "description": "Mini Release",
                    "name": "1.11.11",
                    "userReleaseDate": "29\/Sep\/11",
                    "archived": false,
                    "releaseDate": "2011-09-29",
                    "released": true
                }
            ]
        },
        "project": {
            "name": "project",
            "type": "com.atlassian.jira.project.Project",
            "value": {
                "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/project\/ZF",
                "key": "ZF",
                "name": "Zend Framework",
                "roles": {

                }
            }
        },
        "components": {
            "name": "components",
            "type": "com.atlassian.jira.bc.project.component.ProjectComponent",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10072",
                    "id": 10072,
                    "name": "Zend_Date",
                    "description": "Zend_Date is the basic library for the handling of all date, time and calendar-related issues.",
                    "isAssigneeTypeValid": false
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/component\/10073",
                    "id": 10073,
                    "name": "Zend_Locale",
                    "description": "Zend_Locale is a basic wrapper for all I18N and L10N issues for the Zend Framework. It provides the userbasically with access to translation functionality. It can handle different source file types for translation.",
                    "isAssigneeTypeValid": false
                }
            ]
        },
        "comment": {
            "name": "comment",
            "type": "com.atlassian.jira.issue.fields.CommentSystemField",
            "value": [
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50215",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "body": "It might looks like below:\r\n{code}\r\n    public static function convertPhpToIsoFormat($format)\r\n    {\r\n        if ($format === null) {\r\n            return null;\r\n        }\r\n\r\n        $convert = array('d' => 'dd'  , 'D' => 'EE'  , 'j' => 'd'   , 'l' => 'EEEE', 'N' => 'eee' , 'S' => 'SS'  ,\r\n                         'w' => 'e'   , 'z' => 'D'   , 'W' => 'ww'  , 'F' => 'MMMM', 'm' => 'MM'  , 'M' => 'MMM' ,\r\n                         'n' => 'M'   , 't' => 'ddd' , 'L' => 'l'   , 'o' => 'YYYY', 'Y' => 'yyyy', 'y' => 'yy'  ,\r\n                         'a' => 'a'   , 'A' => 'a'   , 'B' => 'B'   , 'g' => 'h'   , 'G' => 'H'   , 'h' => 'hh'  ,\r\n                         'H' => 'HH'  , 'i' => 'mm'  , 's' => 'ss'  , 'e' => 'zzzz', 'I' => 'I'   , 'O' => 'Z'   ,\r\n                         'P' => 'ZZZZ', 'T' => 'z'   , 'Z' => 'X'   , 'c' => 'yyyy-MM-ddTHH:mm:ssZZZZ',\r\n                         'r' => 'r'   , 'U' => 'U');\r\n        $values = str_split($format);\r\n        $escaped = false;\r\n        $temp = array();\r\n        foreach ($values as $key => $value) {\r\n            if ($v == '\\\\') {\r\n                $escaped = true;\r\n                continue;\r\n            }\r\n            if ($escaped) {\r\n                $temp[] = str_replace(\"'''\", \"''\", \"'$value'\");\r\n                $escaped = false;\r\n            } else if ($value == \"'\") {\r\n                $temp[] = \"''\";\r\n            } else if (isset($convert[$value]) === true) {\r\n                $temp[] = $convert[$value];\r\n            } else {\r\n                $temp[] = $value;\r\n            }\r\n        }\r\n\r\n        return join($values);\r\n    }\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "created": "2012-04-09T16:19:03.000+0000",
                    "updated": "2012-04-09T16:19:03.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50216",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "body": "Wrong return in my example, it should be:\r\n{code}return join($temp);{code}\r\nSorry for typo.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "created": "2012-04-09T16:21:41.000+0000",
                    "updated": "2012-04-09T16:21:41.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50426",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=patrickheck",
                        "name": "patrickheck",
                        "displayName": "Patrick Heck",
                        "active": true
                    },
                    "body": "Hi Mustafin,\r\n\r\nthanks for the code snippet. However I found two issues that still exist:\r\n1. Inserting of consecutive escaped characters like \"\\a\\t\" result in \"a't\"\r\n2. A masked backslash was not displayed\r\n\r\nMy suggestion is to improve it like this:\r\n\r\n{code}\r\npublic static function convertPhpToIsoFormat($format)\r\n    {\r\n        if ($format === null) {\r\n            return null;\r\n        }\r\n\r\n        $convert = array('d' => 'dd'  , 'D' => 'EE'  , 'j' => 'd'   , 'l' => 'EEEE', 'N' => 'eee' , 'S' => 'SS'  ,\r\n                         'w' => 'e'   , 'z' => 'D'   , 'W' => 'ww'  , 'F' => 'MMMM', 'm' => 'MM'  , 'M' => 'MMM' ,\r\n                         'n' => 'M'   , 't' => 'ddd' , 'L' => 'l'   , 'o' => 'YYYY', 'Y' => 'yyyy', 'y' => 'yy'  ,\r\n                         'a' => 'a'   , 'A' => 'a'   , 'B' => 'B'   , 'g' => 'h'   , 'G' => 'H'   , 'h' => 'hh'  ,\r\n                         'H' => 'HH'  , 'i' => 'mm'  , 's' => 'ss'  , 'e' => 'zzzz', 'I' => 'I'   , 'O' => 'Z'   ,\r\n                         'P' => 'ZZZZ', 'T' => 'z'   , 'Z' => 'X'   , 'c' => 'yyyy-MM-ddTHH:mm:ssZZZZ',\r\n                         'r' => 'r'   , 'U' => 'U');\r\n        $values = str_split($format);\r\n        $escaped = false;\r\n        $lastescaped = false;\r\n        $temp = array();\r\n        foreach ($values as $key => $value) {\r\n            if (!$escaped && $value == '\\\\') {\r\n                $escaped = true;\r\n                continue;\r\n            }\r\n            if ($escaped) {\r\n            \tif (!$lastescaped) {\r\n            \t\t$temp[] = \"'\";\r\n            \t\t$lastescaped = true;\r\n            \t} \r\n            \t$temp[] = $value;\r\n            \t$escaped = false;\r\n            } else { \r\n            \tif ($lastescaped) {\r\n            \t\t$temp[] = \"'\";\r\n            \t\t$lastescaped = false;\r\n            \t}\r\n            \tif ($value == \"'\") {\r\n\t                $temp[] = \"''\";\r\n\t            } else if (isset($convert[$value]) === true) {\r\n\t                $temp[] = $convert[$value];\r\n\t            } else {\r\n\t                $temp[] = $value;\r\n\t            }\r\n            }\r\n        }\r\n        return join($temp);\r\n    }\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=patrickheck",
                        "name": "patrickheck",
                        "displayName": "Patrick Heck",
                        "active": true
                    },
                    "created": "2012-05-02T17:18:34.000+0000",
                    "updated": "2012-05-02T17:18:34.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/50428",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=patrickheck",
                        "name": "patrickheck",
                        "displayName": "Patrick Heck",
                        "active": true
                    },
                    "body": "I just realized that the string \"\\a\\'\\b\" wouldn't work properly with this code. The result would be \"a''b\" instead of \"a'b\". To fix this the escaped sequence should only be terminated if the current character is != \"'\".\r\n\r\n{code}\r\n    public static function convertPhpToIsoFormat($format)\r\n    {\r\n        if ($format === null) {\r\n            return null;\r\n        }\r\n\r\n        $convert = array('d' => 'dd'  , 'D' => 'EE'  , 'j' => 'd'   , 'l' => 'EEEE', 'N' => 'eee' , 'S' => 'SS'  ,\r\n                         'w' => 'e'   , 'z' => 'D'   , 'W' => 'ww'  , 'F' => 'MMMM', 'm' => 'MM'  , 'M' => 'MMM' ,\r\n                         'n' => 'M'   , 't' => 'ddd' , 'L' => 'l'   , 'o' => 'YYYY', 'Y' => 'yyyy', 'y' => 'yy'  ,\r\n                         'a' => 'a'   , 'A' => 'a'   , 'B' => 'B'   , 'g' => 'h'   , 'G' => 'H'   , 'h' => 'hh'  ,\r\n                         'H' => 'HH'  , 'i' => 'mm'  , 's' => 'ss'  , 'e' => 'zzzz', 'I' => 'I'   , 'O' => 'Z'   ,\r\n                         'P' => 'ZZZZ', 'T' => 'z'   , 'Z' => 'X'   , 'c' => 'yyyy-MM-ddTHH:mm:ssZZZZ',\r\n                         'r' => 'r'   , 'U' => 'U');\r\n        $values = str_split($format);\r\n        $escaped = false;\r\n        $lastescaped = false;\r\n        $temp = array();\r\n        foreach ($values as $key => $value) {\r\n            if (!$escaped && $value == '\\\\') {\r\n                $escaped = true;\r\n                continue;\r\n            }\r\n            if ($escaped) {\r\n            \tif (!$lastescaped) {\r\n            \t\t$temp[] = \"'\";\r\n            \t\t$lastescaped = true;\r\n            \t} \r\n            \t$temp[] = $value;\r\n            \t$escaped = false;\r\n            } else { \r\n            \tif ($value == \"'\") {\r\n\t                $temp[] = \"''\";\r\n\t            } else {\r\n\t\t            if ($lastescaped) {\r\n\t            \t\t$temp[] = \"'\";\r\n\t            \t\t$lastescaped = false;\r\n\t            \t}\r\n\t\t            if (isset($convert[$value]) === true) {\r\n\t\t                $temp[] = $convert[$value];\r\n\t\t            } else {\r\n\t\t                $temp[] = $value;\r\n\t\t            }\r\n\t            }\r\n            }\r\n        }\r\n        echo join($temp) . \"<br>\";\r\n        return join($temp);\r\n    }\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=patrickheck",
                        "name": "patrickheck",
                        "displayName": "Patrick Heck",
                        "active": true
                    },
                    "created": "2012-05-02T18:10:01.000+0000",
                    "updated": "2012-05-02T18:10:01.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51556",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "body": "Hi Heck,\r\n\r\n{quote}\r\n2. A masked backslash was not displayed\r\n{quote}\r\nIf you try to get an output of \r\n{code}date('\\\\\\\\ \\t\\e\\s\\t');{code}\r\nyou'll get a string\r\n{noformat}\\ test{noformat}\r\nFor this output the valid iso date format is\r\n{noformat}\\ 'test'{noformat}\r\nYou could check it with this code\r\n{code}Zend_Date::now()->toString('\\\\ \\'test\\'');{code}\r\n\r\nSo masked backslash in php date format should be converted to a single backslash for iso date format. No needs to escape it in iso, but with your last snippet it will.\r\n{code}Zend_Locale_Format::convertPhpToIsoFormat('\\\\\\\\ \\t\\e\\s\\t');{code}\r\nwill return\r\n{noformat}'\\' 'test'{noformat}\r\n\r\n\\\\\r\nWith small additional condition we can get the expected behaviour:\r\n{code}\r\n...\r\n            if ($escaped) {\r\n            \tif ($v != '\\\\' && !$lastescaped) { \/\/ added *$v != '\\\\' &&* condition here allows us to get correct backslashes for iso date format\r\n            \t\t$temp[] = \"'\";\r\n            \t\t$lastescaped = true;\r\n            \t} \r\n            \t$temp[] = $value;\r\n            \t$escaped = false;\r\n            }\r\n...\r\n{code}",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "created": "2012-08-09T08:55:34.000+0000",
                    "updated": "2012-08-09T08:55:34.000+0000"
                },
                {
                    "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/comment\/51561",
                    "author": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "body": "Yet another typo please use '$value' instead of '$v' in my examples.\r\nSorry for that.",
                    "updateAuthor": {
                        "self": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/user?username=vladm",
                        "name": "vladm",
                        "displayName": "Vladyslav Mustafin",
                        "active": true
                    },
                    "created": "2012-08-11T08:08:38.000+0000",
                    "updated": "2012-08-11T08:08:38.000+0000"
                }
            ]
        }
    },
    "transitions": "http:\/\/fw02.zend.com\/issues\/rest\/api\/latest\/issue\/ZF-12141\/transitions"
}